@model AutoMarket.Models.ViewModels.AlterarPasswordViewModel
@{
    ViewData["Title"] = "Alterar Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Hero Header -->
<section class="bg-warning text-dark py-4">
    <div class="container">
        <h1 class="mb-1">
            <i class="bi bi-key-fill"></i> Alterar Password
        </h1>
        <p class="mb-0">
            Altere a sua password de acesso
        </p>
    </div>
</section>

<!-- Conteúdo -->
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Card Principal -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-shield-lock"></i> Nova Password
                    </h5>

                    <!-- Alertas -->
                    @if (ViewData.ModelState.ErrorCount > 0)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> 
                            <strong>Erro ao alterar password:</strong>
                            <ul class="mb-0 mt-2">
                                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle-fill"></i> Requisitos de Segurança
                        </h6>
                        <p class="mb-0">A nova password deve ter:</p>
                        <ul class="mb-0 mt-2">
                            <li><strong>Mínimo de 16 caracteres</strong></li>
                            <li>Pelo menos <strong>uma letra maiúscula</strong> (A-Z)</li>
                            <li>Pelo menos <strong>uma letra minúscula</strong> (a-z)</li>
                            <li>Pelo menos <strong>um número</strong> (0-9)</li>
                            <li>Pelo menos <strong>um carácter especial</strong> (@@, #, $, !, etc.)</li>
                        </ul>
                    </div>

                    <!-- Formulário -->
                    <form asp-action="AlterarPassword" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="PasswordAtual" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input asp-for="PasswordAtual" class="form-control" placeholder="Introduza a password atual" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordAtual">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="PasswordAtual" class="text-danger"></span>
                        </div>

                        <hr class="my-4" />

                        <div class="mb-3">
                            <label asp-for="NovaPassword" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input asp-for="NovaPassword" class="form-control" placeholder="Introduza a nova password" id="novaPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleNovaPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NovaPassword" class="text-danger"></span>
                            
                            <!-- Indicador de Força da Password -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Força da password</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmarNovaPassword" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-check2"></i>
                                </span>
                                <input asp-for="ConfirmarNovaPassword" class="form-control" placeholder="Confirme a nova password" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmarNovaPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="bi bi-key-fill"></i> Alterar Password
                            </button>
                            <a asp-action="Perfil" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left"></i> Voltar ao Perfil
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dicas de Segurança -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-lightbulb"></i> Dicas de Segurança
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Não partilhe a sua password com ninguém</li>
                        <li>Use passwords diferentes para cada serviço</li>
                        <li>Altere a sua password regularmente</li>
                        <li>Evite passwords óbvias (datas de nascimento, nomes, etc.)</li>
                        <li>Considere usar um gestor de passwords</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Toggle visibilidade das passwords
        function setupPasswordToggle(toggleBtnId, inputId) {
            const btn = document.getElementById(toggleBtnId);
            const input = document.getElementById(inputId) || document.querySelector(`input[name="${inputId}"]`);
            
            if (btn && input) {
                btn.addEventListener('click', function() {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    
                    const icon = this.querySelector('i');
                    icon.classList.toggle('bi-eye');
                    icon.classList.toggle('bi-eye-slash');
                });
            }
        }

        setupPasswordToggle('togglePasswordAtual', 'PasswordAtual');
        setupPasswordToggle('toggleNovaPassword', 'novaPassword');
        setupPasswordToggle('toggleConfirmarPassword', 'ConfirmarNovaPassword');

        // Indicador de força da password
        const passwordInput = document.getElementById('novaPassword');
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('passwordStrengthText');

        if (passwordInput && strengthBar && strengthText) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let feedback = [];

                if (password.length === 0) {
                    strengthBar.style.width = '0%';
                    strengthBar.className = 'progress-bar';
                    strengthText.textContent = 'Força da password';
                    return;
                }

                // Critérios de força
                if (password.length >= 16) strength += 20;
                else if (password.length >= 12) strength += 10;
                else feedback.push('Mínimo 16 caracteres');

                if (/[a-z]/.test(password)) strength += 20;
                else feedback.push('Falta minúscula');

                if (/[A-Z]/.test(password)) strength += 20;
                else feedback.push('Falta maiúscula');

                if (/[0-9]/.test(password)) strength += 20;
                else feedback.push('Falta número');

                if (/[^a-zA-Z0-9]/.test(password)) strength += 20;
                else feedback.push('Falta carácter especial');

                // Atualizar barra
                strengthBar.style.width = strength + '%';
                
                if (strength < 40) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Fraca: ' + feedback.join(', ');
                    strengthText.className = 'text-danger small';
                } else if (strength < 80) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Média: ' + feedback.join(', ');
                    strengthText.className = 'text-warning small';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Forte: Todos os requisitos cumpridos!';
                    strengthText.className = 'text-success small';
                }
            });
        }
    </script>
}

<style>
    .input-group-text {
        background-color: #f8f9fa;
    }

    .progress {
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        transition: width 0.3s ease, background-color 0.3s ease;
    }
</style>
