@model IEnumerable<AutoMarket.Models.Veiculo>
@{
    ViewData["Title"] = "Pesquisa de Veículos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- SIDEBAR FILTROS (Esquerda) -->
        <aside class="col-lg-3 col-md-4 col-12">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <form method="get" action="/Veiculos/Index" id="filtrosForm">
                        
                        <!-- Marca -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Marca</label>
                            <select name="marca" class="form-select form-select-sm">
                                <option value="">-- Todas as marcas --</option>
                                @foreach (var m in (ViewData["Marcas"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["MarcaSelecionada"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Modelo -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Modelo</label>
                            <select name="modelo" class="form-select form-select-sm">
                                <option value="">-- Todos os modelos --</option>
                                @foreach (var m in (ViewData["Modelos"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["ModeloSelecionado"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Cor -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Cor</label>
                            <select name="cor" class="form-select form-select-sm">
                                <option value="">-- Todas as cores --</option>
                                @foreach (var c in (ViewData["Cores"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@c" selected="@(ViewData["CorSelecionada"]?.ToString() == c)">@c</option>
                                }
                            </select>
                        </div>

                        <!-- Combustível -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Combustível</label>
                            <select name="combustivel" class="form-select form-select-sm">
                                <option value="">-- Todos --</option>
                                @foreach (var c in (ViewData["Combustiveis"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@c" selected="@(ViewData["CombustivelSelecionado"]?.ToString() == c)">@c</option>
                                }
                            </select>
                        </div>

                        <!-- Ano -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ano</label>
                            <select name="ano" class="form-select form-select-sm">
                                <option value="">-- Todos os anos --</option>
                                @foreach (var a in (ViewData["Anos"] as List<int?>) ?? new List<int?>())
                                {
                                    <option value="@a" selected="@(ViewData["AnoSelecionado"]?.ToString() == a.ToString())">@a</option>
                                }
                            </select>
                        </div>

                        <!-- Tipo/Segmento -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tipo (Segmento)</label>
                            <select name="categoria" class="form-select form-select-sm">
                                <option value="">-- Todos os tipos --</option>
                                @foreach (var cat in (ViewData["Categorias"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@cat" selected="@(ViewData["CategoriaSelecionada"]?.ToString() == cat)">@cat</option>
                                }
                            </select>
                        </div>

                        <!-- Preço Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Preço (€)</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="precoMin" class="form-control" placeholder="Mín" value="@ViewData["PrecoMin"]" />
                                <input type="number" name="precoMax" class="form-control" placeholder="Máx" value="@ViewData["PrecoMax"]" />
                            </div>
                        </div>

                        <!-- KM Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Quilómetros</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="kmMin" class="form-control" placeholder="Mín" value="@ViewData["KmMin"]" />
                                <input type="number" name="kmMax" class="form-control" placeholder="Máx" value="@ViewData["KmMax"]" />
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-search"></i> Pesquisar
                            </button>
                            <a href="/Veiculos/Index" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <!-- ANÚNCIOS (Direita) -->
        <section class="col-lg-9 col-md-8 col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Veículos Disponíveis</h5>
                    <div>
                        <label class="form-label mb-0 me-2">Ordenar:</label>
                        <select id="ordenacao" class="form-select form-select-sm d-inline w-auto">
                            <option value="recente" selected="@(ViewData["Ordenacao"]?.ToString() == "recente")">Mais recente</option>
                            <option value="preco_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_asc")">Preço ascendente</option>
                            <option value="preco_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_desc")">Preço descendente</option>
                            <option value="km_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_asc")">KM ascendentes</option>
                            <option value="km_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_desc")">KM descendentes</option>
                            <option value="ano_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_asc")">Ano ascendente</option>
                            <option value="ano_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_desc")">Ano descendente</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Grid de Anúncios -->
            @if (Model.Any())
            {
                <div class="row g-4">
                    @foreach (var veiculo in Model)
                    {
                        <div class="col-lg-4 col-md-6 col-12">
                            <div class="card h-100 shadow-sm vehicle-card transition">
                                @if (!string.IsNullOrEmpty(veiculo.ImagemPrincipal))
                                {
                                    <img src="/images/@veiculo.ImagemPrincipal" class="card-img-top" alt="@veiculo.Marca @veiculo.Modelo" style="height: 200px; object-fit: cover;" />
                                }
                                else
                                {
                                    <div style="height: 200px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">
                                        <small>Sem imagem</small>
                                    </div>
                                }
                                <div class="card-body">
                                    <h6 class="card-title text-primary">@veiculo.Marca @veiculo.Modelo</h6>
                                    <p class="card-text text-danger fw-bold fs-6">€@veiculo.Preco.ToString("F2")</p>
                                    <small class="text-muted d-block">
                                        ?? @veiculo.Ano
                                    </small>
                                    <small class="text-muted d-block">
                                        ??? @veiculo.Quilometros?.ToString("N0") km
                                    </small>
                                    <small class="text-muted d-block mb-2">
                                        ? @veiculo.Combustivel
                                    </small>
                                    @if (!string.IsNullOrEmpty(veiculo.Categoria))
                                    {
                                        <span class="badge bg-info text-dark">@veiculo.Categoria</span>
                                    }
                                </div>
                                <div class="card-footer bg-transparent">
                                    <a href="/Veiculos/Detalhe/@veiculo.Id" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-eye"></i> Ver Detalhes
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info text-center" role="alert">
                    <h6 class="alert-heading">Nenhum veículo encontrado</h6>
                    <p class="mb-3">Nenhum veículo encontrado com os filtros selecionados.</p>
                    <a href="/Veiculos/Index" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
                    </a>
                </div>
            }
        </section>
    </div>
</div>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
</style>

<script>
    // Atualizar o campo de ordenação
    document.getElementById('ordenacao').addEventListener('change', function() {
        var ordenacao = this.value;
        var form = document.getElementById('filtrosForm');
        
        var ordenacaoInput = form.querySelector('input[name="ordenacao"]');
        if (!ordenacaoInput) {
            ordenacaoInput = document.createElement('input');
            ordenacaoInput.type = 'hidden';
            ordenacaoInput.name = 'ordenacao';
            form.appendChild(ordenacaoInput);
        }
        
        ordenacaoInput.value = ordenacao;
        form.submit();
    });
</script>
