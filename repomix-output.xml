This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.repomixignore
appsettings.json
appsettings.Production.json
Areas/Admin/Controllers/AdminController.cs
Areas/Admin/Views/_ViewImports.cshtml
Areas/Admin/Views/_ViewStart.cshtml
Areas/Admin/Views/HistoricoTransacoes.cshtml
Areas/Admin/Views/Index.cshtml
Areas/Public/Controllers/CarrinhoController.cs
Areas/Public/Controllers/CheckoutController.cs
Areas/Public/Controllers/ContaController.cs
Areas/Public/Controllers/HomeController.cs
Areas/Public/Controllers/TransacoesController.cs
Areas/Public/Controllers/VeiculosController.cs
Areas/Public/Views/_ViewImports.cshtml
Areas/Public/Views/_ViewStart.cshtml
Areas/Public/Views/Carrinho/CarrinhoResumoViewComponent.cs
Areas/Public/Views/Carrinho/CartIndex.cshtml
Areas/Public/Views/Conta/AguardandoAprovacao.cshtml
Areas/Public/Views/Conta/Favoritos.cshtml
Areas/Public/Views/Conta/Lockout.cshtml
Areas/Public/Views/Conta/Login.cshtml
Areas/Public/Views/Conta/PreencherDadosFiscais.cshtml
Areas/Public/Views/Conta/Register.cshtml
Areas/Public/Views/Emails/EmailConfirmation.cshtml
Areas/Public/Views/Home/Ajuda.cshtml
Areas/Public/Views/Home/Index.cshtml
Areas/Public/Views/Home/Privacy.cshtml
Areas/Public/Views/Home/Sobre.cshtml
Areas/Public/Views/Shared/_Footer.cshtml
Areas/Public/Views/Shared/_Header.cshtml
Areas/Public/Views/Shared/_Layout.cshtml
Areas/Public/Views/Shared/_Layout.cshtml.css
Areas/Public/Views/Shared/_LoginPartial.cshtml
Areas/Public/Views/Shared/_ValidationScriptsPartial.cshtml
Areas/Public/Views/Shared/Components/CarrinhoResumo/Default.cshtml
Areas/Public/Views/Shared/Error.cshtml
Areas/Public/Views/Transacao/Checkout.cshtml
Areas/Public/Views/Veiculos/_CarListPartial.cshtml
Areas/Public/Views/Veiculos/Detalhe.cshtml
Areas/Public/Views/Veiculos/Index.cshtml
Areas/Vendedores/_ViewImports.cshtml
Areas/Vendedores/_ViewStart.cshtml
Areas/Vendedores/Controllers/VeiculosController.cs
Areas/Vendedores/Views/Veiculos/Create.cshtml
Areas/Vendedores/Views/Veiculos/Delete.cshtml
Areas/Vendedores/Views/Veiculos/Details.cshtml
Areas/Vendedores/Views/Veiculos/Edit.cshtml
Areas/Vendedores/Views/Veiculos/Index.cshtml
AutoMarket.csproj
AutoMarket.sln
GlobalUsings.cs
Infrastructure/Data/ApplicationDbContext.cs
Infrastructure/Data/Configurations/ReservaConfiguration.cs
Infrastructure/Data/CustomUserStore.cs
Infrastructure/Data/DbInitializer.cs
Infrastructure/Options/ReservationOptions.cs
Infrastructure/Security/CustomClaimsPrincipalFactory.cs
Infrastructure/Security/NifEncryptionHelper.cs
Infrastructure/Security/VendedorAprovadoHandler.cs
Infrastructure/Security/VendedorAprovadoRequirement.cs
Infrastructure/Utils/NifValidator.cs
Infrastructure/Utils/SessionExtensions.cs
Models/Attributes/NifPortuguesAttribute.cs
Models/Constants/Roles.cs
Models/DTOs/AuthDto.cs
Models/DTOs/CheckoutDto.cs
Models/DTOs/ReservarVeiculoDto.cs
Models/DTOs/VeiculoDto.cs
Models/DTOs/VeiculoSearchFiltersDto.cs
Models/Entities/CarrinhoItem.cs
Models/Entities/Carro.cs
Models/Entities/CarroImagem.cs
Models/Entities/Categoria.cs
Models/Entities/Comprador.cs
Models/Entities/Denuncia.cs
Models/Entities/Mensagem.cs
Models/Entities/Reserva.cs
Models/Entities/Transacao.cs
Models/Entities/Utilizador.cs
Models/Entities/Veiculo.cs
Models/Entities/VeiculoImagem.cs
Models/Entities/Vendedor.cs
Models/Entities/Visita.cs
Models/Enums/EstadoCarro.cs
Models/Enums/EstadoReserva.cs
Models/Enums/EstadoTransacao.cs
Models/Enums/EstadoVeiculo.cs
Models/Enums/EstadoVisita.cs
Models/Enums/MetodoPagamento.cs
Models/Enums/StatusAprovacao.cs
Models/Enums/TipoConta.cs
Models/ViewModels/CarrinhoWidgetViewModel.cs
Models/ViewModels/CarroViewModel.cs
Models/ViewModels/CheckoutViewModel.cs
Models/ViewModels/DadosFiscaisViewModel.cs
Models/ViewModels/EmailConfirmationViewModel.cs
Models/ViewModels/ErrorViewModel.cs
Models/ViewModels/LoginViewModel.cs
Models/ViewModels/RegisterViewModel.cs
Models/ViewModels/Veiculos/CreateVeiculoViewModel.cs
Models/ViewModels/Veiculos/EditVeiculoViewModel.cs
Models/ViewModels/Veiculos/ListVeiculoViewModel.cs
Program.cs
RaioLaserList.text
README.md
repomix.config.json
Resources/EmailResources.resx
Services/Implementations/AuthService.cs
Services/Implementations/CarrinhoService.cs
Services/Implementations/CheckoutService.cs
Services/Implementations/EmailAuthService.cs
Services/Implementations/EmailFailureTracker.cs
Services/Implementations/EmailSender.cs
Services/Implementations/EmailTemplateService.cs
Services/Implementations/EncryptionService.cs
Services/Implementations/FileService.cs
Services/Implementations/ReservaService.cs
Services/Implementations/ViewRenderService.cs
Services/Interfaces/IAuthService.cs
Services/Interfaces/ICarrinhoService.cs
Services/Interfaces/ICheckoutService.cs
Services/Interfaces/IEmailAuthService.cs
Services/Interfaces/IEmailQueue.cs
Services/Interfaces/IEmailSender.cs
Services/Interfaces/IEncryptionService.cs
Services/Interfaces/IFileService.cs
Services/Interfaces/IReservaService.cs
Services/Interfaces/ISoftDelete.cs
Services/Interfaces/IVeiculoService.cs
wwwroot/css/pesquisa.css
wwwroot/css/site.css
wwwroot/css/style.css
wwwroot/js/script.js
wwwroot/js/site.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".repomixignore">
# --- .NET Build & Cache (CRÍTICO: Isso economiza 90% dos tokens) ---
bin/
obj/
.vs/
.vscode/
.idea/
*.user
*.suo
*.pdb
*.dll
*.exe
*.cache

# --- Dependências de Frontend (O LLM já conhece jQuery/Bootstrap) ---
# Ignoramos as libs baixadas, mas mantemos seu código customizado em css/ e js/
wwwroot/lib/
node_modules/
package-lock.json
yarn.lock
jspm_packages/

# --- Entity Framework Core ---
# Geralmente as classes de Modelo (Entities) e o DbContext são suficientes.
# Os arquivos de migração são gerados automaticamente e gastam muitos tokens.
Migrations/

# --- Arquivos de Sistema e Logs ---
*.log
*.ds_store
Thumbs.db

# --- Assets Binários (Imagens/Fontes não são legíveis por texto) ---
wwwroot/images/
wwwroot/favicon.ico
**/*.png
**/*.jpg
**/*.jpeg
**/*.gif
**/*.svg
**/*.ico
**/*.woff
**/*.woff2
**/*.ttf
**/*.eot

# --- Configurações Sensíveis (Opcional, mas recomendado) ---
# Cuidado para não enviar senhas de banco de dados para a IA
appsettings.Development.json
Properties/launchSettings.json
</file>

<file path="Areas/Admin/Controllers/AdminController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Admin.Controllers
{
    [Authorize(Roles = Roles.Admin)]
    [Area("Admin")]
    public class AdminController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly SignInManager<Utilizador> _signInManager;

        public AdminController(
            ApplicationDbContext context, 
            UserManager<Utilizador> userManager,
            SignInManager<Utilizador> signInManager)
        {
            _context = context;
            _userManager = userManager;
            _signInManager = signInManager;
        }

        // GET: Admin/Index (Lista de Pendentes)
        public async Task<IActionResult> Index(int page = 1)
        {
            int pageSize = 10;
            var query = _context.Vendedores
                .Include(v => v.User)
                .Where(v => v.Status == StatusAprovacao.Pendente)
                .OrderBy(v => v.User.DataRegisto);

            var model = await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = (int)Math.Ceiling(await query.CountAsync() / (double)pageSize);

            return View(model);
        }

        // POST: Admin/Aprovar/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Aprovar(int id)
        {
            var vendedor = await _context.Vendedores.FindAsync(id);
            if (vendedor == null) return NotFound();

            vendedor.Aprovar(_userManager.GetUserId(User));
            await _context.SaveChangesAsync();

            // Refresh do cookie para atualizar as claims (StatusVendedor)
            var user = await _userManager.FindByIdAsync(vendedor.UserId);
            if (user != null)
            {
                await _signInManager.RefreshSignInAsync(user);
            }

            TempData["MensagemStatus"] = "Vendedor aprovado com sucesso!";
            return RedirectToAction(nameof(Index));
        }

        // POST: Admin/Rejeitar/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Rejeitar(int id, string motivo)
        {
            var vendedor = await _context.Vendedores.FindAsync(id);
            if (vendedor == null) return NotFound();

            if (string.IsNullOrWhiteSpace(motivo))
            {
                motivo = "Documentação insuficiente ou dados incorretos.";
            }

            vendedor.Rejeitar(_userManager.GetUserId(User), motivo);
            await _context.SaveChangesAsync();

            // Refresh do cookie para atualizar as claims (StatusVendedor)
            var user = await _userManager.FindByIdAsync(vendedor.UserId);
            if (user != null)
            {
                await _signInManager.RefreshSignInAsync(user);
            }

            TempData["MensagemStatus"] = "Vendedor rejeitado.";
            return RedirectToAction(nameof(Index));
        }

        // GET: Admin/HistoricoTransacoes
        public async Task<IActionResult> HistoricoTransacoes(int page = 1)
        {
            int pageSize = 20;

            var query = _context.Transacoes
                .IgnoreQueryFilters()
                .Include(t => t.Veiculo)
                    .ThenInclude(c => c.Vendedor)
                        .ThenInclude(v => v.User)
                .Include(t => t.Comprador)
                    .ThenInclude(c => c.User)
                .OrderByDescending(t => t.DataTransacao);

            var model = await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
            
            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = (int)Math.Ceiling(await query.CountAsync() / (double)pageSize);

            return View(model);
        }
    }
}
</file>

<file path="Areas/Admin/Views/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Admin/Views/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Admin/Views/HistoricoTransacoes.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Transacao>
@{
    ViewData["Title"] = "Histórico Global";
}

<h2>Histórico de Transações (Admin)</h2>

<table class="table">
    <thead>
        <tr>
            <th>Data</th>
            <th>Carro</th>
            <th>Comprador</th>
            <th>Valor</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.DataTransacao.ToString("dd/MM/yyyy HH:mm")</td>
                <td>@item.Veiculo?.Titulo</td>
                <td>
                    @if (item.Comprador?.User != null)
                    {
                        @item.Comprador.User.Nome
                        @if (item.Comprador.User.IsDeleted)
                        {
                            <span class="badge bg-danger">Eliminado</span>
                        }
                    }
                    else
                    {
                        <span>Dados Pessoais Apagados</span>
                    }
                </td>
                <td>@item.ValorPago.ToString("C")</td>
                <td>@item.Estado</td>
            </tr>
        }
    </tbody>
</table>
</file>

<file path="Areas/Admin/Views/Index.cshtml">
@model IEnumerable<Vendedor>
@using AutoMarket.Models.Entities
@using AutoMarket.Models.Enums

@{
    ViewData["Title"] = "Aprovação de Vendedores";
}

<div class="container mt-4">
    <h2 class="mb-4">Vendedores Pendentes</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-check-circle"></i> Não existem vendedores pendentes de aprovação neste momento.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0 bg-white">
                <thead class="table-light">
                    <tr>
                        <th>Data Registo</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>NIF</th>
                        <th>Tipo</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.User.DataRegisto.ToString("dd/MM/yyyy")</td>
                            <td class="fw-bold">@item.User.Nome</td>
                            <td>
                                <a href="mailto:@item.User.Email" class="text-decoration-none">
                                    @item.User.Email
                                </a>
                            </td>
                            <td>
                                @(item.User.NIF ?? "N/A")
                            </td>
                            <td>
                                @if (item.TipoConta == TipoConta.Empresa)
                                {
                                    <span class="badge bg-primary">Empresa</span>
                                }
                                else
                                {
                                    <span class="badge bg-info text-dark">Particular</span>
                                }
                            </td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <form asp-action="Aprovar" asp-route-id="@item.Id" method="post">
                                        <button type="submit" class="btn btn-success btn-sm" title="Aprovar">
                                            <i class="bi bi-check-lg"></i> Aprovar
                                        </button>
                                    </form>

                                    <form asp-action="Rejeitar" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Tem a certeza que deseja rejeitar este vendedor?');">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Rejeitar">
                                            <i class="bi bi-x-lg"></i> Rejeitar
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
</file>

<file path="Areas/Public/Controllers/CarrinhoController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Services;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Area("Public")]
    public class CarrinhoController : Controller
    {
        private readonly ICarrinhoService _carrinhoService;
        private readonly ApplicationDbContext _context;

        public CarrinhoController(ICarrinhoService carrinhoService, ApplicationDbContext context)
        {
            _carrinhoService = carrinhoService;
            _context = context;
        }

        public IActionResult Index()
        {
            var itens = _carrinhoService.GetItens();
            ViewBag.Total = _carrinhoService.GetTotal();
            return View(itens);
        }

        public async Task<IActionResult> Adicionar(int id)
        {
            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null) return NotFound();

            if (veiculo.Estado != Models.Enums.EstadoVeiculo.Ativo)
            {
                TempData["Erro"] = "Este veículo não está disponível para compra.";
                return RedirectToAction("Index", "Veiculos"); // Ou volta para onde estava
            }

            _carrinhoService.AdicionarItem(veiculo);

            TempData["Sucesso"] = "Veículo adicionado ao carrinho!";
            return RedirectToAction("Index"); // Ou volta para a lista de veículos
        }

        public IActionResult Remover(int id)
        {
            _carrinhoService.RemoverItem(id);
            return RedirectToAction("Index");
        }
    }
}
</file>

<file path="Areas/Public/Controllers/CheckoutController.cs">
using AutoMarket.Models.ViewModels;
using Microsoft.AspNetCore.Identity;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    public class CheckoutController : Controller
    {
        private readonly ICheckoutService _checkoutService;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<CheckoutController> _logger;

        public CheckoutController(
            ICheckoutService checkoutService,
            UserManager<Utilizador> userManager,
            ILogger<CheckoutController> logger)
        {
            _checkoutService = checkoutService;
            _userManager = userManager;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> Index()
        {
            var userId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(userId)) return RedirectToAction("Login", "Conta");

            var checkout = await _checkoutService.GetCheckoutAsync(userId);
            if (checkout == null) return RedirectToAction("Index", "Carrinho");

            var model = new CheckoutViewModel
            {
                NomeCompleto = checkout.NomeCompleto,
                Morada = checkout.Morada ?? string.Empty,
                NifFaturacao = checkout.Nif,
                QueroFaturaComNif = !string.IsNullOrEmpty(checkout.Nif),
                ValorTotal = checkout.ValorTotal
            };

            return View(model);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ProcessarCompra(CheckoutViewModel model)
        {
            var userId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(userId)) return RedirectToAction("Login", "Conta");

            if (!ModelState.IsValid)
            {
                model.ValorTotal = model.ValorTotal == 0 ? model.ValorTotal : model.ValorTotal;
                return View("Index", model);
            }

            var result = await _checkoutService.ProcessAsync(
                userId,
                new CheckoutInputDto(
                    model.Morada,
                    model.CodigoPostal,
                    model.QueroFaturaComNif,
                    model.NifFaturacao,
                    model.MetodoPagamento));

            if (result.Success && result.FirstTransactionId.HasValue)
            {
                return RedirectToAction("Sucesso", new { id = result.FirstTransactionId.Value });
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error);
            }

            model.ValorTotal = model.ValorTotal == 0 ? model.ValorTotal : model.ValorTotal;
            return View("Index", model);
        }

        [HttpGet]
        public async Task<IActionResult> Sucesso(int id)
        {
            var userId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(userId)) return RedirectToAction("Login", "Conta");

            var transacao = await _checkoutService.GetTransacaoAsync(userId, id);
            if (transacao == null) return NotFound();

            return View(transacao);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/ContaController.cs">
using System.Security.Claims;
using AutoMarket.Models.Constants;
using AutoMarket.Models.ViewModels;

namespace AutoMarket.Areas.Public.Controllers
{
    [Area("Public")]
    public class ContaController : Controller
    {
        private readonly IAuthService _authService;
        private readonly ILogger<ContaController> _logger;

        public ContaController(
            IAuthService authService,
            ILogger<ContaController> logger)
        {
            _authService = authService;
            _logger = logger;
        }

        [HttpGet]
        public IActionResult Register()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Register(RegisterViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var confirmationBaseUrl = Url.Action(nameof(ConfirmarEmail), "Conta", null, Request.Scheme) ?? string.Empty;

            var result = await _authService.RegisterAsync(
                new RegisterDto(model.Email, model.Password, model.Nome, model.Morada, model.Contacto, model.NIF, model.TipoConta),
                confirmationBaseUrl);

            if (result.Success)
            {
                return RedirectToAction("Index", "Home");
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error);
            }

            return View(model);
        }

        [HttpGet]
        public IActionResult Login()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Login(LoginViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var result = await _authService.LoginAsync(new LoginDto(model.Email, model.Password, model.RememberMe));

            if (result.Success)
            {
                return RedirectToAction("Index", "Home");
            }

            if (result.FailureReason == nameof(StatusAprovacao.Pendente))
            {
                return RedirectToAction(nameof(AguardandoAprovacao));
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error);
            }

            return View(model);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Logout()
        {
            await _authService.LogoutAsync();
            return RedirectToAction("Index", "Home");
        }

        [HttpGet]
        public async Task<IActionResult> ConfirmarEmail(string userId, string token)
        {
            var result = await _authService.ConfirmEmailAsync(userId, token);
            if (result.Success) return View("EmailConfirmado");

            _logger.LogWarning("Falha na confirmação de email para {UserId}: {Errors}", userId, string.Join(", ", result.Errors));
            return View("Error", new ErrorViewModel
            {
                Message = "Não foi possível confirmar o email. O link pode ter expirado ou já foi utilizado."
            });
        }

        [HttpGet]
        [Authorize]
        public IActionResult PreencherDadosFiscais()
        {
            return View();
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> PreencherDadosFiscais(DadosFiscaisViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var result = await _authService.UpdateNifAsync(userId, model.NIF);

            if (!result.Success)
            {
                foreach (var error in result.Errors)
                {
                    ModelState.AddModelError(string.Empty, error);
                }
                return View(model);
            }

            if (TempData["ReturnUrl"] is string returnUrl)
            {
                TempData.Keep("ReturnUrl");
                return Redirect(returnUrl);
            }

            return RedirectToAction("Index", "Home");
        }

        [HttpGet]
        [Authorize(Roles = Roles.Vendedor)]
        public IActionResult AguardandoAprovacao()
        {
            return View();
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ApagarConta()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return NotFound();

            var result = await _authService.SoftDeleteAsync(userId);
            if (!result.Success)
            {
                foreach (var error in result.Errors)
                {
                    _logger.LogError("Erro ao apagar conta {UserId}: {Error}", userId, error);
                }
            }

            return RedirectToAction("Index", "Home");
        }
    }
}
</file>

<file path="Areas/Public/Controllers/HomeController.cs">
using System.Diagnostics;
using AutoMarket.Models.ViewModels;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Provides basic site pages such as the home, privacy, and error views.
    /// </summary>
    [Area("Public")]
    public class HomeController : Controller
    {
        private readonly ILogger<HomeController> _logger;

        /// <summary>
        /// Initializes a new instance of the <see cref="HomeController"/> class.
        /// </summary>
        /// <param name="logger">Logger used for diagnostic information.</param>
        public HomeController(ILogger<HomeController> logger)
        {
            _logger = logger;
        }

        /// <summary>
        /// Renders the home page.
        /// </summary>
        /// <returns>A view representing the home page.</returns>
        public IActionResult Index()
        {
            return View();
        }

        /// <summary>
        /// Renders the privacy policy page.
        /// </summary>
        /// <returns>A view containing the privacy policy.</returns>
        public IActionResult Privacy()
        {
            return View();
        }


        /// <summary>
        /// Renders the error page including the current request identifier.
        /// </summary>
        /// <returns>A view with error details for troubleshooting.</returns>
        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error()
        {
            return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }
    }
}
</file>

<file path="Areas/Public/Controllers/TransacoesController.cs">
using AutoMarket.Infrastructure.Data;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    public class TransacoesController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<TransacoesController> _logger;

        public TransacoesController(ApplicationDbContext context, UserManager<Utilizador> userManager, ILogger<TransacoesController> logger)
        {
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        /// <summary>
        /// GET: Transacoes/Checkout/5
        /// Exibe a página de checkout para compra de veículo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Checkout(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) { return Challenge(); }

            if (string.IsNullOrEmpty(user.NIF))
            {
                TempData["ReturnUrl"] = Url.Action(nameof(Checkout), new { id });
                return RedirectToAction("PreencherDadosFiscais", "Conta");
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Vendedor)
                .ThenInclude(v => v.User)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
                return NotFound();

            return View(veiculo);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/VeiculosController.cs">
using AutoMarket.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Controller público para listar e pesquisar veículos do catálogo.
    /// Implementa filtros avançados, paginação e otimização de queries.
    /// </summary>
    [Area("Public")]
    public class VeiculosController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<VeiculosController> _logger;

        public VeiculosController(ApplicationDbContext context, ILogger<VeiculosController> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// GET: Veiculos/Index
        /// Lista todos os veículos ativos com filtros, ordenação e paginação.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index(
            string? marca = null,
            string? modelo = null,
            string? combustivel = null,
            int? ano = null,
            string? categoria = null,
            decimal? precoMin = null,
            decimal? precoMax = null,
            int? kmMin = null,
            int? kmMax = null,
            string? ordenacao = "recente",
            int page = 1)
        {
            try
            {
                // Encapsular parâmetros no DTO
                var filters = new VeiculoSearchFiltersDto
                {
                    Marca = marca,
                    Modelo = modelo,
                    Combustivel = combustivel,
                    Ano = ano,
                    Categoria = categoria,
                    PrecoMin = precoMin,
                    PrecoMax = precoMax,
                    KmMin = kmMin,
                    KmMax = kmMax,
                    Ordenacao = ordenacao,
                    Page = Math.Max(page, 1) // Garantir que page >= 1
                };

                // Construir query filtrada e ordenada
                var query = BuildVeiculosQuery(filters);

                // Contar total ANTES de paginar
                var totalVeiculos = await query.CountAsync();
                var totalPages = (int)Math.Ceiling((double)totalVeiculos / filters.PageSize);

                // Aplicar paginação
                var veiculos = await query
                    .Skip((filters.Page - 1) * filters.PageSize)
                    .Take(filters.PageSize)
                    .ToListAsync();

                // Carregar opções dos filtros em UMA ÚNICA QUERY
                var filterOptions = await LoadFilterOptionsAsync();

                // Passar dados para a view
                ViewData["Marcas"] = filterOptions.Marcas;
                ViewData["Modelos"] = filterOptions.Modelos;
                ViewData["Combustiveis"] = filterOptions.Combustiveis;
                ViewData["Anos"] = filterOptions.Anos;
                ViewData["Categorias"] = filterOptions.Categorias;

                // Manter filtros selecionados
                ViewData["MarcaSelecionada"] = marca;
                ViewData["ModeloSelecionado"] = modelo;
                ViewData["CombustivelSelecionado"] = combustivel;
                ViewData["AnoSelecionado"] = ano;
                ViewData["CategoriaSelecionada"] = categoria;
                ViewData["PrecoMin"] = precoMin;
                ViewData["PrecoMax"] = precoMax;
                ViewData["KmMin"] = kmMin;
                ViewData["KmMax"] = kmMax;
                ViewData["Ordenacao"] = ordenacao;

                // Informações de paginação
                ViewData["CurrentPage"] = filters.Page;
                ViewData["TotalPages"] = totalPages;
                ViewData["TotalItems"] = totalVeiculos;
                ViewData["PageSize"] = filters.PageSize;

                _logger.LogInformation(
                    "Pesquisa de ve�culos: {TotalVeiculos} encontrados, P�gina {Page} de {TotalPages}",
                    totalVeiculos, filters.Page, totalPages);

                return View(veiculos);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao pesquisar veículos");
                return View(new List<Veiculo>());
            }
        }

        /// <summary>
        /// POST: Veiculos/BuscarAjax
        /// Retorna PartialView com resultados de busca para AJAX.
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> BuscarAjax(
            string? marca = null,
            string? modelo = null,
            string? combustivel = null,
            int? ano = null,
            string? categoria = null,
            decimal? precoMin = null,
            decimal? precoMax = null,
            int? kmMin = null,
            int? kmMax = null,
            string? ordenacao = "recente",
            int page = 1)
        {
            try
            {
                // Encapsular parâmetros no DTO
                var filters = new VeiculoSearchFiltersDto
                {
                    Marca = marca,
                    Modelo = modelo,
                    Combustivel = combustivel,
                    Ano = ano,
                    Categoria = categoria,
                    PrecoMin = precoMin,
                    PrecoMax = precoMax,
                    KmMin = kmMin,
                    KmMax = kmMax,
                    Ordenacao = ordenacao,
                    Page = Math.Max(page, 1)
                };

                // Construir query filtrada e ordenada
                var query = BuildVeiculosQuery(filters);

                // Contar total ANTES de paginar
                var totalVeiculos = await query.CountAsync();
                var totalPages = (int)Math.Ceiling((double)totalVeiculos / filters.PageSize);

                // Aplicar paginação
                var veiculos = await query
                    .Skip((filters.Page - 1) * filters.PageSize)
                    .Take(filters.PageSize)
                    .ToListAsync();

                // Passar dados para a PartialView
                ViewData["CurrentPage"] = filters.Page;
                ViewData["TotalPages"] = totalPages;
                ViewData["TotalItems"] = totalVeiculos;
                ViewData["PageSize"] = filters.PageSize;

                _logger.LogInformation(
                    "Busca AJAX: {TotalVeiculos} veículos, Página {Page} de {TotalPages}",
                    totalVeiculos, filters.Page, totalPages);

                // Retornar PartialView (sem layout)
                return PartialView("_CarListPartial", veiculos);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao buscar ve�culos via AJAX");
                return PartialView("_CarListPartial", new List<Veiculo>());
            }
        }

        /// <summary>
        /// GET: Veiculos/Detalhe/5
        /// Exibe detalhes completos de um veículo.
        /// </summary>
        [HttpGet]
        [Route("Veiculos/Detalhe/{id}")]
        public async Task<IActionResult> Detalhe(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .Include(v => v.Vendedor)
                .ThenInclude(v => v.User)
                .FirstOrDefaultAsync(v => v.Id == id && v.Estado == EstadoVeiculo.Ativo);

            if (veiculo == null)
                return NotFound();

            return View(veiculo);
        }

        // ============================================================
        // MÉTODOS PRIVADOS (DRY - Reutilizáveis)
        // ============================================================

        /// <summary>
        /// Constrói a query de veículos com filtros e ordenação aplicados.
        /// Reutilizável entre diferentes métodos.
        /// </summary>
        private IQueryable<Veiculo> BuildVeiculosQuery(VeiculoSearchFiltersDto filters)
        {
            var query = _context.Veiculos
                .Where(v => v.Estado == EstadoVeiculo.Ativo)
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .AsQueryable();

            // Aplicar filtros condicionalmente
            if (!string.IsNullOrEmpty(filters.Marca))
                query = query.Where(v => v.Marca == filters.Marca);

            if (!string.IsNullOrEmpty(filters.Modelo))
                query = query.Where(v => v.Modelo == filters.Modelo);

            if (!string.IsNullOrEmpty(filters.Combustivel))
                query = query.Where(v => v.Combustivel == filters.Combustivel);

            if (filters.Ano.HasValue)
                query = query.Where(v => v.Ano == filters.Ano);

            if (!string.IsNullOrEmpty(filters.Categoria))
                query = query.Where(v => v.Categoria.Nome == filters.Categoria);

            if (filters.PrecoMin.HasValue)
                query = query.Where(v => v.Preco >= filters.PrecoMin);

            if (filters.PrecoMax.HasValue)
                query = query.Where(v => v.Preco <= filters.PrecoMax);

            if (filters.KmMin.HasValue)
                query = query.Where(v => v.Km >= filters.KmMin);

            if (filters.KmMax.HasValue)
                query = query.Where(v => v.Km <= filters.KmMax);

            // Aplicar ordenação
            query = filters.Ordenacao switch
            {
                "preco_asc" => query.OrderBy(v => v.Preco),
                "preco_desc" => query.OrderByDescending(v => v.Preco),
                "km_asc" => query.OrderBy(v => v.Km),
                "km_desc" => query.OrderByDescending(v => v.Km),
                "ano_asc" => query.OrderBy(v => v.Ano),
                "ano_desc" => query.OrderByDescending(v => v.Ano),
                _ => query.OrderByDescending(v => v.DataCriacao)
            };

            return query;
        }

        /// <summary>
        /// Carrega todas as opções de filtro em UMA ÚNICA QUERY otimizada.
        /// Evita N+1 queries problem.
        /// </summary>
        private async Task<VeiculoFilterOptionsDto> LoadFilterOptionsAsync()
        {
            // Carregar todos os dados numa única query
            var veiculosAtivos = await _context.Veiculos
                .Where(v => v.Estado == EstadoVeiculo.Ativo)
                .Include(v => v.Categoria)
                .ToListAsync();

            var options = new VeiculoFilterOptionsDto
            {
                Marcas = veiculosAtivos
                    .Select(v => v.Marca)
                    .Distinct()
                    .OrderBy(m => m)
                    .ToList(),

                Modelos = veiculosAtivos
                    .Select(v => v.Modelo)
                    .Distinct()
                    .OrderBy(m => m)
                    .ToList(),

                Combustiveis = veiculosAtivos
                    .Where(v => !string.IsNullOrEmpty(v.Combustivel))
                    .Select(v => v.Combustivel)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList(),

                Anos = veiculosAtivos
                    .Select(v => v.Ano)
                    .Distinct()
                    .OrderByDescending(a => a)
                    .ToList(),

                Categorias = veiculosAtivos
                    .Where(v => v.Categoria != null)
                    .Select(v => v.Categoria.Nome)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList()
            };

            return options;
        }
    }

    /// <summary>
    /// DTO para retornar opções de filtro.
    /// </summary>
    internal class VeiculoFilterOptionsDto
    {
        public List<string> Marcas { get; set; } = new();
        public List<string> Modelos { get; set; } = new();
        public List<string> Combustiveis { get; set; } = new();
        public List<int> Anos { get; set; } = new();
        public List<string> Categorias { get; set; } = new();
    }
}
</file>

<file path="Areas/Public/Views/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Public/Views/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Public/Views/Carrinho/CarrinhoResumoViewComponent.cs">
using AutoMarket.Models.ViewModels;
using AutoMarket.Services;

namespace AutoMarket.Areas.Public.Views.Cart
{
    // O nome da classe deve terminar em ViewComponent
    public class CarrinhoResumoViewComponent : ViewComponent
    {
        private readonly ICarrinhoService _carrinhoService;

        public CarrinhoResumoViewComponent(ICarrinhoService carrinhoService)
        {
            _carrinhoService = carrinhoService;
        }

        public IViewComponentResult Invoke()
        {
            // Lógica: Vai buscar os dados à sessão via serviço
            var model = new CarrinhoWidgetViewModel
            {
                QuantidadeItens = _carrinhoService.GetContagem(),
                ValorTotal = _carrinhoService.GetTotal()
            };

            // Retorna a View associada a este componente
            return View(model);
        }
    }
}
</file>

<file path="Areas/Public/Views/Carrinho/CartIndex.cshtml">
@using AutoMarket.Models.Entities
@model List<CarrinhoItem>

@{
    ViewData["Title"] = "O meu Carrinho";
}

<div class="container mt-5">
    <h2><i class="bi bi-cart3"></i> O meu Carrinho</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-warning mt-4">
            O seu carrinho está vazio. <a asp-controller="Veiculos" asp-action="Index">Ver carros disponíveis</a>.
        </div>
    }
    else
    {
        <div class="row mt-4">
            <div class="col-md-8">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Viatura</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="~/images/carros/@(item.ImagemCapa ?? "sem-imagem.jpg")"
                                             alt="@item.Titulo"
                                             class="rounded me-3"
                                             style="width: 80px; height: 60px; object-fit: cover;">
                                        <div>
                                            <h5 class="mb-0">@item.Marca @item.Modelo</h5>
                                            <small class="text-muted">@item.Titulo</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-bold text-primary">@item.Preco.ToString("C0")</td>
                                <td>
                                    <a asp-action="Remover" asp-route-id="@item.VeiculoId" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i> Remover
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Resumo</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Total:</span>
                            <span class="fw-bold fs-4">@((ViewBag.Total as decimal?)?.ToString("C0") ?? "0 €")</span>
                        </div>
                        <div class="d-grid">
                            <a asp-controller="Checkout" asp-action="Index" class="btn btn-success btn-lg">
                                <i class="bi bi-credit-card"></i> Finalizar Compra
                            </a>
                        </div>
                        <div class="mt-3 text-center">
                            <a asp-controller="Veiculos" asp-action="Index" class="text-decoration-none">Continuar a ver carros</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
</file>

<file path="Areas/Public/Views/Conta/AguardandoAprovacao.cshtml">
@{
    ViewData["Title"] = "Conta em Análise";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="card shadow-lg text-center p-4" style="max-width: 500px; width: 100%;">
        <div class="card-body">
            <div class="mb-4">
                <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
            </div>

            <h2 class="card-title fw-bold mb-3">A sua conta está em análise</h2>

            <p class="card-text text-muted mb-4">
                Obrigado pelo seu registo! A nossa equipa está a verificar os seus dados e o seu NIF.
                <br /><br />
                Receberá um email assim que a sua conta de vendedor for aprovada.
            </p>

            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i> Enquanto aguarda, pode navegar no site como comprador, mas não poderá anunciar viaturas.
            </div>

            <div class="d-grid gap-2">
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary">
                    Continuar a navegar (Modo Leitura)
                </a>

                <hr />

                <form asp-controller="Conta" asp-action="Logout" method="post" class="d-grid">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-box-arrow-right"></i> Terminar Sessão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Conta/Favoritos.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = "Favoritos";
}
<main class="container-main">
    <h1 class="favorites-title">Os Meus Favoritos</h1>
    <div class="favorites-cards">
        <!-- Cards exemplo de favoritos -->
        <div class="vehicle-card">
            <img src="/images/carro_exemplo1.jpg" alt="BMW Série 1" />
            <h3>BMW Série 1</h3>
            <div class="price">€19.900</div>
            <div class="meta">2019 • 45.000km • Lisboa</div>
            <button class="btn-cta remove-fav-btn">Remover dos Favoritos</button>
        </div>
        <div class="vehicle-card">
            <img src="/images/carro_exemplo2.jpg" alt="Renault Clio" />
            <h3>Renault Clio</h3>
            <div class="price">€13.400</div>
            <div class="meta">2018 • 33.000km • Porto</div>
            <button class="btn-cta remove-fav-btn">Remover dos Favoritos</button>
        </div>
    </div>
</main>
<footer>
    &copy; 2025 AutoMarket<br /> Plataforma de compra e venda de veículos usados.
</footer>
@section Styles {
    <link rel="stylesheet" href="/css/style.css" />
}
@section Scripts {
    <script src="/js/script.js"></script>
}
</file>

<file path="Areas/Public/Views/Conta/Lockout.cshtml">
@{
    ViewData["Title"] = "Conta Bloqueada";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="card shadow text-center p-4 border-danger" style="max-width: 500px; width: 100%;">
        <div class="card-body">
            <div class="mb-4 text-danger">
                <i class="bi bi-shield-lock-fill" style="font-size: 4rem;"></i>
            </div>

            <h2 class="card-title fw-bold text-danger mb-3">Acesso Temporariamente Bloqueado</h2>

            <p class="card-text text-muted mb-4">
                Detetámos demasiadas tentativas de login falhadas. Para sua segurança, esta conta foi bloqueada temporariamente.
            </p>

            <div class="alert alert-warning" role="alert">
                <i class="bi bi-clock-history"></i> Por favor, aguarde <strong>15 minutos</strong> antes de tentar novamente.
            </div>

            <div class="d-grid gap-2 mt-4">
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                    Voltar à Página Inicial
                </a>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Conta/Login.cshtml">
@model AutoMarket.Models.ViewModels.LoginViewModel
@{
    ViewData["Title"] = "Login";
}

<main class="container login-container">
    <h2>Login</h2>
    <form asp-controller="Conta" asp-action="Login" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group">
            <label asp-for="Email"></label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Password"></label>
            <input asp-for="Password" type="password" autocomplete="current-password" class="form-control" />
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>
        <div class="form-group form-check">
            <input asp-for="RememberMe" class="form-check-input" />
            <label asp-for="RememberMe" class="form-check-label"></label>
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
        <div class="mt-3 text-center">
            <a asp-controller="Conta" asp-action="Register">Não tem conta? Registe-se</a>
        </div>
    </form>
</main>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
</file>

<file path="Areas/Public/Views/Conta/PreencherDadosFiscais.cshtml">
@model AutoMarket.Models.ViewModels.DadosFiscaisViewModel

@{
	ViewData["Title"] = "Dados em Falta";
}

<div class="container d-flex justify-content-center mt-5">
	<div class="card shadow-sm" style="max-width: 500px; width: 100%;">
		<div class="card-body p-4">
			<h3 class="card-title text-center mb-4">
				<i class="bi bi-card-heading text-primary"></i> Dados Fiscais
			</h3>

			<div class="alert alert-warning">
				<i class="bi bi-info-circle-fill"></i>
				Para prosseguir com a transação, necessitamos do seu NIF para a emissão da fatura.
			</div>

			<form asp-action="PreencherDadosFiscais" method="post">
				<div class="mb-3">
					<label asp-for="NIF" class="form-label fw-bold"></label>
					<input asp-for="NIF" class="form-control form-control-lg" placeholder="Inserir NIF..." />
					<span asp-validation-for="NIF" class="text-danger"></span>
				</div>

				<div class="d-grid gap-2">
					<button type="submit" class="btn btn-primary btn-lg">
						Guardar e Continuar <i class="bi bi-arrow-right"></i>
					</button>
					<a asp-controller="Home" asp-action="Index" class="btn btn-link text-muted">Cancelar</a>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
}
</file>

<file path="Areas/Public/Views/Conta/Register.cshtml">
@model AutoMarket.Models.ViewModels.RegisterViewModel
@{
    ViewData["Title"] = "Registo";
}
<main class="container" style="max-width:520px; margin:2rem auto;">
    <h2>Registo</h2>
    <form asp-controller="Conta" asp-action="Register" method="post">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="form-group">
            <label asp-for="Email"></label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Password"></label>
            <input asp-for="Password" class="form-control" />
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ConfirmPassword"></label>
            <input asp-for="ConfirmPassword" class="form-control" />
            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Nome"></label>
            <input asp-for="Nome" class="form-control" />
            <span asp-validation-for="Nome" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Morada"></label>
            <input asp-for="Morada" class="form-control" />
            <span asp-validation-for="Morada" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Contacto"></label>
            <input asp-for="Contacto" class="form-control" />
            <span asp-validation-for="Contacto" class="text-danger"></span>
        </div>

        <div class="form-group mb-4">
            <label class="form-label fw-bold d-block">Tipo de Conta:</label>

            <div class="btn-group w-100" role="group" aria-label="Seleção de tipo de conta">
                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoComprador" value="0" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoComprador">
                    <i class="bi bi-search"></i> Comprador
                </label>

                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoVendedor" value="1" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoVendedor">
                    <i class="bi bi-car-front"></i> Vendedor Particular
                </label>

                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoEmpresa" value="2" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoEmpresa">
                    <i class="bi bi-building"></i> Empresa
                </label>
            </div>
            <small class="text-muted">Escolha "Comprador" apenas para ver carros. Escolha as outras opções para vender.</small>
        </div>

        <div id="sellerFields" style="display:none;">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-title text-primary">Dados de Vendedor</h6>

                    <div class="form-group mb-3">
                        <label asp-for="NIF" class="control-label fw-bold"></label>
                        <input asp-for="NIF" class="form-control" placeholder="Introduza o NIF" />
                        <span asp-validation-for="NIF" class="text-danger"></span>
                        <div id="nifHelp" class="form-text"></div>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Registar</button>
    </form>
</main>
@section Scripts {
	@await Html.PartialAsync("_ValidationScriptsPartial");

	<script>
		$(document).ready(function () {
			// Mapeamento dos valores do Enum (Para ficar legível)
			// 0 = Comprador, 1 = Vendedor, 2 = Empresa

			const $radios = $('input[name="TipoConta"]');
			const $sellerFields = $('#sellerFields');
			const $nifInput = $('#NIF');
			const $nifLabel = $('label[for="NIF"]');
			const $nifHelp = $('#nifHelp');

			function atualizarFormulario() {
				// Obtém o valor do radio selecionado (0, 1 ou 2)
				const tipoSelecionado = $('input[name="TipoConta"]:checked').val();

				if (tipoSelecionado === '0') {
					// === COMPRADOR ===
					$sellerFields.slideUp();
					$nifInput.val(''); // Limpa o NIF se mudar de ideias
				}
				else {
					// === VENDEDOR OU EMPRESA ===
					$sellerFields.slideDown();

					// Lógica Específica: Empresa vs Particular
					if (tipoSelecionado === '2') {
						// É Empresa: NIF Obrigatório e Rigoroso
						$nifLabel.html('NIF da Empresa <span class="text-danger">*</span>');
						$nifInput.attr('placeholder', 'NIF Obrigatório (9 dígitos)');
						$nifHelp.text('Empresas são obrigadas a apresentar NIF válido para faturação.');
					} else {
						// É Particular: NIF Opcional (ou conforme a tua regra de negócio)
						$nifLabel.html('NIF (Particular)');
						$nifInput.attr('placeholder', 'Opcional');
						$nifHelp.text('Introduza o NIF se desejar fatura detalhada das taxas de serviço.');
					}
				}
			}

			// Event Listeners
			$radios.change(atualizarFormulario);

			// Executar ao carregar a página (para manter o estado se houver erro de validação)
			atualizarFormulario();
		});
	</script>
}
</file>

<file path="Areas/Public/Views/Emails/EmailConfirmation.cshtml">
@model AutoMarket.Models.ViewModels.EmailConfirmationViewModel
@using System.Net
@inject Microsoft.Extensions.Localization.IStringLocalizer Localizer
@{
    Layout = null;
    
    // Use localization with fallback values
    var welcomeHeader = Localizer["Email_Welcome_Header"].Value ?? "Bem-vindo ao AutoMarket!";
    var greeting = string.Format(Localizer["Email_Greeting"].Value ?? "Olá {0},", Model.UserName);
    var intro = Localizer["Email_Confirmation_Intro"].Value ?? "Obrigado por se registar no AutoMarket. Para completar o seu registo, por favor confirme o seu endereço de email clicando no botão abaixo:";
    var confirmButton = Localizer["Email_Confirm_Button"].Value ?? "Confirmar Email";
    var linkAlternative = Localizer["Email_Link_Alternative"].Value ?? "Ou copie e cole o seguinte link no seu navegador:";
    var linkExpiry = Localizer["Email_Link_Expiry"].Value ?? "Este link expirará em 24 horas.";
    var ignoreMessage = Localizer["Email_Ignore_Message"].Value ?? "Se não criou uma conta no AutoMarket, pode ignorar este email.";
    var copyright = Localizer["Email_Footer_Copyright"].Value ?? "© 2025 AutoMarket. Todos os direitos reservados.";
}
<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirme o seu email - AutoMarket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .content {
            padding: 20px;
            background-color: #f9f9f9;
        }
        .button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }
        .link-text {
            word-break: break-all;
            color: #007bff;
            font-size: 12px;
        }
        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>@(welcomeHeader)</h1>
        </div>
        <div class="content">
            <p>@(greeting)</p>
            <p>@(intro)</p>
            <p class="text-center">
                <a href="@Model.ConfirmationLink" class="button">@WebUtility.HtmlEncode(confirmButton)</a>
            </p>
            <p>@(linkAlternative)</p>
            <p class="link-text">@Model.ConfirmationLink</p>
            <p>@(linkExpiry)</p>
            <p>@(ignoreMessage)</p>
        </div>
        <div class="footer">
            <p>@copyright</p>
        </div>
    </div>
</body>
</html>
</file>

<file path="Areas/Public/Views/Home/Ajuda.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = "Centro de Ajuda";
}
<header>
    <div class="nav">
        <nav>
            <ul>
                <li><a href="/Veiculos">Veículos</a></li>
                <li><a href="/Anuncios/Criar" class="btn-cta">Vender Carro</a></li>
                <li><a href="/Home/Sobre">Sobre</a></li>
            </ul>
        </nav>
        <div class="header-actions">
            @if (SignInManager.IsSignedIn(User))
            {
                <a href="/Conta/Favoritos" title="Favoritos"><span style="font-size:1.2em">&#10084;&#65039;</span></a>
            }
            <a href="/Anuncios/Criar" class="btn-cta">Vender Carro</a>
        </div>
    </div>
</header>
<main style="max-width:800px;margin:3rem auto;text-align:left;">
    <h1 style="text-align:center;">Centro de Ajuda</h1>
    <div style="margin-top:2rem;">
        <h3>Como posso pesquisar veículos?</h3>
        <p>Use os filtros avançados disponíveis na página inicial ou em "Veículos" para encontrar exatamente o que procura.</p>
        <h3>Como crio um anúncio?</h3>
        <p>Aceda a "Vender Carro" no topo do site e preencha os 3 passos do formulário.</p>
        <h3>Como contacto o vendedor?</h3>
        <p>Na página do anúncio, encontrará informações detalhadas do vendedor e opções para marcar visita ou reservar.</p>
        <h3>Como funcionam os favoritos?</h3>
        <p>Ao clicar no coração <span style="color:#ff7000">&#10084;&#65039;</span>, adiciona veículos à sua lista de favoritos, acessível no seu perfil.</p>
    </div>
</main>
<footer>
    &copy; 2025 AutoMarket<br /> Plataforma de compra e venda de veículos usados.
</footer>
@section Styles {
    <link rel="stylesheet" href="/css/style.css" />
}
@section Scripts {
    <script src="/js/script.js"></script>
}
</file>

<file path="Areas/Public/Views/Home/Index.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = "Início";
}

<main class="py-5">
    <!-- Hero Section -->
    <section class="text-center mb-5 pb-4">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">Encontre o Seu Próximo Veículo</h1>
            
            <!-- Search Form -->
            <form class="row g-3 justify-content-center mb-4" method="get" asp-area="" asp-controller="Veiculos" asp-action="Index">
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Marca" name="marca" />
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Modelo" name="modelo" />
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" placeholder="Preço até" name="precoMax" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Pesquisar
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Featured Vehicles -->
    <section class="container mb-5">
        <h2 class="h3 mb-4">Veículos em Destaque</h2>
        <div class="row g-4">
            <!-- Card 1 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo1.jpg" class="card-img-top" alt="BMW Série 1" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">BMW Série 1</h5>
                        <p class="card-text text-danger fw-bold fs-5">€19.900</p>
                        <small class="text-muted">2019 • 45.000km • Lisboa</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo2.jpg" class="card-img-top" alt="Renault Clio" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Renault Clio</h5>
                        <p class="card-text text-danger fw-bold fs-5">€13.400</p>
                        <small class="text-muted">2018 • 33.000km • Porto</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo3.jpg" class="card-img-top" alt="Volkswagen Golf" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Volkswagen Golf</h5>
                        <p class="card-text text-danger fw-bold fs-5">€22.500</p>
                        <small class="text-muted">2020 • 29.900km • Braga</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo4.jpg" class="card-img-top" alt="Fiat 500" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Fiat 500</h5>
                        <p class="card-text text-danger fw-bold fs-5">€10.950</p>
                        <small class="text-muted">2016 • 70.000km • Faro</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="bg-light py-5">
        <div class="container">
            <div class="row g-4 text-center">
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-check-circle fs-3"></i>
                        </h5>
                        <h6>Garantia de Qualidade</h6>
                        <p class="text-muted small">Todos os veículos são verificados e avaliados.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-headset fs-3"></i>
                        </h5>
                        <h6>Suporte Dedicado</h6>
                        <p class="text-muted small">Acompanhamento antes, durante e após a compra.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-shield-lock fs-3"></i>
                        </h5>
                        <h6>Compra Segura</h6>
                        <p class="text-muted small">Pagamentos e reservas com total transparência.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .feature-box {
        padding: 1.5rem;
    }
</style>
</file>

<file path="Areas/Public/Views/Home/Privacy.cshtml">
@{
    ViewData["Title"] = "Privacy Policy";
}
<h1>@ViewData["Title"]</h1>

<p>Use this page to detail your site's privacy policy.</p>
</file>

<file path="Areas/Public/Views/Home/Sobre.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = "Sobre o AutoMarket";
}
<header>
    <div class="nav">
        <nav>
            <ul>
                <li><a href="/Veiculos">Veículos</a></li>
                <li><a href="/Anuncios/Criar" class="btn-cta">Vender Carro</a></li>
                <li><a href="/Home/Sobre">Sobre</a></li>
            </ul>
        </nav>
        <div class="header-actions">
            @if (SignInManager.IsSignedIn(User))
            {
                <a href="/Conta/Favoritos" title="Favoritos"><span style="font-size:1.2em">&#10084;&#65039;</span></a>
            }
            <a href="/Anuncios/Criar" class="btn-cta">Vender Carro</a>
        </div>
    </div>
</header>
<main style="max-width:800px;margin:3rem auto;text-align:center;">
    <h1>Sobre o AutoMarket</h1>
    <p style="margin-top:2rem;font-size:1.15rem;">O AutoMarket é um marketplace inovador dedicado exclusivamente à compra e venda de veículos usados em Portugal.<br/><br/>Com uma interface moderna e intuitiva, funcionalidades avançadas de pesquisa e total transparência, é o melhor aliado para vendedores e compradores.<br/><br/>Diferencia-se pelo seu compromisso com qualidade, suporte próximo ao utilizador, segurança nas transações e seleção criteriosa dos veículos listados.</p>
    <div style="margin-top:2.5rem;">
        <img src="/images/logo_grande.png" alt="AutoMarket logo" style="width:190px;opacity:0.75;" />
    </div>
</main>
<footer>
    &copy; 2025 AutoMarket<br /> Plataforma de compra e venda de veículos usados.
</footer>
@section Styles {
    <link rel="stylesheet" href="/css/style.css" />
}
@section Scripts {
    <script src="/js/script.js"></script>
}
</file>

<file path="Areas/Public/Views/Shared/_Footer.cshtml">
<footer class="bg-light border-top mt-5 py-4">
    <div class="container">
        <div class="row gy-3 align-items-center">
            <div class="col-md-4 text-md-start text-center">
                <a class="navbar-brand fw-bold" asp-area="Public" asp-controller="Home" asp-action="Index">
                    🚗 AutoMarket
                </a>
                <div class="text-muted small">© @DateTime.UtcNow.Year AutoMarket. Todos os direitos reservados.</div>
            </div>

            <div class="col-md-4">
                <ul class="nav justify-content-center">
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Index">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Veiculos" asp-action="Index">Veículos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Sobre">Sobre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Ajuda">Ajuda</a>
                    </li>
                </ul>
            </div>

            <div class="col-md-4 text-md-end text-center">
                <div class="text-muted small">Precisa de ajuda?</div>
                <a class="text-decoration-none" href="mailto:support@automarket.com">support@automarket.com</a>
            </div>
        </div>
    </div>
</footer>
</file>

<file path="Areas/Public/Views/Shared/_Header.cshtml">
@using AutoMarket.Models;
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager

<header class="bg-primary py-3 sticky-top shadow-sm">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand fw-bold fs-5" asp-area="Public" asp-controller="Home" asp-action="Index">
                🚗 AutoMarket
            </a>

            <!-- Toggler para Mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Menu Principal -->
            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Links Centrais -->
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" asp-area="Public" asp-controller="Home" asp-action="Sobre">Sobre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="Public" asp-controller="Home" asp-action="Ajuda">Ajuda</a>
                    </li>
                </ul>

                <!-- Links Direita (Autenticação) -->
                <partial name="~/Areas/Public/Views/Shared/_LoginPartial.cshtml" />
            </div>
        </div>
    </nav>
</header>

<style>
    header .navbar-dark .nav-link:hover {
        color: var(--cor-cta) !important;
        transition: color 0.2s;
    }

    header .btn-warning:hover {
        background-color: #e6a800 !important;
    }
</style>
</file>

<file path="Areas/Public/Views/Shared/_Layout.cshtml">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - AutoMarket</title>
    <link rel="stylesheet" href="~/css/style.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/AutoMarket.styles.css" asp-append-version="true" />
    @RenderSection("Styles", required: false)
</head>
<body>
    <partial name="~/Areas/Public/Views/Shared/_Header.cshtml" />
    @if (TempData["MensagemStatus"] != null)
    {
        <div class="container mt-3">
            <div class="alert alert-info text-center" role="alert">
                @TempData["MensagemStatus"]
            </div>
        </div>
    }
    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

	<partial name="~/Areas/Public/Views/Shared/_Footer.cshtml" />

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
</file>

<file path="Areas/Public/Views/Shared/_Layout.cshtml.css">
/* Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
for details on configuring this project to bundle and minify static web assets. */

a.navbar-brand {
  white-space: normal;
  text-align: center;
  word-break: break-all;
}

a {
  color: #0077cc;
}

.btn-primary {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.nav-pills .nav-link.active, .nav-pills .show > .nav-link {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.border-top {
  border-top: 1px solid #e5e5e5;
}
.border-bottom {
  border-bottom: 1px solid #e5e5e5;
}

.box-shadow {
  box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .05);
}

button.accept-policy {
  font-size: 1rem;
  line-height: inherit;
}

.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  white-space: nowrap;
  line-height: 60px;
}
</file>

<file path="Areas/Public/Views/Shared/_LoginPartial.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity

@inject SignInManager<Utilizador> SignInManager
@inject UserManager<Utilizador> UserManager

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Index" title="Gerir Conta">
                Olá, @UserManager.GetUserName(User)!
            </a>
        </li>
        <li class="nav-item">
            <form class="form-inline" asp-area="Public" asp-controller="Conta" asp-action="Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "Public" })">
                <button type="submit" class="nav-link btn btn-link text-dark border-0" style="cursor: pointer;">Sair</button>
            </form>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Register">Registar</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Login">Entrar</a>
        </li>
    }
</ul>
</file>

<file path="Areas/Public/Views/Shared/_ValidationScriptsPartial.cshtml">
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
</file>

<file path="Areas/Public/Views/Shared/Components/CarrinhoResumo/Default.cshtml">
@model AutoMarket.Models.ViewModels.CarrinhoWidgetViewModel

<li class="nav-item">
    <a class="nav-link position-relative" asp-controller="Carrinho" asp-action="Index">
        <i class="bi bi-cart3 fs-5"></i>

        @if (Model.QuantidadeItens > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  style="font-size: 0.7rem;">
                @Model.QuantidadeItens
                <span class="visually-hidden">itens no carrinho</span>
            </span>

            <span class="d-none d-lg-inline ms-1 fw-bold small text-success">
                @Model.ValorTotal.ToString("N0")€
            </span>
        }
    </a>
</li>
</file>

<file path="Areas/Public/Views/Shared/Error.cshtml">
@using AutoMarket.Models.ViewModels
@model ErrorViewModel
@{
    ViewData["Title"] = "Error";
}

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (!string.IsNullOrEmpty(Model.Message))
{
    <div class="alert alert-danger mt-4">
        <i class="bi bi-exclamation-triangle-fill"></i> @Model.Message
    </div>
}
@if (Model.ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@Model.RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>
</file>

<file path="Areas/Public/Views/Transacao/Checkout.cshtml">
@model AutoMarket.Models.ViewModels.CheckoutViewModel

<form asp-action="ProcessarCompra" method="post">
    @Html.AntiForgeryToken()
    
    <h4>Dados de Envio</h4>
    <div class="form-group mb-3">
        <label asp-for="NomeCompleto"></label>
        <input asp-for="NomeCompleto" class="form-control" />
        <span asp-validation-for="NomeCompleto" class="text-danger"></span>
    </div>

    <div class="row mb-3">
        <div class="col-md-8">
            <div class="form-group">
                <label asp-for="Morada"></label>
                <input asp-for="Morada" class="form-control" />
                <span asp-validation-for="Morada" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label asp-for="CodigoPostal"></label>
                <input asp-for="CodigoPostal" class="form-control" placeholder="xxxx-xxx" />
                <span asp-validation-for="CodigoPostal" class="text-danger"></span>
            </div>
        </div>
    </div>

    <h4>Dados de Faturação</h4>
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" asp-for="QueroFaturaComNif" id="chkNif">
        <label class="form-check-label" for="chkNif">
            Desejo fatura com número de contribuinte
        </label>
    </div>

    <div id="areaNif" style="display:none;">
        <div class="form-group">
            <label asp-for="NifFaturacao"></label>
            <input asp-for="NifFaturacao" class="form-control" placeholder="999999990" />
            <span asp-validation-for="NifFaturacao" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="NomeFaturacao"></label>
            <input asp-for="NomeFaturacao" class="form-control" />
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Finalizar Pagamento</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Lógica simples para mostrar/ocultar
        document.getElementById('chkNif').addEventListener('change', function() {
            document.getElementById('areaNif').style.display = this.checked ? 'block' : 'none';
        });

        // Corrigir estado ao carregar página (caso volte com erro de validação)
        if(document.getElementById('chkNif').checked) {
            document.getElementById('areaNif').style.display = 'block';
        }
    </script>
}
</file>

<file path="Areas/Public/Views/Veiculos/_CarListPartial.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    var currentPage = (int?)ViewData["CurrentPage"] ?? 1;
    var totalPages = (int?)ViewData["TotalPages"] ?? 1;
    var totalItems = (int?)ViewData["TotalItems"] ?? 0;
}

<!-- INFORMAÇÕES DE PAGINAÇÃO -->
@if (totalItems > 0)
{
    <div class="alert alert-info mb-3">
        <small>
            <strong>Total:</strong> @totalItems veículo(s) encontrado(s) | 
            <strong>Página:</strong> @currentPage de @totalPages
        </small>
    </div>
}

<!-- Grid de Anúncios -->
@if (Model.Any())
{
    <div class="row g-4" id="veiculosGrid">
        @foreach (var veiculo in Model)
        {
            var imagemPrincipal = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
                                  ?? veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro;

            <div class="col-lg-4 col-md-6 col-12">
                <div class="card h-100 shadow-sm vehicle-card transition">
                    @if (!string.IsNullOrEmpty(imagemPrincipal))
                    {
                        <img src="/images/veiculos/@imagemPrincipal" class="card-img-top" alt="@veiculo.Marca @veiculo.Modelo" style="height: 200px; object-fit: cover;" />
                    }
                    else
                    {
                        <div style="height: 200px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">
                            <small>Sem imagem</small>
                        </div>
                    }
                    <div class="card-body">
                        <h6 class="card-title text-primary">@veiculo.Marca @veiculo.Modelo</h6>
                        <p class="card-text text-danger fw-bold fs-6">€@veiculo.Preco.ToString("F2")</p>
                        <small class="text-muted d-block">
                            ?? @veiculo.Ano
                        </small>
                        <small class="text-muted d-block">
                            ??? @veiculo.Km.ToString("N0") km
                        </small>
                        <small class="text-muted d-block mb-2">
                            ? @veiculo.Combustivel
                        </small>
                        @if (veiculo.Categoria != null)
                        {
                            <span class="badge bg-info text-dark">@veiculo.Categoria.Nome</span>
                        }
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="/Veiculos/Detalhe/@veiculo.Id" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-eye"></i> Ver Detalhes
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- CONTROLES DE PAGINAÇÃO -->
    @if (totalPages > 1)
    {
        <nav aria-label="Navegação de Páginas" class="mt-5">
            <ul class="pagination justify-content-center">
                <!-- Botão Anterior -->
                <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                    <a class="page-link pagination-link" href="#" data-page="@(currentPage - 1)" aria-label="Página Anterior">
                        <i class="bi bi-chevron-left"></i> Anterior
                    </a>
                </li>

                <!-- Números de Páginas -->
                @for (int i = 1; i <= totalPages; i++)
                {
                    if (i == currentPage)
                    {
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">@i</span>
                        </li>
                    }
                    else if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                    {
                        <li class="page-item">
                            <a class="page-link pagination-link" href="#" data-page="@i">@i</a>
                        </li>
                    }
                    else if (i == currentPage - 3 || i == currentPage + 3)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }

                <!-- Botão Próximo -->
                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <a class="page-link pagination-link" href="#" data-page="@(currentPage + 1)" aria-label="Próxima Página">
                        Próximo <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
}
else
{
    <div class="alert alert-info text-center" role="alert">
        <h6 class="alert-heading">Nenhum veículo encontrado</h6>
        <p class="mb-3">Nenhum veículo encontrado com os filtros selecionados.</p>
        <a href="/Veiculos/Index" class="btn btn-primary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
        </a>
    </div>
}
</file>

<file path="Areas/Public/Views/Veiculos/Detalhe.cshtml">
@model Veiculo
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = $"{Model.Marca} {Model.Modelo} - {Model.Ano}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container">
        <h1 class="text-white mb-2">@Model.Marca @Model.Modelo</h1>
        <p class="text-white-50">@Model.Titulo</p>
    </div>
</div>

<div class="container py-5">
    <div class="row g-4">
        <!-- COLUNA ESQUERDA: Carrossel e Infos -->
        <div class="col-lg-8">
            
            <!-- CARROSSEL BOOTSTRAP -->
            @if (Model.Imagens?.Any() == true)
            {
                <div class="card shadow-sm mb-4">
                    <div id="veiculoCarousel" class="carousel slide" data-bs-ride="carousel">
                        <!-- Imagens -->
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Imagens.Count; i++)
                            {
                                var imagem = Model.Imagens.ElementAt(i);
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="/images/veiculos/@imagem.CaminhoFicheiro" 
                                         class="d-block w-100" 
                                         alt="@Model.Marca @Model.Modelo - Foto @(i + 1)"
                                         style="height: 500px; object-fit: cover;" />
                                </div>
                            }
                        </div>

                        <!-- Botões Anterior/Próximo -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#veiculoCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#veiculoCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Próximo</span>
                        </button>

                        <!-- Indicadores -->
                        <div class="carousel-indicators">
                            @for (int i = 0; i < Model.Imagens.Count; i++)
                            {
                                <button type="button" 
                                        data-bs-target="#veiculoCarousel" 
                                        data-bs-slide-to="@i" 
                                        class="@(i == 0 ? "active" : "")" 
                                        aria-label="Foto @(i + 1)"></button>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm mb-4">
                    <div style="height: 500px; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                        <div class="text-center">
                            <i class="bi bi-image" style="font-size: 4rem; color: #999;"></i>
                            <p class="text-muted mt-3">Sem imagens disponíveis</p>
                        </div>
                    </div>
                </div>
            }

            <!-- INFORMAÇÕES PRINCIPAIS -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="card-title mb-4">@Model.Marca @Model.Modelo</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="text-muted">Preço</h5>
                            <h3 class="text-primary fw-bold">€@Model.Preco.ToString("F2")</h3>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-muted">Estado</h5>
                            <div>
                                @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success fs-6">Ativo</span>
                                }
                                else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger fs-6">Vendido</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning fs-6">@Model.Estado</span>
                                }
                            </div>
                        </div>
                    </div>

                    <hr />

                    <!-- ESPECIFICAÇÕES TÉCNICAS -->
                    <h4 class="mb-3">Especificações Técnicas</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Ano</h6>
                            <p class="fw-bold fs-5">@Model.Ano</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Quilómetros</h6>
                            <p class="fw-bold fs-5">@Model.Km.ToString("N0") km</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Combustível</h6>
                            <p class="fw-bold fs-5">@Model.Combustivel</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Caixa</h6>
                            <p class="fw-bold fs-5">@Model.Caixa</p>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Condicao))
                        {
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Condição</h6>
                                <p class="fw-bold fs-5">@Model.Condicao</p>
                            </div>
                        }
                        @if (Model.Categoria != null)
                        {
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Categoria</h6>
                                <p class="fw-bold fs-5">@Model.Categoria.Nome</p>
                            </div>
                        }
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Localização</h6>
                            <p class="fw-bold fs-5">?? @Model.Localizacao</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DESCRIÇÃO DETALHADA -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Descrição Detalhada</h4>
                    <p class="card-text" style="line-height: 1.8; white-space: pre-wrap;">@Model.Descricao</p>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA: Vendedor e Ações -->
        <div class="col-lg-4">
            
            <!-- CARD DO VENDEDOR -->
            @if (Model.Vendedor?.User != null)
            {
                <div class="card shadow-sm mb-4 sticky-top" style="top: 100px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informações do Vendedor</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="avatar mb-3" style="width: 80px; height: 80px; background: #e0e0e0; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-person" style="font-size: 2rem; color: #999;"></i>
                            </div>
                            <h5 class="fw-bold">@Model.Vendedor.User.Nome</h5>
                            <small class="text-muted d-block">Vendedor desde @Model.Vendedor.User.DataRegisto.ToString("MMMM yyyy")</small>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <h6 class="text-muted">Contacto</h6>
                            <p class="fw-bold">
                                <i class="bi bi-telephone"></i> 
                                @Model.Vendedor.User.Contacto
                            </p>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-muted">Localização</h6>
                            <p class="fw-bold">
                                <i class="bi bi-geo-alt"></i> 
                                @Model.Vendedor.User.Morada
                            </p>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-muted">Email</h6>
                            <p class="fw-bold" style="word-break: break-all;">
                                <i class="bi bi-envelope"></i> 
                                @Model.Vendedor.User.Email
                            </p>
                        </div>

                        <hr />

                        <!-- BOTÕES DE AÇÃO -->
                        <div class="d-grid gap-2">
                            @if (SignInManager.IsSignedIn(User))
                            {
                                <a href="@Url.Action("Checkout", "Transacoes", new { id = Model.Id })" class="btn btn-success btn-lg">
                                    <i class="bi bi-cart"></i> Comprar Veículo
                                </a>
                                <button class="btn btn-outline-primary btn-lg" onclick="alert('Funcionalidade em desenvolvimento')">
                                    <i class="bi bi-heart"></i> Adicionar aos Favoritos
                                </button>
                                <a href="javascript:void(0)" class="btn btn-outline-secondary btn-lg" onclick="alert('Chat em desenvolvimento')">
                                    <i class="bi bi-chat-dots"></i> Enviar Mensagem
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("Login", "Conta")" class="btn btn-success btn-lg">
                                    <i class="bi bi-cart"></i> Login para Comprar
                                </a>
                                <p class="text-muted text-center mt-2">
                                    Faça login para contactar o vendedor
                                </p>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- CARD DE INFORMAÇÕES ADICIONAIS -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Informações do Anúncio</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted">Publicado em</h6>
                        <p class="fw-bold">@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted">ID do Anúncio</h6>
                        <p class="fw-bold text-monospace">#@Model.Id</p>
                    </div>
                    <div>
                        <h6 class="text-muted">Imagens</h6>
                        <p class="fw-bold">
                            <i class="bi bi-image"></i> 
                            @(Model.Imagens?.Count ?? 0) foto(s)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTÕES DE NAVEGAÇÃO NO RODAPÉ -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex gap-2 justify-content-between">
                <a href="@Url.Action("Index", "Veiculos")" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-arrow-left"></i> Voltar ao Catálogo
                </a>
                <a href="@Url.Action("Index", "Veiculos", new { marca = Model.Marca })" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-search"></i> Ver Mais @Model.Marca
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS ADICIONAIS -->
@section Styles {
    <style>
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            filter: invert(1);
        }

        .carousel-indicators button {
            background-color: #666;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }

        .carousel-indicators button.active {
            background-color: #0d6efd;
        }

        .sticky-top {
            z-index: 10;
        }

        .avatar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .text-monospace {
            font-family: 'Courier New', monospace;
        }

        @@media (max-width: 768px) {
            .sticky-top {
                position: relative !important;
                top: auto !important;
                margin-top: 2rem;
            }

            .carousel-inner {
                height: 300px;
            }
        }
    </style>
}
</file>

<file path="Areas/Public/Views/Veiculos/Index.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    ViewData["Title"] = "Pesquisa de Veículos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- SIDEBAR FILTROS (Esquerda) -->
        <aside class="col-lg-3 col-md-4 col-12">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/Veiculos/BuscarAjax" id="filtrosForm">
                        
                        <!-- Marca -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Marca</label>
                            <select name="marca" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todas as marcas --</option>
                                @foreach (var m in (ViewData["Marcas"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["MarcaSelecionada"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Modelo -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Modelo</label>
                            <select name="modelo" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os modelos --</option>
                                @foreach (var m in (ViewData["Modelos"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["ModeloSelecionado"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Combustível -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Combustível</label>
                            <select name="combustivel" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos --</option>
                                @foreach (var c in (ViewData["Combustiveis"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@c" selected="@(ViewData["CombustivelSelecionado"]?.ToString() == c)">@c</option>
                                }
                            </select>
                        </div>

                        <!-- Ano -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ano</label>
                            <select name="ano" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os anos --</option>
                                @foreach (var a in (ViewData["Anos"] as List<int>) ?? new List<int>())
                                {
                                    <option value="@a" selected="@(ViewData["AnoSelecionado"]?.ToString() == a.ToString())">@a</option>
                                }
                            </select>
                        </div>

                        <!-- Tipo/Segmento -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tipo (Segmento)</label>
                            <select name="categoria" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os tipos --</option>
                                @foreach (var cat in (ViewData["Categorias"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@cat" selected="@(ViewData["CategoriaSelecionada"]?.ToString() == cat)">@cat</option>
                                }
                            </select>
                        </div>

                        <!-- Preço Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Preço (€)</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="precoMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["PrecoMin"]" />
                                <input type="number" name="precoMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["PrecoMax"]" />
                            </div>
                        </div>

                        <!-- KM Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Quilómetros</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="kmMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["KmMin"]" />
                                <input type="number" name="kmMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["KmMax"]" />
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm" id="btnPesquisar">
                                <i class="bi bi-search"></i> Pesquisar
                            </button>
                            <a href="/Veiculos/Index" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <!-- ANÚNCIOS (Direita) -->
        <section class="col-lg-9 col-md-8 col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Veículos Disponíveis</h5>
                    <div>
                        <label class="form-label mb-0 me-2">Ordenar:</label>
                        <select id="ordenacao" class="form-select form-select-sm d-inline w-auto filtro-select">
                            <option value="recente" selected="@(ViewData["Ordenacao"]?.ToString() == "recente")">Mais recente</option>
                            <option value="preco_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_asc")">Preço ascendente</option>
                            <option value="preco_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_desc")">Preço descendente</option>
                            <option value="km_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_asc")">KM ascendentes</option>
                            <option value="km_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_desc")">KM descendentes</option>
                            <option value="ano_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_asc")">Ano ascendente</option>
                            <option value="ano_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_desc")">Ano descendente</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- LOADING SPINNER -->
            <div id="loadingSpinner" class="text-center" style="display: none; padding: 3rem;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-3">Procurando veículos...</p>
            </div>

            <!-- CONTENTOR DE RESULTADOS (será preenchido via AJAX) -->
            <div id="resultado">
                @await Html.PartialAsync("_CarListPartial", Model)
            </div>
        </section>
    </div>
</div>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<script>
    // ============================================================
    // AJAX LISTENER - Pesquisa dinâmica sem recarregar página
    // ============================================================

    function executarBusca() {
        // Mostrar loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('resultado').style.opacity = '0.5';

        // Obter dados do formulário
        const formData = new FormData(document.getElementById('filtrosForm'));
        const ordenacao = document.getElementById('ordenacao').value;
        formData.append('ordenacao', ordenacao);

        // Fazer requisição AJAX
        fetch('/Veiculos/BuscarAjax', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            // Substituir conteúdo do resultado
            document.getElementById('resultado').innerHTML = html;
            document.getElementById('resultado').style.opacity = '1';

            // Adicionar listeners aos links de paginação
            adicionarListenersPaginacao();

            // Scroll suave até os resultados
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Erro ao pesquisar:', error);
            document.getElementById('resultado').innerHTML = `
                <div class="alert alert-danger text-center">
                    <h6>Erro ao carregar resultados</h6>
                    <p>${error.message}</p>
                </div>
            `;
            document.getElementById('resultado').style.opacity = '1';
        })
        .finally(() => {
            // Esconder loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
        });
    }

    function adicionarListenersPaginacao() {
        // Listeners para links de paginação
        document.querySelectorAll('.pagination-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                const formData = new FormData(document.getElementById('filtrosForm'));
                formData.append('page', page);
                formData.append('ordenacao', document.getElementById('ordenacao').value);

                // Repetir busca com nova página
                executarBusca();
            });
        });
    }

    // ============================================================
    // INICIALIZAÇÃO
    // ============================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Listeners nos filtros (select e input)
        document.querySelectorAll('.filtro-select, .filtro-input').forEach(element => {
            element.addEventListener('change', executarBusca);
        });

        // Listener na dropdown de ordenação
        document.getElementById('ordenacao').addEventListener('change', executarBusca);

        // Listener no botão pesquisar (para Enter em inputs)
        document.getElementById('filtrosForm').addEventListener('submit', (e) => {
            e.preventDefault();
            executarBusca();
        });

        // Listeners iniciais na paginação
        adicionarListenersPaginacao();
    });
</script>
</file>

<file path="Areas/Vendedores/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Vendedores/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Vendedores/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Create.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.CreateVeiculoViewModel
@{
    ViewData["Title"] = "Criar Novo Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Criar Novo Veьculo</h1>

            <form asp-action="Create" asp-controller="Veiculos" asp-area="Vendedores" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                <!-- Seусo 1: Informaушes Bрsicas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informaушes Bрsicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label">Tьtulo do AnЩncio *</label>
                            <input asp-for="Titulo" class="form-control" placeholder="Ex: BMW 320i 2018 em perfeito estado" required />
                            <span asp-validation-for="Titulo" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Marca" class="form-label">Marca *</label>
                                <input asp-for="Marca" class="form-control" placeholder="Ex: BMW" required />
                                <span asp-validation-for="Marca" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Modelo" class="form-label">Modelo *</label>
                                <input asp-for="Modelo" class="form-control" placeholder="Ex: 320i" required />
                                <span asp-validation-for="Modelo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Ano" class="form-label">Ano *</label>
                                <input asp-for="Ano" type="number" class="form-control" placeholder="2023" required />
                                <span asp-validation-for="Ano" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoriaId" class="form-label">Tipo/Segmento *</label>
                                <select asp-for="CategoriaId" class="form-select" required>
                                    <option value="">-- Selecione uma categoria --</option>
                                    @if (Model.CategoriesDropdown.Any())
                                    {
                                        @foreach (var cat in Model.CategoriesDropdown)
                                        {
                                            <option value="@cat.Id">@cat.Nome</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoriaId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 2: Especificaушes Tжcnicas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Especificaушes Tжcnicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Combustivel" class="form-label">Combustьvel *</label>
                                <select asp-for="Combustivel" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Gasolina">Gasolina</option>
                                    <option value="Gasзleo">Gasзleo</option>
                                    <option value="Hьbrido">Hьbrido</option>
                                    <option value="Elжtrico">Elжtrico</option>
                                    <option value="GLP">GLP</option>
                                </select>
                                <span asp-validation-for="Combustivel" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Caixa" class="form-label">Caixa *</label>
                                <select asp-for="Caixa" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Automрtica">Automрtica</option>
                                    <option value="CVT">CVT</option>
                                </select>
                                <span asp-validation-for="Caixa" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Km" class="form-label">Quilзmetros</label>
                                <input asp-for="Km" type="number" class="form-control" placeholder="45000" />
                                <span asp-validation-for="Km" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Condicao" class="form-label">Condiусo</label>
                                <input asp-for="Condicao" class="form-control" placeholder="Ex: Usado, Novo" />
                                <span asp-validation-for="Condicao" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Preco" class="form-label">Preуo (ђ) *</label>
                                <input asp-for="Preco" type="number" step="0.01" class="form-control" placeholder="25000.00" required />
                                <span asp-validation-for="Preco" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 3: Localizaусo e Descriусo -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Localizaусo e Descriусo</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Localizacao" class="form-label">Localizaусo *</label>
                            <input asp-for="Localizacao" class="form-control" placeholder="Ex: Lisboa, Portugal" required />
                            <span asp-validation-for="Localizacao" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Descricao" class="form-label">Descriусo Detalhada *</label>
                            <textarea asp-for="Descricao" class="form-control" rows="5" placeholder="Descreva em detalhe o estado do veьculo, histзrico de manutenусo, reparaушes, etc." required></textarea>
                            <small class="form-text text-muted">Mрximo 2000 caracteres</small>
                            <span asp-validation-for="Descricao" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Seусo 4: Fotos -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Fotos (Mрximo 10 imagens)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Fotos" class="form-label">Selecione as Fotos *</label>
                            <input asp-for="Fotos" type="file" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple required />
                            <small class="form-text text-muted">
                                Formatos: JPG, JPEG, PNG, WebP | Mрximo 10 imagens | Mрximo 5 MB por imagem
                            </small>
                            <span asp-validation-for="Fotos" class="text-danger"></span>
                        </div>

                        <div id="preview" class="row mt-3"></div>
                    </div>
                </div>

                <!-- Botшes -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Criar Veьculo
                    </button>
                    <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelector('input[type="file"]').addEventListener('change', function(e) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            
            Array.from(this.files).slice(0, 10).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                    col.innerHTML = `
                        <div class="position-relative">
                            <img src="${event.target.result}" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
                            <small class="d-block mt-1 text-muted">${file.name}</small>
                        </div>
                    `;
                    preview.appendChild(col);
                };
                reader.readAsDataURL(file);
            });

            if (this.files.length > 10) {
                alert('Mрximo de 10 imagens permitidas. Apenas as primeiras 10 serсo usadas.');
            }
        });
    </script>
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Details.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.ListVeiculoViewModel
@{
    ViewData["Title"] = "Detalhes do Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@Model.Titulo</h5>
                    @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                    {
                        <span class="badge bg-success">Ativo</span>
                    }
                    else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                    {
                        <span class="badge bg-danger">Vendido</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">@Model.Estado</span>
                    }
                </div>

                <div class="card-body">
                    <!-- Imagem Principal -->
                    <div class="mb-4">
                        @if (!string.IsNullOrEmpty(Model.ImagemPrincipal))
                        {
                            <img src="/images/veiculos/@Model.ImagemPrincipal" alt="@Model.Titulo" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px;" />
                        }
                        else
                        {
                            <div style="width: 100%; height: 400px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999; font-size: 1.2rem;">Sem imagem</span>
                            </div>
                        }
                    </div>

                    <!-- Informaушes Principais -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Marca/Modelo</h6>
                            <h5>@Model.Marca @Model.Modelo</h5>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Preуo</h6>
                            <h5 class="text-primary fw-bold">ђ@Model.Preco.ToString("F2")</h5>
                        </div>
                    </div>

                    <hr />

                    <!-- Especificaушes -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <h6 class="text-muted">Ano</h6>
                            <p class="fw-bold">@Model.Ano</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Quilзmetros</h6>
                            <p class="fw-bold">@Model.Km.ToString("N0") km</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Combustьvel</h6>
                            <p class="fw-bold">@Model.Combustivel</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <h6 class="text-muted">Caixa</h6>
                            <p class="fw-bold">@Model.Caixa</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Categoria</h6>
                            <p class="fw-bold">@Model.CategoriaNome</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Condiусo</h6>
                            <p class="fw-bold">@(string.IsNullOrEmpty(Model.Condicao) ? "N/A" : Model.Condicao)</p>
                        </div>
                    </div>

                    <hr />

                    <!-- Informaушes de Publicaусo -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Data de Publicaусo</h6>
                            <p class="fw-bold">@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Estado</h6>
                            <p class="fw-bold">
                                @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success">@Model.Estado</span>
                                }
                                else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger">@Model.Estado</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">@Model.Estado</span>
                                }
                            </p>
                        </div>
                    </div>

                    <!-- Descriусo -->
                    <div class="mb-4">
                        <h6 class="text-muted">Descriусo</h6>
                        <p>@Model.Descricao</p>
                    </div>

                    <hr />

                    <!-- Botшes de Aусo -->
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("Edit", "Veiculos", new { area = "Vendedores", id = Model.Id })" class="btn btn-warning btn-lg">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="@Url.Action("Delete", "Veiculos", new { area = "Vendedores", id = Model.Id })" class="btn btn-danger btn-lg">
                            <i class="bi bi-trash"></i> Eliminar
                        </a>
                        <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Vendedores/Views/Veiculos/Edit.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.EditVeiculoViewModel
@{
    ViewData["Title"] = "Editar Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Editar Veьculo</h1>

            <form asp-action="Edit" asp-controller="Veiculos" asp-area="Vendedores" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="Id" />

                <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                <!-- Seусo 1: Informaушes Bрsicas -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Informaушes Bрsicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label">Tьtulo do AnЩncio *</label>
                            <input asp-for="Titulo" class="form-control" required />
                            <span asp-validation-for="Titulo" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Marca" class="form-label">Marca *</label>
                                <input asp-for="Marca" class="form-control" required />
                                <span asp-validation-for="Marca" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Modelo" class="form-label">Modelo *</label>
                                <input asp-for="Modelo" class="form-control" required />
                                <span asp-validation-for="Modelo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Ano" class="form-label">Ano *</label>
                                <input asp-for="Ano" type="number" class="form-control" required />
                                <span asp-validation-for="Ano" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoriaId" class="form-label">Tipo/Segmento *</label>
                                <select asp-for="CategoriaId" class="form-select" required>
                                    <option value="">-- Selecione uma categoria --</option>
                                    @if (Model.CategoriesDropdown.Any())
                                    {
                                        @foreach (var cat in Model.CategoriesDropdown)
                                        {
                                            <option value="@cat.Id" selected="@(cat.Id == Model.CategoriaId)">@cat.Nome</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoriaId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 2: Especificaушes Tжcnicas -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Especificaушes Tжcnicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Combustivel" class="form-label">Combustьvel *</label>
                                <select asp-for="Combustivel" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Gasolina" selected="@(Model.Combustivel == "Gasolina")">Gasolina</option>
                                    <option value="Gasзleo" selected="@(Model.Combustivel == "Gasзleo")">Gasзleo</option>
                                    <option value="Hьbrido" selected="@(Model.Combustivel == "Hьbrido")">Hьbrido</option>
                                    <option value="Elжtrico" selected="@(Model.Combustivel == "Elжtrico")">Elжtrico</option>
                                    <option value="GLP" selected="@(Model.Combustivel == "GLP")">GLP</option>
                                </select>
                                <span asp-validation-for="Combustivel" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Caixa" class="form-label">Caixa *</label>
                                <select asp-for="Caixa" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Manual" selected="@(Model.Caixa == "Manual")">Manual</option>
                                    <option value="Automрtica" selected="@(Model.Caixa == "Automрtica")">Automрtica</option>
                                    <option value="CVT" selected="@(Model.Caixa == "CVT")">CVT</option>
                                </select>
                                <span asp-validation-for="Caixa" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Km" class="form-label">Quilзmetros</label>
                                <input asp-for="Km" type="number" class="form-control" />
                                <span asp-validation-for="Km" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Condicao" class="form-label">Condiусo</label>
                                <input asp-for="Condicao" class="form-control" />
                                <span asp-validation-for="Condicao" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Preco" class="form-label">Preуo (ђ) *</label>
                                <input asp-for="Preco" type="number" step="0.01" class="form-control" required />
                                <span asp-validation-for="Preco" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 3: Localizaусo e Descriусo -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Localizaусo e Descriусo</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Localizacao" class="form-label">Localizaусo *</label>
                            <input asp-for="Localizacao" class="form-control" required />
                            <span asp-validation-for="Localizacao" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Descricao" class="form-label">Descriусo Detalhada *</label>
                            <textarea asp-for="Descricao" class="form-control" rows="5" required></textarea>
                            <small class="form-text text-muted">Mрximo 2000 caracteres</small>
                            <span asp-validation-for="Descricao" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Seусo 4: Fotos -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Fotos (Mрximo 10 imagens)</h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.ImagemPrincipalAtual))
                        {
                            <div class="alert alert-info mb-3">
                                <strong>Imagem Atual:</strong>
                                <br />
                                <img src="/images/veiculos/@Model.ImagemPrincipalAtual" alt="Imagem atual" style="max-width: 200px; height: auto; border-radius: 4px; margin-top: 10px;" />
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="Fotos" class="form-label">Adicionar Novas Fotos (Opcional)</label>
                            <input asp-for="Fotos" type="file" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple />
                            <small class="form-text text-muted">
                                Formatos: JPG, JPEG, PNG, WebP | Mрximo 10 imagens | Mрximo 5 MB por imagem
                            </small>
                            <span asp-validation-for="Fotos" class="text-danger"></span>
                        </div>

                        <div id="preview" class="row mt-3"></div>
                    </div>
                </div>

                <!-- Botшes -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-warning btn-lg">
                        <i class="bi bi-pencil"></i> Atualizar Veьculo
                    </button>
                    <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const preview = document.getElementById('preview');
                preview.innerHTML = '';
                
                Array.from(this.files).slice(0, 10).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${event.target.result}" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
                                <small class="d-block mt-1 text-muted">${file.name}</small>
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });

                if (this.files.length > 10) {
                    alert('Mрximo de 10 imagens permitidas. Apenas as primeiras 10 serсo usadas.');
                }
            });
        }
    </script>
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Index.cshtml">
@model List<AutoMarket.Models.ViewModels.Veiculos.ListVeiculoViewModel>
@{
    ViewData["Title"] = "Os Meus Veículos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="h3">Os Meus Veículos</h1>
        </div>
        <div class="col-md-6 text-end">
            <a href="@Url.Action("Create", "Veiculos", new { area = "Vendedores" })" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Criar Novo Veículo
            </a>
        </div>
    </div>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Imagem</th>
                        <th>Título</th>
                        <th>Marca/Modelo</th>
                        <th>Preço</th>
                        <th>KM</th>
                        <th>Ano</th>
                        <th>Estado</th>
                        <th>Publicado</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var veiculo in Model)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(veiculo.ImagemPrincipal))
                                {
                                    <img src="/images/veiculos/@veiculo.ImagemPrincipal" alt="@veiculo.Titulo" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" />
                                }
                                else
                                {
                                    <div style="width: 60px; height: 60px; background: #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #999;">
                                        Sem imagem
                                    </div>
                                }
                            </td>
                            <td>
                                <strong>@veiculo.Titulo</strong>
                            </td>
                            <td>
                                @veiculo.Marca @veiculo.Modelo
                            </td>
                            <td>
                                <span class="text-primary fw-bold">€@veiculo.Preco.ToString("F2")</span>
                            </td>
                            <td>
                                @veiculo.Km.ToString("N0") km
                            </td>
                            <td>
                                @veiculo.Ano
                            </td>
                            <td>
                                @if (veiculo.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success">Ativo</span>
                                }
                                else if (veiculo.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger">Vendido</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">@veiculo.Estado</span>
                                }
                            </td>
                            <td>
                                <small class="text-muted">@veiculo.DataCriacao.ToString("dd/MM/yyyy")</small>
                            </td>
                            <td class="text-center">
                                <a href="@Url.Action("Details", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-info" title="Ver Detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="@Url.Action("Edit", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-warning" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="@Url.Action("Delete", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-danger" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <h5>Nenhum veículo encontrado</h5>
            <p class="mb-3">Ainda não tem veículos publicados. Comece criando o seu primeiro anúncio!</p>
            <a href="@Url.Action("Create", "Veiculos", new { area = "Vendedores" })" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Criar Primeiro Veículo
            </a>
        </div>
    }
</div>
</file>

<file path="AutoMarket.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9 d17.14
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoMarket", "AutoMarket.csproj", "{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {0AF442B4-A056-4BE9-88F5-F25246B9EF62}
	EndGlobalSection
EndGlobal
</file>

<file path="GlobalUsings.cs">
global using System;
global using System.Collections.Generic;
global using System.Linq;
global using System.Threading.Tasks;
global using Microsoft.AspNetCore.Mvc;
global using Microsoft.AspNetCore.Authorization;
global using Microsoft.Extensions.Logging;
global using AutoMarket.Models.DTOs;
global using AutoMarket.Models.Enums;
global using AutoMarket.Models.Entities;
global using AutoMarket.Services.Interfaces;
</file>

<file path="Infrastructure/Data/Configurations/ReservaConfiguration.cs">
using AutoMarket.Models.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace AutoMarket.Infrastructure.Data.Configurations
{
    public class ReservaConfiguration : IEntityTypeConfiguration<Reserva>
    {
        public void Configure(EntityTypeBuilder<Reserva> builder)
        {
            // Única reserva ativa por veículo
            builder.HasIndex(r => r.VeiculoId)
                   .IsUnique()
                   .HasFilter("[Estado] = 'Ativa'");

            builder.Property(r => r.Estado)
                   .HasMaxLength(50);

            builder.Property(r => r.DataReserva)
                   .HasColumnType("datetime2");

            builder.Property(r => r.DataExpiracao)
                   .HasColumnType("datetime2");

            builder.HasOne(r => r.Veiculo)
                   .WithMany()
                   .HasForeignKey(r => r.VeiculoId)
                   .OnDelete(DeleteBehavior.Restrict);

            builder.HasOne(r => r.Comprador)
                   .WithMany()
                   .HasForeignKey(r => r.CompradorId)
                   .OnDelete(DeleteBehavior.Restrict);
        }
    }
}
</file>

<file path="Infrastructure/Data/CustomUserStore.cs">
using AutoMarket.Models.Entities;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Infrastructure.Data
{
    /// <summary>
    /// UserStore customizado que filtra utilizadores deletados (soft delete) em todas as operações do Identity.
    /// </summary>
    public class CustomUserStore : UserStore<Utilizador>
    {
        public CustomUserStore(ApplicationDbContext context, IdentityErrorDescriber? describer = null)
            : base(context, describer)
        {
        }

        public override async Task<Utilizador?> FindByIdAsync(string userId, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.Id == userId, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override async Task<Utilizador?> FindByNameAsync(string normalizedUserName, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.NormalizedUserName == normalizedUserName, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override async Task<Utilizador?> FindByEmailAsync(string normalizedEmail, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.NormalizedEmail == normalizedEmail, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override IQueryable<Utilizador> Users => base.Users.Where(u => !u.IsDeleted);
    }
}
</file>

<file path="Infrastructure/Data/DbInitializer.cs">
using AutoMarket.Models.Constants;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Infrastructure.Data
{
    public static class DbInitializer
    {
        public static async Task InitializeAsync(IServiceProvider serviceProvider)
        {
            var roleManager = serviceProvider.GetRequiredService<RoleManager<IdentityRole>>();
            var userManager = serviceProvider.GetRequiredService<UserManager<Utilizador>>();
            var context = serviceProvider.GetRequiredService<ApplicationDbContext>();
            var configuration = serviceProvider.GetRequiredService<IConfiguration>();
            var environment = serviceProvider.GetRequiredService<IHostEnvironment>();

            // 1. Roles
            string[] roles = { Roles.Admin, Roles.Vendedor, Roles.Comprador };
            foreach (var role in roles)
            {
                if (!await roleManager.RoleExistsAsync(role))
                {
                    await roleManager.CreateAsync(new IdentityRole(role));
                }
            }

            // 2. Default Admin
            var adminEmail = configuration["DefaultAdmin:Email"] ?? "admin@automarket.com";
            var adminPwd = configuration["DefaultAdmin:Password"];

            if (string.IsNullOrWhiteSpace(adminPwd))
            {
                // Em produção, falha para obrigar a usar secrets
                if (environment.IsProduction())
                {
                    throw new InvalidOperationException("A password do Admin não está configurada (DefaultAdmin:Password).");
                }
                adminPwd = "Password1231"; // Apenas para dev/local
            }

            var adminUser = await EnsureUserAsync(userManager, adminEmail, adminPwd, "Administrador Sistema", Roles.Admin);

            if (environment.IsDevelopment())
            {
                // 3. Comprador Teste
                var compradorUser = await EnsureUserAsync(userManager, "comprador@automarket.com", "Password123!", "Comprador Exemplo", Roles.Comprador);
                if (compradorUser != null)
                {
                    if (!await context.Compradores.AnyAsync(c => c.UserId == compradorUser.Id))
                    {
                        context.Compradores.Add(new Comprador
                        {
                            UserId = compradorUser.Id,
                            ReceberNotificacoes = true
                        });
                        await context.SaveChangesAsync();
                    }
                }

                // 4. Vendedor Particular (Aprovado)
                var vendedorPartUser = await EnsureUserAsync(userManager, "vendedor_part@automarket.com", "Password123!", "Vendedor Particular", Roles.Vendedor);
                if (vendedorPartUser != null)
                {
                    if (!await context.Vendedores.AnyAsync(v => v.UserId == vendedorPartUser.Id))
                    {
                        context.Vendedores.Add(new Vendedor
                        {
                            UserId = vendedorPartUser.Id,
                            TipoConta = TipoConta.Vendedor,
                            Status = StatusAprovacao.Aprovado,
                            ApprovedByAdminId = adminUser?.Id 
                        });
                        await context.SaveChangesAsync();
                    }
                }

                // 5. Vendedor Empresa (Aprovado)
                var vendedorEmpUser = await EnsureUserAsync(userManager, "vendedor_emp@automarket.com", "Password123!", "Stand AutoMarket Lda", Roles.Vendedor);
                if (vendedorEmpUser != null)
                {
                    if (!await context.Vendedores.AnyAsync(v => v.UserId == vendedorEmpUser.Id))
                    {
                        context.Vendedores.Add(new Vendedor
                        {
                            UserId = vendedorEmpUser.Id,
                            TipoConta = TipoConta.Empresa,
                            Status = StatusAprovacao.Aprovado,
                            ApprovedByAdminId = adminUser?.Id
                        });
                        await context.SaveChangesAsync();
                    }
                }
            }
        }

        private static async Task<Utilizador?> EnsureUserAsync(UserManager<Utilizador> userManager, string email, string password, string nome, string role)
        {
            var user = await userManager.FindByEmailAsync(email);
            if (user == null)
            {
                user = new Utilizador
                {
                    UserName = email,
                    Email = email,
                    Nome = nome,
                    Contacto = "N/A", 
                    EmailConfirmed = true,
                    DataRegisto = DateTime.UtcNow
                };

                var result = await userManager.CreateAsync(user, password);
                if (result.Succeeded)
                {
                    await userManager.AddToRoleAsync(user, role);
                }
                else
                {
                    foreach (var error in result.Errors)
                    {
                        Console.WriteLine($"[DBInitializer] Erro ao criar utilizador {email}: {error.Description}");
                    }
                    return null;
                }
            }
            return user;
        }
    }
}
</file>

<file path="Infrastructure/Options/ReservationOptions.cs">
namespace AutoMarket.Infrastructure.Options
{
    public class ReservationOptions
    {
        /// <summary>Horas até expirar uma reserva (ex.: 24).</summary>
        public int TempoExpiracaoHoras { get; set; } = 24;

        /// <summary>Máximo de reservas ativas por comprador.</summary>
        public int MaxReservasAtivasPorComprador { get; set; } = 3;
    }
}
</file>

<file path="Infrastructure/Security/CustomClaimsPrincipalFactory.cs">
using System.Security.Claims;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Options;
using Microsoft.EntityFrameworkCore;
using AutoMarket.Models.Enums;
using AutoMarket.Models.Entities;
using AutoMarket.Infrastructure.Data;

namespace AutoMarket.Infrastructure.Security
{
    /// <summary>
    /// Factory customizado para adicionar claims específicas do AutoMarket ao ClaimsPrincipal.
    /// Adiciona VendedorId, StatusVendedor e CompradorId para evitar queries repetidas à BD.
    /// </summary>
    public class CustomClaimsPrincipalFactory : UserClaimsPrincipalFactory<Utilizador, IdentityRole>
    {
        private readonly ApplicationDbContext _context;

        public CustomClaimsPrincipalFactory(
            UserManager<Utilizador> userManager,
            RoleManager<IdentityRole> roleManager,
            IOptions<IdentityOptions> optionsAccessor,
            ApplicationDbContext context)
            : base(userManager, roleManager, optionsAccessor)
        {
            _context = context;
        }

        protected override async Task<ClaimsIdentity> GenerateClaimsAsync(Utilizador user)
        {
            var identity = await base.GenerateClaimsAsync(user);

            // 1. Injetar Claim de Vendedor se existir
            var vendedor = await _context.Vendedores
                .AsNoTracking()
                .FirstOrDefaultAsync(v => v.UserId == user.Id);

            if (vendedor != null)
            {
                identity.AddClaim(new Claim("VendedorId", vendedor.Id.ToString()));
                identity.AddClaim(new Claim("StatusVendedor", vendedor.Status.ToString())); // Útil para Policies
            }

            // 2. Injetar Claim de Comprador se existir
            var comprador = await _context.Compradores
                .AsNoTracking()
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador != null)
            {
                identity.AddClaim(new Claim("CompradorId", comprador.Id.ToString()));
            }
            
            // 3. NIF NÃO deve ser adicionado (RGPD compliance)
            // O NIF está encriptado na BD e não deve ser exposto no cookie, mesmo que encriptado.
            // Se necessário, desencriptar apenas quando necessário em operações específicas.

            return identity;
        }
    }
}
</file>

<file path="Infrastructure/Security/NifEncryptionHelper.cs">
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Infrastructure.Security
{
    /// <summary>
    /// Helper estático para acessar o serviço de encriptação do NIF.
    /// Usado pela propriedade NIF em Utilizador para encriptação/desencriptação automática.
    /// </summary>
    public static class NifEncryptionHelper
    {
        private static IEncryptionService? _encryptionService;
        private static readonly object _lock = new object();

        /// <summary>
        /// Inicializa o helper com o serviço de encriptação.
        /// Deve ser chamado no Program.cs durante a configuração.
        /// </summary>
        public static void Initialize(IEncryptionService encryptionService)
        {
            lock (_lock)
            {
                _encryptionService = encryptionService;
            }
        }

        /// <summary>
        /// Encripta o NIF antes de guardar na base de dados.
        /// </summary>
        public static string? EncryptNif(string? nif)
        {
            if (string.IsNullOrEmpty(nif))
                return nif;

            if (_encryptionService == null)
            {
                // Se o serviço não estiver inicializado, retornar sem encriptar
                // (útil durante migrações ou inicialização)
                return nif;
            }

            return _encryptionService.Encrypt(nif);
        }

        /// <summary>
        /// Desencripta o NIF ao ler da base de dados.
        /// </summary>
        public static string? DecryptNif(string? encryptedNif)
        {
            if (string.IsNullOrEmpty(encryptedNif))
                return encryptedNif;

            if (_encryptionService == null)
            {
                // Se o serviço não estiver inicializado, retornar como está
                return encryptedNif;
            }

            // Se não estiver encriptado (dados antigos), retornar como está
            if (!_encryptionService.IsEncrypted(encryptedNif))
                return encryptedNif;

            try
            {
                return _encryptionService.Decrypt(encryptedNif);
            }
            catch
            {
                // Se falhar a desencriptação, retornar como está (pode ser dado antigo)
                return encryptedNif;
            }
        }
    }
}
</file>

<file path="Infrastructure/Security/VendedorAprovadoHandler.cs">
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using AutoMarket.Models.Constants;
using AutoMarket.Infrastructure.Data;

namespace AutoMarket.Infrastructure.Security
{
    public class VendedorAprovadoHandler : AuthorizationHandler<VendedorAprovadoRequirement>
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;

        public VendedorAprovadoHandler(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        protected override async Task HandleRequirementAsync(
            AuthorizationHandlerContext context,
            VendedorAprovadoRequirement requirement)
        {
            var userPrincipal = context.User;

            // 1. Verificar se está logado e se é Vendedor
            if (userPrincipal.Identity?.IsAuthenticated != true || !userPrincipal.IsInRole(Roles.Vendedor))
            {
                // Se não é vendedor, a policy não se aplica (ou falha)
                return;
            }

            // 2. Tentar obter StatusVendedor da claim (otimização - evita query à BD)
            var statusClaim = userPrincipal.FindFirst("StatusVendedor")?.Value;
            StatusAprovacao? status = null;

            if (!string.IsNullOrEmpty(statusClaim) && Enum.TryParse<StatusAprovacao>(statusClaim, out var parsedStatus))
            {
                status = parsedStatus;
            }
            else
            {
                // Fallback: Se a claim não existir, fazer query à BD (compatibilidade)
                var userId = _userManager.GetUserId(userPrincipal);
                if (string.IsNullOrEmpty(userId)) return;

                status = await _context.Vendedores
                    .Where(v => v.UserId == userId)
                    .Select(v => v.Status)
                    .FirstOrDefaultAsync();
            }

            // 3. O momento da verdade
            if (status == StatusAprovacao.Aprovado)
            {
                context.Succeed(requirement); // SUCESSO!
            }
            else
            {
                // Se falhar, podemos redirecionar ou deixar o ASP.NET retornar 403 Forbidden.
                // Dica Pro: Para redirecionar dentro de um Handler é preciso lógica extra,
                // geralmente o 403 é intercetado no Program.cs ou deixa-se falhar.

                // Opção Simples: Apenas não chamamos o Succeed. O sistema assume falha.
            }
        }
    }
}
</file>

<file path="Infrastructure/Security/VendedorAprovadoRequirement.cs">
using Microsoft.AspNetCore.Authorization;

namespace AutoMarket.Infrastructure.Security
{
    // Esta classe é um "marcador" que diz que existe esta regra
    public class VendedorAprovadoRequirement : IAuthorizationRequirement
    {
    }
}
</file>

<file path="Infrastructure/Utils/NifValidator.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Infrastructure.Utils
{
    public static class NifValidator
    {
        public static bool IsValid(string nif)
        {
            if (string.IsNullOrWhiteSpace(nif) || nif.Length != 9 || !long.TryParse(nif, out _))
                return false;

            var total = 0;
            for (var i = 0; i < 8; i++)
            {
                total += int.Parse(nif[i].ToString()) * (9 - i);
            }

            var resto = total % 11;
            var checkDigit = resto < 2 ? 0 : 11 - resto;

            return checkDigit == int.Parse(nif[8].ToString());
        }

        public static bool IsEmpresa(string nif)
        {
            if (!IsValid(nif)) return false;
            char prefix = nif[0];
            // 5: Pessoas Coletivas (Sociedades)
            // 6: Administração Pública
            // 9: Entidades Equiparadas / Irregulares (ex: Condomínios)
            // Nota: Existem outros (70, 71, etc.) mas são casos muito específicos de Heranças/Não Residentes
            return prefix == '5' || prefix == '6' || prefix == '9';
        }

        public static bool IsParticular(string nif)
        {
            if (!IsValid(nif)) return false;
            char prefix = nif[0];
            // 1, 2, 3: Pessoas Singulares (o 3 já está a ser atribuído)
            // 45: Pessoas Singulares Não Residentes (NIF provisório em alguns casos, mas raro ser usado em registo normal)
            return prefix == '1' || prefix == '2' || prefix == '3';
        }
    }
}
</file>

<file path="Infrastructure/Utils/SessionExtensions.cs">
using System.Text.Json;
using Microsoft.AspNetCore.Http;

namespace AutoMarket.Infrastructure.Utils
{
    public static class SessionExtensions
    {
        private static readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true,
            WriteIndented = false
        };

        public static void SetObjectAsJson(this ISession session, string key, object value)
        {
            session.SetString(key, JsonSerializer.Serialize(value, _jsonOptions));
        }

        public static T? GetObjectFromJson<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            if (value == null) return default;

            try
            {
                return JsonSerializer.Deserialize<T>(value, _jsonOptions);
            }
            catch (JsonException)
            {
                // In case of corruption, return default/null to prevent crash
                return default;
            }
        }
    }
}
</file>

<file path="Models/Attributes/NifPortuguesAttribute.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Attributes
{
    public class NifPortuguesAttribute : ValidationAttribute
    {
        protected override ValidationResult IsValid(object value, ValidationContext validationContext)
        {
            // 1. Se for null ou vazio, assumimos Sucesso. 
            // Porquê? Porque a responsabilidade de ser "Obrigatório" é do atributo [Required].
            // Este atributo só valida: "SE tiver dados, eles têm de ser um NIF válido".
            string nif = value as string;
            if (string.IsNullOrWhiteSpace(nif))
            {
                return ValidationResult.Success;
            }

            // 2. Limpar espaços
            nif = nif.Trim();

            // 3. Verifica se tem 9 dígitos e se é numérico
            if (nif.Length != 9 || !long.TryParse(nif, out _))
            {
                return new ValidationResult("O NIF deve conter exatamente 9 dígitos numéricos.");
            }

            // 4. Algoritmo de Validação (Módulo 11)
            // Lógica oficial da Autoridade Tributária
            int total = 0;
            for (int i = 0; i < 8; i++)
            {
                total += int.Parse(nif[i].ToString()) * (9 - i);
            }

            int resto = total % 11;
            int digitoControloCalculado = resto < 2 ? 0 : 11 - resto;
            int digitoControloInformado = int.Parse(nif[8].ToString());

            if (digitoControloCalculado != digitoControloInformado)
            {
                return new ValidationResult("O NIF introduzido é inválido.");
            }

            return ValidationResult.Success;
        }
    }
}
</file>

<file path="Models/Constants/Roles.cs">
namespace AutoMarket.Models.Constants
{
    public static class Roles
    {
        public const string Admin = "Admin";
        public const string Vendedor = "Vendedor";
        public const string Comprador = "Comprador";
    }
}
</file>

<file path="Models/DTOs/AuthDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record RegisterDto(string Email, string Password, string Nome, string Morada, string? Contacto, string? Nif, TipoConta TipoConta);

    public sealed record RegisterResultDto(bool Success, IEnumerable<string> Errors, string? ConfirmationLink);

    public sealed record LoginDto(string Email, string Password, bool RememberMe);

    public sealed record LoginResultDto(bool Success, string? FailureReason, IEnumerable<string> Errors);

    public sealed record ConfirmEmailResultDto(bool Success, IEnumerable<string> Errors);

    public sealed record UpdateNifResultDto(bool Success, IEnumerable<string> Errors);

    public sealed record SoftDeleteResultDto(bool Success, IEnumerable<string> Errors);
}
</file>

<file path="Models/DTOs/CheckoutDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record CheckoutInitDto(
        string? NomeCompleto,
        string? Morada,
        string? Nif,
        decimal ValorTotal);

    public sealed record CheckoutInputDto(
        string Morada,
        string CodigoPostal,
        bool QueroFaturaComNif,
        string? NifFaturacao,
        MetodoPagamento MetodoPagamento);

    public sealed record CheckoutProcessResultDto(bool Success, int? FirstTransactionId, IEnumerable<string> Errors);

    public sealed record TransacaoDto(
        int Id,
        decimal ValorPago,
        EstadoTransacao Estado,
        DateTime Data,
        string? NifSnapshot,
        string MoradaSnapshot);
}
</file>

<file path="Models/DTOs/ReservarVeiculoDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record ReservarVeiculoDto(int VeiculoId);
}
</file>

<file path="Models/DTOs/VeiculoDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record VeiculoCreateDto(string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado);
    public sealed record VeiculoUpdateDto(string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado);
    public sealed record VeiculoDto(int Id, string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado, bool IsDeleted);
    public sealed record VeiculoFiltroDto(string? Marca, string? Modelo, int? AnoMin, int? AnoMax, decimal? PrecoMin, decimal? PrecoMax);
    public sealed record ValidationResultDto(bool IsValid, IEnumerable<string> Errors);
    public sealed record CommandResultDto(bool Success, IEnumerable<string> Errors);
}
</file>

<file path="Models/DTOs/VeiculoSearchFiltersDto.cs">
namespace AutoMarket.Models.DTOs
{
    /// <summary>
    /// DTO para encapsular parâmetros de pesquisa/filtro de veículos.
    /// Reutilizável entre diferentes métodos do controller.
    /// </summary>
    public class VeiculoSearchFiltersDto
    {
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? Combustivel { get; set; }
        public int? Ano { get; set; }
        public string? Categoria { get; set; }
        public decimal? PrecoMin { get; set; }
        public decimal? PrecoMax { get; set; }
        public int? KmMin { get; set; }
        public int? KmMax { get; set; }
        public string Ordenacao { get; set; } = "recente";
        public int Page { get; set; } = 1;
        public int PageSize { get; set; } = 12; // 12 veículos por página

        /// <summary>
        /// Valida se pelo menos um filtro foi aplicado.
        /// </summary>
        public bool HasFilters()
        {
            return !string.IsNullOrEmpty(Marca)
                || !string.IsNullOrEmpty(Modelo)
                || !string.IsNullOrEmpty(Combustivel)
                || Ano.HasValue
                || !string.IsNullOrEmpty(Categoria)
                || PrecoMin.HasValue
                || PrecoMax.HasValue
                || KmMin.HasValue
                || KmMax.HasValue;
        }
    }
}
</file>

<file path="Models/Entities/CarrinhoItem.cs">
namespace AutoMarket.Models.Entities
{
    public class CarrinhoItem
    {
        public int VeiculoId { get; set; }
        public string Titulo { get; set; }
        public string Marca { get; set; }
        public string Modelo { get; set; }
        public decimal Preco { get; set; }
        public string? ImagemCapa { get; set; }
    }
}
</file>

<file path="Models/Entities/Carro.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    public class Carro
    {
        [Key]
        public int Id { get; set; }

        // --- Dados do veículo ---
        [Required]
        [StringLength(100)]
        public string Titulo { get; set; } // Ex: "Mclaren MP4-4 do Senna"

        [Required]
        [StringLength(50)]
        public string Marca { get; set; } // Ex: Mclaren

        [Required]
        [StringLength(50)]
        public string Modelo { get; set; } // Ex: MP4-4

        [Required]
        public int CategoriaId { get; set; }

        [ForeignKey("CategoriaId")]
        public Categoria Categoria { get; set; }

        [Required]
        public int Ano { get; set; }

        [Required]
        [Column(TypeName = "decimal(18,2)")]
        public decimal Preco { get; set; }

        public int Km { get; set; }

        // Dropdowns fixos (vamos simplificar como string por agora, ou Enum se preferires rigidez)
        [Required]
        [StringLength(20)]
        public string Combustivel { get; set; }

        [Required]
        [StringLength(20)]
        public string Caixa { get; set; }

        [Required]
        [StringLength(100)]
        public string Localizacao { get; set; } // Ex: "Lisboa"

        [Required]
        [StringLength(2000)]
        public string Descricao { get; set; }

        // --- Estado e Controlo ---

        public EstadoCarro Estado { get; set; } = EstadoCarro.Ativo;

        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        // --- Relacao com Vendedor (1 Vendedor -> N Carros) ---
        [Required]
        public int VendedorId { get; set; }

        [ForeignKey("VendedorId")]
        public Vendedor Vendedor { get; set; }

        // --- Relação com Imagens (1 Carro -> N Imagens) ---
        public ICollection<CarroImagem> Imagens { get; set; } = [];
    }
}
</file>

<file path="Models/Entities/CarroImagem.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class CarroImagem
    {
        [Key] //Desnecessária esta data annotation?? 
        public int Id { get; set; }

        [Required]
        [StringLength(255)]
        public string CaminhoFicheiro { get; set; } // ex: "carro_123_guid.jpg"

        [Required]
        [StringLength(50)]
        public string ContentType { get; set; } // ex: "image/jpeg"

        [Display(Name = "Capa")]
        public bool IsCapa { get; set; } = false; // Define se é a foto de capa

        // --- Relação com Carro ---
        public int CarroId { get; set; }

        [ForeignKey("CarroId")]
        public Carro Carro { get; set; }
    }
}
</file>

<file path="Models/Entities/Categoria.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Entities
{
    public class Categoria
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(50)]
        public string Nome { get; set; } // Ex: "SUV", "Sedan"

        // Relação: Uma categoria tem muitos carros
        public ICollection<Veiculo> Veiculos { get; set; } = new List<Veiculo>();
    }
}
</file>

<file path="Models/Entities/Comprador.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{

	public class Comprador
	{
		[Key]
		public int Id { get; set; }

		// Relação 1:1 com Utilizador
		[Required]
		public string UserId { get; set; } //Foreign Key: coluna na tabela Compradores. Isto liga as tabelas

		[ForeignKey("UserId")]
		public Utilizador User { get; set; } //Navigation Property: não existe coluna na BD. Serve para poder fazer comprador.User.Nome sem ter de fazer uma query manual SQL

		//Dados específicos do Comprador
		public bool ReceberNotificacoes { get; set; }

        // TODO: Histórico de compras do Comprador

        // Lista de carros favoritos do Comprador (Many-to-Many com Car)
        // public ICollection<Car> Favoritos { get; set; }
        // TODO: Implementar a tabela de junção para favoritos?
    }
}
</file>

<file path="Models/Entities/Denuncia.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public enum EstadoDenuncia
    {
        Aberta = 0,
        EmAnalise = 1,
        Encerrada = 2
    }

    public class Denuncia : IValidatableObject
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string DenuncianteId { get; set; } = string.Empty;

        [ForeignKey("DenuncianteId")]
        public Utilizador? Denunciante { get; set; }

        // Alvos (Opcionais na BD, Obrigatorios na Logica)
        public int? TargetVeiculoId { get; set; }
        public Veiculo? TargetVeiculo { get; set; }

        public string? TargetUserId { get; set; }
        public Utilizador? TargetUser { get; set; }

        [Required(ErrorMessage = "O motivo й obrigatуrio.")]
        [StringLength(500)]
        public string Motivo { get; set; } = string.Empty;

        public EstadoDenuncia Estado { get; set; } = EstadoDenuncia.Aberta;
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        // Gestгo Admin
        public string? DecisaoAdmin { get; set; }

        [StringLength(450)]
        public string? AnalisadoPorAdminId { get; set; }

        [ForeignKey("AnalisadoPorAdminId")]
        public Utilizador? AnalisadoPorAdmin { get; set; }

        // Validaзгo: Garante que escolheu pelo menos um alvo
        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (TargetVeiculoId == null && string.IsNullOrEmpty(TargetUserId))
            {
                yield return new ValidationResult(
                    "Tem de denunciar um Veнculo ou um Utilizador.",
                    new[] { nameof(TargetVeiculoId), nameof(TargetUserId) }
                );
            }
        }
    }
}
</file>

<file path="Models/Entities/Mensagem.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class Mensagem
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(1000)]
        public string Conteudo { get; set; } = string.Empty;

        public DateTime DataEnvio { get; set; } = DateTime.UtcNow;
        public bool Lida { get; set; } = false;

        [Required]
        public string RemetenteId { get; set; } = string.Empty;

        [ForeignKey("RemetenteId")]
        public Utilizador Remetente { get; set; }

        [Required]
        public string DestinatarioId { get; set; } = string.Empty;

        [ForeignKey("DestinatarioId")]
        public Utilizador Destinatario { get; set; }

        // Contexto: Sobre que veículo estão a falar?
        public int? VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo? Veiculo { get; set; }
    }
}
</file>

<file path="Models/Entities/Reserva.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class Reserva
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey(nameof(VeiculoId))]
        public Veiculo Veiculo { get; set; } = null!;

        [Required]
        public int CompradorId { get; set; }

        [ForeignKey(nameof(CompradorId))]
        public Comprador Comprador { get; set; } = null!;

        [Required]
        public DateTime DataReserva { get; set; } = DateTime.UtcNow;

        [Required]
        public DateTime DataExpiracao { get; set; }

        [Required]
        public EstadoReserva Estado { get; set; } = EstadoReserva.Ativa;
    }
}
</file>

<file path="Models/Entities/Transacao.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    public class Transacao
    {
        [Key]
        public int Id { get; set; }

        [Display(Name = "Data da Transação")]
        public DateTime DataTransacao { get; set; } = DateTime.UtcNow;

        [Required]
        [DataType(DataType.Currency)]
        public decimal ValorPago { get; set; }

        public MetodoPagamento Metodo { get; set; }

        // Exemplo: Pendente, Pago, Cancelado
        public EstadoTransacao Estado { get; set; } = EstadoTransacao.Pendente;

        // Snapshot dos dados para fatura (caso o user mude de morada depois)
        public string MoradaEnvioSnapshot { get; set; } = string.Empty;
        public string NifFaturacaoSnapshot { get; set; } = string.Empty;

        // Relações
        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; }

        [Required]
        public int CompradorId { get; set; }

        [ForeignKey("CompradorId")]
        public Comprador Comprador { get; set; }
    }
}
</file>

<file path="Models/Entities/Utilizador.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Attributes;
using Microsoft.AspNetCore.Identity;

namespace AutoMarket.Models.Entities
{
    // Utilizador é a classe base para todos os tipos de utilizadores no sistema
    public class Utilizador : IdentityUser, ISoftDelete
    {
        [Required(ErrorMessage = "O nome é obrigatório.")]
        [MaxLength(100, ErrorMessage = "O nome não pode exceder 100 caracteres.")]
        [Display(Name = "Nome Completo")]
        [PersonalData]
        public string Nome { get; set; } = string.Empty;

        [Required(ErrorMessage = "A morada é obrigatória.")]
        [MaxLength(200, ErrorMessage = "A morada não pode exceder 200 caracteres.")]
        [PersonalData]
        public string Morada { get; set; } = string.Empty;

        [DataType(DataType.Date)]
        [Display(Name = "Data de Registo")]
        public DateTime DataRegisto { get; set; } = DateTime.UtcNow;

        [MaxLength(50, ErrorMessage = "Os contactos não podem exceder 50 caracteres.")]
        [PersonalData]
        public string Contacto { get; set; } = string.Empty;

        [StringLength(9)]
        [NifPortugues(ErrorMessage = "O NIF introduzido não é válido.")]
        [PersonalData]
        public string? NIF { get; set; }
        // POde ser null se o utilizador ainda não tiver preenchido os dados fiscais

        //Campos para o bloqueio administrativo 
        public bool IsBlocked { get; set; } = false;
        public string? BlockReason { get; set; }    

        // soft Delete
        public bool IsDeleted { get; set; } = false;
    }
}
</file>

<file path="Models/Entities/Veiculo.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Modelo genйrico para Veнculos (Carros, Motas, etc.)
    /// Representa um veнculo listado para venda no catбlogo.
    /// </summary>
    public class Veiculo
    {
        [Key]
        public int Id { get; set; }

        // --- Dados do veнculo ---
        [Required(ErrorMessage = "O tнtulo й obrigatуrio")]
        [StringLength(100, ErrorMessage = "Mбximo de 100 caracteres.")]
        [Display(Name = "Tнtulo do Anъncio")]
        public string Titulo { get; set; } // Ex: "McLaren MP4-4 do Senna"

        [Required]
        [StringLength(50)]
        public string Marca { get; set; } // Ex: McLaren

        [Required]
        [StringLength(50)]
        public string Modelo { get; set; } // Ex: MP4-4

        [Required]
        [Display(Name = "Categoria")]
        public int CategoriaId { get; set; }

        [ForeignKey("CategoriaId")]
        public Categoria Categoria { get; set; }

        [Required]
        [Display(Name = "Ano")]
        [Range(1900, 2100, ErrorMessage = "Ano invбlido.")]
        public int Ano { get; set; }

        [Required]
        [DataType(DataType.Currency)]
        [Display(Name = "Preзo")]
        [Range(0, 99999999, ErrorMessage = "Valor invбlido.")]
        public decimal Preco { get; set; }

        [Display(Name = "Quilуmetros")]
        [Range(0, int.MaxValue, ErrorMessage = "Valor nгo pode ser negativo.")]
        public int Km { get; set; }

        [Required]
        [StringLength(20)]
        [Display(Name = "Combustнvel")]
        public string Combustivel { get; set; }

        [Required]
        [StringLength(20)]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; }

        [Required]
        [StringLength(100)]
        [Display(Name = "Localizaзгo")]
        public string Localizacao { get; set; }

        [StringLength(50)]
        [Display(Name = "Condiзгo")]
        public string? Condicao { get; set; }

        [Required]
        [DataType(DataType.MultilineText)]
        [StringLength(2000, ErrorMessage = "A descriзгo й demasiado longa.")]
        [Display(Name = "Descriзгo Detalhada")]
        public string Descricao { get; set; }

        // --- Estado e Controlo ---
        [Display(Name = "Estado")]
        public EstadoVeiculo Estado { get; set; } = EstadoVeiculo.Ativo;

        [Display(Name = "Publicado em")]
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        // --- Relaзгo com Vendedor (1 Vendedor -> N Veнculos) ---
        [Required]
        public int VendedorId { get; set; }

        [ForeignKey("VendedorId")]
        public Vendedor Vendedor { get; set; }

        // --- Relaзгo com Imagens (1 Veнculo -> N Imagens) ---
        public ICollection<VeiculoImagem> Imagens { get; set; } = [];
    }
}
</file>

<file path="Models/Entities/VeiculoImagem.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Modelo que representa uma imagem associada a um veнculo.
    /// Um veнculo pode ter mъltiplas imagens.
    /// </summary>
    public class VeiculoImagem
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(255)]
        public string CaminhoFicheiro { get; set; } // ex: "veiculo_123_guid.jpg"

        [Required]
        [StringLength(50)]
        public string ContentType { get; set; } // ex: "image/jpeg"

        [Display(Name = "Capa")]
        public bool IsCapa { get; set; } = false; // Define se й a foto de capa

        // --- Relaзгo com Veнculo ---
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; }
    }
}
</file>

<file path="Models/Entities/Vendedor.cs">
using AutoMarket.Models.Enums;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class Vendedor
    {
        [Key] //o Identity já define propriedades com "Id" no nome como Primary Key mas senior developers preferem explicitar na mesma caso o nome da propriedade seja alterado e serve de documentação
        public int Id { get; set; }

        //Relação 1:1 com Utilizador
        [Required]
        public string UserId { get; set; }

        [ForeignKey("UserId")]
        public Utilizador User { get; set; } = null!;

        [Required] // EF já faz por defeito a propriedade enum como NOT NULL na BD mas é boa prática explicitar
        public TipoConta TipoConta { get; set; }

        //Gestão de Aprovação - usado no backoffice admin  
        public StatusAprovacao Status { get; set; } = StatusAprovacao.Pendente;

        //Registo de quem aprovou (auditoria)
        [StringLength(450)]
        public string? ApprovedByAdminId { get; set; } //ID do admin que aprovou o vendedor

        [ForeignKey("ApprovedByAdminId")]
        public Utilizador? ApprovedByAdmin { get; set; } //Navegação para o admin que aprovou o vendedor

        [StringLength(500)] 
        public string? MotivoRejeicao { get; set; } //Motivo da rejeição, se aplicável

        //Lista de carros que este vendedor tem à venda
        public ICollection<Veiculo> VeiculosAVenda { get; set; } = [];

        // -- Métodos de Domínio (Lógica de negócio) --

        public void Aprovar(string adminId)
        {
            if (Status != StatusAprovacao.Pendente)
                throw new InvalidOperationException($"Apenas vendedores pendentes podem ser aprovados. Estado atual: {Status}");

            Status = StatusAprovacao.Aprovado;
            ApprovedByAdminId = adminId;
            MotivoRejeicao = null; // Limpa o motivo de rejeição se houver
        }

        public void Rejeitar(string adminId, string motivo)
        {
            if (Status != StatusAprovacao.Pendente)
                throw new InvalidOperationException($"Apenas vendedores pendentes podem ser rejeitados.");

            Status = StatusAprovacao.Rejeitado;
            ApprovedByAdminId = adminId;
            MotivoRejeicao = motivo; // Define o motivo da rejeição 
        }

        public void Ressubmeter()
        {
            if (Status != StatusAprovacao.Rejeitado)
                throw new InvalidOperationException($"Apenas vendedores rejeitados podem ser ressubmetidos. Estado atual: {Status}");
            
            Status = StatusAprovacao.Pendente;
            MotivoRejeicao = null; // Limpa o motivo anterior
        }
    }
}
</file>

<file path="Models/Entities/Visita.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    public class Visita
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey(nameof(VeiculoId))]
        public Veiculo Veiculo { get; set; } = null!;

        [Required]
        public int CompradorId { get; set; }

        [ForeignKey(nameof(CompradorId))]
        public Comprador Comprador { get; set; } = null!;

        [Required]
        public int VendedorId { get; set; }

        [ForeignKey(nameof(VendedorId))]
        public Vendedor Vendedor { get; set; } = null!;

        [Required]
        public DateTime DataHoraVisita { get; set; }

        [MaxLength(1000)]
        public string? Observacoes { get; set; }

        [Required]
        public EstadoVisita Estado { get; set; } = EstadoVisita.Pendente;
    }
}
</file>

<file path="Models/Enums/EstadoReserva.cs">
namespace AutoMarket.Models.Enums
{
    public enum EstadoReserva
    {
        Ativa = 0,
        Expirada = 1,
        Concluida = 2,
        Cancelada = 3
    }
}
</file>

<file path="Models/Enums/EstadoTransacao.cs">
namespace AutoMarket.Models.Enums
{
    public enum EstadoTransacao
    {
        Pendente = 0,
        Pago = 1,
        Enviado = 2,
        Cancelado = 3
    }
}
</file>

<file path="Models/Enums/EstadoVisita.cs">
namespace AutoMarket.Models.Enums
{
    public enum EstadoVisita
    {
        Pendente = 0,
        Confirmada = 1,
        Rejeitada = 2,
        Realizada = 3
    }
}
</file>

<file path="Models/Enums/MetodoPagamento.cs">
namespace AutoMarket.Models.Enums
{
    public enum MetodoPagamento
    {
        CartaoCredito = 0,
        MBWay = 1,
        Transferencia = 2,
        Numerario = 3
    }
}
</file>

<file path="Models/ViewModels/CarrinhoWidgetViewModel.cs">
namespace AutoMarket.Models.ViewModels
{
    public class CarrinhoWidgetViewModel
    {
        public int QuantidadeItens { get; set; }
        public decimal ValorTotal { get; set; }
    }
}
</file>

<file path="RaioLaserList.text">

</file>

<file path="repomix.config.json">
{
  "$schema": "https://repomix.com/schemas/latest/schema.json",
  "input": {
    "maxFileSize": 52428800
  },
  "output": {
    "filePath": "repomix-output.xml",
    "style": "xml",
    "parsableStyle": false,
    "fileSummary": true,
    "directoryStructure": true,
    "files": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "compress": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "truncateBase64": false,
    "copyToClipboard": false,
    "includeFullDirectoryStructure": false,
    "tokenCountTree": false,
    "git": {
      "sortByChanges": true,
      "sortByChangesMaxCommits": 100,
      "includeDiffs": false,
      "includeLogs": false,
      "includeLogsCount": 50
    }
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDotIgnore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "o200k_base"
  }
}
</file>

<file path="Resources/EmailResources.resx">
<?xml version="1.0" encoding="utf-8"?>
<root>
  <!-- 
    Microsoft ResX Schema 
    
    Version 2.0
    
    The primary goals of this format is to allow a simple XML format 
    that is mostly human readable. The generation and parsing of the 
    various data types are done through the TypeConverter classes 
    associated with the data types.
    
    Example:
    
    ... ado.net/XML headers & schema ...
    <resheader name="resmimetype">text/microsoft-resx</resheader>
    <resheader name="version">2.0</resheader>
    <resheader name="reader">System.Resources.ResXResourceReader, System.Windows.Forms, ...</resheader>
    <resheader name="writer">System.Resources.ResXResourceWriter, System.Windows.Forms, ...</resheader>
    <data name="Name1"><value>this is my long string</value><comment>this is a comment</comment></data>
    <data name="Color1" type="System.Drawing.Color, System.Drawing">Blue</data>
    <data name="Bitmap1" mimetype="application/x-microsoft.net.object.binary.base64">
        <value>[base64 mime encoded serialized .NET Framework object]</value>
    </data>
    <data name="Icon1" type="System.Drawing.Icon, System.Drawing" mimetype="application/x-microsoft.net.object.bytearray.base64">
        <value>[base64 mime encoded string representing a byte array form of the .NET Framework object]</value>
        <comment>This is a comment</comment>
    </data>
                
    There are any number of "resheader" rows that contain simple 
    name/value pairs.
    
    Each data row contains a name, and value. The row also contains a 
    type or mimetype. Type corresponds to a .NET class that support 
    text/value conversion through the TypeConverter architecture. 
    Classes that don't support this are serialized and stored with the 
    mimetype set.
    
    The mimetype is used for serialized objects, and tells the 
    ResXResourceReader how to depersist the object. This is currently not 
    extensible. For a given mimetype the value must be set accordingly:
    
    Note - application/x-microsoft.net.object.binary.base64 is the format 
    that the ResXResourceWriter will generate, however the reader can 
    read any of the formats listed below.
    
    mimetype: application/x-microsoft.net.object.binary.base64
    value   : The object must be serialized with 
            : System.Runtime.Serialization.Formatters.Binary.BinaryFormatter
            : and then encoded with base64 encoding.
    
    mimetype: application/x-microsoft.net.object.soap.base64
    value   : The object must be serialized with 
            : System.Runtime.Serialization.Formatters.Soap.SoapFormatter
            : and then encoded with base64 encoding.

    mimetype: application/x-microsoft.net.object.bytearray.base64
    value   : The object must be serialized into a byte array 
            : using a System.ComponentModel.TypeConverter
            : and then encoded with base64 encoding.
    -->
  <xsd:schema id="root" xmlns="" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:msdata="urn:schemas-microsoft-com:xml-msdata">
    <xsd:import namespace="http://www.w3.org/XML/1998/namespace" />
    <xsd:element name="root" msdata:IsDataSet="true">
      <xsd:complexType>
        <xsd:choice maxOccurs="unbounded">
          <xsd:element name="metadata">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" />
              </xsd:sequence>
              <xsd:attribute name="name" use="required" type="xsd:string" />
              <xsd:attribute name="type" type="xsd:string" />
              <xsd:attribute name="mimetype" type="xsd:string" />
              <xsd:attribute ref="xml:space" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="assembly">
            <xsd:complexType>
              <xsd:attribute name="alias" type="xsd:string" />
              <xsd:attribute name="name" type="xsd:string" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="data">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" msdata:Ordinal="1" />
                <xsd:element name="comment" type="xsd:string" minOccurs="0" msdata:Ordinal="2" />
              </xsd:sequence>
              <xsd:attribute name="name" type="xsd:string" use="required" msdata:Ordinal="1" />
              <xsd:attribute name="type" type="xsd:string" msdata:Ordinal="3" />
              <xsd:attribute name="mimetype" type="xsd:string" msdata:Ordinal="4" />
              <xsd:attribute ref="xml:space" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="resheader">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" msdata:Ordinal="1" />
              </xsd:sequence>
              <xsd:attribute name="name" type="xsd:string" use="required" />
            </xsd:complexType>
          </xsd:element>
        </xsd:choice>
      </xsd:complexType>
    </xsd:element>
  </xsd:schema>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>2.0</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="Email_Welcome_Header" xml:space="preserve">
    <value>Bem-vindo ao AutoMarket!</value>
  </data>
  <data name="Email_Greeting" xml:space="preserve">
    <value>Olá {0},</value>
  </data>
  <data name="Email_Confirmation_Intro" xml:space="preserve">
    <value>Obrigado por se registar no AutoMarket. Para completar o seu registo, por favor confirme o seu endereço de email clicando no botão abaixo:</value>
  </data>
  <data name="Email_Confirm_Button" xml:space="preserve">
    <value>Confirmar Email</value>
  </data>
  <data name="Email_Link_Alternative" xml:space="preserve">
    <value>Ou copie e cole o seguinte link no seu navegador:</value>
  </data>
  <data name="Email_Link_Expiry" xml:space="preserve">
    <value>Este link expirará em 24 horas.</value>
  </data>
  <data name="Email_Ignore_Message" xml:space="preserve">
    <value>Se não criou uma conta no AutoMarket, pode ignorar este email.</value>
  </data>
  <data name="Email_Footer_Copyright" xml:space="preserve">
    <value>AutoMarket &amp;copy; 2025</value>
  </data>
</root>
</file>

<file path="Services/Implementations/AuthService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Constants;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.WebUtilities;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
	public class AuthService : IAuthService
	{
		private readonly UserManager<Utilizador> _userManager;
		private readonly SignInManager<Utilizador> _signInManager;
		private readonly ApplicationDbContext _context;
		private readonly IEmailAuthService _emailAuthService;
		private readonly ILogger<AuthService> _logger;

		public AuthService(
			UserManager<Utilizador> userManager,
			SignInManager<Utilizador> signInManager,
			ApplicationDbContext context,
			IEmailAuthService emailAuthService,
			ILogger<AuthService> logger)
		{
			_userManager = userManager;
			_signInManager = signInManager;
			_context = context;
			_emailAuthService = emailAuthService;
			_logger = logger;
		}

		public async Task<RegisterResultDto> RegisterAsync(RegisterDto dto, string confirmationBaseUrl)
		{
			var errors = new List<string>();

			if (!string.IsNullOrEmpty(dto.Nif) && !NifValidator.IsValid(dto.Nif))
			{
				errors.Add("NIF invбlido. Por favor, verifique o nъmero introduzido.");
				return new RegisterResultDto(false, errors, null);
			}

			await using var transaction = await _context.Database.BeginTransactionAsync();

			try
			{
				var user = new Utilizador
				{
					UserName = dto.Email,
					Email = dto.Email,
					Nome = dto.Nome,
					Morada = dto.Morada,
					PhoneNumber = dto.Contacto,
					NIF = dto.Nif,
					DataRegisto = DateTime.UtcNow
				};

				var identityResult = await _userManager.CreateAsync(user, dto.Password);
				if (!identityResult.Succeeded)
				{
					errors.AddRange(identityResult.Errors.Select(e => e.Description));
					return new RegisterResultDto(false, errors, null);
				}

				if (dto.TipoConta == TipoConta.Vendedor || dto.TipoConta == TipoConta.Empresa)
				{
					var vendedor = new Vendedor
					{
						UserId = user.Id,
						TipoConta = dto.TipoConta,
						Status = StatusAprovacao.Pendente
					};
					_context.Vendedores.Add(vendedor);
					await _userManager.AddToRoleAsync(user, Roles.Vendedor);
				}
				else
				{
					var comprador = new Comprador
					{
						UserId = user.Id,
						ReceberNotificacoes = false
					};
					_context.Compradores.Add(comprador);
					await _userManager.AddToRoleAsync(user, Roles.Comprador);
				}

				await _context.SaveChangesAsync();
				await transaction.CommitAsync();

				var token = await _userManager.GenerateEmailConfirmationTokenAsync(user);
				var confirmationLink = QueryHelpers.AddQueryString(
					confirmationBaseUrl,
					new Dictionary<string, string?>
					{
						["userId"] = user.Id,
						["token"] = token
					});

				if (string.IsNullOrEmpty(confirmationLink))
				{
					_logger.LogError("Falha ao gerar link de confirmaзгo para {Email}", user.Email);
				}
				else
				{
					await _emailAuthService.EnviarEmailConfirmacaoAsync(user, confirmationLink);
				}

				return new RegisterResultDto(true, Enumerable.Empty<string>(), confirmationLink);
			}
			catch (Exception ex)
			{
				_logger.LogError(ex, "Erro ao registar utilizador {Email}", dto.Email);
				errors.Add("Ocorreu um erro interno. Tente novamente.");
				return new RegisterResultDto(false, errors, null);
			}
		}

		public async Task<LoginResultDto> LoginAsync(LoginDto dto)
		{
			var errors = new List<string>();

			var signInResult = await _signInManager.PasswordSignInAsync(dto.Email, dto.Password, dto.RememberMe, false);
			if (!signInResult.Succeeded)
			{
				errors.Add("Login invбlido.");
				return new LoginResultDto(false, null, errors);
			}

			var user = await _userManager.FindByEmailAsync(dto.Email);
			if (user == null)
			{
				await _signInManager.SignOutAsync();
				errors.Add("Erro inesperado ao obter dados do utilizador.");
				return new LoginResultDto(false, null, errors);
			}

			if (user.IsBlocked || user.IsDeleted)
			{
				await _signInManager.SignOutAsync();
				errors.Add("Conta bloqueada ou eliminada.");
				return new LoginResultDto(false, null, errors);
			}

			if (await _userManager.IsInRoleAsync(user, Roles.Vendedor))
			{
				var vendedor = await _context.Vendedores
					.Select(v => new { v.UserId, v.Status })
					.FirstOrDefaultAsync(v => v.UserId == user.Id);

				if (vendedor != null && vendedor.Status != StatusAprovacao.Aprovado)
				{
					_logger.LogWarning("Vendedor {Email} tentou entrar mas estб com status {Status}", user.Email, vendedor.Status);
					await _signInManager.SignOutAsync();
					return new LoginResultDto(false, nameof(StatusAprovacao.Pendente), errors);
				}
			}

			return new LoginResultDto(true, null, Enumerable.Empty<string>());
		}

		public Task LogoutAsync()
		{
			return _signInManager.SignOutAsync();
		}

		public async Task<ConfirmEmailResultDto> ConfirmEmailAsync(string userId, string token)
		{
			var errors = new List<string>();

			if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(token))
			{
				errors.Add("Link de confirmaзгo invбlido ou incompleto.");
				return new ConfirmEmailResultDto(false, errors);
			}

			var user = await _userManager.FindByIdAsync(userId);
			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado no sistema.");
				return new ConfirmEmailResultDto(false, errors);
			}

			var result = await _userManager.ConfirmEmailAsync(user, token);
			if (!result.Succeeded)
			{
				errors.AddRange(result.Errors.Select(e => e.Description));
				_logger.LogWarning("Falha na confirmaзгo de email para {UserId}: {Errors}", userId, string.Join(", ", errors));
				return new ConfirmEmailResultDto(false, errors);
			}

			return new ConfirmEmailResultDto(true, Enumerable.Empty<string>());
		}

		public async Task<UpdateNifResultDto> UpdateNifAsync(string userId, string nif)
		{
			var errors = new List<string>();

			if (string.IsNullOrEmpty(nif))
			{
				errors.Add("O NIF й obrigatуrio.");
				return new UpdateNifResultDto(false, errors);
			}

			if (!NifValidator.IsValid(nif))
			{
				errors.Add("NIF invбlido. Por favor, verifique o nъmero introduzido.");
				return new UpdateNifResultDto(false, errors);
			}

			var user = await _userManager.FindByIdAsync(userId);
			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado.");
				return new UpdateNifResultDto(false, errors);
			}

			user.NIF = nif;
			var result = await _userManager.UpdateAsync(user);
			if (!result.Succeeded)
			{
				errors.AddRange(result.Errors.Select(e => e.Description));
				return new UpdateNifResultDto(false, errors);
			}

			return new UpdateNifResultDto(true, Enumerable.Empty<string>());
		}

		public async Task<SoftDeleteResultDto> SoftDeleteAsync(string userId)
		{
			var errors = new List<string>();
			var user = await _userManager.FindByIdAsync(userId);

			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado.");
				return new SoftDeleteResultDto(false, errors);
			}

			try
			{
				await _signInManager.SignOutAsync();

				user.IsDeleted = true;

				var deletedEmailSuffix = $"deleted_{Guid.NewGuid():N}@automarket.invalid";
				user.Email = deletedEmailSuffix;
				user.UserName = deletedEmailSuffix;
				user.NormalizedEmail = deletedEmailSuffix.ToUpperInvariant();
				user.NormalizedUserName = deletedEmailSuffix.ToUpperInvariant();
				user.Nome = "Utilizador Eliminado";
				user.NIF = null;
				user.Morada = string.Empty;
				user.Contacto = string.Empty;

				var result = await _userManager.UpdateAsync(user);
				if (!result.Succeeded)
				{
					errors.AddRange(result.Errors.Select(e => e.Description));
					foreach (var error in result.Errors)
					{
						_logger.LogError("Erro ao atualizar utilizador {Id} apуs soft delete: {Error}", user.Id, error.Description);
					}
					return new SoftDeleteResultDto(false, errors);
				}

				_logger.LogInformation("Utilizador {Id} apagou a conta (Soft Delete). Sessгo invalidada.", user.Id);
				return new SoftDeleteResultDto(true, Enumerable.Empty<string>());
			}
			catch (Exception ex)
			{
				_logger.LogError(ex, "Erro crнtico ao apagar conta do utilizador {Id}", user.Id);
				errors.Add("Erro crнtico ao apagar conta.");
				return new SoftDeleteResultDto(false, errors);
			}
		}
	}
}
</file>

<file path="Services/Implementations/CarrinhoService.cs">
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Implementations
{
    public class CarrinhoService : ICarrinhoService
    {
        private readonly IHttpContextAccessor _httpContextAccessor;
        private const string SessionKey = "CarrinhoCompras";
        private const string DefaultImagePlaceholder = "sem-imagem.jpg";
        // Precisamos do IHttpContextAccessor para aceder à Session fora de um Controller
        public CarrinhoService(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        private ISession Session
        {
            get
            {
                var context = _httpContextAccessor.HttpContext;
                if (context == null)
                {
                    throw new InvalidOperationException("HttpContext is null. Ensure this service is called within an HTTP request context.");
                }
                if (context.Session == null)
                {
                    throw new InvalidOperationException("Session is not available. Ensure that session middleware is configured.");
                }
                return context.Session;
            }
        }

        public List<CarrinhoItem> GetItens()
        {
            return Session.GetObjectFromJson<List<CarrinhoItem>>(SessionKey) ?? new List<CarrinhoItem>();
        }

        public void AdicionarItem(Veiculo veiculo)
        {
            if (veiculo == null) { throw new ArgumentNullException(nameof(veiculo)); }

            var itens = GetItens();

            // Como é um veículo único, verificamos se já lá está
            if (!itens.Any(i => i.VeiculoId == veiculo.Id))
            {
                itens.Add(new CarrinhoItem
                {
                    VeiculoId = veiculo.Id,
                    Titulo = veiculo.Titulo,
                    Marca = veiculo.Marca,
                    Modelo = veiculo.Modelo,
                    Preco = veiculo.Preco,
                    // Pega a primeira imagem ou uma placeholder
                    ImagemCapa = veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro ?? DefaultImagePlaceholder
                });

                Session.SetObjectAsJson(SessionKey, itens);
            }
        }

        public void RemoverItem(int veiculoId)
        {
            var itens = GetItens();
            var item = itens.FirstOrDefault(i => i.VeiculoId == veiculoId);

            if (item != null)
            {
                itens.Remove(item);
                Session.SetObjectAsJson(SessionKey, itens);
            }
        }

        public void LimparCarrinho()
        {
            Session.Remove(SessionKey);
        }

        public decimal GetTotal()
        {
            return GetItens().Sum(i => i.Preco);
        }

        public int GetContagem()
        {
            return GetItens().Count;
        }
    }
}
</file>

<file path="Services/Implementations/CheckoutService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.DTOs;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    public class CheckoutService : ICheckoutService
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ICarrinhoService _carrinhoService;
        private readonly ILogger<CheckoutService> _logger;

        public CheckoutService(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ICarrinhoService carrinhoService,
            ILogger<CheckoutService> logger)
        {
            _context = context;
            _userManager = userManager;
            _carrinhoService = carrinhoService;
            _logger = logger;
        }

        public async Task<CheckoutInitDto?> GetCheckoutAsync(string userId)
        {
            var user = await _userManager.FindByIdAsync(userId);
            if (user == null) return null;

            var carrinhoItens = _carrinhoService.GetItens();
            if (!carrinhoItens.Any()) return null;

            return new CheckoutInitDto(
                user.Nome,
                user.Morada ?? string.Empty,
                user.NIF,
                _carrinhoService.GetTotal());
        }

        public async Task<CheckoutProcessResultDto> ProcessAsync(string userId, CheckoutInputDto input)
        {
            var errors = new List<string>();
            var itensCarrinho = _carrinhoService.GetItens();
            if (!itensCarrinho.Any())
            {
                errors.Add("O carrinho está vazio.");
                return new CheckoutProcessResultDto(false, null, errors);
            }

            var user = await _userManager.FindByIdAsync(userId);
            if (user == null)
            {
                errors.Add("Utilizador não encontrado.");
                return new CheckoutProcessResultDto(false, null, errors);
            }

            if (input.QueroFaturaComNif && string.IsNullOrEmpty(user.NIF) && !string.IsNullOrEmpty(input.NifFaturacao))
            {
                if (!NifValidator.IsValid(input.NifFaturacao))
                {
                    errors.Add("NIF inválido. Por favor, verifique o número introduzido.");
                    return new CheckoutProcessResultDto(false, null, errors);
                }

                user.NIF = input.NifFaturacao;
                await _userManager.UpdateAsync(user);
            }

            await using var dbTransaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var comprador = await _context.Compradores.FirstOrDefaultAsync(c => c.UserId == user.Id);
                if (comprador == null)
                {
                    comprador = new Comprador { UserId = user.Id };
                    _context.Add(comprador);
                    await _context.SaveChangesAsync();
                }

                var transacoesIds = new List<int>();

                foreach (var item in itensCarrinho)
                {
                    var veiculoDb = await _context.Veiculos.FindAsync(item.VeiculoId);
                    if (veiculoDb == null || veiculoDb.Estado != EstadoVeiculo.Ativo)
                    {
                        throw new InvalidOperationException($"O veículo {item.Marca} {item.Modelo} já não está disponível.");
                    }

                    var transacao = new Transacao
                    {
                        DataTransacao = DateTime.UtcNow,
                        ValorPago = item.Preco,
                        Metodo = input.MetodoPagamento,
                        Estado = EstadoTransacao.Pendente,
                        CompradorId = comprador.Id,
                        VeiculoId = item.VeiculoId,
                        NifFaturacaoSnapshot = input.QueroFaturaComNif ? input.NifFaturacao : null,
                        MoradaEnvioSnapshot = $"{input.Morada}, {input.CodigoPostal}"
                    };

                    _context.Transacoes.Add(transacao);
                    veiculoDb.Estado = EstadoVeiculo.Reservado;
                    transacoesIds.Add(transacao.Id);
                }

                await _context.SaveChangesAsync();
                await dbTransaction.CommitAsync();

                _carrinhoService.LimparCarrinho();

                return new CheckoutProcessResultDto(true, transacoesIds.FirstOrDefault(), Enumerable.Empty<string>());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao processar compra para o utilizador {UserId}", user.Id);
                errors.Add(ex.Message);
                return new CheckoutProcessResultDto(false, null, errors);
            }
        }

        public async Task<TransacaoDto?> GetTransacaoAsync(string userId, int transacaoId)
        {
            var transacao = await _context.Transacoes
                .Include(t => t.Comprador)
                .FirstOrDefaultAsync(t => t.Id == transacaoId);

            if (transacao == null || transacao.Comprador.UserId != userId)
            {
                return null;
            }

            return new TransacaoDto(
                transacao.Id,
                transacao.ValorPago,
                transacao.Estado,
                transacao.DataTransacao,
                string.IsNullOrWhiteSpace(transacao.NifFaturacaoSnapshot) ? null : transacao.NifFaturacaoSnapshot,
                transacao.MoradaEnvioSnapshot);
        }
    }
}
</file>

<file path="Services/Implementations/EmailAuthService.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Http;

namespace AutoMarket.Services.Implementations
{
    public class EmailAuthService : IEmailAuthService
    {
        private readonly IEmailSender _emailSender;
        private readonly EmailTemplateService _emailTemplateService;
        private readonly ILogger<EmailAuthService> _logger;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public EmailAuthService(
            IEmailSender emailSender,
            EmailTemplateService emailTemplateService,
            ILogger<EmailAuthService> logger,
            IHttpContextAccessor httpContextAccessor)
        {
            _emailSender = emailSender;
            _emailTemplateService = emailTemplateService;
            _logger = logger;
            _httpContextAccessor = httpContextAccessor;
        }

        public async Task EnviarEmailConfirmacaoAsync(Utilizador user, string confirmationLink)
        {   // Guard Clause
            if (string.IsNullOrEmpty(user.Email))
            {
                _logger.LogError("Tentativa de enviar email para utilizador {UserId} sem email definido.", user.Id);
                return; // Ou lançar exceção: throw new InvalidOperationException("User email cannot be null");
            }

            try
            {
                // Se estivermos fora de um pedido HTTP (ex: background job), isto pode ser null, 
                // mas no fluxo de Registo existe sempre.
                // passar o contexto
                var httpContext = _httpContextAccessor.HttpContext;
                if (httpContext == null)
                    {
                        _logger.LogWarning("HttpContext não disponível para renderizar template de email para {Email}", user.Email);
                        // Consider using the static fallback method or a pre-rendered template
                        return;
                    }

                var emailBody = await _emailTemplateService.GenerateEmailConfirmationTemplateAsync(
                    user.Nome,
                    confirmationLink,
                    httpContext 
                );

                // 2. Enviar
                await _emailSender.SendEmailAsync(
                    user.Email,
                    "Bem-vindo ao AutoMarket - Confirme a sua conta",
                    emailBody
                );

                _logger.LogInformation("Email de confirmação enviado para {Email}", user.Email);
            }
            catch (Exception ex)
            {
                // Logamos o erro aqui para não "rebentar" o registo do utilizador
                _logger.LogError(ex, "Falha crítica ao enviar email para {Email}", user.Email);
                // Não fazemos throw para não crashar o registo do user, apenas logamos o erro de envio.
            }
        }
        
    }
}
</file>

<file path="Services/Implementations/EmailFailureTracker.cs">
using System.Collections.Concurrent;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Tracks email sending failures for circuit breaker pattern.
    /// </summary>
    public class EmailFailureTracker
    {
        private readonly ConcurrentDictionary<string, FailureInfo> _failures = new();
        private readonly int _maxFailures;
        private readonly TimeSpan _failureWindow;
        private readonly TimeSpan _circuitBreakerTimeout;

        public EmailFailureTracker(int maxFailures = 5, TimeSpan? failureWindow = null, TimeSpan? circuitBreakerTimeout = null)
        {
            _maxFailures = maxFailures;
            _failureWindow = failureWindow ?? TimeSpan.FromMinutes(5);
            _circuitBreakerTimeout = circuitBreakerTimeout ?? TimeSpan.FromMinutes(1);
        }

        public void RecordFailure()
        {
            var now = DateTime.UtcNow;
            var key = "global"; // Track global failures

            _failures.AddOrUpdate(key,
                new FailureInfo { Count = 1, FirstFailure = now, LastFailure = now, CircuitOpenUntil = null },
                (k, existing) =>
                {
                    // Reset if outside failure window
                    if (now - existing.FirstFailure > _failureWindow)
                    {
                        return new FailureInfo { Count = 1, FirstFailure = now, LastFailure = now, CircuitOpenUntil = null };
                    }

                    var newCount = existing.Count + 1;
                    var circuitOpenUntil = newCount >= _maxFailures 
                        ? now.Add(_circuitBreakerTimeout) 
                        : existing.CircuitOpenUntil;

                    return new FailureInfo
                    {
                        Count = newCount,
                        FirstFailure = existing.FirstFailure,
                        LastFailure = now,
                        CircuitOpenUntil = circuitOpenUntil
                    };
                });
        }

        public void RecordSuccess()
        {
            _failures.TryRemove("global", out _);
        }

        public bool IsCircuitOpen()
        {
            if (!_failures.TryGetValue("global", out var info))
                return false;

            if (info.CircuitOpenUntil == null)
                return false;

            if (DateTime.UtcNow < info.CircuitOpenUntil.Value)
                return true;

            // Circuit breaker timeout expired, reset
            _failures.TryRemove("global", out _);
            return false;
        }

        public int GetFailureCount()
        {
            return _failures.TryGetValue("global", out var info) ? info.Count : 0;
        }

        private class FailureInfo
        {
            public int Count { get; set; }
            public DateTime FirstFailure { get; set; }
            public DateTime LastFailure { get; set; }
            public DateTime? CircuitOpenUntil { get; set; }
        }
    }
}
</file>

<file path="Services/Implementations/EmailSender.cs">
using MailKit.Net.Smtp;
using MailKit.Security;
using MimeKit;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for sending emails using SMTP via MailKit.
    /// </summary>
    public class EmailSender : IEmailSender
    {
        private readonly IConfiguration _configuration;
        private readonly ILogger<EmailSender> _logger;
        private readonly EmailFailureTracker _failureTracker;
        private int _failureCount = 0;

        public EmailSender(IConfiguration configuration, ILogger<EmailSender> logger, EmailFailureTracker failureTracker)
        {
            _configuration = configuration;
            _logger = logger;
            _failureTracker = failureTracker;
        }

        public async Task SendEmailAsync(string to, string subject, string message, CancellationToken cancellationToken = default)
        {
            // Circuit breaker: fail fast if too many recent failures
            if (_failureTracker.IsCircuitOpen())
            {
                _logger.LogWarning("Email circuit breaker is OPEN. Skipping email send to {To}. Total failures: {FailureCount}", 
                    to, _failureTracker.GetFailureCount());
                throw new InvalidOperationException("Email service is temporarily unavailable due to repeated failures. Please try again later.");
            }

            try
            {
                var emailSettings = _configuration.GetSection("EmailSettings");
                var smtpServer = emailSettings["SmtpServer"];
                var smtpPort = emailSettings.GetValue("SmtpPort", 587);
                var smtpUsername = emailSettings["SmtpUsername"];
                var smtpPassword = emailSettings["SmtpPassword"];
                var fromEmail = emailSettings["FromEmail"];
                var fromName = emailSettings["FromName"] ?? "AutoMarket";
                
                // Get SecureSocketOptions from configuration (defaults to StartTls)
                var secureSocketOptionString = emailSettings["SecureSocketOptions"] ?? "StartTls";
                var secureSocketOptions = ParseSecureSocketOptions(secureSocketOptionString);

                // If email settings are not configured, log and return (for development)
                if (string.IsNullOrEmpty(smtpServer) || string.IsNullOrEmpty(smtpUsername) || string.IsNullOrEmpty(smtpPassword) || string.IsNullOrEmpty(fromEmail))
                {
                    _logger.LogWarning("Email settings not configured. Email not sent to {To}. Subject: {Subject}", to, subject);
                    _logger.LogInformation("Email would be sent to: {To}\nSubject: {Subject}\nMessage: {Message}", to, subject, message);
                    return;
                }

                var email = new MimeMessage();
                email.From.Add(new MailboxAddress(fromName, fromEmail));
                email.To.Add(MailboxAddress.Parse(to));
                email.Subject = subject;

                var bodyBuilder = new BodyBuilder
                {
                    HtmlBody = message
                };
                email.Body = bodyBuilder.ToMessageBody();

                using var client = new SmtpClient();
                
                try
                {
                    await client.ConnectAsync(smtpServer, smtpPort, secureSocketOptions, cancellationToken);
                }
                catch (SmtpCommandException ex)
                {
                    _logger.LogError(ex, "SMTP connection error: Failed to connect to {Server}:{Port} with {SecureOption}", smtpServer, smtpPort, secureSocketOptions);
                    RecordFailure();
                    throw new InvalidOperationException($"Failed to connect to SMTP server {smtpServer}:{smtpPort}", ex);
                }
                catch (SmtpProtocolException ex)
                {
                    _logger.LogError(ex, "SMTP protocol error: Failed to connect to {Server}:{Port}", smtpServer, smtpPort);
                    RecordFailure();
                    throw new InvalidOperationException($"SMTP protocol error connecting to {smtpServer}:{smtpPort}", ex);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogWarning("Email connection was cancelled for {To}", to);
                    throw;
                }

                try
                {
                    await client.AuthenticateAsync(smtpUsername, smtpPassword, cancellationToken);
                }
                catch (AuthenticationException ex)
                {
                    _logger.LogError(ex, "SMTP authentication failed on {Server}", smtpServer);
                    RecordFailure();
                    throw new UnauthorizedAccessException($"SMTP authentication failed for {smtpServer}", ex);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogWarning("Email authentication was cancelled for {To}", to);
                    throw;
                }
                
                try
                {
                    await client.SendAsync(email, cancellationToken);
                    _logger.LogInformation("Email sent successfully to {To}", to);
                    _failureTracker.RecordSuccess();
                    _failureCount = 0;
                }
                catch (SmtpCommandException ex)
                {
                    _logger.LogError(ex, "SMTP send error: Failed to send email to {To}", to);
                    RecordFailure();
                    throw new InvalidOperationException($"Failed to send email to {to}", ex);
                }
                finally
                {
                    if (client.IsConnected)
                    {
                        await client.DisconnectAsync(true, cancellationToken);
                    }
                }
            }
            catch (OperationCanceledException)
            {
                _logger.LogWarning("Email send operation was cancelled for {To}", to);
                throw;
            }
            catch (InvalidOperationException ex)
            {
                _logger.LogError(ex, "Email send failed for {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                throw;
            }
            catch (UnauthorizedAccessException ex)
            {
                _logger.LogError(ex, "Email authentication failed for {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                throw;
            }
            catch (Exception ex)
            {
                RecordFailure();
                _logger.LogError(ex, "Unexpected error sending email to {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                // Don't throw unexpected errors - we don't want email failures to break user registration
                // In production, you might want to queue the email for retry
            }
        }

        private void RecordFailure()
        {
            _failureTracker.RecordFailure();
            Interlocked.Increment(ref _failureCount);
        }

        /// <summary>
        /// Gets the current failure count for monitoring/metrics.
        /// </summary>
        public int GetFailureCount() => _failureCount;

        private static SecureSocketOptions ParseSecureSocketOptions(string value)
        {
            return value.ToLowerInvariant() switch
            {
                "none" => SecureSocketOptions.None,
                "automatic" => SecureSocketOptions.Auto,
                "starttls" => SecureSocketOptions.StartTls,
                "starttlswhenavailable" => SecureSocketOptions.StartTlsWhenAvailable,
                "ssl" => SecureSocketOptions.SslOnConnect,
                _ => SecureSocketOptions.StartTls // Default
            };
        }
    }
}
</file>

<file path="Services/Implementations/EmailTemplateService.cs">
using AutoMarket.Models.ViewModels;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for generating email templates using Razor views.
    /// </summary>
    public class EmailTemplateService
    {
        private readonly ViewRenderService _viewRenderService;
        private readonly ILogger<EmailTemplateService> _logger;
        public EmailTemplateService(ViewRenderService viewRenderService, ILogger<EmailTemplateService> logger)
        {
            _viewRenderService = viewRenderService;
            _logger = logger;
        }

        /// <summary>
        /// Generates an HTML email template for email confirmation using Razor view.
        /// </summary>
        /// <param name="userName">The name of the user.</param>
        /// <param name="confirmationLink">The email confirmation link.</param>
        /// <param name="httpContext">The HTTP context for view rendering.</param>
        /// <returns>HTML email template as a string.</returns>
        /// <exception cref="ArgumentNullException">Thrown when userName or confirmationLink is null or empty.</exception>
        /// <exception cref="ArgumentException">Thrown when confirmationLink is not a valid URL.</exception>
        public async Task<string> GenerateEmailConfirmationTemplateAsync(string userName, string confirmationLink, HttpContext httpContext)
        {
            // Input validation
            if (string.IsNullOrWhiteSpace(userName))
                throw new ArgumentNullException(nameof(userName), "User name cannot be null or empty.");

            if (string.IsNullOrWhiteSpace(confirmationLink))
                throw new ArgumentNullException(nameof(confirmationLink), "Confirmation link cannot be null or empty.");

            if (!Uri.TryCreate(confirmationLink, UriKind.Absolute, out _))
                throw new ArgumentException("Confirmation link must be a valid absolute URL.", nameof(confirmationLink));

            var viewModel = new EmailConfirmationViewModel
            {
                UserName = userName,
                ConfirmationLink = confirmationLink
            };

            try
            {
                return await _viewRenderService.RenderToStringAsync("~/Views/Emails/EmailConfirmation.cshtml", viewModel, httpContext);
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "Failed to render email template with path prefix, trying without prefix.");
                return await _viewRenderService.RenderToStringAsync("Emails/EmailConfirmation", viewModel, httpContext);
            }
        }

        /// <summary>
        /// Generates an HTML email template for email confirmation (fallback method using string interpolation).
        /// This method is kept for backward compatibility and as a fallback if Razor view rendering fails.
        /// </summary>
        /// <param name="userName">The name of the user.</param>
        /// <param name="confirmationLink">The email confirmation link.</param>
        /// <returns>HTML email template as a string.</returns>
        /// <exception cref="ArgumentNullException">Thrown when userName or confirmationLink is null or empty.</exception>
        /// <exception cref="ArgumentException">Thrown when confirmationLink is not a valid URL.</exception>
        [Obsolete("Use GenerateEmailConfirmationTemplateAsync instead. This method is kept for backward compatibility.")]
        public static string GenerateEmailConfirmationTemplate(string userName, string confirmationLink)
        {
            // Input validation
            if (string.IsNullOrWhiteSpace(userName))
                throw new ArgumentNullException(nameof(userName), "User name cannot be null or empty.");

            if (string.IsNullOrWhiteSpace(confirmationLink))
                throw new ArgumentNullException(nameof(confirmationLink), "Confirmation link cannot be null or empty.");

            if (!Uri.TryCreate(confirmationLink, UriKind.Absolute, out _))
                throw new ArgumentException("Confirmation link must be a valid absolute URL.", nameof(confirmationLink));

            // HTML encode user input to prevent XSS
            var encodedUserName = System.Net.WebUtility.HtmlEncode(userName);
            var encodedConfirmationLink = System.Net.WebUtility.HtmlEncode(confirmationLink);

            return $@"
                <html>
                <head>
                    <style>
                        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
                        .header {{ background-color: #007bff; color: white; padding: 20px; text-align: center; }}
                        .content {{ padding: 20px; background-color: #f9f9f9; }}
                        .button {{ display: inline-block; padding: 12px 24px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }}
                        .footer {{ text-align: center; padding: 20px; font-size: 12px; color: #666; }}
                        .link-text {{ word-break: break-all; color: #007bff; }}
                    </style>
                </head>
                <body>
                    <div class=""container"">
                        <div class=""header"">
                            <h1>Bem-vindo ao AutoMarket!</h1>
                        </div>
                        <div class=""content"">
                            <p>Olá {encodedUserName},</p>
                            <p>Obrigado por se registar no AutoMarket. Para completar o seu registo, por favor confirme o seu endereço de email clicando no botão abaixo:</p>
                            <p style=""text-align: center;"">
                                <a href=""{encodedConfirmationLink}"" class=""button"">Confirmar Email</a>
                            </p>
                            <p>Ou copie e cole o seguinte link no seu navegador:</p>
                            <p class=""link-text"">{encodedConfirmationLink}</p>
                            <p>Este link expirará em 24 horas.</p>
                            <p>Se não criou uma conta no AutoMarket, pode ignorar este email.</p>
                        </div>
                        <div class=""footer"">
                            <p>&copy; 2025 AutoMarket. Todos os direitos reservados.</p>
                        </div>
                    </div>
                </body>
                </html>";
        }
    }
}
</file>

<file path="Services/Implementations/EncryptionService.cs">
using System.Security.Cryptography;
using System.Text;
using AutoMarket.Services.Interfaces;
using Microsoft.Extensions.Configuration;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Serviço de encriptação para dados sensíveis (RGPD compliance).
    /// Usa AES-256-GCM para encriptação simétrica.
    /// </summary>
    public class EncryptionService : IEncryptionService
    {
        private readonly byte[] _key;
        private readonly ILogger<EncryptionService> _logger;

        public EncryptionService(IConfiguration configuration, ILogger<EncryptionService> logger)
        {
            _logger = logger;
            
            // Obter chave de encriptação da configuração
            var encryptionKey = configuration["Encryption:Key"];
            
            if (string.IsNullOrEmpty(encryptionKey))
            {
                // Se não houver chave configurada, gerar uma e logar um aviso
                _logger.LogWarning("Chave de encriptação não configurada. Gerando chave temporária. Configure 'Encryption:Key' em appsettings.json para produção.");
                encryptionKey = GenerateTemporaryKey();
            }

            // A chave deve ter 32 bytes (256 bits) para AES-256
            _key = DeriveKey(encryptionKey, 32);
        }

        public string Encrypt(string plainText)
        {
            if (string.IsNullOrEmpty(plainText))
                return plainText;

            try
            {
                using var aes = Aes.Create();
                aes.KeySize = 256;
                aes.Mode = CipherMode.CBC;
                aes.Padding = PaddingMode.PKCS7;
                aes.Key = _key;
                aes.GenerateIV();

                using var encryptor = aes.CreateEncryptor();
                using var msEncrypt = new MemoryStream();
                
                // Escrever IV primeiro
                msEncrypt.Write(aes.IV, 0, aes.IV.Length);

                using (var csEncrypt = new CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write))
                using (var swEncrypt = new StreamWriter(csEncrypt))
                {
                    swEncrypt.Write(plainText);
                }

                var encrypted = msEncrypt.ToArray();
                return Convert.ToBase64String(encrypted);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao encriptar dados sensíveis");
                throw new InvalidOperationException("Falha na encriptação de dados sensíveis", ex);
            }
        }

        public string Decrypt(string cipherText)
        {
            if (string.IsNullOrEmpty(cipherText))
                return cipherText;

            // Se não estiver encriptado (formato Base64), retornar como está (para migração)
            if (!IsEncrypted(cipherText))
                return cipherText;

            try
            {
                var fullCipher = Convert.FromBase64String(cipherText);

                using var aes = Aes.Create();
                aes.KeySize = 256;
                aes.Mode = CipherMode.CBC;
                aes.Padding = PaddingMode.PKCS7;
                aes.Key = _key;

                // Extrair IV (primeiros 16 bytes)
                var iv = new byte[16];
                Array.Copy(fullCipher, 0, iv, 0, 16);
                aes.IV = iv;

                // Extrair dados encriptados (resto)
                var cipher = new byte[fullCipher.Length - 16];
                Array.Copy(fullCipher, 16, cipher, 0, cipher.Length);

                using var decryptor = aes.CreateDecryptor();
                using var msDecrypt = new MemoryStream(cipher);
                using var csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read);
                using var srDecrypt = new StreamReader(csDecrypt);

                return srDecrypt.ReadToEnd();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao desencriptar dados sensíveis");
                throw new InvalidOperationException("Falha na desencriptação de dados sensíveis", ex);
            }
        }

        public bool IsEncrypted(string value)
        {
            if (string.IsNullOrEmpty(value))
                return false;

            // Verificar se é Base64 válido e tem tamanho mínimo (IV + pelo menos alguns bytes)
            try
            {
                var bytes = Convert.FromBase64String(value);
                return bytes.Length >= 20; // IV (16 bytes) + pelo menos 4 bytes de dados
            }
            catch
            {
                return false;
            }
        }

        private static byte[] DeriveKey(string password, int keyLength)
        {
            using var sha256 = SHA256.Create();
            var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            
            if (hash.Length >= keyLength)
            {
                var key = new byte[keyLength];
                Array.Copy(hash, 0, key, 0, keyLength);
                return key;
            }
            
            // Se o hash for menor que o necessário, usar PBKDF2
            using var pbkdf2 = new Rfc2898DeriveBytes(password, hash, 10000, HashAlgorithmName.SHA256);
            return pbkdf2.GetBytes(keyLength);
        }

        private static string GenerateTemporaryKey()
        {
            // Gerar uma chave aleatória de 32 bytes e converter para Base64
            var keyBytes = new byte[32];
            using (var rng = RandomNumberGenerator.Create())
            {
                rng.GetBytes(keyBytes);
            }
            return Convert.ToBase64String(keyBytes);
        }
    }
}
</file>

<file path="Services/Implementations/FileService.cs">
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Serviço para gerenciar upload e processamento de ficheiros.
    /// </summary>
    public class FileService : IFileService
    {
        private readonly IWebHostEnvironment _webHostEnvironment;
        private readonly ILogger<FileService> _logger;

        public FileService(IWebHostEnvironment webHostEnvironment, ILogger<FileService> logger)
        {
            _webHostEnvironment = webHostEnvironment;
            _logger = logger;
        }

        /// <summary>
        /// Faz upload de um ficheiro único.
        /// </summary>
        public async Task<string> UploadFileAsync(IFormFile file, string uploadFolder)
        {
            try
            {
                // Validação
                if (file == null || file.Length == 0)
                    throw new ArgumentException("Ficheiro inválido ou vazio.");

                // Validar extensão
                var extension = Path.GetExtension(file.FileName).ToLower();
                var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".webp" };

                if (!allowedExtensions.Contains(extension))
                    throw new ArgumentException($"Extensão '{extension}' não permitida. Use: {string.Join(", ", allowedExtensions)}");

                // Validar tamanho (10 MB)
                const long maxFileSize = 10 * 1024 * 1024;
                if (file.Length > maxFileSize)
                    throw new ArgumentException($"Ficheiro demasiado grande. Máximo: 10 MB");

                // VALIDAÇÃO CRÍTICA: Verificar Magic Numbers (bytes de cabeçalho)
                // Previne upload de ficheiros maliciosos renomeados (ex: malware.exe -> image.jpg)
                if (!ValidateImageMagicNumbers(file))
                {
                    throw new ArgumentException("Ficheiro inválido: o conteúdo do ficheiro não corresponde a uma imagem válida.");
                }

                // Criar pasta se não existir
                var uploadPath = Path.Combine(_webHostEnvironment.WebRootPath, uploadFolder);
                if (!Directory.Exists(uploadPath))
                    Directory.CreateDirectory(uploadPath);

                // Gerar nome único com GUID
                var fileName = $"{Guid.NewGuid()}{extension}";
                var filePath = Path.Combine(uploadPath, fileName);

                // Guardar ficheiro
                using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await file.CopyToAsync(stream);
                }

                _logger.LogInformation("Ficheiro guardado com sucesso: {FileName}", fileName);
                return fileName;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao fazer upload do ficheiro: {FileName}", file?.FileName);
                throw;
            }
        }

        /// <summary>
        /// Faz upload de m�ltiplos ficheiros.
        /// </summary>
        public async Task<List<string>> UploadMultipleFilesAsync(List<IFormFile> files, string uploadFolder)
        {
            var uploadedFiles = new List<string>();

            // Validar quantidade
            if (files == null || files.Count == 0)
                throw new ArgumentException("Nenhum ficheiro fornecido.");

            const int maxFilesPerCar = 10;
            if (files.Count > maxFilesPerCar)
                throw new ArgumentException($"M�ximo de {maxFilesPerCar} ficheiros permitidos.");

            // Validar tamanho total
            const long maxTotalSize = 50 * 1024 * 1024; // 50 MB
            var totalSize = files.Sum(f => f.Length);

            if (totalSize > maxTotalSize)
                throw new ArgumentException($"Tamanho total demasiado grande. M�ximo: 50 MB");

            // Fazer upload de cada ficheiro
            foreach (var file in files)
            {
                try
                {
                    var fileName = await UploadFileAsync(file, uploadFolder);
                    uploadedFiles.Add(fileName);
                }
                catch (Exception ex)
                {
                    _logger.LogWarning(ex, "Erro ao fazer upload de um ficheiro. Continuando com os restantes.");
                    // Continuar com os pr�ximos ficheiros
                }
            }

            return uploadedFiles;
        }

        /// <summary>
        /// Valida um ficheiro.
        /// </summary>
        public bool ValidateFile(IFormFile file, long maxSizeInBytes, string[] allowedExtensions)
        {
            if (file == null || file.Length == 0)
                return false;

            // Validar extensão
            var extension = Path.GetExtension(file.FileName).ToLower();
            if (!allowedExtensions.Contains(extension))
                return false;

            // Validar tamanho
            if (file.Length > maxSizeInBytes)
                return false;

            // Validar Magic Numbers (segurança crítica)
            if (!ValidateImageMagicNumbers(file))
                return false;

            return true;
        }

        /// <summary>
        /// Obt�m mensagem de erro de valida��o de ficheiro.
        /// </summary>
        public string GetFileValidationError(IFormFile file, long maxSizeInBytes, string[] allowedExtensions)
        {
            if (file == null)
                return "Ficheiro n�o fornecido.";

            if (file.Length == 0)
                return "Ficheiro vazio.";

            // Validar extens�o
            var extension = Path.GetExtension(file.FileName).ToLower();
            if (!allowedExtensions.Contains(extension))
                return $"Extens�o '{extension}' n�o permitida. Use: {string.Join(", ", allowedExtensions)}";

            // Validar tamanho
            if (file.Length > maxSizeInBytes)
            {
                var maxSizeMB = maxSizeInBytes / (1024 * 1024);
                return $"Ficheiro demasiado grande. M�ximo: {maxSizeMB} MB";
            }

            // Validar Magic Numbers (segurança crítica)
            if (!ValidateImageMagicNumbers(file))
                return "Ficheiro inv�lido: o conte�do do ficheiro n�o corresponde a uma imagem v�lida.";

            return string.Empty;
        }

        /// <summary>
        /// Apaga um ficheiro.
        /// </summary>
        public async Task<bool> DeleteFileAsync(string filePath)
        {
            try
            {
                var fullPath = Path.Combine(_webHostEnvironment.WebRootPath, filePath);

                if (!File.Exists(fullPath))
                {
                    _logger.LogWarning("Ficheiro não encontrado: {FilePath}", fullPath);
                    return false;
                }

                File.Delete(fullPath);
                _logger.LogInformation("Ficheiro apagado com sucesso: {FilePath}", filePath);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao apagar ficheiro: {FilePath}", filePath);
                return false;
            }
        }

        /// <summary>
        /// Valida os Magic Numbers (bytes de cabeçalho) de um ficheiro de imagem.
        /// Esta validação é crítica para segurança: previne upload de ficheiros maliciosos
        /// que foram renomeados para parecer imagens (ex: malware.exe -> image.jpg).
        /// </summary>
        private bool ValidateImageMagicNumbers(IFormFile file)
        {
            try
            {
                // Ler os primeiros bytes do ficheiro (Magic Numbers)
                var header = new byte[12];
                using (var stream = file.OpenReadStream())
                {
                    var bytesRead = stream.Read(header, 0, header.Length);
                    if (bytesRead < 4) // Precisamos pelo menos 4 bytes para validar
                        return false;

                    stream.Position = 0; // Reset para permitir leitura posterior
                }

                // JPEG: FF D8 FF
                if (header[0] == 0xFF && header[1] == 0xD8 && header[2] == 0xFF)
                {
                    return true;
                }

                // PNG: 89 50 4E 47 0D 0A 1A 0A
                if (header[0] == 0x89 && header[1] == 0x50 && header[2] == 0x4E && header[3] == 0x47 &&
                    header[4] == 0x0D && header[5] == 0x0A && header[6] == 0x1A && header[7] == 0x0A)
                {
                    return true;
                }

                // WebP: RIFF ... WEBP
                // RIFF signature: 52 49 46 46 (RIFF em ASCII)
                // WebP signature começa no byte 8: 57 45 42 50 (WEBP em ASCII)
                if (header.Length >= 12 &&
                    header[0] == 0x52 && header[1] == 0x49 && header[2] == 0x46 && header[3] == 0x46 &&
                    header[8] == 0x57 && header[9] == 0x45 && header[10] == 0x42 && header[11] == 0x50)
                {
                    return true;
                }

                // GIF: 47 49 46 38 (GIF8)
                if (header[0] == 0x47 && header[1] == 0x49 && header[2] == 0x46 && header[3] == 0x38)
                {
                    return true;
                }

                // BMP: 42 4D (BM em ASCII)
                if (header[0] == 0x42 && header[1] == 0x4D)
                {
                    return true;
                }

                _logger.LogWarning("Ficheiro rejeitado: Magic Numbers não correspondem a uma imagem válida. Primeiros bytes: {Bytes}", 
                    BitConverter.ToString(header.Take(8).ToArray()));
                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao validar Magic Numbers do ficheiro: {FileName}", file.FileName);
                return false;
            }
        }
    }
}
</file>

<file path="Services/Implementations/ReservaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Options;
using AutoMarket.Models.DTOs;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Options;

namespace AutoMarket.Services.Implementations
{
    public class ReservaService : IReservaService
    {
        private readonly ApplicationDbContext _context;
        private readonly ReservationOptions _options;
        private readonly ILogger<ReservaService> _logger;

        public ReservaService(
            ApplicationDbContext context,
            IOptions<ReservationOptions> options,
            ILogger<ReservaService> logger)
        {
            _context = context;
            _options = options.Value;
            _logger = logger;
        }

        public async Task<CommandResultDto> ReservarVeiculoAsync(ReservarVeiculoDto dto, string userId)
        {
            var errors = new List<string>();

            var comprador = await _context.Compradores
                .AsNoTracking()
                .FirstOrDefaultAsync(c => c.UserId == userId);

            if (comprador == null)
            {
                errors.Add("Comprador não encontrado.");
                return new CommandResultDto(false, errors);
            }

            // Anti-spam: limite por comprador
            var reservasAtivasDoComprador = await _context.Reservas
                .CountAsync(r => r.CompradorId == comprador.Id && r.Estado == EstadoReserva.Ativa);
            if (reservasAtivasDoComprador >= _options.MaxReservasAtivasPorComprador)
            {
                errors.Add("Limite de reservas ativas atingido.");
                return new CommandResultDto(false, errors);
            }

            await using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var veiculo = await _context.Veiculos
                    .FirstOrDefaultAsync(v => v.Id == dto.VeiculoId);

                if (veiculo == null)
                {
                    errors.Add("Veículo não encontrado.");
                    return new CommandResultDto(false, errors);
                }

                if (veiculo.Estado != EstadoVeiculo.Ativo)
                {
                    errors.Add("Veículo não está disponível.");
                    return new CommandResultDto(false, errors);
                }

                // Checar reserva ativa existente (reforçado por índice único filtrado)
                var reservaAtiva = await _context.Reservas
                    .FirstOrDefaultAsync(r => r.VeiculoId == dto.VeiculoId && r.Estado == EstadoReserva.Ativa);

                if (reservaAtiva != null)
                {
                    errors.Add("Veículo já está reservado.");
                    return new CommandResultDto(false, errors);
                }

                var novaReserva = new Reserva
                {
                    VeiculoId = veiculo.Id,
                    CompradorId = comprador.Id,
                    DataExpiracao = DateTime.UtcNow.AddHours(_options.TempoExpiracaoHoras),
                    Estado = EstadoReserva.Ativa
                };

                veiculo.Estado = EstadoVeiculo.Reservado;

                _context.Reservas.Add(novaReserva);
                _context.Veiculos.Update(veiculo);

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return new CommandResultDto(true, Array.Empty<string>());
            }
            catch (DbUpdateException ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Erro ao reservar veículo {VeiculoId} para user {UserId}", dto.VeiculoId, userId);
                errors.Add("Não foi possível reservar o veículo.");
                return new CommandResultDto(false, errors);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Erro ao reservar veículo {VeiculoId} para user {UserId}", dto.VeiculoId, userId);
                errors.Add("Erro interno ao processar a reserva.");
                return new CommandResultDto(false, errors);
            }
        }
    }
}
</file>

<file path="Services/Implementations/ViewRenderService.cs">
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Abstractions;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.AspNetCore.Mvc.ViewEngines;
using Microsoft.AspNetCore.Mvc.ViewFeatures;
using Microsoft.AspNetCore.Routing;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for rendering Razor views to strings.
    /// </summary>
    public class ViewRenderService
    {
        private readonly ICompositeViewEngine _viewEngine;
        private readonly ITempDataProvider _tempDataProvider;
        private readonly IServiceProvider _serviceProvider;

        public ViewRenderService(
            ICompositeViewEngine viewEngine,
            ITempDataProvider tempDataProvider,
            IServiceProvider serviceProvider)
        {
            _viewEngine = viewEngine;
            _tempDataProvider = tempDataProvider;
            _serviceProvider = serviceProvider;
        }

        public async Task<string> RenderToStringAsync(string viewName, object model, HttpContext httpContext)
        {
            var actionContext = new ActionContext(httpContext, new RouteData(), new ActionDescriptor());
            var viewResult = _viewEngine.FindView(actionContext, viewName, false);

            if (!viewResult.Success)
            {
                viewResult = _viewEngine.GetView(viewName, viewName, false);
            }

            if (!viewResult.Success)
            {
                throw new InvalidOperationException($"Could not find view '{viewName}'. Searched locations: {string.Join(", ", viewResult.SearchedLocations)}");
            }

            var view = viewResult.View;
            using var writer = new StringWriter();
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary())
            {
                Model = model
            };

            var viewContext = new ViewContext(
                actionContext,
                view,
                viewData,
                new TempDataDictionary(httpContext, _tempDataProvider),
                writer,
                new HtmlHelperOptions()
            );

            await view.RenderAsync(viewContext);
            return writer.ToString();
        }
    }
}
</file>

<file path="Services/Interfaces/IAuthService.cs">
using AutoMarket.Models.DTOs;

namespace AutoMarket.Services.Interfaces
{
	public interface IAuthService
	{
		Task<RegisterResultDto> RegisterAsync(RegisterDto dto, string confirmationBaseUrl);
		Task<LoginResultDto> LoginAsync(LoginDto dto);
		Task LogoutAsync();
		Task<ConfirmEmailResultDto> ConfirmEmailAsync(string userId, string token);
		Task<UpdateNifResultDto> UpdateNifAsync(string userId, string nif);
		Task<SoftDeleteResultDto> SoftDeleteAsync(string userId);
	}
}
</file>

<file path="Services/Interfaces/ICheckoutService.cs">
namespace AutoMarket.Services.Interfaces
{
    public interface ICheckoutService
    {
        Task<CheckoutInitDto> GetCheckoutAsync(string userId);
        Task<CheckoutProcessResultDto> ProcessAsync(string userId, CheckoutInputDto input);
        Task<TransacaoDto?> GetTransacaoAsync(string userId, int transacaoId);
    }
}
</file>

<file path="Services/Interfaces/IEmailQueue.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface for queuing failed emails for retry.
    /// </summary>
    public interface IEmailQueue
    {
        /// <summary>
        /// Queues an email for retry.
        /// </summary>
        /// <param name="to">Recipient email address.</param>
        /// <param name="subject">Email subject.</param>
        /// <param name="message">Email body.</param>
        /// <returns>A task that represents the asynchronous operation.</returns>
        Task QueueEmailAsync(string to, string subject, string message);
    }
}
</file>

<file path="Services/Interfaces/IEmailSender.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface for sending emails.
    /// </summary>
    public interface IEmailSender
    {
        /// <summary>
        /// Sends an email asynchronously.
        /// </summary>
        /// <param name="to">Recipient email address.</param>
        /// <param name="subject">Email subject.</param>
        /// <param name="message">Email body (HTML or plain text).</param>
        /// <param name="cancellationToken">Cancellation token to cancel the operation.</param>
        /// <returns>A task that represents the asynchronous operation.</returns>
        Task SendEmailAsync(string to, string subject, string message, CancellationToken cancellationToken = default);
    }
}
</file>

<file path="Services/Interfaces/IEncryptionService.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviços de encriptação de dados sensíveis (RGPD compliance).
    /// </summary>
    public interface IEncryptionService
    {
        /// <summary>
        /// Encripta um valor sensível.
        /// </summary>
        string Encrypt(string plainText);

        /// <summary>
        /// Desencripta um valor encriptado.
        /// </summary>
        string Decrypt(string cipherText);

        /// <summary>
        /// Verifica se uma string está encriptada.
        /// </summary>
        bool IsEncrypted(string value);
    }
}
</file>

<file path="Services/Interfaces/IFileService.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para gerenciar upload e processamento de ficheiros.
    /// </summary>
    public interface IFileService
    {
        /// <summary>
        /// Faz upload de um ficheiro ъnico.
        /// </summary>
        /// <param name="file">Ficheiro a fazer upload</param>
        /// <param name="uploadFolder">Pasta de destino (relativa a wwwroot)</param>
        /// <returns>Nome do ficheiro guardado</returns>
        Task<string> UploadFileAsync(IFormFile file, string uploadFolder);

        /// <summary>
        /// Faz upload de mъltiplos ficheiros.
        /// </summary>
        /// <param name="files">Lista de ficheiros a fazer upload</param>
        /// <param name="uploadFolder">Pasta de destino (relativa a wwwroot)</param>
        /// <returns>Lista de nomes de ficheiros guardados</returns>
        Task<List<string>> UploadMultipleFilesAsync(List<IFormFile> files, string uploadFolder);

        /// <summary>
        /// Valida um ficheiro.
        /// </summary>
        /// <param name="file">Ficheiro a validar</param>
        /// <param name="maxSizeInBytes">Tamanho mбximo em bytes</param>
        /// <param name="allowedExtensions">Extensхes permitidas (ex: .jpg, .png)</param>
        /// <returns>True se vбlido, False caso contrбrio</returns>
        bool ValidateFile(IFormFile file, long maxSizeInBytes, string[] allowedExtensions);

        /// <summary>
        /// Obtйm mensagem de erro de validaзгo de ficheiro.
        /// </summary>
        /// <param name="file">Ficheiro a validar</param>
        /// <param name="maxSizeInBytes">Tamanho mбximo em bytes</param>
        /// <param name="allowedExtensions">Extensхes permitidas</param>
        /// <returns>Mensagem de erro ou string vazia se vбlido</returns>
        string GetFileValidationError(IFormFile file, long maxSizeInBytes, string[] allowedExtensions);

        /// <summary>
        /// Apaga um ficheiro.
        /// </summary>
        /// <param name="filePath">Caminho relativo do ficheiro (relativo a wwwroot)</param>
        /// <returns>True se apagado com sucesso, False caso contrбrio</returns>
        Task<bool> DeleteFileAsync(string filePath);
    }
}
</file>

<file path="Services/Interfaces/IReservaService.cs">
using AutoMarket.Models.DTOs;
using AutoMarket.Models.Enums;

namespace AutoMarket.Services.Interfaces
{
    public interface IReservaService
    {
        Task<CommandResultDto> ReservarVeiculoAsync(ReservarVeiculoDto dto, string userId);
    }
}
</file>

<file path="Services/Interfaces/ISoftDelete.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para entidades que suportam Soft Delete.
    /// Quando uma entidade implementa esta interface, o ApplicationDbContext
    /// intercepta tentativas de delete físico e converte-as automaticamente
    /// em soft delete (IsDeleted = true).
    /// </summary>
    public interface ISoftDelete
    {
        /// <summary>
        /// Indica se a entidade foi marcada como eliminada (soft delete).
        /// </summary>
        bool IsDeleted { get; set; }
    }
}
</file>

<file path="Services/Interfaces/IVeiculoService.cs">
namespace AutoMarket.Services.Interfaces
{
    public interface IVeiculoService
    {
        Task<VeiculoDto?> GetAsync(int id);
        Task<IReadOnlyList<VeiculoDto>> ListAsync(VeiculoFiltroDto filtro);
        Task<CommandResultDto> CreateAsync(VeiculoCreateDto dto);
        Task<CommandResultDto> UpdateAsync(int id, VeiculoUpdateDto dto);
        Task<CommandResultDto> SoftDeleteAsync(int id);
        ValidationResultDto Validate(VeiculoCreateDto dto);
    }
}
</file>

<file path="wwwroot/css/pesquisa.css">
/* Estilos para a página de pesquisa de veículos */

.vehicle-card:hover {
    box-shadow: 0 4px 12px #00214720;
    transform: translateY(-2px);
}

@media (max-width: 1024px) {
    .pesquisa-container {
        flex-direction: column;
    }

    .filtros-sidebar {
        min-width: auto;
    }
}

@media (max-width: 768px) {
    .pesquisa-container {
        flex-direction: column;
        gap: 1rem;
    }

    .filtros-sidebar {
        min-width: auto;
    }
}
</file>

<file path="Areas/Vendedores/Controllers/VeiculosController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Models.ViewModels.Veiculos;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Vendedores.Controllers
{
    /// <summary>
    /// Controller para gerenciar ve�culos da �rea de Vendedores.
    /// Requer autenticação e email confirmado.
    /// </summary>
    [Area("Vendedores")]
    [Authorize(Policy = "VendedorAprovado")]
    public class VeiculosController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly IFileService _fileService;
        private readonly ILogger<VeiculosController> _logger;

        public VeiculosController(
            ApplicationDbContext context,
            IFileService fileService,
            ILogger<VeiculosController> logger)
        {
            _context = context;
            _fileService = fileService;
            _logger = logger;
        }

        /// <summary>
        /// Obt�m o vendedor logado pelo userId do contexto.
        /// </summary>
        private async Task<Vendedor?> GetVendedorLogado()
        {
            var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
                return null;

            return await _context.Vendedores.FirstOrDefaultAsync(v => v.UserId == userId);
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Index
        /// Lista todos os ve�culos do vendedor logado (excluindo removidos).
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index()
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de acesso a Index sem vendedor logado");
                return Unauthorized();
            }

            var veiculos = await _context.Veiculos
                .Where(v => v.VendedorId == vendedor.Id && v.Estado != EstadoVeiculo.Pausado)
                .OrderByDescending(v => v.DataCriacao)
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .ToListAsync();

            var viewModel = veiculos.Select(v => ListVeiculoViewModel.FromVeiculo(v)).ToList();
            return View(viewModel);
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Create
        /// Exibe formul�rio para criar novo ve�culo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Create()
        {
            var viewModel = new CreateVeiculoViewModel
            {
                CategoriesDropdown = await _context.Categorias.ToListAsync()
            };
            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Create
        /// Cria um novo ve�culo no sistema com upload de imagens.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create(CreateVeiculoViewModel viewModel)
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de cria��o de ve�culo sem vendedor logado");
                return Unauthorized();
            }

            if (!ModelState.IsValid)
            {
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }

            try
            {
                // Fazer upload das imagens se fornecidas
                List<VeiculoImagem> imagens = new();

                if (viewModel.Fotos?.Any() == true)
                {
                    var uploadedFiles = await _fileService.UploadMultipleFilesAsync(
                        viewModel.Fotos.ToList(),
                        "images/veiculos"
                    );

                    bool isPrimeiraImagem = true;
                    foreach (var fileName in uploadedFiles)
                    {
                        imagens.Add(new VeiculoImagem
                        {
                            CaminhoFicheiro = fileName,
                            IsCapa = isPrimeiraImagem,
                            ContentType = MimeTypeHelper.GetMimeType(fileName)
                        });

                        if (isPrimeiraImagem)
                            isPrimeiraImagem = false;
                    }
                }

                // Converter ViewModel para Model
                var veiculo = viewModel.ToVeiculo(vendedor.Id);
                veiculo.Imagens = imagens;

                // Guardar na base de dados
                _context.Veiculos.Add(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo criado com sucesso. ID: {VeiculoId}, Vendedor: {VendedorId}, Imagens: {ImagemCount}",
                    veiculo.Id, vendedor.Id, imagens.Count);

                TempData["Sucesso"] = $"Ve�culo '{veiculo.Marca} {veiculo.Modelo}' criado com sucesso com {imagens.Count} imagens!";
                return RedirectToAction(nameof(Index));
            }
            catch (ArgumentException ex)
            {
                _logger.LogError(ex, "Erro na valida��o de ficheiro durante cria��o de ve�culo");
                ModelState.AddModelError("Fotos", ex.Message);
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (DbUpdateException ex)
            {
                // Check for SQL Server Unique Constraint Violation
                if (ex.InnerException is SqlException sqlEx 
                    && (sqlEx.Number == 2601 || sqlEx.Number == 2627))
                {
                    ModelState.AddModelError("", "Já existe um veículo registado com estes dados.");
                }
                else
                {
                    _logger.LogError(ex, "Database error creating vehicle for vendedor {VendedorId}", vendedor.Id);
                    ModelState.AddModelError("", "Erro de base de dados. Tente novamente.");
                }
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao criar ve�culo para vendedor {VendedorId}", vendedor.Id);
                ModelState.AddModelError(string.Empty, "Erro ao guardar o ve�culo. Tente novamente.");
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Edit/5
        /// Exibe formul�rio para editar um ve�culo existente.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Edit(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de edi��o sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado. ID: {VeiculoId}", id);
                return NotFound();
            }

            // Verificar se o ve�culo pertence ao vendedor logado
            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de edi��o de ve�culo de outro vendedor. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            var viewModel = EditVeiculoViewModel.FromVeiculo(veiculo);
            viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();

            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Edit/5
        /// Atualiza um ve�culo existente com novo upload de imagens (opcional).
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(int id, EditVeiculoViewModel viewModel)
        {
            if (id != viewModel.Id)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de edi��o sem vendedor logado");
                return Unauthorized();
            }

            if (!ModelState.IsValid)
            {
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }

            var veiculoExistente = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculoExistente == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para edi��o. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculoExistente.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de edi��o n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            try
            {
                // Fazer upload de novas imagens se fornecidas
                if (viewModel.Fotos?.Any() == true)
                {
                    var uploadedFiles = await _fileService.UploadMultipleFilesAsync(
                        viewModel.Fotos.ToList(),
                        "images/veiculos"
                    );

                    foreach (var fileName in uploadedFiles)
                    {
                        veiculoExistente.Imagens.Add(new VeiculoImagem
                        {
                            CaminhoFicheiro = fileName,
                            IsCapa = veiculoExistente.Imagens.Count == 0,
                            ContentType = MimeTypeHelper.GetMimeType(fileName),
                            VeiculoId = veiculoExistente.Id
                        });
                    }
                }

                // Atualizar campos do ve�culo
                veiculoExistente.Titulo = viewModel.Titulo;
                veiculoExistente.Marca = viewModel.Marca;
                veiculoExistente.Modelo = viewModel.Modelo;
                veiculoExistente.Ano = viewModel.Ano;
                veiculoExistente.CategoriaId = viewModel.CategoriaId;
                veiculoExistente.Combustivel = viewModel.Combustivel;
                veiculoExistente.Caixa = viewModel.Caixa;
                veiculoExistente.Km = viewModel.Km;
                veiculoExistente.Preco = viewModel.Preco;
                veiculoExistente.Condicao = viewModel.Condicao;
                veiculoExistente.Localizacao = viewModel.Localizacao;
                veiculoExistente.Descricao = viewModel.Descricao;

                _context.Veiculos.Update(veiculoExistente);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo atualizado com sucesso. ID: {VeiculoId}, Vendedor: {VendedorId}",
                    id, vendedor.Id);

                TempData["Sucesso"] = "Ve�culo atualizado com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            catch (ArgumentException ex)
            {
                _logger.LogError(ex, "Erro na valida��o de ficheiro durante edi��o de ve�culo");
                ModelState.AddModelError("Fotos", ex.Message);
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (DbUpdateException ex)
            {
                // Check for SQL Server Unique Constraint Violation
                if (ex.InnerException is SqlException sqlEx 
                    && (sqlEx.Number == 2601 || sqlEx.Number == 2627))
                {
                    ModelState.AddModelError("", "Já existe um veículo registado com estes dados.");
                }
                else
                {
                    _logger.LogError(ex, "Database error updating vehicle. ID: {VeiculoId}", id);
                    ModelState.AddModelError("", "Erro de base de dados. Tente novamente.");
                }
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao atualizar ve�culo. ID: {VeiculoId}", id);
                ModelState.AddModelError(string.Empty, "Erro ao guardar o ve�culo. Tente novamente.");
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Delete/5
        /// Exibe confirma��o antes de eliminar um ve�culo (soft delete).
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Delete(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de elimina��o sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para elimina��o. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de elimina��o n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            var viewModel = ListVeiculoViewModel.FromVeiculo(veiculo);
            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Delete/5
        /// Executa soft delete (muda estado para Pausado).
        /// </summary>
        [HttpPost]
        [ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteConfirmed(int id)
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de soft delete sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos.FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para soft delete. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de soft delete n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            try
            {
                // Soft Delete: Mudar estado para Pausado (mant�m dados para recuperar)
                veiculo.Estado = EstadoVeiculo.Pausado;

                _context.Veiculos.Update(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo removido (soft delete). ID: {VeiculoId}, Vendedor: {VendedorId}",
                    id, vendedor.Id);

                TempData["Sucesso"] = "Ve�culo removido com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao remover ve�culo. ID: {VeiculoId}", id);
                TempData["Erro"] = "Erro ao remover o ve�culo. Tente novamente.";
                return RedirectToAction(nameof(Index));
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Details/5
        /// Exibe detalhes de um ve�culo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Details(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de visualiza��o de detalhes sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .FirstOrDefaultAsync(v => v.Id == id && v.VendedorId == vendedor.Id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado. ID: {VeiculoId}", id);
                return NotFound();
            }

            var viewModel = ListVeiculoViewModel.FromVeiculo(veiculo);
            return View(viewModel);
        }
    }

    /// <summary>
    /// Helper para obter MIME types de ficheiros.
    /// </summary>
    internal static class MimeTypeHelper
    {
        public static string GetMimeType(string fileName)
        {
            return Path.GetExtension(fileName).ToLower() switch
            {
                ".jpg" or ".jpeg" => "image/jpeg",
                ".png" => "image/png",
                ".webp" => "image/webp",
                ".gif" => "image/gif",
                _ => "image/jpeg"
            };
        }
    }
}
</file>

<file path="Infrastructure/Data/ApplicationDbContext.cs">
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using AutoMarket.Infrastructure.Security;

namespace AutoMarket.Infrastructure.Data
{
    public class ApplicationDbContext : IdentityDbContext<Utilizador>
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        // =========================================================
        // DbSets (Tabelas)
        // =========================================================
        public DbSet<Veiculo> Veiculos { get; set; } = null!;
        public DbSet<VeiculoImagem> VeiculoImagens { get; set; } = null!;
        public DbSet<Utilizador> Utilizadores { get; set; }
        public DbSet<Vendedor> Vendedores { get; set; }
        public DbSet<Comprador> Compradores { get; set; }
        public DbSet<Denuncia> Denuncias { get; set; }
        public DbSet<Mensagem> Mensagens { get; set; }
        public DbSet<Transacao> Transacoes { get; set; }
        public DbSet<Categoria> Categorias { get; set; }
        public DbSet<Reserva> Reservas { get; set; } = null!;
        public DbSet<Visita> Visitas { get; set; } = null!;

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // Aplica todas as configurations (incluindo Reserva/Visita)
            builder.ApplyConfigurationsFromAssembly(typeof(ApplicationDbContext).Assembly);

            // Conversao de Enums para String (Legibilidade na BD)
            builder.Entity<Vendedor>().Property(v => v.Status).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Vendedor>().Property(v => v.TipoConta).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Veiculo>().Property(v => v.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Transacao>().Property(t => t.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Transacao>().Property(t => t.Metodo).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Denuncia>().Property(d => d.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Reserva>().Property(r => r.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Visita>().Property(v => v.Estado).HasConversion<string>().HasMaxLength(50);

            // Tipos SQL Especificos (Money)
            builder.Entity<Veiculo>().Property(v => v.Preco).HasColumnType("decimal(18,2)");
            builder.Entity<Transacao>().Property(t => t.ValorPago).HasColumnType("decimal(18,2)");

            // #endregion

            // #region 2. Indices e Restricoes (Unicidade)

            // Garante relacao 1:1 estrita (Um User so pode ter 1 perfil de cada tipo)
            builder.Entity<Comprador>()
                .HasIndex(c => c.UserId)
                .IsUnique();

            builder.Entity<Vendedor>()
                .HasIndex(v => v.UserId)
                .IsUnique();

            // Indices para performance
            builder.Entity<Veiculo>()
                .HasIndex(v => v.VendedorId)
                .HasDatabaseName("IX_Veiculo_VendedorId");

            builder.Entity<Veiculo>()
                .HasIndex(v => v.Estado)
                .HasDatabaseName("IX_Veiculo_Estado");

            builder.Entity<Veiculo>()
                .HasIndex(v => v.Marca)
                .HasDatabaseName("IX_Veiculo_Marca");

            // Soft Delete Global Query Filter
            builder.Entity<Utilizador>().HasQueryFilter(u => !u.IsDeleted);

            // Encriptação do NIF (RGPD compliance) usando helper estático
            var nifConverter = new ValueConverter<string?, string?>(
                v => string.IsNullOrEmpty(v) ? v : NifEncryptionHelper.EncryptNif(v),
                v => string.IsNullOrEmpty(v) ? v : NifEncryptionHelper.DecryptNif(v),
                convertsNulls: true);

            builder.Entity<Utilizador>()
                .Property(u => u.NIF)
                .HasConversion(nifConverter);

            // #endregion

            // #region 3. Relacoes: Delete CASCADE (Pai morre -> Filhos morrem)

            // Se apagar Vendedor -> Apaga os seus Ve�culos
            builder.Entity<Veiculo>()
                .HasOne(v => v.Vendedor)
                .WithMany()
                .HasForeignKey(v => v.VendedorId)
                .OnDelete(DeleteBehavior.Cascade);

            // Se apagar Ve�culo -> Apaga as suas Imagens
            builder.Entity<VeiculoImagem>()
                .HasOne(i => i.Veiculo)
                .WithMany(v => v.Imagens)
                .HasForeignKey(i => i.VeiculoId)
                .OnDelete(DeleteBehavior.Cascade);

            // #endregion

            // #region 4. Relacoes: Delete RESTRICT (Seguranca & Historico)

            // --- Transacoes (Financeiro) ---
            builder.Entity<Transacao>()
                .HasOne(t => t.Comprador)
                .WithMany()
                .HasForeignKey(t => t.CompradorId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Transacao>()
                .HasOne(t => t.Veiculo)
                .WithMany()
                .HasForeignKey(t => t.VeiculoId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Denuncias (Auditoria) ---
            builder.Entity<Denuncia>()
                .HasOne(d => d.Denunciante)
                .WithMany()
                .HasForeignKey(d => d.DenuncianteId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Denuncia>()
                .HasOne(d => d.AnalisadoPorAdmin)
                .WithMany()
                .HasForeignKey(d => d.AnalisadoPorAdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Vendedores (Aprovacoes) ---
            builder.Entity<Vendedor>()
                .HasOne(v => v.ApprovedByAdmin)
                .WithMany()
                .HasForeignKey(v => v.ApprovedByAdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Mensagens (Chat) ---
            builder.Entity<Mensagem>()
                .HasOne(m => m.Remetente)
                .WithMany()
                .HasForeignKey(m => m.RemetenteId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Mensagem>()
                .HasOne(m => m.Destinatario)
                .WithMany()
                .HasForeignKey(m => m.DestinatarioId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Categoria ---
            builder.Entity<Veiculo>()
                .HasOne(v => v.Categoria)
                .WithMany()
                .HasForeignKey(v => v.CategoriaId)
                .OnDelete(DeleteBehavior.Restrict);

            // #endregion
        }

        /// <summary>
        /// Intercepta tentativas de delete físico em entidades ISoftDelete
        /// e converte-as automaticamente em soft delete (IsDeleted = true).
        /// </summary>
        /// <remarks>
        /// Mesmo que um developer use _context.Utilizadores.Remove(user),
        /// o sistema converte automaticamente para soft delete.
        /// </remarks>
        public override int SaveChanges(bool acceptAllChangesOnSuccess)
        {
            InterceptSoftDeletes();
            return base.SaveChanges(acceptAllChangesOnSuccess);
        }

        /// <summary>
        /// Intercepta tentativas de delete físico em entidades ISoftDelete
        /// e converte-as automaticamente em soft delete (IsDeleted = true).
        /// </summary>
        /// <remarks>
        /// Mesmo que um developer use _context.Utilizadores.Remove(user),
        /// o sistema converte automaticamente para soft delete.
        /// </remarks>
        public override Task<int> SaveChangesAsync(bool acceptAllChangesOnSuccess, CancellationToken cancellationToken = default)
        {
            InterceptSoftDeletes();
            return base.SaveChangesAsync(acceptAllChangesOnSuccess, cancellationToken);
        }

        /// <summary>
        /// Intercepta entidades marcadas para delete físico e converte-as em soft delete.
        /// </summary>
        private void InterceptSoftDeletes()
        {
            // Intercetar entradas marcadas para Deleted que implementam ISoftDelete
            var entries = ChangeTracker.Entries<ISoftDelete>()
                .Where(e => e.State == EntityState.Deleted)
                .ToList();

            foreach (var entry in entries)
            {
                // Cancelar o delete físico
                entry.State = EntityState.Modified;

                // Aplicar o soft delete
                entry.Entity.IsDeleted = true;

                // Opcional: Se a entidade tiver DataRemocao, pode ser adicionado aqui
                // if (entry.Entity is Utilizador utilizador && utilizador.GetType().GetProperty("DataRemocao") != null)
                // {
                //     utilizador.DataRemocao = DateTime.UtcNow;
                // }
            }
        }
    }
}
</file>

<file path="Models/Enums/EstadoVeiculo.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Enums
{
    /// <summary>
    /// Enum para o estado do veículo no sistema.
    /// </summary>
    public enum EstadoVeiculo
    {
        [Display(Name = "Ativo")]
        Ativo = 0,

        [Display(Name = "Reservado")]
        Reservado = 1,

        [Display(Name = "Vendido")]
        Vendido = 2,

        [Display(Name = "Pausado")]
        Pausado = 3
    }
}
</file>

<file path="Models/Enums/StatusAprovacao.cs">
namespace AutoMarket.Models.Enums
{
    public enum StatusAprovacao
    {
        Pendente = 0,
        Aprovado = 1,
        Rejeitado = 2
    }
}
</file>

<file path="Models/ViewModels/CarroViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using Microsoft.AspNetCore.Http;

namespace AutoMarket.Models.ViewModels
{
    public class CarroViewModel
    {
        public int Id { get; set; }

        [Display(Name = "Título do Anúncio")]
        [Required(ErrorMessage = "O título é obrigatório.")]
        [StringLength(100, ErrorMessage = "O título não pode exceder 100 caracteres.")]
        public string Titulo { get; set; }

        [Display(Name = "Marca")]
        [Required(ErrorMessage = "A marca é obrigatória.")]
        [StringLength(50, ErrorMessage = "A marca não pode exceder 50 caracteres.")]
        public string Marca { get; set; }

        [Display(Name = "Modelo")]
        [Required(ErrorMessage = "O modelo é obrigatório.")]
        [StringLength(50, ErrorMessage = "O modelo não pode exceder 50 caracteres.")]
        public string Modelo { get; set; }

        [Display(Name = "Categoria")]
        [Required(ErrorMessage = "Selecione uma categoria.")]
        public int CategoriaId { get; set; }

        [Display(Name = "Ano de Fabrico")]
        [Range(1900, 2100, ErrorMessage = "Insira um ano válido.")]
        public int Ano { get; set; }

        [Display(Name = "Preço (€)")]
        [Required(ErrorMessage = "O preço é obrigatório.")]
        [Range(0.01, 10000000, ErrorMessage = "O preço deve ser superior a 0.")]
        [DataType(DataType.Currency)]
        public decimal Preco { get; set; }

        [Display(Name = "Quilómetros")]
        [Range(0, int.MaxValue, ErrorMessage = "Os quilómetros não podem ser negativos.")]
        public int Km { get; set; }

        [Display(Name = "Combustível")]
        [Required(ErrorMessage = "Selecione o tipo de combustível.")]
        [StringLength(30, ErrorMessage = "O combustível não pode exceder 30 caracteres.")]
        public string Combustivel { get; set; }

        [Display(Name = "Caixa de Velocidades")]
        [Required(ErrorMessage = "Selecione o tipo de caixa.")]
        [StringLength(30, ErrorMessage = "A caixa não pode exceder 30 caracteres.")]
        public string Caixa { get; set; }

        [Display(Name = "Localização")]
        [Required(ErrorMessage = "A localização é obrigatória.")]
        [StringLength(100, ErrorMessage = "A localização não pode exceder 100 caracteres.")]
        public string Localizacao { get; set; }

        [Display(Name = "Descrição Detalhada")]
        [Required(ErrorMessage = "A descrição é obrigatória.")]
        [StringLength(2000, ErrorMessage = "A descrição é demasiado longa.")]
        [DataType(DataType.MultilineText)]
        public string Descricao { get; set; }

        // Campo auxiliar para Upload (não vai para a BD diretamente)
        [Display(Name = "Fotografias do Veículo")]
        public List<IFormFile>? ImagensUpload { get; set; }

        // Apenas para edição: mostrar imagens existentes
        public ICollection<CarroImagem>? ImagensAtuais { get; set; }
    }
}
</file>

<file path="Models/ViewModels/CheckoutViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels
{
    public class CheckoutViewModel : IValidatableObject
    {
        // Dados de Envio / Contacto
        [Required(ErrorMessage = "O nome completo é obrigatório.")]
        public string NomeCompleto { get; set; } = string.Empty;

        [Required(ErrorMessage = "A morada é obrigatória.")]
        public string Morada { get; set; } = string.Empty;

        [Required(ErrorMessage = "O código postal é obrigatório.")]
        [RegularExpression(@"^\d{4}-\d{3}$", ErrorMessage = "Formato inválido (ex: 1234-567).")]
        public string CodigoPostal { get; set; } = string.Empty;

        // --- DADOS FISCAIS ---

        [Display(Name = "Desejo fatura com número de contribuinte")]
        public bool QueroFaturaComNif { get; set; }

        [Display(Name = "NIF para Fatura")]
        public string? NifFaturacao { get; set; }

        [Display(Name = "Nome na Fatura (Opcional)")]
        public string? NomeFaturacao { get; set; }

        [Required(ErrorMessage ="Escolha um método de pagamento")]
        [Display(Name ="Método de Pagamento")]
        public MetodoPagamento MetodoPagamento { get; set; }

        public int CarroId { get; set; }
        public decimal ValorTotal { get; set; }



        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // 1. Se pediu fatura, o NIF passa a ser OBRIGATÓRIO
            if (QueroFaturaComNif)
            {
                if (string.IsNullOrWhiteSpace(NifFaturacao))
                {
                    yield return new ValidationResult(
                        "Para emitir fatura, é necessário introduzir o NIF.",
                        new[] { nameof(NifFaturacao) });
                }
                else
                {
                    // 2. Se preenchido, tem de ser matematicamente válido
                    if (!NifValidator.IsValid(NifFaturacao))
                    {
                        yield return new ValidationResult(
                            "O NIF de faturação não é válido.",
                            new[] { nameof(NifFaturacao) });
                    }

                    // Nota: No checkout, normalmente NÃO validamos se começa por 1 ou 5.
                    // Eu posso ser um particular (conta 1) a comprar carro para a minha empresa (nif 5),
                    // ou vice-versa. Validamos apenas a existência fiscal (IsValid).
                }
            }
            // 3. Caso Raro: Não pediu fatura, mas escreveu NIF na caixa (User Error)
            else if (!string.IsNullOrWhiteSpace(NifFaturacao))
            {
                if (!NifValidator.IsValid(NifFaturacao))
                {
                    yield return new ValidationResult(
                        "O NIF introduzido não é válido.",
                        new[] { nameof(NifFaturacao) });
                }
            }
        }
    }
}
</file>

<file path="Models/ViewModels/DadosFiscaisViewModel.cs">
using AutoMarket.Models.Attributes;
using AutoMarket.Models; // Para aceder ao atributo [NifPortugues]
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    public class DadosFiscaisViewModel
    {
        [Display(Name = "Número de Identificação Fiscal (NIF)")]
        [Required(ErrorMessage = "O NIF é obrigatório para emitir a fatura.")]
        [StringLength(9, ErrorMessage = "O NIF deve ter 9 dígitos.")]
        [NifPortugues(ErrorMessage = "O NIF introduzido não é válido.")]
        public string NIF { get; set; }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/CreateVeiculoViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para criar um novo veםculo (POST).
    /// Mapeia para Veiculo durante a criaחדo.
    /// </summary>
    public class CreateVeiculoViewModel
    {
        [Required(ErrorMessage = "O tםtulo י obrigatףrio")]
        [StringLength(100, ErrorMessage = "O tםtulo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Tםtulo do Anתncio")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A marca י obrigatףria")]
        [StringLength(50, ErrorMessage = "A marca nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Marca")]
        public string Marca { get; set; } = string.Empty;

        [Required(ErrorMessage = "O modelo י obrigatףrio")]
        [StringLength(50, ErrorMessage = "O modelo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Modelo")]
        public string Modelo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A categoria י obrigatףria")]
        [Display(Name = "Tipo/Segmento")]
        public int CategoriaId { get; set; }

        [Required(ErrorMessage = "O ano י obrigatףrio")]
        [Range(1900, 2100, ErrorMessage = "O ano deve estar entre 1900 e 2100")]
        [Display(Name = "Ano")]
        public int Ano { get; set; }

        [Required(ErrorMessage = "O preחo י obrigatףrio")]
        [Range(0.01, 9999999.99, ErrorMessage = "O preחo deve ser superior a 0")]
        [DataType(DataType.Currency)]
        [Display(Name = "Preחo (€)")]
        public decimal Preco { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "A quilometragem nדo pode ser negativa")]
        [Display(Name = "Quilףmetros")]
        public int Km { get; set; }

        [Required(ErrorMessage = "O combustםvel י obrigatףrio")]
        [StringLength(20, ErrorMessage = "O combustםvel nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Combustםvel")]
        public string Combustivel { get; set; } = string.Empty;

        [Required(ErrorMessage = "A caixa י obrigatףria")]
        [StringLength(20, ErrorMessage = "A caixa nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; } = string.Empty;

        [Required(ErrorMessage = "A localizaחדo י obrigatףria")]
        [StringLength(100, ErrorMessage = "A localizaחדo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Localizaחדo")]
        public string Localizacao { get; set; } = string.Empty;

        [Required(ErrorMessage = "A descriחדo י obrigatףria")]
        [StringLength(2000, ErrorMessage = "A descriחדo nדo pode ter mais de 2000 caracteres")]
        [DataType(DataType.MultilineText)]
        [Display(Name = "Descriחדo Detalhada")]
        public string Descricao { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "A condiחדo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Condiחדo")]
        public string? Condicao { get; set; }

        [Display(Name = "Fotos")]
        public List<IFormFile> Fotos { get; set; } = new();

        // Propriedades auxiliares para a View
        public List<Categoria> CategoriesDropdown { get; set; } = new();

        /// <summary>
        /// Converte este ViewModel para uma Model Veiculo.
        /// </summary>
        public Veiculo ToVeiculo(int vendedorId)
        {
            return new Veiculo
            {
                Titulo = Titulo,
                Marca = Marca,
                Modelo = Modelo,
                Ano = Ano,
                CategoriaId = CategoriaId,
                Combustivel = Combustivel,
                Caixa = Caixa,
                Km = Km,
                Preco = Preco,
                Condicao = Condicao,
                Localizacao = Localizacao,
                Descricao = Descricao,
                VendedorId = vendedorId,
                DataCriacao = DateTime.UtcNow,
                Estado = EstadoVeiculo.Ativo
            };
        }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/EditVeiculoViewModel.cs">
using AutoMarket.Models.Entities;
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para editar um veםculo existente (POST).
    /// Mapeia entre Veiculo e formulבrio de ediחדo.
    /// </summary>
    public class EditVeiculoViewModel
    {
        [Required]
        public int Id { get; set; }

        [Required(ErrorMessage = "O tםtulo י obrigatףrio")]
        [StringLength(100, ErrorMessage = "O tםtulo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Tםtulo do Anתncio")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A marca י obrigatףria")]
        [StringLength(50, ErrorMessage = "A marca nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Marca")]
        public string Marca { get; set; } = string.Empty;

        [Required(ErrorMessage = "O modelo י obrigatףrio")]
        [StringLength(50, ErrorMessage = "O modelo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Modelo")]
        public string Modelo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A categoria י obrigatףria")]
        [Display(Name = "Tipo/Segmento")]
        public int CategoriaId { get; set; }

        [Required(ErrorMessage = "O ano י obrigatףrio")]
        [Range(1900, 2100, ErrorMessage = "O ano deve estar entre 1900 e 2100")]
        [Display(Name = "Ano")]
        public int Ano { get; set; }

        [Required(ErrorMessage = "O preחo י obrigatףrio")]
        [Range(0.01, 9999999.99, ErrorMessage = "O preחo deve ser superior a 0")]
        [DataType(DataType.Currency)]
        [Display(Name = "Preחo (€)")]
        public decimal Preco { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "A quilometragem nדo pode ser negativa")]
        [Display(Name = "Quilףmetros")]
        public int Km { get; set; }

        [Required(ErrorMessage = "O combustםvel י obrigatףrio")]
        [StringLength(20, ErrorMessage = "O combustםvel nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Combustםvel")]
        public string Combustivel { get; set; } = string.Empty;

        [Required(ErrorMessage = "A caixa י obrigatףria")]
        [StringLength(20, ErrorMessage = "A caixa nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; } = string.Empty;

        [Required(ErrorMessage = "A localizaחדo י obrigatףria")]
        [StringLength(100, ErrorMessage = "A localizaחדo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Localizaחדo")]
        public string Localizacao { get; set; } = string.Empty;

        [Required(ErrorMessage = "A descriחדo י obrigatףria")]
        [StringLength(2000, ErrorMessage = "A descriחדo nדo pode ter mais de 2000 caracteres")]
        [DataType(DataType.MultilineText)]
        [Display(Name = "Descriחדo Detalhada")]
        public string Descricao { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "A condiחדo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Condiחדo")]
        public string? Condicao { get; set; }

        [Display(Name = "Fotos")]
        public List<IFormFile> Fotos { get; set; } = new();

        // Propriedades auxiliares
        public string? ImagemPrincipalAtual { get; set; }
        public List<Categoria> CategoriesDropdown { get; set; } = new();

        /// <summary>
        /// Cria um ViewModel a partir de um Veiculo existente.
        /// </summary>
        public static EditVeiculoViewModel FromVeiculo(Veiculo veiculo)
        {
            return new EditVeiculoViewModel
            {
                Id = veiculo.Id,
                Titulo = veiculo.Titulo,
                Marca = veiculo.Marca,
                Modelo = veiculo.Modelo,
                Ano = veiculo.Ano,
                CategoriaId = veiculo.CategoriaId,
                Combustivel = veiculo.Combustivel,
                Caixa = veiculo.Caixa,
                Km = veiculo.Km,
                Preco = veiculo.Preco,
                Condicao = veiculo.Condicao,
                Localizacao = veiculo.Localizacao,
                Descricao = veiculo.Descricao,
                ImagemPrincipalAtual = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
            };
        }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/ListVeiculoViewModel.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para listar veьculos (GET).
    /// Usado para exibir informaушes resumidas de veьculos no catрlogo.
    /// </summary>
    public class ListVeiculoViewModel
    {
        public int Id { get; set; }
        public string Titulo { get; set; }
        public string Marca { get; set; }
        public string Modelo { get; set; }
        public int Ano { get; set; }
        public decimal Preco { get; set; }
        public int Km { get; set; }
        public string Combustivel { get; set; }
        public string Caixa { get; set; }
        public string Localizacao { get; set; }
        public string Descricao { get; set; }
        public string? Condicao { get; set; }
        public EstadoVeiculo Estado { get; set; }
        public DateTime DataCriacao { get; set; }
        public int VendedorId { get; set; }
        public string VendedorNome { get; set; }
        public string? ImagemPrincipal { get; set; }
        public string CategoriaNome { get; set; }

        /// <summary>
        /// Converte um Veiculo para ListVeiculoViewModel.
        /// </summary>
        public static ListVeiculoViewModel FromVeiculo(Veiculo veiculo)
        {
            var imagemPrincipal = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
                                  ?? veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro;

            return new ListVeiculoViewModel
            {
                Id = veiculo.Id,
                Titulo = veiculo.Titulo,
                Marca = veiculo.Marca,
                Modelo = veiculo.Modelo,
                Ano = veiculo.Ano,
                Preco = veiculo.Preco,
                Km = veiculo.Km,
                Combustivel = veiculo.Combustivel,
                Caixa = veiculo.Caixa,
                Localizacao = veiculo.Localizacao,
                Descricao = veiculo.Descricao,
                Condicao = veiculo.Condicao,
                Estado = veiculo.Estado,
                DataCriacao = veiculo.DataCriacao,
                VendedorId = veiculo.VendedorId,
                VendedorNome = veiculo.Vendedor?.User?.Nome ?? "Desconhecido",
                ImagemPrincipal = imagemPrincipal,
                CategoriaNome = veiculo.Categoria?.Nome ?? "Sem categoria"
            };
        }
    }
}
</file>

<file path=".gitignore">
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Ww][Ii][Nn]32/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Ll]og/
[Ll]ogs/

# Visual Studio cache/options directory
.vs/

# .NET Core
project.lock.json
project.fragment.lock.json
artifacts/

# NuGet Packages
*.nupkg
*.snupkg
**/packages/*
!**/packages/build/
*.nuget.props
*.nuget.targets

# ASP.NET Scaffolding
ScaffoldingReadMe.txt

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# ReSharper
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# JetBrains Rider
.idea/
*.sln.iml

# User Secrets (sensitive configuration)
secrets.json

# Note: appsettings.json, appsettings.Development.json, and appsettings.Production.json
# are kept in source control with placeholders. Never commit real credentials.
# Use User Secrets for development or environment variables for production.

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Build output
bin/
obj/

# Visual Studio
.vs/
</file>

<file path="Models/Enums/TipoConta.cs">
namespace AutoMarket.Models.Enums
{
    public enum TipoConta
    {
        Comprador = 0,
        Vendedor = 1,  // Vendedor Particular
        Empresa = 2    // Vendedor
    }
}
</file>

<file path="Models/ViewModels/EmailConfirmationViewModel.cs">
namespace AutoMarket.Models.ViewModels
{
    /// <summary>
    /// View model for email confirmation template.
    /// </summary>
    public class EmailConfirmationViewModel
    {
        /// <summary>
        /// Gets or sets the user's name.
        /// </summary>
        public string UserName { get; set; } = string.Empty;

        /// <summary>
        /// Gets or sets the email confirmation link.
        /// </summary>
        public string ConfirmationLink { get; set; } = string.Empty;
    }
}
</file>

<file path="Models/ViewModels/LoginViewModel.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    public class LoginViewModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;
        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;
        public bool RememberMe { get; set; }
    }
}
</file>

<file path="Services/Interfaces/ICarrinhoService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services
{
    public interface ICarrinhoService
    {
        /// <summary>
        /// Adiciona um veículo ao carrinho.
        /// </summary>
        void AdicionarItem(Veiculo veiculo);

        /// <summary>
        /// Remove um item do carrinho pelo ID do veículo.
        /// </summary>
        void RemoverItem(int veiculoId);

        /// <summary>
        /// Obtém a lista atual de itens no carrinho.
        /// </summary>
        List<CarrinhoItem> GetItens();

        /// <summary>
        /// Remove todos os itens do carrinho.
        /// </summary>
        void LimparCarrinho();

        /// <summary>
        /// Calcula o valor total dos itens no carrinho.
        /// </summary>
        decimal GetTotal();

        /// <summary>
        /// Retorna a quantidade de itens no carrinho.
        /// </summary>
        int GetContagem();
    }
}
</file>

<file path="wwwroot/js/site.js">
// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Write your JavaScript code.
</file>

<file path="appsettings.Production.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning"
    }
  },
  "ConnectionStrings": {
    "_Comment": "IMPORTANTE: NÃO coloque credenciais reais neste ficheiro. Use variáveis de ambiente ou User Secrets.",
    "_Comment2": "Para produção, configure a connection string através de variáveis de ambiente:",
    "_Comment3": "export ConnectionStrings__DefaultConnection=\"Server=...;Database=...;User Id=...;Password=...;\"",
    "_Comment4": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "DefaultConnection": "Server=YOUR_SERVER;Database=AutoMarket;User Id=YOUR_USER;Password=YOUR_PASSWORD;MultipleActiveResultSets=true;TrustServerCertificate=False;Encrypt=True;"
  },
  "EmailSettings": {
    "_Comment": "IMPORTANTE: NÃO coloque credenciais reais neste ficheiro. Use variáveis de ambiente:",
    "_Comment2": "export EmailSettings__SmtpServer=\"smtp.gmail.com\"",
    "_Comment3": "export EmailSettings__SmtpPort=\"587\"",
    "_Comment4": "export EmailSettings__SmtpUsername=\"seu-email@gmail.com\"",
    "_Comment5": "export EmailSettings__SmtpPassword=\"sua-senha-app\"",
    "_Comment6": "export EmailSettings__FromEmail=\"noreply@automarket.com\"",
    "_Comment7": "export EmailSettings__SecureSocketOptions=\"StartTls\"",
    "_Comment8": "SecureSocketOptions: None, Auto, StartTls, StartTlsWhenAvailable, SslOnConnect",
    "_Comment9": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "SmtpServer": "",
    "SmtpPort": 587,
    "SmtpUsername": "",
    "SmtpPassword": "",
    "FromEmail": "noreply@automarket.com",
    "FromName": "AutoMarket",
    "SecureSocketOptions": "StartTls"
  },
  "Encryption": {
    "_Comment": "IMPORTANTE: NÃO coloque a chave de encriptação neste ficheiro. Use variáveis de ambiente:",
    "_Comment2": "export Encryption__Key=\"sua-chave-secreta-de-32-caracteres-minimo\"",
    "_Comment3": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "_Comment4": "A chave deve ter pelo menos 32 caracteres para segurança adequada.",
    "Key": ""
  }
}
</file>

<file path="Models/ViewModels/ErrorViewModel.cs">
namespace AutoMarket.Models.ViewModels
{
    public class ErrorViewModel
    {
        public string? RequestId { get; set; }

        public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

        public string? Message { get; set; }
    }
}
</file>

<file path="Services/Interfaces/IEmailAuthService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    public interface IEmailAuthService
    {
        /// <summary>
        /// Gera o template e envia o email de confirmação de conta.
        /// </summary>
        Task EnviarEmailConfirmacaoAsync(Utilizador user, string confirmationLink);
    }
}
</file>

<file path="wwwroot/css/site.css">
html {
  font-size: 14px;
}

@media (min-width: 768px) {
  html {
    font-size: 16px;
  }
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
  box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

html {
  position: relative;
  min-height: 100%;
}

body {
    margin-bottom: 60px;
}

/* Authentication form containers */
.login-container {
  max-width: 450px;
  margin: 2rem auto;
}

.register-container {
  max-width: 520px;
  margin: 2rem auto;
}
</file>

<file path="wwwroot/js/script.js">
// AutoMarket JS
// Interatividade inicial (abas, formulários, etc.)

document.addEventListener('DOMContentLoaded', function() {
    // Alternar abas Login/Registo
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            panes.forEach(pane => pane.classList.remove('active'));
            document.getElementById(this.dataset.target).classList.add('active');
        });
    });
});

// Placeholder para validação de formulários (Simples)
function validarFormLogin() {
    // TODO: Adicionar validações reais
    return true;
}

function validarFormRegisto() {
    // TODO: Adicionar validações reais
    return true;
}

// TODO: Implementar fetch() para buscar veículos da API (RF1)
// TODO: Enviar dados do formulário 'criar-anuncio' para o backend (RF12)
</file>

<file path="Models/Enums/EstadoCarro.cs">
namespace AutoMarket.Models.Enums
{
    public enum EstadoCarro
    {
        Ativo = 0,
        Reservado = 1,
        Vendido = 2,
        Pausado = 3
    }
}
</file>

<file path="wwwroot/css/style.css">
/*
    AutoMarket Stylesheet
    Criado segundo requisitos do projeto para responsividade, esquema de cores, componentes comuns e utilitários.
*/

:root {
    --cor-primaria: #002147;
    --cor-cta: #ff7000;
    --cor-bg: #f7f7f7;
    --cor-texto: #222;
    --cor-footer: #1a1a1a;
    --cor-destaque: #e0eefc;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--cor-bg);
    color: var(--cor-texto);
    min-height: 100vh;
}

header {
    background: var(--cor-primaria);
    color: #fff;
    padding: 1rem 0;
}
header .nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
}

.logo {
    font-size: 2rem;
    font-weight: bold;
    letter-spacing: 2px;
    text-decoration: none;
    color: #fff;
}

nav ul {
    list-style: none;
    display: flex;
    gap: 2rem;
}
nav ul li a {
    text-decoration: none;
    color: #fff;
    font-size: 1rem;
    transition: color 0.2s;
}
nav ul li a:hover { color: var(--cor-cta); }

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-primario {
    background: var(--cor-primaria);
    color: #fff;
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-primario:hover {
    background: #18345a;
}

.btn-cta {
    background: var(--cor-cta);
    color: #fff;
    padding: 0.6rem 2rem;
    border: none;
    border-radius: 3px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px #ff700030;
    transition: background 0.2s;
}
.btn-cta:hover {
    background: #ff8800;
}

footer {
    background: var(--cor-footer);
    color: #fff;
    text-align: center;
    padding: 2rem 0 1rem;
    font-size: 1rem;
}

.vehicle-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
    padding: 1rem;
    margin: 1rem 0;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: box-shadow 0.2s;
}
.vehicle-card:hover {
    box-shadow: 0 4px 16px #00214722;
}
.vehicle-card img {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 6px;
    object-fit: cover;
    margin-bottom: 0.5rem;
}
.vehicle-card h3 {
    font-size: 1.1rem;
    color: var(--cor-primaria);
    margin-bottom: 0.4rem;
    font-weight: bold;
}
.vehicle-card .price {
    color: var(--cor-cta);
    font-size: 1.2rem;
    font-weight: bold;
}
.vehicle-card .meta {
    font-size: 0.96rem;
    color: #444;
    margin-bottom: 0.2rem;
}

.filter-sidebar {
    background: var(--cor-destaque);
    border-radius: 12px;
    padding: 1.5rem 1rem;
    margin-right: 2rem;
    min-width: 220px;
}

.filter-group label {
    font-size: 1rem;
    color: var(--cor-primaria);
    font-weight: 500;
}
.filter-group input,
.filter-group select {
    width: 100%;
    margin: 0.2rem 0 1rem 0;
    padding: 0.3rem;
    border-radius: 4px;
    border: 1px solid #ccc;
}

.form-step {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
    padding: 2rem 1.5rem;
    margin-bottom: 1.5rem;
}

.container-main {
    max-width: 1050px;
    margin: 2rem auto 3rem auto;
}
.favorites-title {
    margin-bottom: 2rem;
}
.favorites-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
}
.remove-fav-btn {
    margin-top: 1rem;
}

.card {
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
}
.card-lg {
    padding: 1.5rem;
}
.card-mb {
    margin-bottom: 0.8rem;
}
.card-mb-lg {
    margin-bottom: 1.2rem;
}
.status-badge {
    border-radius: 3px;
    padding: 2px 7px;
    font-size: 0.94em;
    font-weight: 500;
}
.status-active {
    background: #bee3b4;
    color: #256908;
}
.status-paused {
    background: #ffe9a0;
    color: #b88301;
}

.seller-fields {
    border-left: 3px solid #0d6efd;
    padding-left: 15px;
}

.badge-container {
    margin: 0.8rem 0;
}

@media (max-width: 900px) {
    header .nav { flex-direction: column; gap: 1.5rem; }
    .filter-sidebar { min-width: 170px; }
}

@media (max-width: 600px) {
    header .nav { flex-direction: column; gap: 1rem; }
    .btn-cta, .btn-primario { width: 100%; }
    .filter-sidebar { margin-right: 0; margin-bottom: 2rem; }
    .vehicle-card { max-width: 100%; }
    .form-step { padding: 1rem; }
    .filter-sidebar { padding: 1rem 0.5rem; }
}
</file>

<file path="README.md">
Here's the improved README.md file incorporating the new content while maintaining the existing structure and information:


# Project Title

## Description

[Provide a brief description of the project, its purpose, and key features.]

## Installation

[Instructions on how to install the project, including prerequisites and setup steps.]

## Usage

[Examples of how to use the project, including code snippets and command-line instructions.]

## Configuration

[Details on how to configure the project, including any necessary configuration files or environment variables.]

## Security: Encryption Key Configuration

Set a strong 256-bit encryption key via secret configuration (never commit keys to source control):

- Generate a key (Base64):
  - Linux/macOS: `openssl rand -base64 32`
  - Windows (PowerShell): `[Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))`
- Configure it as a secret (preferred):
  - Development (user secrets): `dotnet user-secrets set "Encryption:Key" "<base64-key>"`
  - Or environment variable: `setx Encryption__Key "<base64-key>"` (Windows) / `export Encryption__Key="<base64-key>"` (bash)
- Production: inject via your secret store/Key Vault or deployment environment variable `Encryption__Key`.
- Startup will fail in Production if `Encryption:Key` is missing or empty (fail-fast guard).

## Contributing

[Guidelines for contributing to the project, including how to submit issues and pull requests.]

## License

[Information about the project's license, including any relevant links.]

## Contact

[Details on how to contact the project maintainers or contributors.]


### Changes Made:
1. Incorporated the new "Security: Encryption Key Configuration" section into the existing structure.
2. Ensured that the new content flows logically within the README, maintaining coherence with the other sections.
3. Preserved the original formatting and headings for consistency.
</file>

<file path="appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": ""
  },
  "DefaultAdmin": {
    "Email": "admin@automarket.com",
    "Password": ""
  },
  "EmailSettings": {
    "SmtpServer": "",
    "SmtpPort": 587,
    "SmtpUsername": "",
    "SmtpPassword": "",
    "FromEmail": "noreply@automarket.com",
    "FromName": "AutoMarket",
    "SecureSocketOptions": "StartTls"
  },
  "FileUploadSettings": {
    "MaxFileSizePerFileInBytes": 10485760,
    "MaxTotalSizePerCarInBytes": 52428800,
    "MaxFilesPerCar": 10,
    "AllowedExtensions": [ ".jpg", ".jpeg", ".png", ".webp" ],
    "UploadFolder": "images/cars"
  },
  "Encryption": {
    "Key": ""
  },
  "Reservation": {
    "TempoExpiracaoHoras": 24,
    "MaxReservasAtivasPorComprador": 3
  }
}
</file>

<file path="AutoMarket.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>823e9d94-4f52-46ad-bce5-166fb074c3cf</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="Areas\Vendedores\Views\Carros\**" />
    <Content Remove="Areas\Vendedores\Views\Carros\**" />
    <EmbeddedResource Remove="Areas\Vendedores\Views\Carros\**" />
    <None Remove="Areas\Vendedores\Views\Carros\**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.22" />
    
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.22" />
    
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.22">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    
    <PackageReference Include="MailKit" Version="4.9.0" />
    <PackageReference Include="MimeKit" Version="4.9.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Areas\Admin\Pages\" />
    <Folder Include="Areas\Admin\NewFolder\" />
    <Folder Include="Areas\Public\Pages\" />
    <Folder Include="Areas\Vendedores\Pages\" />
    <Folder Include="docs\" />
    <Folder Include="Infrastructure\Migrations\" />
    <Folder Include="Models\ViewModels\Carros\" />
  </ItemGroup>
</Project>
</file>

<file path="Models/ViewModels/RegisterViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Attributes;

namespace AutoMarket.Models.ViewModels
{
    public class RegisterViewModel : IValidatableObject
    {
        // --- Identity Base ---
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = string.Empty;

        [Required]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = string.Empty;

        [DataType(DataType.Password)]
        [Display(Name = "Confirmar password")]
        [Compare("Password", ErrorMessage = "As passwords não coincidem.")]
        public string ConfirmPassword { get; set; } = string.Empty;

        [Required]
        [Display(Name = "Nome Completo")]
        public string Nome { get; set; } = string.Empty;

        [Required]
        [StringLength(200, ErrorMessage= "A morada não pode ter mais de 200 caracteres.")]
        [Display(Name = "Morada")]
        public string Morada { get; set; } = string.Empty;

        [Required]
        [StringLength(50, ErrorMessage = "O contacto não pode ter mais de 50 caracteres.")]
        [Display(Name = "Contacto")]
        public string Contacto { get; set; } = string.Empty;

        [Required(ErrorMessage = "Por favor, selecione o tipo de conta.")]
        [Display(Name = "Tipo de Conta")]
        public TipoConta TipoConta { get; set; } = TipoConta.Comprador;

        // --- Campos específicos para Vendedor --- (Nullable para não dar erro de validação ao comprador)
        [Display(Name ="NIF")]
        [NifPortugues]
        public string? NIF { get; set; }

        // -- Lógica de validação personalizada do NIF --
        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // Regra 1: Validação para empresas
            if (TipoConta == TipoConta.Empresa)
            {
                if (string.IsNullOrWhiteSpace(NIF))
                {
                    yield return new ValidationResult("O NIF é obrigatório para contas de Empresa.", new[] { nameof(NIF) });
                }
                else if (!NIF.Trim().StartsWith("5"))
                {
                    yield return new ValidationResult("NIF de empresa deve começar por 5.", new[] { nameof(NIF) });
                }
            }
        }
    }
}
</file>

<file path="Program.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Options;
using AutoMarket.Infrastructure.Security;
using AutoMarket.Models.Constants;
using AutoMarket.Services;
using AutoMarket.Services.Implementations;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllersWithViews();

// Add localization services
builder.Services.AddLocalization(options => options.ResourcesPath = "Resources");
builder.Services.Configure<RequestLocalizationOptions>(options =>
{
    var supportedCultures = new[] { "pt-PT", "en-US" };
    options.SetDefaultCulture("pt-PT")
           .AddSupportedCultures(supportedCultures)
           .AddSupportedUICultures(supportedCultures);
});

// Adiciona o serviço de encriptação (RGPD compliance)
builder.Services.AddSingleton<IEncryptionService, EncryptionService>();

// Adiciona o DbContext
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Adiciona o ASP.NET Core Identity com UserStore customizado (soft delete)
builder.Services.AddIdentity<Utilizador, IdentityRole>(options =>
{
    options.Password.RequireDigit = true;
    options.Password.RequireLowercase = true;
    options.Password.RequireUppercase = true;
    options.Password.RequireNonAlphanumeric = true;
    options.Password.RequiredLength = 16;
    options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(15);
    options.Lockout.MaxFailedAccessAttempts = 5;
    options.Lockout.AllowedForNewUsers = true;
    options.User.RequireUniqueEmail = true;
    options.SignIn.RequireConfirmedEmail = true;
})
.AddEntityFrameworkStores<ApplicationDbContext>() 
.AddUserStore<CustomUserStore>()                
.AddDefaultTokenProviders()
.AddClaimsPrincipalFactory<CustomClaimsPrincipalFactory>();

builder.Services.AddHttpContextAccessor();
builder.Services.AddScoped<IAuthorizationHandler, VendedorAprovadoHandler>();
builder.Services.AddSingleton<EmailFailureTracker>(sp =>
    new EmailFailureTracker(maxFailures: 5, failureWindow: TimeSpan.FromMinutes(5), circuitBreakerTimeout: TimeSpan.FromMinutes(1)));
builder.Services.AddScoped<IEmailSender, EmailSender>();
builder.Services.AddScoped<EmailTemplateService>();
builder.Services.AddScoped<IEmailAuthService, EmailAuthService>();

builder.Services.AddScoped<IFileService, FileService>();
builder.Services.AddScoped<ViewRenderService>();

builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IReservaService, ReservaService>();
builder.Services.AddScoped<ICheckoutService, CheckoutService>();

builder.Services.AddScoped<ICarrinhoService, CarrinhoService>();

// Opções
builder.Services.Configure<ReservationOptions>(builder.Configuration.GetSection("Reservation"));



builder.Services.AddSession(options => {                 
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

builder.Services.ConfigureApplicationCookie(options =>
{
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = builder.Environment.IsDevelopment()
        ? CookieSecurePolicy.SameAsRequest
        : CookieSecurePolicy.Always;
    options.ExpireTimeSpan = TimeSpan.FromMinutes(30);
    options.LoginPath = "/Public/Conta/Login";
    options.SlidingExpiration = true;
});

var app = builder.Build();

var encryptionService = app.Services.GetRequiredService<IEncryptionService>();
NifEncryptionHelper.Initialize(encryptionService);

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseSession();
var localizationOptions = app.Services.GetRequiredService<Microsoft.Extensions.Options.IOptions<RequestLocalizationOptions>>().Value;
app.UseRequestLocalization(localizationOptions);
app.UseAuthentication();
app.UseAuthorization();
app.UseStatusCodePages(context =>
{
    var response = context.HttpContext.Response;
    var user = context.HttpContext.User;

    if (response.StatusCode == 403 && user.IsInRole(Roles.Vendedor))
    {
        response.Redirect("/Conta/AguardandoAprovacao");
    }
    return Task.CompletedTask;
});
app.MapControllerRoute(
    name: "areas",
    pattern: "{area:exists}/{controller=Home}/{action=Index}/{id?}");

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}",
    defaults: new { area = "Public" }
);

app.MapAreaControllerRoute(
    name: "vendedores",
    areaName: "Vendedores",
    pattern: "Vendedores/{controller=Carros}/{action=Index}/{id?}");

app.Run();
</file>

</files>
