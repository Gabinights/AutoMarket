This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.repomixignore
.txt
appsettings.json
appsettings.Production.json
Areas/Admin/Controllers/AdminController.cs
Areas/Admin/Controllers/AnunciosController.cs
Areas/Admin/Controllers/DenunciasController.cs
Areas/Admin/Controllers/UtilizadoresController.cs
Areas/Admin/Views/_ViewImports.cshtml
Areas/Admin/Views/_ViewStart.cshtml
Areas/Admin/Views/Anuncios/Index.cshtml
Areas/Admin/Views/Dashboard.cshtml
Areas/Admin/Views/Denuncias/Detalhe.cshtml
Areas/Admin/Views/Denuncias/Index.cshtml
Areas/Admin/Views/Utilizadores/Index.cshtml
Areas/Public/Controllers/CarrinhoController.cs
Areas/Public/Controllers/CheckoutController.cs
Areas/Public/Controllers/ContaController.cs
Areas/Public/Controllers/DenunciasApiController.cs
Areas/Public/Controllers/FavoritosApiController.cs
Areas/Public/Controllers/HomeController.cs
Areas/Public/Controllers/NotificacoesApiController.cs
Areas/Public/Controllers/ReservasController.cs
Areas/Public/Controllers/TransacoesController.cs
Areas/Public/Controllers/VeiculosController.cs
Areas/Public/Controllers/VisitasController.cs
Areas/Public/Views/_ViewImports.cshtml
Areas/Public/Views/_ViewStart.cshtml
Areas/Public/Views/Carrinho/CarrinhoResumoViewComponent.cs
Areas/Public/Views/Carrinho/CartIndex.cshtml
Areas/Public/Views/Checkout/Confirmacao.cshtml
Areas/Public/Views/Checkout/Index.cshtml
Areas/Public/Views/Conta/AccessDenied.cshtml
Areas/Public/Views/Conta/AguardandoAprovacao.cshtml
Areas/Public/Views/Conta/AlterarPassword.cshtml
Areas/Public/Views/Conta/Favoritos.cshtml
Areas/Public/Views/Conta/Index.cshtml
Areas/Public/Views/Conta/Lockout.cshtml
Areas/Public/Views/Conta/Login.cshtml
Areas/Public/Views/Conta/Notificacoes.cshtml
Areas/Public/Views/Conta/Perfil.cshtml
Areas/Public/Views/Conta/PreencherDadosFiscais.cshtml
Areas/Public/Views/Conta/Register.cshtml
Areas/Public/Views/Denuncias/Criar.cshtml
Areas/Public/Views/Emails/EmailConfirmation.cshtml
Areas/Public/Views/Home/Ajuda.cshtml
Areas/Public/Views/Home/Contactos.cshtml
Areas/Public/Views/Home/Index.cshtml
Areas/Public/Views/Home/Politicas.cshtml
Areas/Public/Views/Home/Privacy.cshtml
Areas/Public/Views/Home/Sobre.cshtml
Areas/Public/Views/Home/Termos.cshtml
Areas/Public/Views/Reservas/Criar.cshtml
Areas/Public/Views/Reservas/Minhas.cshtml
Areas/Public/Views/Shared/_Footer.cshtml
Areas/Public/Views/Shared/_Header.cshtml
Areas/Public/Views/Shared/_Layout.cshtml
Areas/Public/Views/Shared/_Layout.cshtml.css
Areas/Public/Views/Shared/_LoginPartial.cshtml
Areas/Public/Views/Shared/_ValidationScriptsPartial.cshtml
Areas/Public/Views/Shared/Components/CarrinhoResumo/Default.cshtml
Areas/Public/Views/Shared/Error.cshtml
Areas/Public/Views/Transacao/MinhasCompras.cshtml
Areas/Public/Views/Transacao/MinhasVendas.cshtml
Areas/Public/Views/Veiculos/_CarListPartial.cshtml
Areas/Public/Views/Veiculos/Detalhe.cshtml
Areas/Public/Views/Veiculos/Index.cshtml
Areas/Public/Views/Visitas/Agendar.cshtml
Areas/Public/Views/Visitas/MinhasVisitas.cshtml
Areas/Public/Views/Visitas/VendedorDashboard.cshtml
Areas/Vendedores/_ViewImports.cshtml
Areas/Vendedores/_ViewStart.cshtml
Areas/Vendedores/Controllers/VeiculosController.cs
Areas/Vendedores/Views/Veiculos/Create.cshtml
Areas/Vendedores/Views/Veiculos/Delete.cshtml
Areas/Vendedores/Views/Veiculos/Details.cshtml
Areas/Vendedores/Views/Veiculos/Edit.cshtml
Areas/Vendedores/Views/Veiculos/Index.cshtml
AutoMarket.csproj
AutoMarket.sln
Controllers/CheckoutController.cs
Controllers/ContaController.cs
Docs/Diagnóstico Arquitetural.txt
GlobalUsings.cs
Infrastructure/Data/ApplicationDbContext.cs
Infrastructure/Data/CustomUserStore.cs
Infrastructure/Data/DbInitializer.cs
Infrastructure/Security/CustomClaimsPrincipalFactory.cs
Infrastructure/Security/NifEncryptionHelper.cs
Infrastructure/Security/VendedorAprovadoHandler.cs
Infrastructure/Security/VendedorAprovadoRequirement.cs
Infrastructure/Utils/NifValidator.cs
Infrastructure/Utils/SessionExtensions.cs
Models/Attributes/NifPortuguesAttribute.cs
Models/Constants/Roles.cs
Models/DTOs/AuthDto.cs
Models/DTOs/VeiculoDto.cs
Models/DTOs/VeiculoSearchFiltersDto.cs
Models/Entities/AuditoriaLog.cs
Models/Entities/CarrinhoItem.cs
Models/Entities/Categoria.cs
Models/Entities/Comprador.cs
Models/Entities/Denuncia.cs
Models/Entities/Favorito.cs
Models/Entities/ISoftDelete.cs
Models/Entities/Mensagem.cs
Models/Entities/Notificacao.cs
Models/Entities/Reserva.cs
Models/Entities/Transacao.cs
Models/Entities/Utilizador.cs
Models/Entities/Veiculo.cs
Models/Entities/VeiculoImagem.cs
Models/Entities/Vendedor.cs
Models/Entities/Visita.cs
Models/Enums/EstadoReserva.cs
Models/Enums/EstadoTransacao.cs
Models/Enums/EstadoVeiculo.cs
Models/Enums/EstadoVisita.cs
Models/Enums/MetodoPagamento.cs
Models/Enums/StatusAprovacao.cs
Models/Enums/TipoConta.cs
Models/ViewModels/AlterarPasswordViewModel.cs
Models/ViewModels/CarrinhoWidgetViewModel.cs
Models/ViewModels/CheckoutViewModel.cs
Models/ViewModels/DadosFiscaisViewModel.cs
Models/ViewModels/EditarPerfilViewModel.cs
Models/ViewModels/ErrorViewModel.cs
Models/ViewModels/LoginViewModel.cs
Models/ViewModels/RegisterViewModel.cs
Models/ViewModels/TransacaoListViewModel.cs
Models/ViewModels/Veiculos/CreateVeiculoViewModel.cs
Models/ViewModels/Veiculos/EditVeiculoViewModel.cs
Models/ViewModels/Veiculos/ListVeiculoViewModel.cs
Program.cs
README.md
repomix.config.json
Resources/EmailResources.resx
Services/Implementations/AuditoriaService.cs
Services/Implementations/AuthService.cs
Services/Implementations/CarrinhoService.cs
Services/Implementations/CheckoutService.cs
Services/Implementations/DenunciaService.cs
Services/Implementations/EmailAuthService.cs
Services/Implementations/EmailFailureTracker.cs
Services/Implementations/EmailSender.cs
Services/Implementations/EmailTemplateService.cs
Services/Implementations/EncryptionService.cs
Services/Implementations/EstatisticasService.cs
Services/Implementations/FavoritoService.cs
Services/Implementations/FileService.cs
Services/Implementations/GestaoUtilizadoresService.cs
Services/Implementations/LimparReservasHostedService.cs
Services/Implementations/MensagensService.cs
Services/Implementations/NotificacaoService.cs
Services/Implementations/ReservaService.cs
Services/Implementations/ViewRenderService.cs
Services/Implementations/VisitaService.cs
Services/Interfaces/IAuditoriaService.cs
Services/Interfaces/IAuthService.cs
Services/Interfaces/ICarrinhoService.cs
Services/Interfaces/ICheckoutService.cs
Services/Interfaces/IDenunciaService.cs
Services/Interfaces/IEmailAuthService.cs
Services/Interfaces/IEmailQueue.cs
Services/Interfaces/IEmailSender.cs
Services/Interfaces/IEncryptionService.cs
Services/Interfaces/IEstatisticasService.cs
Services/Interfaces/IFavoritoService.cs
Services/Interfaces/IFileService.cs
Services/Interfaces/IGestaoUtilizadoresService.cs
Services/Interfaces/IMensagensService.cs
Services/Interfaces/INotificacaoService.cs
Services/Interfaces/IReservaService.cs
Services/Interfaces/IVeiculoService.cs
Services/Interfaces/IVisitaService.cs
Views/Checkout/Sucesso.cshtml
Views/Shared/_Header.cshtml
wwwroot/css/pesquisa.css
wwwroot/css/site.css
wwwroot/css/style.css
wwwroot/js/script.js
wwwroot/js/site.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="Areas/Public/Views/Conta/AccessDenied.cshtml">
@{
    ViewData["Title"] = "Acesso Negado";
    var returnUrl = ViewData["ReturnUrl"] as string;
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 70vh;">
    <div class="card shadow-lg text-center p-5" style="max-width: 600px; width: 100%;">
        <div class="card-body">
            <!-- Ícone de Alerta -->
            <div class="mb-4">
                <i class="bi bi-shield-exclamation text-danger" style="font-size: 6rem;"></i>
            </div>

            <!-- Título -->
            <h1 class="card-title fw-bold text-danger mb-3">
                Acesso Negado
            </h1>

            <!-- Mensagem -->
            <p class="card-text text-muted mb-4 fs-5">
                Não tem permissões para aceder a esta página.
            </p>

            <!-- Informação Adicional -->
            <div class="alert alert-warning text-start" role="alert">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle-fill"></i> Possíveis Razões:
                </h6>
                <ul class="mb-0">
                    <li><strong>Não é vendedor:</strong> Esta página é exclusiva para utilizadores com conta de vendedor aprovada.</li>
                    <li><strong>Conta pendente:</strong> Se é vendedor, a sua conta pode estar a aguardar aprovação.</li>
                    <li><strong>Sessão expirada:</strong> Por favor, faça login novamente.</li>
                </ul>
            </div>

            @if (!string.IsNullOrEmpty(returnUrl))
            {
                <div class="alert alert-info text-start" role="alert">
                    <strong>Tentou aceder:</strong> 
                    <code>@returnUrl</code>
                </div>
            }

            <!-- Ações -->
            <div class="d-grid gap-2 mt-4">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <!-- Utilizador Logado -->
                    <a asp-controller="Conta" asp-action="Perfil" class="btn btn-primary btn-lg">
                        <i class="bi bi-person-circle"></i> Ver o Meu Perfil
                    </a>
                    
                    @if (!User.IsInRole("Vendedor"))
                    {
                        <a asp-controller="Conta" asp-action="Register" class="btn btn-success btn-lg">
                            <i class="bi bi-shop"></i> Criar Conta de Vendedor
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Conta" asp-action="AguardandoAprovacao" class="btn btn-warning btn-lg">
                            <i class="bi bi-hourglass-split"></i> Estado da Aprovação
                        </a>
                    }
                }
                else
                {
                    <!-- Utilizador Não Logado -->
                    <a asp-controller="Conta" asp-action="Login" asp-route-returnUrl="@returnUrl" class="btn btn-primary btn-lg">
                        <i class="bi bi-box-arrow-in-right"></i> Fazer Login
                    </a>
                    
                    <a asp-controller="Conta" asp-action="Register" class="btn btn-success btn-lg">
                        <i class="bi bi-person-plus"></i> Criar Conta
                    </a>
                }

                <hr />

                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-house"></i> Voltar à Página Inicial
                </a>

                <a asp-controller="Home" asp-action="Ajuda" class="btn btn-outline-info btn-lg">
                    <i class="bi bi-question-circle"></i> Centro de Ajuda
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        border-radius: 15px;
    }

    .btn-lg {
        padding: 0.8rem 1.5rem;
    }

    code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        color: #d63384;
    }
</style>
</file>

<file path="Areas/Public/Views/Conta/AlterarPassword.cshtml">
@model AutoMarket.Models.ViewModels.AlterarPasswordViewModel
@{
    ViewData["Title"] = "Alterar Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Hero Header -->
<section class="bg-warning text-dark py-4">
    <div class="container">
        <h1 class="mb-1">
            <i class="bi bi-key-fill"></i> Alterar Password
        </h1>
        <p class="mb-0">
            Altere a sua password de acesso
        </p>
    </div>
</section>

<!-- Conteúdo -->
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Card Principal -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-shield-lock"></i> Nova Password
                    </h5>

                    <!-- Alertas -->
                    @if (ViewData.ModelState.ErrorCount > 0)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> 
                            <strong>Erro ao alterar password:</strong>
                            <ul class="mb-0 mt-2">
                                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle-fill"></i> Requisitos de Segurança
                        </h6>
                        <p class="mb-0">A nova password deve ter:</p>
                        <ul class="mb-0 mt-2">
                            <li><strong>Mínimo de 16 caracteres</strong></li>
                            <li>Pelo menos <strong>uma letra maiúscula</strong> (A-Z)</li>
                            <li>Pelo menos <strong>uma letra minúscula</strong> (a-z)</li>
                            <li>Pelo menos <strong>um número</strong> (0-9)</li>
                            <li>Pelo menos <strong>um carácter especial</strong> (@@, #, $, !, etc.)</li>
                        </ul>
                    </div>

                    <!-- Formulário -->
                    <form asp-action="AlterarPassword" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="PasswordAtual" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input asp-for="PasswordAtual" class="form-control" placeholder="Introduza a password atual" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordAtual">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="PasswordAtual" class="text-danger"></span>
                        </div>

                        <hr class="my-4" />

                        <div class="mb-3">
                            <label asp-for="NovaPassword" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input asp-for="NovaPassword" class="form-control" placeholder="Introduza a nova password" id="novaPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleNovaPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NovaPassword" class="text-danger"></span>
                            
                            <!-- Indicador de Força da Password -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Força da password</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmarNovaPassword" class="form-label fw-bold"></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-check2"></i>
                                </span>
                                <input asp-for="ConfirmarNovaPassword" class="form-control" placeholder="Confirme a nova password" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmarNovaPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="bi bi-key-fill"></i> Alterar Password
                            </button>
                            <a asp-action="Perfil" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left"></i> Voltar ao Perfil
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dicas de Segurança -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-lightbulb"></i> Dicas de Segurança
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Não partilhe a sua password com ninguém</li>
                        <li>Use passwords diferentes para cada serviço</li>
                        <li>Altere a sua password regularmente</li>
                        <li>Evite passwords óbvias (datas de nascimento, nomes, etc.)</li>
                        <li>Considere usar um gestor de passwords</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Toggle visibilidade das passwords
        function setupPasswordToggle(toggleBtnId, inputId) {
            const btn = document.getElementById(toggleBtnId);
            const input = document.getElementById(inputId) || document.querySelector(`input[name="${inputId}"]`);
            
            if (btn && input) {
                btn.addEventListener('click', function() {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    
                    const icon = this.querySelector('i');
                    icon.classList.toggle('bi-eye');
                    icon.classList.toggle('bi-eye-slash');
                });
            }
        }

        setupPasswordToggle('togglePasswordAtual', 'PasswordAtual');
        setupPasswordToggle('toggleNovaPassword', 'novaPassword');
        setupPasswordToggle('toggleConfirmarPassword', 'ConfirmarNovaPassword');

        // Indicador de força da password
        const passwordInput = document.getElementById('novaPassword');
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('passwordStrengthText');

        if (passwordInput && strengthBar && strengthText) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let feedback = [];

                if (password.length === 0) {
                    strengthBar.style.width = '0%';
                    strengthBar.className = 'progress-bar';
                    strengthText.textContent = 'Força da password';
                    return;
                }

                // Critérios de força
                if (password.length >= 16) strength += 20;
                else if (password.length >= 12) strength += 10;
                else feedback.push('Mínimo 16 caracteres');

                if (/[a-z]/.test(password)) strength += 20;
                else feedback.push('Falta minúscula');

                if (/[A-Z]/.test(password)) strength += 20;
                else feedback.push('Falta maiúscula');

                if (/[0-9]/.test(password)) strength += 20;
                else feedback.push('Falta número');

                if (/[^a-zA-Z0-9]/.test(password)) strength += 20;
                else feedback.push('Falta carácter especial');

                // Atualizar barra
                strengthBar.style.width = strength + '%';
                
                if (strength < 40) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Fraca: ' + feedback.join(', ');
                    strengthText.className = 'text-danger small';
                } else if (strength < 80) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Média: ' + feedback.join(', ');
                    strengthText.className = 'text-warning small';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Forte: Todos os requisitos cumpridos!';
                    strengthText.className = 'text-success small';
                }
            });
        }
    </script>
}

<style>
    .input-group-text {
        background-color: #f8f9fa;
    }

    .progress {
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        transition: width 0.3s ease, background-color 0.3s ease;
    }
</style>
</file>

<file path="Areas/Public/Views/Conta/Perfil.cshtml">
@model AutoMarket.Models.ViewModels.EditarPerfilViewModel
@{
    ViewData["Title"] = "O Meu Perfil";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Hero Header -->
<section class="bg-primary text-white py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-1">
                    <i class="bi bi-person-circle"></i> O Meu Perfil
                </h1>
                <p class="mb-0 opacity-75">
                    Gerir a sua conta e preferências
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="badge bg-light text-dark fs-6">
                    @if (ViewBag.IsVendedor)
                    {
                        <i class="bi bi-shop"></i> @: Vendedor
                    }
                    else
                    {
                        <i class="bi bi-cart-check"></i> @: Comprador
                    }
                </span>
            </div>
        </div>
    </div>
</section>

<!-- Mensagens de Feedback -->
@if (TempData["MensagemSucesso"] != null)
{
    <div class="container mt-3">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["MensagemSucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

<!-- Conteúdo Principal -->
<div class="container my-5">
    <div class="row">
        <!-- Sidebar com Estatísticas -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-person-circle text-primary" style="font-size: 5rem;"></i>
                    </div>
                    <h5 class="card-title fw-bold">@Model.Nome</h5>
                    <p class="text-muted small mb-3">
                        <i class="bi bi-envelope"></i> @Model.Email
                    </p>
                    <p class="text-muted small">
                        <i class="bi bi-calendar-check"></i> 
                        Membro desde @Model.DataRegisto.ToString("dd/MM/yyyy")
                    </p>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-graph-up"></i> Estatísticas
                    </h6>
                </div>
                <div class="card-body">
                    @if (ViewBag.IsComprador)
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Compras:</span>
                            <strong class="text-primary">@(ViewBag.TotalCompras ?? 0)</strong>
                        </div>
                    }
                    @if (ViewBag.IsVendedor)
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Vendas:</span>
                            <strong class="text-success">@(ViewBag.TotalVendas ?? 0)</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Veículos:</span>
                            <strong class="text-info">@(ViewBag.TotalVeiculos ?? 0)</strong>
                        </div>
                        <hr />
                        <div class="text-center">
                            <span class="badge bg-@(ViewBag.StatusVendedor == "Aprovado" ? "success" : "warning")">
                                Status: @ViewBag.StatusVendedor
                            </span>
                        </div>
                    }
                </div>
            </div>

            <!-- Links Rápidos -->
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-link-45deg"></i> Links Rápidos
                    </h6>
                </div>
                <div class="list-group list-group-flush">
                    @if (ViewBag.IsComprador)
                    {
                        <a asp-controller="Transacoes" asp-action="MinhasCompras" class="list-group-item list-group-item-action">
                            <i class="bi bi-bag-check"></i> Minhas Compras
                        </a>
                    }
                    @if (ViewBag.IsVendedor)
                    {
                        <a asp-controller="Transacoes" asp-action="MinhasVendas" class="list-group-item list-group-item-action">
                            <i class="bi bi-cash-stack"></i> Minhas Vendas
                        </a>
                        <a asp-area="Vendedores" asp-controller="Carros" asp-action="Index" class="list-group-item list-group-item-action">
                            <i class="bi bi-car-front"></i> Meus Veículos
                        </a>
                    }
                    <a asp-controller="Home" asp-action="Ajuda" class="list-group-item list-group-item-action">
                        <i class="bi bi-question-circle"></i> Centro de Ajuda
                    </a>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal com Tabs -->
        <div class="col-lg-9">
            <div class="card shadow-sm border-0">
                <!-- Tabs Navigation -->
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="perfilTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados" type="button" role="tab">
                                <i class="bi bi-person"></i> Dados Pessoais
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                <i class="bi bi-key"></i> Password
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="seguranca-tab" data-bs-toggle="tab" data-bs-target="#seguranca" type="button" role="tab">
                                <i class="bi bi-shield-check"></i> Segurança
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tabs Content -->
                <div class="card-body">
                    <div class="tab-content" id="perfilTabsContent">
                        
                        <!-- Tab: Dados Pessoais -->
                        <div class="tab-pane fade show active" id="dados" role="tabpanel">
                            <h5 class="card-title mb-4">
                                <i class="bi bi-pencil-square"></i> Editar Dados Pessoais
                            </h5>
                            
                            <form asp-action="Perfil" method="post">
                                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label asp-for="Nome" class="form-label fw-bold"></label>
                                        <input asp-for="Nome" class="form-control" placeholder="Nome completo" />
                                        <span asp-validation-for="Nome" class="text-danger"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label asp-for="Email" class="form-label fw-bold"></label>
                                        <input asp-for="Email" class="form-control" readonly disabled />
                                        <small class="text-muted">O email não pode ser alterado</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label asp-for="Contacto" class="form-label fw-bold"></label>
                                        <input asp-for="Contacto" class="form-control" placeholder="+351 912 345 678" />
                                        <span asp-validation-for="Contacto" class="text-danger"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label asp-for="NIF" class="form-label fw-bold"></label>
                                        <input asp-for="NIF" class="form-control" placeholder="123456789" maxlength="9" />
                                        <span asp-validation-for="NIF" class="text-danger"></span>
                                    </div>

                                    <div class="col-12">
                                        <label asp-for="Morada" class="form-label fw-bold"></label>
                                        <textarea asp-for="Morada" class="form-control" rows="3" placeholder="Rua, Número, Código Postal, Localidade"></textarea>
                                        <span asp-validation-for="Morada" class="text-danger"></span>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-save"></i> Guardar Alterações
                                        </button>
                                        <a asp-action="Perfil" class="btn btn-outline-secondary btn-lg ms-2">
                                            <i class="bi bi-x-circle"></i> Cancelar
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Tab: Password -->
                        <div class="tab-pane fade" id="password" role="tabpanel">
                            <h5 class="card-title mb-4">
                                <i class="bi bi-key-fill"></i> Alterar Password
                            </h5>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> 
                                <strong>Requisitos de Segurança:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Mínimo de 16 caracteres</li>
                                    <li>Pelo menos uma letra maiúscula</li>
                                    <li>Pelo menos uma letra minúscula</li>
                                    <li>Pelo menos um número</li>
                                    <li>Pelo menos um carácter especial (@@, #, $, etc.)</li>
                                </ul>
                            </div>

                            <a asp-action="AlterarPassword" class="btn btn-warning btn-lg">
                                <i class="bi bi-key"></i> Ir para Alteração de Password
                            </a>
                        </div>

                        <!-- Tab: Segurança -->
                        <div class="tab-pane fade" id="seguranca" role="tabpanel">
                            <h5 class="card-title mb-4 text-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> Zona de Perigo
                            </h5>

                            <div class="alert alert-warning">
                                <h6 class="alert-heading">
                                    <i class="bi bi-shield-exclamation"></i> Apagar Conta
                                </h6>
                                <p>
                                    Ao apagar a sua conta:
                                </p>
                                <ul>
                                    <li>A conta será <strong>desativada permanentemente</strong></li>
                                    <li>Não poderá fazer login novamente</li>
                                    <li>Os seus anúncios ficam ocultos</li>
                                    <li>O histórico de transações é mantido (obrigação legal)</li>
                                </ul>
                                <hr />
                                <p class="mb-0">
                                    <strong>Esta ação não pode ser revertida!</strong>
                                </p>
                            </div>

                            <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#confirmarApagarModal">
                                <i class="bi bi-trash-fill"></i> Apagar a Minha Conta
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Apagar Conta -->
<div class="modal fade" id="confirmarApagarModal" tabindex="-1" aria-labelledby="confirmarApagarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmarApagarLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> Confirmar Eliminação
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fw-bold">Tem a certeza absoluta que deseja apagar a sua conta?</p>
                <p>Esta ação é <strong>irreversível</strong> e irá:</p>
                <ul>
                    <li>Desativar permanentemente a sua conta</li>
                    <li>Impedir futuros logins</li>
                    <li>Ocultar todos os seus anúncios</li>
                </ul>
                <p class="text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i> 
                    <strong>Não será possível recuperar esta conta!</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <form asp-action="ApagarConta" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill"></i> Sim, Apagar Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Manter tab ativa após refresh
        document.addEventListener('DOMContentLoaded', function() {
            var activeTab = localStorage.getItem('activePerfilTab');
            if (activeTab) {
                var tab = new bootstrap.Tab(document.querySelector('#' + activeTab));
                tab.show();
            }
        });

        // Guardar tab ativa
        document.querySelectorAll('#perfilTabs button').forEach(function(tab) {
            tab.addEventListener('shown.bs.tab', function(e) {
                localStorage.setItem('activePerfilTab', e.target.id);
            });
        });
    </script>
}

<style>
    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        border-color: #dee2e6;
        color: #0d6efd;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-color: #0d6efd;
    }

    .list-group-item-action:hover {
        background-color: #f8f9fa;
    }
</style>
</file>

<file path="Areas/Public/Views/Transacao/MinhasCompras.cshtml">
@model IEnumerable<AutoMarket.Models.ViewModels.TransacaoListViewModel>
@{
    ViewData["Title"] = "Minhas Compras";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold">
                <i class="bi bi-bag-check text-primary"></i> Minhas Compras
            </h2>
            <p class="text-muted">Histзrico de todas as suas transaушes como comprador</p>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
            <h5>Ainda nсo realizou nenhuma compra</h5>
            <p class="mb-3">Explore o nosso catрlogo e encontre o veьculo ideal para si!</p>
            <a asp-controller="Veiculos" asp-action="Index" class="btn btn-primary">
                <i class="bi bi-search"></i> Ver Veьculos Disponьveis
            </a>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var transacao in Model)
            {
                <div class="col-12">
                    <div class="card shadow-sm hover-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Imagem do Veьculo -->
                                <div class="col-md-3 col-12 mb-3 mb-md-0">
                                    @if (!string.IsNullOrEmpty(transacao.VeiculoImagemCapa))
                                    {
                                        <img src="@transacao.VeiculoImagemCapa" 
                                             alt="@transacao.VeiculoTitulo" 
                                             class="img-fluid rounded" 
                                             style="max-height: 150px; object-fit: cover; width: 100%;">
                                    }
                                    else
                                    {
                                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" 
                                             style="height: 150px;">
                                            <i class="bi bi-car-front-fill fs-1"></i>
                                        </div>
                                    }
                                </div>

                                <!-- Detalhes da Transaусo -->
                                <div class="col-md-6 col-12">
                                    <h5 class="fw-bold mb-2">
                                        <a asp-controller="Veiculos" asp-action="Detalhe" asp-route-id="@transacao.VeiculoId" 
                                           class="text-decoration-none text-dark">
                                            @transacao.VeiculoTitulo
                                        </a>
                                    </h5>
                                    <p class="text-muted mb-2">
                                        <strong>@transacao.VeiculoMarca @transacao.VeiculoModelo</strong>
                                    </p>
                                    <div class="mb-2">
                                        <span class="badge bg-secondary me-2">
                                            <i class="bi bi-calendar3"></i> @transacao.DataTransacao.ToString("dd/MM/yyyy")
                                        </span>
                                        <span class="badge 
                                            @(transacao.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pago ? "bg-success" : 
                                              transacao.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pendente ? "bg-warning" : "bg-danger")">
                                            @transacao.Estado
                                        </span>
                                    </div>
                                    <p class="mb-1 small">
                                        <strong>Vendedor:</strong> @transacao.VendedorNome
                                    </p>
                                    <p class="mb-1 small">
                                        <strong>Mжtodo:</strong> @transacao.Metodo
                                    </p>
                                    @if (!string.IsNullOrEmpty(transacao.MoradaEnvioSnapshot))
                                    {
                                        <p class="mb-0 small text-muted">
                                            <i class="bi bi-geo-alt"></i> @transacao.MoradaEnvioSnapshot
                                        </p>
                                    }
                                </div>

                                <!-- Valor e Aушes -->
                                <div class="col-md-3 col-12 text-md-end">
                                    <h4 class="fw-bold text-primary mb-3">
                                        @transacao.ValorPago.ToString("C2")
                                    </h4>
                                    <div class="d-grid gap-2">
                                        <a asp-controller="Veiculos" asp-action="Detalhe" asp-route-id="@transacao.VeiculoId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Ver Veьculo
                                        </a>
                                        @if (!string.IsNullOrEmpty(transacao.NifFaturacaoSnapshot))
                                        {
                                            <small class="text-muted">
                                                <i class="bi bi-file-text"></i> NIF: @transacao.NifFaturacaoSnapshot
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Resumo no Final -->
        <div class="card mt-4 bg-light">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4 col-12 mb-3 mb-md-0">
                        <h5 class="fw-bold text-primary">@Model.Count()</h5>
                        <p class="text-muted mb-0">Total de Compras</p>
                    </div>
                    <div class="col-md-4 col-12 mb-3 mb-md-0">
                        <h5 class="fw-bold text-success">@Model.Sum(t => t.ValorPago).ToString("C2")</h5>
                        <p class="text-muted mb-0">Valor Total Investido</p>
                    </div>
                    <div class="col-md-4 col-12">
                        <h5 class="fw-bold text-info">@Model.Count(t => t.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pago)</h5>
                        <p class="text-muted mb-0">Compras Concluьdas</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
</style>
</file>

<file path="Areas/Public/Views/Transacao/MinhasVendas.cshtml">
@model IEnumerable<AutoMarket.Models.ViewModels.TransacaoListViewModel>
@{
    ViewData["Title"] = "Minhas Vendas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold">
                <i class="bi bi-graph-up-arrow text-success"></i> Minhas Vendas
            </h2>
            <p class="text-muted">Histórico de todas as suas transações como vendedor</p>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
            <h5>Ainda não realizou nenhuma venda</h5>
            <p class="mb-3">Comece a vender os seus veículos na nossa plataforma!</p>
            <a asp-area="Vendedores" asp-controller="Veiculos" asp-action="Create" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Adicionar Veículo
            </a>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var transacao in Model)
            {
                <div class="col-12">
                    <div class="card shadow-sm hover-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Imagem do Veículo -->
                                <div class="col-md-3 col-12 mb-3 mb-md-0">
                                    @if (!string.IsNullOrEmpty(transacao.VeiculoImagemCapa))
                                    {
                                        <img src="@transacao.VeiculoImagemCapa" 
                                             alt="@transacao.VeiculoTitulo" 
                                             class="img-fluid rounded" 
                                             style="max-height: 150px; object-fit: cover; width: 100%;">
                                    }
                                    else
                                    {
                                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" 
                                             style="height: 150px;">
                                            <i class="bi bi-car-front-fill fs-1"></i>
                                        </div>
                                    }
                                </div>

                                <!-- Detalhes da Transação -->
                                <div class="col-md-6 col-12">
                                    <h5 class="fw-bold mb-2">
                                        <a asp-controller="Veiculos" asp-action="Detalhe" asp-route-id="@transacao.VeiculoId" 
                                           class="text-decoration-none text-dark">
                                            @transacao.VeiculoTitulo
                                        </a>
                                    </h5>
                                    <p class="text-muted mb-2">
                                        <strong>@transacao.VeiculoMarca @transacao.VeiculoModelo</strong>
                                    </p>
                                    <div class="mb-2">
                                        <span class="badge bg-secondary me-2">
                                            <i class="bi bi-calendar3"></i> @transacao.DataTransacao.ToString("dd/MM/yyyy")
                                        </span>
                                        <span class="badge 
                                            @(transacao.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pago ? "bg-success" : 
                                              transacao.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pendente ? "bg-warning" : "bg-danger")">
                                            @transacao.Estado
                                        </span>
                                    </div>
                                    <p class="mb-1 small">
                                        <strong>Comprador:</strong> @transacao.CompradorNome
                                    </p>
                                    <p class="mb-1 small">
                                        <strong>Método:</strong> @transacao.Metodo
                                    </p>
                                    @if (!string.IsNullOrEmpty(transacao.MoradaEnvioSnapshot))
                                    {
                                        <p class="mb-0 small text-muted">
                                            <i class="bi bi-geo-alt"></i> @transacao.MoradaEnvioSnapshot
                                        </p>
                                    }
                                </div>

                                <!-- Valor e Ações -->
                                <div class="col-md-3 col-12 text-md-end">
                                    <h4 class="fw-bold text-success mb-3">
                                        @transacao.ValorPago.ToString("C2")
                                    </h4>
                                    <div class="d-grid gap-2">
                                        <a asp-controller="Veiculos" asp-action="Detalhe" asp-route-id="@transacao.VeiculoId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Ver Veículo
                                        </a>
                                        @if (!string.IsNullOrEmpty(transacao.NifFaturacaoSnapshot))
                                        {
                                            <small class="text-muted">
                                                <i class="bi bi-file-text"></i> NIF: @transacao.NifFaturacaoSnapshot
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Resumo no Final -->
        <div class="card mt-4 bg-light">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4 col-12 mb-3 mb-md-0">
                        <h5 class="fw-bold text-primary">@Model.Count()</h5>
                        <p class="text-muted mb-0">Total de Vendas</p>
                    </div>
                    <div class="col-md-4 col-12 mb-3 mb-md-0">
                        <h5 class="fw-bold text-success">@Model.Sum(t => t.ValorPago).ToString("C2")</h5>
                        <p class="text-muted mb-0">Receita Total</p>
                    </div>
                    <div class="col-md-4 col-12">
                        <h5 class="fw-bold text-info">@Model.Count(t => t.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pago)</h5>
                        <p class="text-muted mb-0">Vendas Concluídas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dica para Vendedores -->
        <div class="alert alert-success mt-4">
            <i class="bi bi-lightbulb-fill"></i>
            <strong>Dica:</strong> Mantenha os seus veículos sempre atualizados com fotos e descrições detalhadas para aumentar as vendas!
        </div>
    }
</div>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
</style>
</file>

<file path="Docs/Diagnóstico Arquitetural.txt">

</file>

<file path=".repomixignore">
# --- .NET Build & Cache (CRÍTICO: Isso economiza 90% dos tokens) ---
bin/
obj/
.vs/
.vscode/
.idea/
*.user
*.suo
*.pdb
*.dll
*.exe
*.cache

# --- Dependências de Frontend (O LLM já conhece jQuery/Bootstrap) ---
# Ignoramos as libs baixadas, mas mantemos seu código customizado em css/ e js/
wwwroot/lib/
node_modules/
package-lock.json
yarn.lock
jspm_packages/

# --- Entity Framework Core ---
# Geralmente as classes de Modelo (Entities) e o DbContext são suficientes.
# Os arquivos de migração são gerados automaticamente e gastam muitos tokens.
Migrations/

# --- Arquivos de Sistema e Logs ---
*.log
*.ds_store
Thumbs.db

# --- Assets Binários (Imagens/Fontes não são legíveis por texto) ---
wwwroot/images/
wwwroot/favicon.ico
**/*.png
**/*.jpg
**/*.jpeg
**/*.gif
**/*.svg
**/*.ico
**/*.woff
**/*.woff2
**/*.ttf
**/*.eot

# --- Configurações Sensíveis (Opcional, mas recomendado) ---
# Cuidado para não enviar senhas de banco de dados para a IA
appsettings.Development.json
Properties/launchSettings.json
</file>

<file path=".txt">

</file>

<file path="Areas/Admin/Controllers/AnunciosController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Admin.Controllers
{
    [Area("Admin")]
    [Authorize(Roles = "Admin")]
    public class AnunciosController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<AnunciosController> _logger;

        public AnunciosController(ApplicationDbContext context, ILogger<AnunciosController> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// GET: Admin/Anuncios
        /// Listar todos os anúncios para moderar
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index(string? estado = null, int page = 1)
        {
            try
            {
                var query = _context.Veiculos
                    .Include(v => v.Vendedor)
                    .ThenInclude(v => v.User)
                    .Include(v => v.Imagens)
                    .AsQueryable();

                // Filtro por estado
                if (!string.IsNullOrEmpty(estado))
                    query = query.Where(v => v.Estado.ToString() == estado);

                var total = await query.CountAsync();
                const int pageSize = 10;

                var anuncios = await query
                    .OrderByDescending(v => v.DataCriacao)
                    .Skip((page - 1) * pageSize)
                    .Take(pageSize)
                    .ToListAsync();

                ViewData["CurrentPage"] = page;
                ViewData["TotalPages"] = (int)Math.Ceiling(total / (decimal)pageSize);
                ViewData["TotalAnuncios"] = total;
                ViewData["EstadoFiltro"] = estado;

                return View(anuncios);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao listar anúncios");
                return RedirectToAction("Index", "Admin");
            }
        }

        /// <summary>
        /// GET: Admin/Anuncios/Pausar/5
        /// Pausar um anúncio
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Pausar(int id)
        {
            try
            {
                var veiculo = await _context.Veiculos.FindAsync(id);
                if (veiculo == null) return NotFound();

                veiculo.Estado = Models.Enums.EstadoVeiculo.Pausado;
                _context.Update(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Anúncio {VeiculoId} pausado pelo admin", id);
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao pausar anúncio");
                return RedirectToAction(nameof(Index));
            }
        }

        /// <summary>
        /// GET: Admin/Anuncios/Remover/5
        /// Remover um anúncio
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> Remover(int id)
        {
            try
            {
                var veiculo = await _context.Veiculos.FindAsync(id);
                if (veiculo == null) return NotFound();

                _context.Remove(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Anúncio {VeiculoId} removido pelo admin", id);
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao remover anúncio");
                return RedirectToAction(nameof(Index));
            }
        }
    }
}
</file>

<file path="Areas/Admin/Controllers/DenunciasController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Admin.Controllers
{
    [Authorize(Roles = Roles.Admin)]
    [Area("Admin")]
    public class DenunciasController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly IDenunciaService _denunciaService;
        private readonly IAuditoriaService _auditoriaService;
        private readonly ILogger<DenunciasController> _logger;

        public DenunciasController(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            IDenunciaService denunciaService,
            IAuditoriaService auditoriaService,
            ILogger<DenunciasController> logger)
        {
            _context = context;
            _userManager = userManager;
            _denunciaService = denunciaService;
            _auditoriaService = auditoriaService;
            _logger = logger;
        }

        /// <summary>
        /// GET: Admin/Denuncias/Index
        /// Lista todas as denúncias com filtro por estado.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index(string? estado = null, int page = 1)
        {
            try
            {
                var denuncias = await _denunciaService.ListarDenunciasAsync(estado, page, 20);
                var contagens = await _denunciaService.ContarPorEstadoAsync();

                ViewData["Contagens"] = contagens;
                ViewData["EstadoFiltro"] = estado;
                ViewData["CurrentPage"] = page;

                return View(denuncias);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao listar denúncias");
                TempData["Erro"] = "Erro ao carregar denúncias.";
                return View(new List<Denuncia>());
            }
        }

        /// <summary>
        /// GET: Admin/Denuncias/Detalhe/5
        /// Exibe detalhes completos de uma denúncia.
        /// </summary>
        [HttpGet("{id}")]
        [Route("Admin/Denuncias/{id}")]
        public async Task<IActionResult> Detalhe(int id)
        {
            var denuncia = await _denunciaService.ObterDenunciaAsync(id);
            if (denuncia == null)
                return NotFound();

            return View(denuncia);
        }

        /// <summary>
        /// POST: Admin/Denuncias/IniciarAnalise/5
        /// Muda denúncia de "Aberta" para "Em Análise".
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> IniciarAnalise(int id)
        {
            var adminId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(adminId))
                return Unauthorized();

            var sucesso = await _denunciaService.IniciarAnaliseAsync(id, adminId);
            if (!sucesso)
            {
                TempData["Erro"] = "Não foi possível iniciar a análise.";
                return RedirectToAction(nameof(Detalhe), new { id });
            }

            TempData["Sucesso"] = "Análise iniciada.";
            return RedirectToAction(nameof(Detalhe), new { id });
        }

        /// <summary>
        /// POST: Admin/Denuncias/Encerrar/5
        /// Encerra denúncia com decisão (Procedente/Não Procedente).
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Encerrar(int id, bool procedente, string decisao)
        {
            var adminId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(adminId))
                return Unauthorized();

            if (string.IsNullOrWhiteSpace(decisao))
            {
                TempData["Erro"] = "Decisão não pode estar vazia.";
                return RedirectToAction(nameof(Detalhe), new { id });
            }

            var sucesso = await _denunciaService.EncerrarDenunciaAsync(id, adminId, procedente, decisao);
            if (!sucesso)
            {
                TempData["Erro"] = "Não foi possível encerrar a denúncia.";
                return RedirectToAction(nameof(Detalhe), new { id });
            }

            TempData["Sucesso"] = $"Denúncia encerrada como {(procedente ? "PROCEDENTE" : "NÃO PROCEDENTE")}.";
            return RedirectToAction(nameof(Index));
        }
    }
}
</file>

<file path="Areas/Admin/Controllers/UtilizadoresController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Admin.Controllers
{
    [Authorize(Roles = Roles.Admin)]
    [Area("Admin")]
    public class UtilizadoresController : Controller
    {
        private readonly UserManager<Utilizador> _userManager;
        private readonly IGestaoUtilizadoresService _gestaoService;
        private readonly ILogger<UtilizadoresController> _logger;

        public UtilizadoresController(
            UserManager<Utilizador> userManager,
            IGestaoUtilizadoresService gestaoService,
            ILogger<UtilizadoresController> logger)
        {
            _userManager = userManager;
            _gestaoService = gestaoService;
            _logger = logger;
        }

        /// <summary>
        /// GET: Admin/Utilizadores/Index
        /// Lista utilizadores bloqueados.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index(int page = 1)
        {
            var bloqueados = await _gestaoService.ListarUtilizadoresBloqueadosAsync(page, 20);
            var totalBloqueados = await _userManager.Users
                .CountAsync(u => u.IsBlocked && !u.IsDeleted);

            ViewData["TotalPages"] = (int)Math.Ceiling(totalBloqueados / 20.0);
            ViewData["CurrentPage"] = page;

            return View(bloqueados);
        }

        /// <summary>
        /// POST: Admin/Utilizadores/Bloquear
        /// Bloqueia um utilizador.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Bloquear(string utilizadorId, string motivo)
        {
            if (string.IsNullOrWhiteSpace(utilizadorId) || string.IsNullOrWhiteSpace(motivo))
            {
                TempData["Erro"] = "Utilizador e motivo são obrigatórios.";
                return RedirectToAction(nameof(Index));
            }

            var adminId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(adminId))
                return Unauthorized();

            var sucesso = await _gestaoService.BloquearUtilizadorAsync(utilizadorId, motivo, adminId);
            if (!sucesso)
            {
                TempData["Erro"] = "Não foi possível bloquear o utilizador.";
                return RedirectToAction(nameof(Index));
            }

            TempData["Sucesso"] = "Utilizador bloqueado com sucesso.";
            return RedirectToAction(nameof(Index));
        }

        /// <summary>
        /// POST: Admin/Utilizadores/Desbloquear
        /// Desbloqueia um utilizador.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Desbloquear(string utilizadorId)
        {
            if (string.IsNullOrWhiteSpace(utilizadorId))
            {
                TempData["Erro"] = "ID do utilizador inválido.";
                return RedirectToAction(nameof(Index));
            }

            var adminId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(adminId))
                return Unauthorized();

            var sucesso = await _gestaoService.DesbloquearUtilizadorAsync(utilizadorId, adminId);
            if (!sucesso)
            {
                TempData["Erro"] = "Não foi possível desbloquear o utilizador.";
                return RedirectToAction(nameof(Index));
            }

            TempData["Sucesso"] = "Utilizador desbloqueado com sucesso.";
            return RedirectToAction(nameof(Index));
        }
    }
}
</file>

<file path="Areas/Admin/Views/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Admin/Views/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Admin/Views/Dashboard.cshtml">
@model dynamic
@{
    ViewData["Title"] = "Dashboard Admin";
}

<div class="container-fluid py-4">
    <!-- HEADER -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="fw-bold mb-1">?? Dashboard Admin</h1>
            <p class="text-muted">Bem-vindo ao painel de administração do AutoMarket</p>
        </div>
    </div>

    <!-- KPIs PRINCIPAIS -->
    <div class="row mb-4 g-3">
        <!-- Total Compradores -->
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total de Compradores</h6>
                            <h3 class="fw-bold text-primary mb-0">@(Model?.TotalCompradores ?? 0)</h3>
                        </div>
                        <span style="font-size: 2rem;">??</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Vendedores -->
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total de Vendedores</h6>
                            <h3 class="fw-bold text-success mb-0">@(Model?.TotalVendedores ?? 0)</h3>
                        </div>
                        <span style="font-size: 2rem;">??</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anúncios Ativos -->
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Anúncios Ativos</h6>
                            <h3 class="fw-bold text-warning mb-0">@(Model?.TotalAnunciosAtivos ?? 0)</h3>
                        </div>
                        <span style="font-size: 2rem;">??</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Vendas -->
        <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total de Vendas</h6>
                            <h3 class="fw-bold text-danger mb-0">€@(Model?.TotalVendas?.ToString("F0") ?? "0")</h3>
                        </div>
                        <span style="font-size: 2rem;">??</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="row mb-4 g-3">
        <!-- Gráfico: Vendas por Período -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0">?? Vendas por Período (últimos 6 meses)</h5>
                </div>
                <div class="card-body" style="height: 350px;">
                    <canvas id="vendasChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico: Distribuição Compradores/Vendedores -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0">?? Distribuição de Utilizadores</h5>
                </div>
                <div class="card-body" style="height: 350px;">
                    <canvas id="distribuicaoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Gráfico: Top 10 Marcas -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0">?? Top 10 Marcas Mais Vendidas</h5>
                </div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="marcasChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico: Top 10 Modelos -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0">?? Top 10 Modelos Mais Vendidos</h5>
                </div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="modelosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- AÇÕES RÁPIDAS -->
    <div class="row mt-4 g-3">
        <div class="col-lg-3">
            <a href="/Admin/Utilizadores" class="btn btn-outline-primary btn-lg w-100 py-3">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                Gerir Utilizadores
            </a>
        </div>
        <div class="col-lg-3">
            <a href="/Admin/Anuncios" class="btn btn-outline-success btn-lg w-100 py-3">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                Moderar Anúncios
            </a>
        </div>
        <div class="col-lg-3">
            <a href="/Admin/Denuncias" class="btn btn-outline-warning btn-lg w-100 py-3">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                Gerir Denúncias
            </a>
        </div>
        <div class="col-lg-3">
            <a href="/Admin/Dashboard" class="btn btn-outline-info btn-lg w-100 py-3">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">??</div>
                Atualizar Dados
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Cores
        const colors = {
            primary: '#0d6efd',
            success: '#198754',
            warning: '#ffc107',
            danger: '#dc3545',
            info: '#0dcaf0'
        };

        // 1. VENDAS POR PERÍODO
        const ctx1 = document.getElementById('vendasChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                datasets: [{
                    label: 'Vendas (€)',
                    data: [15000, 22000, 18500, 29000, 31500, 38000],
                    borderColor: colors.primary,
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // 2. DISTRIBUIÇÃO UTILIZADORES
        const ctx2 = document.getElementById('distribuicaoChart').getContext('2d');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Compradores', 'Vendedores'],
                datasets: [{
                    data: [@(Model?.TotalCompradores ?? 0), @(Model?.TotalVendedores ?? 0)],
                    backgroundColor: [colors.primary, colors.success]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // 3. TOP MARCAS
        const ctx3 = document.getElementById('marcasChart').getContext('2d');
        new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: ['BMW', 'Audi', 'Mercedes', 'VW', 'Fiat', 'Opel', 'Ford', 'Toyota', 'Renault', 'Citroën'],
                datasets: [{ label: 'Vendas', data: [45, 38, 35, 32, 28, 25, 22, 20, 18, 15], backgroundColor: colors.warning }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        // 4. TOP MODELOS
        const ctx4 = document.getElementById('modelosChart').getContext('2d');
        new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['3 Series', 'A4', 'C-Class', 'Golf', 'Panda', 'Astra', 'Focus', 'Corolla', 'Clio', 'C1'],
                datasets: [{ label: 'Vendas', data: [32, 28, 25, 22, 18, 16, 14, 12, 10, 8], backgroundColor: colors.success }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    </script>
}
</file>

<file path="Areas/Admin/Views/Denuncias/Detalhe.cshtml">
@using AutoMarket.Models.Entities
@model Denuncia
@{
    ViewData["Title"] = $"DenЩncia #{Model.Id}";
}

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>DenЩncia #@Model.Id</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="/Admin/Denuncias" class="btn btn-secondary">? Voltar Я Lista</a>
        </div>
    </div>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Informaушes da DenЩncia -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">Informaушes da DenЩncia</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">ESTADO</label>
                            <p>
                                @switch (Model.Estado.ToString())
                                {
                                    case "Aberta":
                                        <span class="badge bg-danger">Aberta</span>
                                        break;
                                    case "EmAnalise":
                                        <span class="badge bg-warning">Em Anрlise</span>
                                        break;
                                    case "Encerrada":
                                        <span class="badge bg-success">Encerrada</span>
                                        break;
                                }
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">DATA DE CRIAК├O</label>
                            <p>@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="text-muted small">DENUNCIANTE</label>
                            <p>
                                @Model.Denunciante?.Nome
                                <small class="text-muted">(@Model.Denunciante?.Email)</small>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="text-muted small">ALVO</label>
                            <p>
                                @if (Model.TargetVeiculo != null)
                                {
                                    <span class="badge bg-info mb-2">Veьculo</span>
                                    <br />
                                    <strong>@Model.TargetVeiculo.Titulo</strong>
                                    <br />
                                    <small class="text-muted">Vendedor: @Model.TargetVeiculo.Vendedor?.User?.Nome</small>
                                }
                                else if (Model.TargetUser != null)
                                {
                                    <span class="badge bg-warning mb-2">Utilizador</span>
                                    <br />
                                    <strong>@Model.TargetUser.Nome</strong>
                                    <br />
                                    <small class="text-muted">@Model.TargetUser.Email</small>
                                }
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="text-muted small">MOTIVO</label>
                            <p>@Model.Motivo</p>
                        </div>
                    </div>

                    @if (Model.Estado == EstadoDenuncia.Encerrada)
                    {
                        <div class="row">
                            <div class="col-12">
                                <label class="text-muted small">DECIS├O DO ADMIN</label>
                                <p>
                                    <strong>@Model.DecisaoAdmin</strong>
                                    <br />
                                    <small class="text-muted">por @Model.AnalisadoPorAdmin?.Nome</small>
                                </p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Painel de Aушes -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">Aушes</h6>
                </div>
                <div class="card-body">
                    @if (Model.Estado == EstadoDenuncia.Aberta)
                    {
                        <form method="post" action="@Url.Action("IniciarAnalise", "Denuncias", new { id = Model.Id })" class="mb-3">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-play"></i> Iniciar Anрlise
                            </button>
                        </form>
                    }

                    @if (Model.Estado == EstadoDenuncia.EmAnalise)
                    {
                        <div class="alert alert-info small mb-3">
                            <strong>Anрlise em Curso</strong><br />
                            Iniciada por: @Model.AnalisadoPorAdmin?.Nome
                        </div>

                        <button class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#modalEncerrar" data-procedente="true">
                            <i class="bi bi-check"></i> Encerrar como Procedente
                        </button>
                        <button class="btn btn-secondary w-100" data-bs-toggle="modal" data-bs-target="#modalEncerrar" data-procedente="false">
                            <i class="bi bi-x"></i> Encerrar como Nсo Procedente
                        </button>
                    }

                    @if (Model.Estado == EstadoDenuncia.Encerrada)
                    {
                        <div class="alert alert-success small">
                            <strong>DenЩncia Encerrada</strong><br />
                            Esta denЩncia jр foi analisada.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Encerrar DenЩncia -->
<div class="modal fade" id="modalEncerrar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="@Url.Action("Encerrar", "Denuncias", new { id = Model.Id })">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Encerrar DenЩncia</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Resultado</label>
                        <input type="hidden" name="procedente" id="procedente" value="true" />
                        <div id="resultado"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Decisсo Detalhada</label>
                        <textarea name="decisao" class="form-control" rows="4" required placeholder="Explique a decisсo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Encerrar DenЩncia</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('modalEncerrar').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const procedente = button.dataset.procedente === 'true';
        document.getElementById('procedente').value = procedente;
        document.getElementById('resultado').innerHTML = procedente
            ? '<span class="badge bg-success">Procedente</span>'
            : '<span class="badge bg-secondary">Nсo Procedente</span>';
    });
</script>
</file>

<file path="Areas/Admin/Views/Denuncias/Index.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Denuncia>
@{
    ViewData["Title"] = "Gestсo de DenЩncias";
    var contagens = ViewData["Contagens"] as Dictionary<string, int> ?? new();
    var estadoFiltro = ViewData["EstadoFiltro"]?.ToString() ?? "";
}

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>DenЩncias</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="/Admin" class="btn btn-secondary">? Voltar ao Dashboard</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Filtrar por Estado</label>
                            <select name="estado" class="form-select">
                                <option value="">Todas</option>
                                <option value="Aberta">Aberta</option>
                                <option value="EmAnalise">Em Anрlise</option>
                                <option value="Encerrada">Encerrada</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Abertas</h6>
                    <h3 class="text-danger">@(contagens.ContainsKey("Aberta") ? contagens["Aberta"] : 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Em Anрlise</h6>
                    <h3 class="text-warning">@(contagens.ContainsKey("EmAnalise") ? contagens["EmAnalise"] : 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Encerradas</h6>
                    <h3 class="text-success">@(contagens.ContainsKey("Encerrada") ? contagens["Encerrada"] : 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Total</h6>
                    <h3>@(contagens.Values.Sum())</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h6 class="mb-0">Lista de DenЩncias</h6>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="alert alert-info m-3">
                    Nenhuma denЩncia encontrada.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#ID</th>
                                <th>Denunciante</th>
                                <th>Alvo</th>
                                <th>Tipo</th>
                                <th>Data</th>
                                <th>Estado</th>
                                <th>Aушes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var denuncia in Model)
                            {
                                <tr>
                                    <td><strong>#@denuncia.Id</strong></td>
                                    <td>@denuncia.Denunciante?.Nome</td>
                                    <td>
                                        @if (denuncia.TargetVeiculo != null)
                                        {
                                            <span class="badge bg-info">Veьculo #@denuncia.TargetVeiculoId</span>
                                        }
                                        else if (denuncia.TargetUser != null)
                                        {
                                            <span class="badge bg-warning">Utilizador: @denuncia.TargetUser.Nome</span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var motivo = denuncia.Motivo;
                                            if (motivo.Length > 30)
                                            {
                                                <text>@motivo.Substring(0, 30)...</text>
                                            }
                                            else
                                            {
                                                <text>@motivo</text>
                                            }
                                        }
                                    </td>
                                    <td>@denuncia.DataCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        @switch (denuncia.Estado.ToString())
                                        {
                                            case "Aberta":
                                                <span class="badge bg-danger">Aberta</span>
                                                break;
                                            case "EmAnalise":
                                                <span class="badge bg-warning">Em Anрlise</span>
                                                break;
                                            case "Encerrada":
                                                <span class="badge bg-success">Encerrada</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Detalhe", "Denuncias", new { id = denuncia.Id })" class="btn btn-sm btn-info">
                                            Ver
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
</file>

<file path="Areas/Admin/Views/Utilizadores/Index.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Utilizador>
@{
    ViewData["Title"] = "Gestсo de Utilizadores";
}

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Utilizadores Bloqueados</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="/Admin" class="btn btn-secondary">? Voltar ao Dashboard</a>
        </div>
    </div>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h6 class="mb-0">Lista de Utilizadores Bloqueados</h6>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="alert alert-info m-3">
                    Nenhum utilizador bloqueado.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Contacto</th>
                                <th>Motivo do Bloqueio</th>
                                <th>Data de Registo</th>
                                <th>Aушes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr>
                                    <td>
                                        <strong>@user.Nome</strong>
                                    </td>
                                    <td>@user.Email</td>
                                    <td>@user.Contacto</td>
                                    <td>
                                        <small class="text-muted">
                                            @if (!string.IsNullOrEmpty(user.BlockReason))
                                            {
                                                @user.BlockReason
                                            }
                                            else
                                            {
                                                <em>Sem motivo registado</em>
                                            }
                                        </small>
                                    </td>
                                    <td>@user.DataRegisto.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <form method="post" action="@Url.Action("Desbloquear", "Utilizadores")" style="display: inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="utilizadorId" value="@user.Id" />
                                            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Desbloquear este utilizador?')">
                                                Desbloquear
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Modal para Bloquear Novo Utilizador (opcional) -->
    <div class="mt-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalBloquear">
            + Bloquear Novo Utilizador
        </button>
    </div>
</div>

<!-- Modal Bloquear -->
<div class="modal fade" id="modalBloquear" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="@Url.Action("Bloquear", "Utilizadores")">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Bloquear Utilizador</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Email do Utilizador</label>
                        <input type="email" name="utilizadorId" class="form-control" placeholder="email@example.com" required />
                        <small class="form-text text-muted">Nota: This should be refactored to use a dropdown with user list</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo do Bloqueio</label>
                        <textarea name="motivo" class="form-control" rows="4" required placeholder="Descreva o motivo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Bloquear</button>
                </div>
            </form>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Controllers/CarrinhoController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Services;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Area("Public")]
    public class CarrinhoController : Controller
    {
        private readonly ICarrinhoService _carrinhoService;
        private readonly ApplicationDbContext _context;

        public CarrinhoController(ICarrinhoService carrinhoService, ApplicationDbContext context)
        {
            _carrinhoService = carrinhoService;
            _context = context;
        }

        public IActionResult Index()
        {
            var itens = _carrinhoService.GetItens();
            ViewBag.Total = _carrinhoService.GetTotal();
            return View(itens);
        }

        public async Task<IActionResult> Adicionar(int id)
        {
            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null) return NotFound();

            if (veiculo.Estado != Models.Enums.EstadoVeiculo.Ativo)
            {
                TempData["Erro"] = "Este veículo não está disponível para compra.";
                return RedirectToAction("Index", "Veiculos"); // Ou volta para onde estava
            }

            _carrinhoService.AdicionarItem(veiculo);

            TempData["Sucesso"] = "Veículo adicionado ao carrinho!";
            return RedirectToAction("Index"); // Ou volta para a lista de veículos
        }

        public IActionResult Remover(int id)
        {
            _carrinhoService.RemoverItem(id);
            return RedirectToAction("Index");
        }
    }
}
</file>

<file path="Areas/Public/Controllers/DenunciasApiController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    [Route("api/[controller]")]
    [ApiController]
    public class DenunciasApiController : ControllerBase
    {
        private readonly UserManager<Utilizador> _userManager;
        private readonly IDenunciaService _denunciaService;
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DenunciasApiController> _logger;

        public DenunciasApiController(
            UserManager<Utilizador> userManager,
            IDenunciaService denunciaService,
            ApplicationDbContext context,
            ILogger<DenunciasApiController> logger)
        {
            _userManager = userManager;
            _denunciaService = denunciaService;
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// POST: api/denuncias/criar
        /// Criar uma denúncia.
        /// </summary>
        [HttpPost("criar")]
        public async Task<IActionResult> Criar([FromBody] CreateDenunciaDto dto)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            if (string.IsNullOrWhiteSpace(dto.Motivo))
                return BadRequest(new { message = "Motivo é obrigatório." });

            if (!dto.VeiculoId.HasValue && string.IsNullOrEmpty(dto.TargetUserId))
                return BadRequest(new { message = "Forneça um veículo ou utilizador para denunciar." });

            string? targetUserId = null;

            // Se denunciar veículo, validar que existe
            if (dto.VeiculoId.HasValue)
            {
                var veiculo = await _context.Veiculos.FindAsync(dto.VeiculoId.Value);
                if (veiculo == null)
                    return BadRequest(new { message = "Veículo não encontrado." });
            }
            // Se denunciar utilizador, converter email para ID
            else if (!string.IsNullOrEmpty(dto.TargetUserId))
            {
                var targetUser = await _userManager.FindByEmailAsync(dto.TargetUserId);
                if (targetUser == null)
                    return BadRequest(new { message = "Utilizador não encontrado." });
                targetUserId = targetUser.Id;
            }

            var denuncia = await _denunciaService.CriarDenunciaAsync(
                user.Id,
                dto.VeiculoId,
                targetUserId,
                dto.Motivo);

            return Ok(new { message = "Denúncia criada com sucesso!", denunciaId = denuncia.Id });
        }
    }

    public class CreateDenunciaDto
    {
        public int? VeiculoId { get; set; }
        public string? TargetUserId { get; set; }
        public string Motivo { get; set; } = "";
    }
}
</file>

<file path="Areas/Public/Controllers/FavoritosApiController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    [Route("api/[controller]")]
    [ApiController]
    public class FavoritosApiController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly IFavoritoService _favoritoService;
        private readonly ILogger<FavoritosApiController> _logger;

        public FavoritosApiController(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            IFavoritoService favoritoService,
            ILogger<FavoritosApiController> logger)
        {
            _context = context;
            _userManager = userManager;
            _favoritoService = favoritoService;
            _logger = logger;
        }

        /// <summary>
        /// POST: api/favoritos/adicionar/{veiculoId}
        /// Adiciona um veículo aos favoritos.
        /// </summary>
        [HttpPost("adicionar/{veiculoId}")]
        public async Task<IActionResult> Adicionar(int veiculoId)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            // Obter ID do comprador
            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
                return BadRequest(new { message = "Utilizador não é comprador registado." });

            var sucesso = await _favoritoService.AdicionarFavoritoAsync(comprador.Id, veiculoId);
            if (!sucesso)
                return BadRequest(new { message = "Não foi possível adicionar o favorito." });

            return Ok(new { message = "Favorito adicionado com sucesso." });
        }

        /// <summary>
        /// DELETE: api/favoritos/remover/{veiculoId}
        /// Remove um veículo dos favoritos.
        /// </summary>
        [HttpDelete("remover/{veiculoId}")]
        public async Task<IActionResult> Remover(int veiculoId)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
                return BadRequest(new { message = "Utilizador não é comprador registado." });

            var sucesso = await _favoritoService.RemoverFavoritoAsync(comprador.Id, veiculoId);
            if (!sucesso)
                return BadRequest(new { message = "Não foi possível remover o favorito." });

            return Ok(new { message = "Favorito removido com sucesso." });
        }

        /// <summary>
        /// GET: api/favoritos/verificar/{veiculoId}
        /// Verifica se um veículo está nos favoritos.
        /// </summary>
        [HttpGet("verificar/{veiculoId}")]
        public async Task<IActionResult> Verificar(int veiculoId)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
                return Ok(new { estaNosFavoritos = false });

            var estaNosFavoritos = await _favoritoService.EstaNosFavoritosAsync(comprador.Id, veiculoId);
            return Ok(new { estaNosFavoritos });
        }

        /// <summary>
        /// GET: api/favoritos/listar
        /// Lista os favoritos do utilizador.
        /// </summary>
        [HttpGet("listar")]
        public async Task<IActionResult> Listar(int page = 1)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
                return BadRequest(new { message = "Utilizador não é comprador registado." });

            var favoritos = await _favoritoService.ListarFavoritosAsync(comprador.Id, page, 20);
            var total = await _favoritoService.ContarFavoritosAsync(comprador.Id);

            return Ok(new { favoritos, total, page });
        }
    }
}
</file>

<file path="Areas/Public/Controllers/NotificacoesApiController.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    [Route("api/[controller]")]
    [ApiController]
    public class NotificacoesApiController : ControllerBase
    {
        private readonly UserManager<Utilizador> _userManager;
        private readonly INotificacaoService _notificacaoService;
        private readonly ILogger<NotificacoesApiController> _logger;

        public NotificacoesApiController(
            UserManager<Utilizador> userManager,
            INotificacaoService notificacaoService,
            ILogger<NotificacoesApiController> logger)
        {
            _userManager = userManager;
            _notificacaoService = notificacaoService;
            _logger = logger;
        }

        /// <summary>
        /// GET: api/notificacoes/nao-lidas
        /// Obter notificaушes nсo lidas do utilizador.
        /// </summary>
        [HttpGet("nao-lidas")]
        public async Task<IActionResult> ObterNaoLidas()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            var notificacoes = await _notificacaoService.ObterNaolidasAsync(user.Id);
            return Ok(new { count = notificacoes.Count, notificacoes });
        }

        /// <summary>
        /// GET: api/notificacoes/listar
        /// Listar todas as notificaушes com paginaусo.
        /// </summary>
        [HttpGet("listar")]
        public async Task<IActionResult> Listar(int page = 1)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null)
                return Unauthorized();

            var notificacoes = await _notificacaoService.ListarNotificacoesAsync(user.Id, page, 20);
            return Ok(new { notificacoes, page });
        }

        /// <summary>
        /// POST: api/notificacoes/marcar-como-lida/{id}
        /// Marcar uma notificaусo como lida.
        /// </summary>
        [HttpPost("marcar-como-lida/{id}")]
        public async Task<IActionResult> MarcarComoLida(int id)
        {
            var sucesso = await _notificacaoService.MarcarComolida(id);
            if (!sucesso)
                return BadRequest(new { message = "Nсo foi possьvel marcar a notificaусo como lida." });

            return Ok(new { message = "Notificaусo marcada como lida." });
        }
    }
}
</file>

<file path="Areas/Public/Controllers/ReservasController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Controller para gestão de reservas de veículos.
    /// Apenas para utilizadores autenticados.
    /// </summary>
    [Area("Public")]
    [Authorize]
    public class ReservasController : Controller
    {
        private readonly IReservaService _reservaService;
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<ReservasController> _logger;

        public ReservasController(
            IReservaService reservaService,
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ILogger<ReservasController> logger)
        {
            _reservaService = reservaService;
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        /// <summary>
        /// GET: /Reservas/Criar/5
        /// Mostrar detalhes do veículo e botão para confirmar reserva.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Criar(int id)
        {
            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .Include(v => v.Vendedor)
                .ThenInclude(vend => vend.User)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
                return NotFound();

            // Verificar se comprador existe
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                TempData["Erro"] = "Perfil de comprador não encontrado.";
                return RedirectToAction("Index", "Veiculos");
            }

            return View(veiculo);
        }

        /// <summary>
        /// POST: /Reservas/Criar
        /// Submeter a reserva.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CriarReserva(int veiculoId)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                TempData["Erro"] = "Perfil de comprador não encontrado.";
                return RedirectToAction("Index", "Veiculos");
            }

            // Criar reserva
            var (sucesso, reserva, mensagem) = await _reservaService.CriarReservaAsync(
                veiculoId,
                comprador.Id,
                diasValidez: 7);

            if (!sucesso)
            {
                TempData["Erro"] = mensagem;
                return RedirectToAction("Detalhe", "Veiculos", new { id = veiculoId });
            }

            TempData["Sucesso"] = mensagem;
            return RedirectToAction("Minhas");
        }

        /// <summary>
        /// GET: /Reservas/Minhas
        /// Listar todas as reservas do comprador autenticado.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Minhas()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                TempData["Erro"] = "Perfil de comprador não encontrado.";
                return RedirectToAction("Index", "Veiculos");
            }

            var reservas = await _reservaService.ObterReservasCompradorAsync(comprador.Id);

            return View(reservas);
        }

        /// <summary>
        /// POST: /Reservas/Cancelar/5
        /// Cancelar uma reserva.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Cancelar(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Validar que a reserva pertence ao comprador
            var reserva = await _context.Reservas
                .Include(r => r.Comprador)
                .FirstOrDefaultAsync(r => r.Id == id);

            if (reserva == null)
            {
                TempData["Erro"] = "Reserva não encontrada.";
                return RedirectToAction("Minhas");
            }

            if (reserva.Comprador.UserId != user.Id)
            {
                TempData["Erro"] = "Não tem permissão para cancelar esta reserva.";
                return RedirectToAction("Minhas");
            }

            var (sucesso, mensagem) = await _reservaService.CancelarReservaAsync(
                id,
                motivo: "Cancelado pelo comprador");

            TempData[sucesso ? "Sucesso" : "Erro"] = mensagem;
            return RedirectToAction("Minhas");
        }

        /// <summary>
        /// GET: /Reservas/Detalhes/5
        /// Ver detalhes de uma reserva específica.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Detalhes(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var reserva = await _reservaService.ObterReservaAsync(id);

            if (reserva == null)
                return NotFound();

            // Verificar permissão
            if (reserva.Comprador.UserId != user.Id)
            {
                return Forbid();
            }

            return View(reserva);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/TransacoesController.cs">
using AutoMarket.Models.Constants;
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.ViewModels;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    public class TransacoesController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<TransacoesController> _logger;

        public TransacoesController(ApplicationDbContext context, UserManager<Utilizador> userManager, ILogger<TransacoesController> logger)
        {
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        /// <summary>
        /// GET: Transacoes/Checkout/5
        /// Exibe a página de checkout para compra de veículo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Checkout(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) { return Challenge(); }

            if (string.IsNullOrEmpty(user.NIF))
            {
                TempData["ReturnUrl"] = Url.Action(nameof(Checkout), new { id });
                return RedirectToAction("PreencherDadosFiscais", "Conta");
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Vendedor)
                .ThenInclude(v => v.User)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
                return NotFound();

            return View(veiculo);
        }

        /// <summary>
        /// GET: Transacoes/MinhasCompras
        /// Lista todas as transações onde o utilizador atual é o comprador.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> MinhasCompras()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Obter perfil de Comprador
            var comprador = await _context.Compradores
                .AsNoTracking()
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                // Utilizador não tem perfil de comprador ainda
                return View(new List<TransacaoListViewModel>());
            }

            // Buscar transações onde é comprador
            var transacoes = await _context.Transacoes
                .AsNoTracking()
                .Include(t => t.Veiculo)
                    .ThenInclude(v => v.Imagens)
                .Include(t => t.Vendedor)
                    .ThenInclude(v => v.User)
                .Where(t => t.CompradorId == comprador.Id)
                .OrderByDescending(t => t.DataTransacao)
                .Select(t => new TransacaoListViewModel
                {
                    TransacaoId = t.Id,
                    DataTransacao = t.DataTransacao,
                    ValorPago = t.ValorPago,
                    Estado = t.Estado,
                    Metodo = t.Metodo,
                    VeiculoId = t.VeiculoId,
                    VeiculoTitulo = t.Veiculo.Titulo,
                    VeiculoMarca = t.Veiculo.Marca,
                    VeiculoModelo = t.Veiculo.Modelo,
                    VeiculoImagemCapa = t.Veiculo.Imagens.FirstOrDefault(i => i.IsCapa) != null ? t.Veiculo.Imagens.FirstOrDefault(i => i.IsCapa)!.CaminhoFicheiro : null,
                    VendedorNome = t.Vendedor.User.Nome,
                    MoradaEnvioSnapshot = t.MoradaEnvioSnapshot,
                    NifFaturacaoSnapshot = t.NifFaturacaoSnapshot
                })
                .ToListAsync();

            return View(transacoes);
        }

        /// <summary>
        /// GET: Transacoes/MinhasVendas
        /// Lista todas as transações onde o utilizador atual é o vendedor.
        /// Apenas acessível por utilizadores com role Vendedor.
        /// </summary>
        [HttpGet]
        [Authorize(Roles = Roles.Vendedor)]
        public async Task<IActionResult> MinhasVendas()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Obter perfil de Vendedor
            var vendedor = await _context.Vendedores
                .AsNoTracking()
                .FirstOrDefaultAsync(v => v.UserId == user.Id);

            if (vendedor == null)
            {
                // Utilizador não tem perfil de vendedor
                return View(new List<TransacaoListViewModel>());
            }

            // Buscar transações onde é vendedor
            var transacoes = await _context.Transacoes
                .AsNoTracking()
                .Include(t => t.Veiculo)
                    .ThenInclude(v => v.Imagens)
                .Include(t => t.Comprador)
                    .ThenInclude(c => c.User)
                .Where(t => t.VendedorId == vendedor.Id)
                .OrderByDescending(t => t.DataTransacao)
                .Select(t => new TransacaoListViewModel
                {
                    TransacaoId = t.Id,
                    DataTransacao = t.DataTransacao,
                    ValorPago = t.ValorPago,
                    Estado = t.Estado,
                    Metodo = t.Metodo,
                    VeiculoId = t.VeiculoId,
                    VeiculoTitulo = t.Veiculo.Titulo,
                    VeiculoMarca = t.Veiculo.Marca,
                    VeiculoModelo = t.Veiculo.Modelo,
                    VeiculoImagemCapa = t.Veiculo.Imagens.FirstOrDefault(i => i.IsCapa) != null ? t.Veiculo.Imagens.FirstOrDefault(i => i.IsCapa)!.CaminhoFicheiro : null,
                    CompradorNome = t.Comprador.User.Nome,
                    MoradaEnvioSnapshot = t.MoradaEnvioSnapshot,
                    NifFaturacaoSnapshot = t.NifFaturacaoSnapshot
                })
                .ToListAsync();

            return View(transacoes);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/VeiculosController.cs">
using AutoMarket.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Controller público para listar e pesquisar veículos do catálogo.
    /// Implementa filtros avançados, paginação e otimização de queries.
    /// </summary>
    [Area("Public")]
    public class VeiculosController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<VeiculosController> _logger;

        public VeiculosController(ApplicationDbContext context, ILogger<VeiculosController> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// GET: Veiculos/Index
        /// Lista todos os veículos ativos com filtros, ordenação e paginação.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index(
            string? marca = null,
            string? modelo = null,
            string? combustivel = null,
            int? ano = null,
            string? categoria = null,
            decimal? precoMin = null,
            decimal? precoMax = null,
            int? kmMin = null,
            int? kmMax = null,
            string? ordenacao = "recente",
            int page = 1)
        {
            try
            {
                // Encapsular parâmetros no DTO
                var filters = new VeiculoSearchFiltersDto
                {
                    Marca = marca,
                    Modelo = modelo,
                    Combustivel = combustivel,
                    Ano = ano,
                    Categoria = categoria,
                    PrecoMin = precoMin,
                    PrecoMax = precoMax,
                    KmMin = kmMin,
                    KmMax = kmMax,
                    Ordenacao = ordenacao,
                    Page = Math.Max(page, 1) // Garantir que page >= 1
                };

                // Construir query filtrada e ordenada
                var query = BuildVeiculosQuery(filters);

                // Contar total ANTES de paginar
                var totalVeiculos = await query.CountAsync();
                var totalPages = (int)Math.Ceiling((double)totalVeiculos / filters.PageSize);

                // Aplicar paginação
                var veiculos = await query
                    .Skip((filters.Page - 1) * filters.PageSize)
                    .Take(filters.PageSize)
                    .ToListAsync();

                // Carregar opções dos filtros em UMA ÚNICA QUERY
                var filterOptions = await LoadFilterOptionsAsync();

                // Passar dados para a view
                ViewData["Marcas"] = filterOptions.Marcas;
                ViewData["Modelos"] = filterOptions.Modelos;
                ViewData["Combustiveis"] = filterOptions.Combustiveis;
                ViewData["Anos"] = filterOptions.Anos;
                ViewData["Categorias"] = filterOptions.Categorias;

                // Manter filtros selecionados
                ViewData["MarcaSelecionada"] = marca;
                ViewData["ModeloSelecionado"] = modelo;
                ViewData["CombustivelSelecionado"] = combustivel;
                ViewData["AnoSelecionado"] = ano;
                ViewData["CategoriaSelecionada"] = categoria;
                ViewData["PrecoMin"] = precoMin;
                ViewData["PrecoMax"] = precoMax;
                ViewData["KmMin"] = kmMin;
                ViewData["KmMax"] = kmMax;
                ViewData["Ordenacao"] = ordenacao;

                // Informações de paginação
                ViewData["CurrentPage"] = filters.Page;
                ViewData["TotalPages"] = totalPages;
                ViewData["TotalItems"] = totalVeiculos;
                ViewData["PageSize"] = filters.PageSize;

                _logger.LogInformation(
                    "Pesquisa de ve�culos: {TotalVeiculos} encontrados, P�gina {Page} de {TotalPages}",
                    totalVeiculos, filters.Page, totalPages);

                return View(veiculos);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao pesquisar veículos");
                return View(new List<Veiculo>());
            }
        }

        /// <summary>
        /// POST: Veiculos/BuscarAjax
        /// Retorna PartialView com resultados de busca para AJAX.
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> BuscarAjax(
            string? marca = null,
            string? modelo = null,
            string? combustivel = null,
            int? ano = null,
            string? categoria = null,
            decimal? precoMin = null,
            decimal? precoMax = null,
            int? kmMin = null,
            int? kmMax = null,
            string? ordenacao = "recente",
            int page = 1)
        {
            try
            {
                // Encapsular parâmetros no DTO
                var filters = new VeiculoSearchFiltersDto
                {
                    Marca = marca,
                    Modelo = modelo,
                    Combustivel = combustivel,
                    Ano = ano,
                    Categoria = categoria,
                    PrecoMin = precoMin,
                    PrecoMax = precoMax,
                    KmMin = kmMin,
                    KmMax = kmMax,
                    Ordenacao = ordenacao,
                    Page = Math.Max(page, 1)
                };

                // Construir query filtrada e ordenada
                var query = BuildVeiculosQuery(filters);

                // Contar total ANTES de paginar
                var totalVeiculos = await query.CountAsync();
                var totalPages = (int)Math.Ceiling((double)totalVeiculos / filters.PageSize);

                // Aplicar paginação
                var veiculos = await query
                    .Skip((filters.Page - 1) * filters.PageSize)
                    .Take(filters.PageSize)
                    .ToListAsync();

                // Passar dados para a PartialView
                ViewData["CurrentPage"] = filters.Page;
                ViewData["TotalPages"] = totalPages;
                ViewData["TotalItems"] = totalVeiculos;
                ViewData["PageSize"] = filters.PageSize;

                _logger.LogInformation(
                    "Busca AJAX: {TotalVeiculos} veículos, Página {Page} de {TotalPages}",
                    totalVeiculos, filters.Page, totalPages);

                // Retornar PartialView (sem layout)
                return PartialView("_CarListPartial", veiculos);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao buscar ve�culos via AJAX");
                return PartialView("_CarListPartial", new List<Veiculo>());
            }
        }

        /// <summary>
        /// GET: Veiculos/Detalhe/5
        /// Exibe detalhes completos de um veículo.
        /// </summary>
        [HttpGet]
        [Route("Veiculos/Detalhe/{id}")]
        public async Task<IActionResult> Detalhe(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .Include(v => v.Vendedor)
                .ThenInclude(v => v.User)
                .FirstOrDefaultAsync(v => v.Id == id && v.Estado == EstadoVeiculo.Ativo);

            if (veiculo == null)
                return NotFound();

            return View(veiculo);
        }

        // ============================================================
        // MÉTODOS PRIVADOS (DRY - Reutilizáveis)
        // ============================================================

        /// <summary>
        /// Constrói a query de veículos com filtros e ordenação aplicados.
        /// Reutilizável entre diferentes métodos.
        /// </summary>
        private IQueryable<Veiculo> BuildVeiculosQuery(VeiculoSearchFiltersDto filters)
        {
            var query = _context.Veiculos
                .Where(v => v.Estado == EstadoVeiculo.Ativo)
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .AsQueryable();

            // Aplicar filtros condicionalmente
            if (!string.IsNullOrEmpty(filters.Marca))
                query = query.Where(v => v.Marca == filters.Marca);

            if (!string.IsNullOrEmpty(filters.Modelo))
                query = query.Where(v => v.Modelo == filters.Modelo);

            if (!string.IsNullOrEmpty(filters.Combustivel))
                query = query.Where(v => v.Combustivel == filters.Combustivel);

            if (filters.Ano.HasValue)
                query = query.Where(v => v.Ano == filters.Ano);

            if (!string.IsNullOrEmpty(filters.Categoria))
                query = query.Where(v => v.Categoria.Nome == filters.Categoria);

            if (filters.PrecoMin.HasValue)
                query = query.Where(v => v.Preco >= filters.PrecoMin);

            if (filters.PrecoMax.HasValue)
                query = query.Where(v => v.Preco <= filters.PrecoMax);

            if (filters.KmMin.HasValue)
                query = query.Where(v => v.Km >= filters.KmMin);

            if (filters.KmMax.HasValue)
                query = query.Where(v => v.Km <= filters.KmMax);

            // Aplicar ordenação
            query = filters.Ordenacao switch
            {
                "preco_asc" => query.OrderBy(v => v.Preco),
                "preco_desc" => query.OrderByDescending(v => v.Preco),
                "km_asc" => query.OrderBy(v => v.Km),
                "km_desc" => query.OrderByDescending(v => v.Km),
                "ano_asc" => query.OrderBy(v => v.Ano),
                "ano_desc" => query.OrderByDescending(v => v.Ano),
                _ => query.OrderByDescending(v => v.DataCriacao)
            };

            return query;
        }

        /// <summary>
        /// Carrega todas as opções de filtro em UMA ÚNICA QUERY otimizada.
        /// Evita N+1 queries problem.
        /// </summary>
        private async Task<VeiculoFilterOptionsDto> LoadFilterOptionsAsync()
        {
            // Carregar todos os dados numa única query
            var veiculosAtivos = await _context.Veiculos
                .Where(v => v.Estado == EstadoVeiculo.Ativo)
                .Include(v => v.Categoria)
                .ToListAsync();

            var options = new VeiculoFilterOptionsDto
            {
                Marcas = veiculosAtivos
                    .Select(v => v.Marca)
                    .Distinct()
                    .OrderBy(m => m)
                    .ToList(),

                Modelos = veiculosAtivos
                    .Select(v => v.Modelo)
                    .Distinct()
                    .OrderBy(m => m)
                    .ToList(),

                Combustiveis = veiculosAtivos
                    .Where(v => !string.IsNullOrEmpty(v.Combustivel))
                    .Select(v => v.Combustivel)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList(),

                Anos = veiculosAtivos
                    .Select(v => v.Ano)
                    .Distinct()
                    .OrderByDescending(a => a)
                    .ToList(),

                Categorias = veiculosAtivos
                    .Where(v => v.Categoria != null)
                    .Select(v => v.Categoria.Nome)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList()
            };

            return options;
        }
    }

    /// <summary>
    /// DTO para retornar opções de filtro.
    /// </summary>
    internal class VeiculoFilterOptionsDto
    {
        public List<string> Marcas { get; set; } = new();
        public List<string> Modelos { get; set; } = new();
        public List<string> Combustiveis { get; set; } = new();
        public List<int> Anos { get; set; } = new();
        public List<string> Categorias { get; set; } = new();
    }
}
</file>

<file path="Areas/Public/Views/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Public/Views/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Public/Views/Carrinho/CarrinhoResumoViewComponent.cs">
using AutoMarket.Models.ViewModels;
using AutoMarket.Services;

namespace AutoMarket.Areas.Public.Views.Cart
{
    // O nome da classe deve terminar em ViewComponent
    public class CarrinhoResumoViewComponent : ViewComponent
    {
        private readonly ICarrinhoService _carrinhoService;

        public CarrinhoResumoViewComponent(ICarrinhoService carrinhoService)
        {
            _carrinhoService = carrinhoService;
        }

        public IViewComponentResult Invoke()
        {
            // Lógica: Vai buscar os dados à sessão via serviço
            var model = new CarrinhoWidgetViewModel
            {
                QuantidadeItens = _carrinhoService.GetContagem(),
                ValorTotal = _carrinhoService.GetTotal()
            };

            // Retorna a View associada a este componente
            return View(model);
        }
    }
}
</file>

<file path="Areas/Public/Views/Carrinho/CartIndex.cshtml">
@using AutoMarket.Models.Entities
@model List<CarrinhoItem>

@{
    ViewData["Title"] = "O meu Carrinho";
}

<div class="container mt-5">
    <h2><i class="bi bi-cart3"></i> O meu Carrinho</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-warning mt-4">
            O seu carrinho está vazio. <a asp-controller="Veiculos" asp-action="Index">Ver carros disponíveis</a>.
        </div>
    }
    else
    {
        <div class="row mt-4">
            <div class="col-md-8">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Viatura</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="~/images/carros/@(item.ImagemCapa ?? "sem-imagem.jpg")"
                                             alt="@item.Titulo"
                                             class="rounded me-3"
                                             style="width: 80px; height: 60px; object-fit: cover;">
                                        <div>
                                            <h5 class="mb-0">@item.Marca @item.Modelo</h5>
                                            <small class="text-muted">@item.Titulo</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-bold text-primary">@item.Preco.ToString("C0")</td>
                                <td>
                                    <a asp-action="Remover" asp-route-id="@item.VeiculoId" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i> Remover
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Resumo</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>Total:</span>
                            <span class="fw-bold fs-4">@((ViewBag.Total as decimal?)?.ToString("C0") ?? "0 €")</span>
                        </div>
                        <div class="d-grid">
                            <a asp-controller="Checkout" asp-action="Index" class="btn btn-success btn-lg">
                                <i class="bi bi-credit-card"></i> Finalizar Compra
                            </a>
                        </div>
                        <div class="mt-3 text-center">
                            <a asp-controller="Veiculos" asp-action="Index" class="text-decoration-none">Continuar a ver carros</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
</file>

<file path="Areas/Public/Views/Checkout/Confirmacao.cshtml">
@model Transacao
@using AutoMarket.Models.Entities
@{
    ViewData["Title"] = "Compra Confirmada";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- HEADER SUCCESS -->
            <div class="text-center mb-5">
                <div style="font-size: 4rem; margin-bottom: 1rem;">?</div>
                <h1 class="text-success fw-bold mb-2">Compra Confirmada!</h1>
                <p class="text-muted fs-5">O seu pagamento foi processado com sucesso</p>
            </div>

            <!-- CARD PRINCIPAL -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-success text-white py-4">
                    <h4 class="mb-1">Detalhes da Transação</h4>
                    <small>Referência: #@Model.Id</small>
                </div>
                <div class="card-body">
                    <!-- INFO PAGAMENTO -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Número da Encomenda</h6>
                            <h4 class="text-success">#@Model.Id</h4>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Data de Compra</h6>
                            <h4>@Model.DataTransacao.ToString("dd/MM/yyyy HH:mm")</h4>
                        </div>
                    </div>

                    <hr>

                    <!-- VEÍCULO COMPRADO -->
                    <div class="mb-4">
                        <h5 class="mb-3">?? Veículo Comprado</h5>
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                @if (Model.Veiculo?.Imagens?.Any() == true)
                                {
                                    var img = Model.Veiculo.Imagens.FirstOrDefault(i => i.IsCapa) ?? Model.Veiculo.Imagens.First();
                                    <img src="/images/veiculos/@img.CaminhoFicheiro" class="img-fluid rounded" alt="@Model.Veiculo.Marca @Model.Veiculo.Modelo">
                                }
                            </div>
                            <div class="col-md-8">
                                <h5>@Model.Veiculo?.Marca @Model.Veiculo?.Modelo (@Model.Veiculo?.Ano)</h5>
                                <p class="text-muted mb-2">@Model.Veiculo?.Titulo</p>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Quilometragem</small>
                                        <p class="fw-bold">@Model.Veiculo?.Km.ToString("N0") km</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Localização</small>
                                        <p class="fw-bold">@Model.Veiculo?.Localizacao</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- RESUMO FINANCEIRO -->
                    <div class="mb-4">
                        <h5 class="mb-3">?? Resumo Financeiro</h5>
                        <table class="table table-borderless">
                            <tr>
                                <td>Preço do Veículo:</td>
                                <td class="text-end">€@(Model.ValorPago * 0.8127m).ToString("F2")</td>
                            </tr>
                            <tr>
                                <td>Comissão de Serviço:</td>
                                <td class="text-end">€@(Model.ValorPago * 0.0406m).ToString("F2")</td>
                            </tr>
                            <tr>
                                <td>IVA (23%):</td>
                                <td class="text-end">€@(Model.ValorPago * 0.1467m).ToString("F2")</td>
                            </tr>
                            <tr class="border-top pt-3">
                                <td class="fw-bold fs-5">Total Pago:</td>
                                <td class="text-end text-success fw-bold fs-5">€@Model.ValorPago.ToString("F2")</td>
                            </tr>
                        </table>
                    </div>

                    <hr>

                    <!-- ESTADO PAGAMENTO -->
                    <div class="mb-4">
                        <h5 class="mb-3">?? Estado da Entrega</h5>
                        <div class="alert alert-success" role="alert">
                            <h6 class="mb-2">? @Model.Estado</h6>
                            <small>O seu veículo está sendo preparado para entrega. Receberá um email com os detalhes de contacto do vendedor em breve.</small>
                        </div>

                        <!-- PROGRESSO -->
                        <div class="progress mb-3" style="height: 30px;">
                            <div class="progress-bar bg-success" style="width: 25%;">
                                <small class="fw-bold">Pagamento Confirmado</small>
                            </div>
                            <div class="progress-bar bg-light" style="width: 25%;"></div>
                            <div class="progress-bar bg-light" style="width: 25%;"></div>
                            <div class="progress-bar bg-light" style="width: 25%;"></div>
                        </div>
                        <div class="row text-center small text-muted">
                            <div class="col-3">Pagamento</div>
                            <div class="col-3">Preparação</div>
                            <div class="col-3">Envio</div>
                            <div class="col-3">Entregue</div>
                        </div>
                    </div>

                    <hr>

                    <!-- DADOS SNAPSHOT -->
                    <div class="mb-4">
                        <h5 class="mb-3">?? Dados da Compra</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Morada de Envio</h6>
                                <p class="fw-bold">@Model.MoradaEnvioSnapshot</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">NIF para Fatura</h6>
                                <p class="fw-bold">@Model.NifFaturacaoSnapshot</p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- MÉTODO PAGAMENTO -->
                    <div class="mb-4">
                        <h5 class="mb-3">?? Método de Pagamento</h5>
                        <div class="badge bg-info text-dark p-2">
                            @Model.Metodo switch
                            {
                                "cartao" => "?? Cartão de Crédito",
                                "transferencia" => "?? Transferência Bancária",
                                "mbway" => "?? MB Way",
                                "paypal" => "??? PayPal",
                                _ => "?? Outro"
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- INFO IMPORTANTE -->
            <div class="alert alert-info" role="alert">
                <h5 class="mb-2">?? Próximos Passos</h5>
                <ul class="mb-0">
                    <li>Receberá um email de confirmação em breve</li>
                    <li>O vendedor entrará em contacto com você para coordenar a entrega</li>
                    <li>Pode acompanhar o estado da sua compra em <strong>Minha Conta ? Compras</strong></li>
                    <li>Tem direito a devolução em até 14 dias</li>
                </ul>
            </div>

            <!-- SUPORTE -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <h6 class="mb-3">Precisa de Ajuda?</h6>
                    <p class="text-muted mb-3">Entre em contacto com o nosso suporte</p>
                    <a href="/Public/Home/Contactos" class="btn btn-outline-primary me-2">
                        ?? Contacte-nos
                    </a>
                    <a href="/Public/Home/Ajuda" class="btn btn-outline-secondary">
                        ? Perguntas Frequentes
                    </a>
                </div>
            </div>

            <!-- BOTÕES AÇÃO -->
            <div class="d-grid gap-2">
                <a href="/Public/Veiculos" class="btn btn-primary btn-lg fw-bold">
                    ??? Continuar a Comprar
                </a>
                <a href="/Public/Conta/Index" class="btn btn-outline-secondary btn-lg">
                    ?? Ir para Minha Conta
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
</file>

<file path="Areas/Public/Views/Checkout/Index.cshtml">
@model Veiculo
@using AutoMarket.Models.Entities
@{
    ViewData["Title"] = "Checkout - Comprar Veículo";
}

<div class="container py-5">
    <div class="row">
        <!-- Coluna Esquerda: Formulário -->
        <div class="col-lg-8">
            <h2 class="mb-4">?? Finalizar Compra</h2>

            <form method="post" asp-action="ProcessarPagamento" class="needs-validation">
                <!-- RESUMO DO VEÍCULO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">?? Resumo do Veículo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                @{
                                    var imagem = Model.Imagens?.FirstOrDefault(i => i.IsCapa) ?? Model.Imagens?.FirstOrDefault();
                                }
                                @if (imagem != null)
                                {
                                    <img src="/images/veiculos/@imagem.CaminhoFicheiro" class="img-fluid rounded" alt="@Model.Marca @Model.Modelo">
                                }
                                else
                                {
                                    <div style="height: 200px; background: #e0e0e0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">Sem imagem</span>
                                    </div>
                                }
                            </div>
                            <div class="col-md-8">
                                <h5>@Model.Marca @Model.Modelo (@Model.Ano)</h5>
                                <p class="text-muted mb-2">@Model.Titulo</p>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <small class="text-muted">Quilometragem</small>
                                        <p class="fw-bold">@Model.Km.ToString("N0") km</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Combustível</small>
                                        <p class="fw-bold">@Model.Combustivel</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Caixa</small>
                                        <p class="fw-bold">@Model.Caixa</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Localização</small>
                                        <p class="fw-bold">@Model.Localizacao</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DADOS DE FATURAÇÃO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">?? Dados de Faturação</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="morada" class="form-label fw-bold">Morada de Envio</label>
                                <input type="text" class="form-control" id="morada" name="morada" required>
                                <small class="text-muted">Onde deseja receber o veículo</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nif" class="form-label fw-bold">NIF (para fatura)</label>
                                <input type="text" class="form-control" id="nif" name="nif" placeholder="123456789" required>
                                <small class="text-muted">Número de contribuinte</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label fw-bold">Nome Completo</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label fw-bold">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefone" class="form-label fw-bold">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" name="telefone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cidade" class="form-label fw-bold">Cidade</label>
                                <input type="text" class="form-control" id="cidade" name="cidade" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MÉTODO DE PAGAMENTO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">?? Método de Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="metodo" class="form-label fw-bold">Selecione o Método</label>
                            <select class="form-select form-select-lg" id="metodo" name="metodo" required>
                                <option value="">-- Escolher --</option>
                                <option value="cartao">?? Cartão de Crédito</option>
                                <option value="transferencia">?? Transferência Bancária</option>
                                <option value="mbway">?? MB Way</option>
                                <option value="paypal">??? PayPal</option>
                            </select>
                        </div>

                        <!-- Dados Cartão (apenas para demonstração) -->
                        <div id="dadosCartao" style="display: none;" class="mt-3">
                            <div class="alert alert-info">
                                ?? <strong>Simulação:</strong> Use os dados abaixo para testar o pagamento
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold">Número do Cartão</label>
                                    <input type="text" class="form-control" value="4532123456789010" readonly>
                                    <small class="text-muted">Teste: 4532123456789010</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">CVV</label>
                                    <input type="text" class="form-control" value="123" readonly>
                                    <small class="text-muted">Teste: 123</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Validade</label>
                                    <input type="text" class="form-control" value="12/25" readonly>
                                    <small class="text-muted">Teste: 12/25</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Nome do Titular</label>
                                    <input type="text" class="form-control" value="JOHN DOE" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TERMOS E CONDIÇÕES -->
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="termos" name="aceitar_termos" required>
                    <label class="form-check-label" for="termos">
                        Aceito os <a href="/Public/Home/Termos" target="_blank">termos e condições</a> da compra
                    </label>
                </div>

                <!-- BOTÕES -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg fw-bold">
                        ? Confirmar Pagamento - €@Model.Preco.ToString("F2")
                    </button>
                    <a href="@Url.Action("Detalhe", "Veiculos", new { id = Model.Id })" class="btn btn-outline-secondary btn-lg">
                        ? Voltar ao Anúncio
                    </a>
                </div>
            </form>
        </div>

        <!-- Coluna Direita: Resumo -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">?? Resumo da Compra</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td>Preço do Veículo:</td>
                            <td class="text-end fw-bold">€@Model.Preco.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>Comissão de Serviço:</td>
                            <td class="text-end">€@(Model.Preco * 0.05m).ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>IVA (23%):</td>
                            <td class="text-end">€@(Model.Preco * 1.23m * 0.23m).ToString("F2")</td>
                        </tr>
                        <tr class="border-top pt-3">
                            <td class="fw-bold">Total a Pagar:</td>
                            <td class="text-end text-success fw-bold fs-5">€@(Model.Preco * 1.23m + (Model.Preco * 0.05m)).ToString("F2")</td>
                        </tr>
                    </table>

                    <hr>

                    <div class="mb-3">
                        <h6 class="mb-2">Vendedor</h6>
                        <p class="mb-0 fw-bold">@Model.Vendedor?.User?.Nome</p>
                        <small class="text-muted">
                            <i class="bi bi-telephone"></i> @Model.Vendedor?.User?.Contacto
                        </small>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <small>
                            ? Compra segura com garantia de entrega<br>
                            ? Suporte ao cliente 24/7<br>
                            ? Direito de devolução em 14 dias
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('metodo').addEventListener('change', function() {
            document.getElementById('dadosCartao').style.display = 
                this.value === 'cartao' ? 'block' : 'none';
        });
    </script>
}
</file>

<file path="Areas/Public/Views/Conta/AguardandoAprovacao.cshtml">
@{
    ViewData["Title"] = "Conta em Análise";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="card shadow-lg text-center p-4" style="max-width: 500px; width: 100%;">
        <div class="card-body">
            <div class="mb-4">
                <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
            </div>

            <h2 class="card-title fw-bold mb-3">A sua conta está em análise</h2>

            <p class="card-text text-muted mb-4">
                Obrigado pelo seu registo! A nossa equipa está a verificar os seus dados e o seu NIF.
                <br /><br />
                Receberá um email assim que a sua conta de vendedor for aprovada.
            </p>

            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i> Enquanto aguarda, pode navegar no site como comprador, mas não poderá anunciar viaturas.
            </div>

            <div class="d-grid gap-2">
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary">
                    Continuar a navegar (Modo Leitura)
                </a>

                <hr />

                <form asp-controller="Conta" asp-action="Logout" method="post" class="d-grid">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-box-arrow-right"></i> Terminar Sessão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Conta/Index.cshtml">
@using AutoMarket.Models.Entities
@model Utilizador
@{
    ViewData["Title"] = "Meu Perfil";
}

<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Cabeуalho do Perfil -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">??</div>
                    <h2>@Model.Nome</h2>
                    <p class="text-muted">@Model.Email</p>
                    <hr />
                    <p class="small text-muted">Membro desde: @Model.DataRegisto.ToString("dd/MM/yyyy")</p>
                </div>
            </div>

            <!-- Informaушes Pessoais -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">?? Informaушes Pessoais</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Nome:</strong><br />
                            @Model.Nome
                        </div>
                        <div class="col-md-6">
                            <strong>Email:</strong><br />
                            @Model.Email
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Contacto:</strong><br />
                            @Model.Contacto
                        </div>
                        <div class="col-md-6">
                            <strong>NIF:</strong><br />
                            @(Model.NIF ?? "Nсo preenchido")
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <strong>Morada:</strong><br />
                            @Model.Morada
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu de Aушes -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">?? Aушes</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <a href="/Public/Conta/Favoritos" class="btn btn-outline-primary w-100">
                                <span style="font-size: 1.3em;">??</span> Meus Favoritos
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/Public/Conta/Notificacoes" class="btn btn-outline-primary w-100">
                                <span style="font-size: 1.3em;">??</span> Notificaушes
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seguranуa -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">?? Seguranуa</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="Logout" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-info btn-sm me-2">
                            ?? Terminar Sessсo (Logout)
                        </button>
                    </form>
                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        ??? Apagar Conta
                    </button>
                    <small class="text-muted d-block mt-2">
                        ?? Esta aусo ж permanente. A sua conta e todos os dados associados serсo removidos.
                    </small>
                </div>
            </div>

            <!-- Botсo Voltar -->
            <div class="mt-4 text-center">
                <a href="/" class="btn btn-secondary">? Voltar ao Inьcio</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmaусo de Eliminaусo -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">?? Apagar Conta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger fw-bold">Tem a certeza que deseja apagar sua conta?</p>
                <p>Esta aусo ж <strong>permanente</strong> e nсo pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="post" asp-action="ApagarConta" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">Apagar Conta</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
}
</file>

<file path="Areas/Public/Views/Conta/Lockout.cshtml">
@{
    ViewData["Title"] = "Conta Bloqueada";
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="card shadow text-center p-4 border-danger" style="max-width: 500px; width: 100%;">
        <div class="card-body">
            <div class="mb-4 text-danger">
                <i class="bi bi-shield-lock-fill" style="font-size: 4rem;"></i>
            </div>

            <h2 class="card-title fw-bold text-danger mb-3">Acesso Temporariamente Bloqueado</h2>

            <p class="card-text text-muted mb-4">
                Detetámos demasiadas tentativas de login falhadas. Para sua segurança, esta conta foi bloqueada temporariamente.
            </p>

            <div class="alert alert-warning" role="alert">
                <i class="bi bi-clock-history"></i> Por favor, aguarde <strong>15 minutos</strong> antes de tentar novamente.
            </div>

            <div class="d-grid gap-2 mt-4">
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                    Voltar à Página Inicial
                </a>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Conta/Login.cshtml">
@model AutoMarket.Models.ViewModels.LoginViewModel
@{
    ViewData["Title"] = "Login";
}

<main class="container login-container">
    <h2>Login</h2>
    <form asp-controller="Conta" asp-action="Login" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group">
            <label asp-for="Email"></label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Password"></label>
            <input asp-for="Password" type="password" autocomplete="current-password" class="form-control" />
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>
        <div class="form-group form-check">
            <input asp-for="RememberMe" class="form-check-input" />
            <label asp-for="RememberMe" class="form-check-label"></label>
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
        <div class="mt-3 text-center">
            <a asp-controller="Conta" asp-action="Register">Não tem conta? Registe-se</a>
        </div>
    </form>
</main>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
</file>

<file path="Areas/Public/Views/Conta/Notificacoes.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Notificacao>
@{
    ViewData["Title"] = "Minhas Notificaушes";
    var total = ViewData["TotalNotificacoes"] ?? 0;
    var page = ViewData["CurrentPage"] ?? 1;
    var totalPages = ViewData["TotalPages"] ?? 1;
}

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Notificaушes</h2>
            <p class="text-muted">Total: @total notificaусo(шes)</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/" class="btn btn-secondary">? Voltar</a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            Nenhuma notificaусo no momento.
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var notif in Model)
            {
                <a href="#" class="list-group-item list-group-item-action @(notif.Lida ? "" : "list-group-item-primary")" onclick="marcarComoLida(@notif.Id, '@notif.LinkRelacionado'); return false;">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">@notif.Assunto</h6>
                        <small class="text-muted">@notif.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                    <p class="mb-1">@notif.Corpo</p>
                    <small class="text-muted badge bg-secondary">@notif.Tipo</small>
                    @if (!notif.Lida)
                    {
                        <small class="text-muted ms-2 badge bg-danger">Nсo lida</small>
                    }
                </a>
            }
        </div>

        @if ((int)totalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    @for (int i = 1; i <= (int)totalPages; i++)
                    {
                        <li class="page-item @(i == (int)page ? "active" : "")">
                            <a class="page-link" href="?page=@i">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
</div>

<script>
    function marcarComoLida(notificacaoId, link) {
        fetch(`/api/notificacoes/marcar-como-lida/${notificacaoId}`, {
            method: 'POST',
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        })
        .then(r => r.json())
        .then(d => {
            if (link && link !== '') {
                window.location.href = link;
            } else {
                location.reload();
            }
        })
        .catch(e => console.error('Erro:', e));
    }
</script>
</file>

<file path="Areas/Public/Views/Conta/PreencherDadosFiscais.cshtml">
@model AutoMarket.Models.ViewModels.DadosFiscaisViewModel

@{
	ViewData["Title"] = "Dados em Falta";
}

<div class="container d-flex justify-content-center mt-5">
	<div class="card shadow-sm" style="max-width: 500px; width: 100%;">
		<div class="card-body p-4">
			<h3 class="card-title text-center mb-4">
				<i class="bi bi-card-heading text-primary"></i> Dados Fiscais
			</h3>

			<div class="alert alert-warning">
				<i class="bi bi-info-circle-fill"></i>
				Para prosseguir com a transação, necessitamos do seu NIF para a emissão da fatura.
			</div>

			<form asp-action="PreencherDadosFiscais" method="post">
				<div class="mb-3">
					<label asp-for="NIF" class="form-label fw-bold"></label>
					<input asp-for="NIF" class="form-control form-control-lg" placeholder="Inserir NIF..." />
					<span asp-validation-for="NIF" class="text-danger"></span>
				</div>

				<div class="d-grid gap-2">
					<button type="submit" class="btn btn-primary btn-lg">
						Guardar e Continuar <i class="bi bi-arrow-right"></i>
					</button>
					<a asp-controller="Home" asp-action="Index" class="btn btn-link text-muted">Cancelar</a>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
}
</file>

<file path="Areas/Public/Views/Conta/Register.cshtml">
@model AutoMarket.Models.ViewModels.RegisterViewModel
@{
    ViewData["Title"] = "Registo";
}
<main class="container" style="max-width:520px; margin:2rem auto;">
    <h2>Registo</h2>
    <form asp-controller="Conta" asp-action="Register" method="post">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="form-group">
            <label asp-for="Email"></label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Password"></label>
            <input asp-for="Password" class="form-control" />
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ConfirmPassword"></label>
            <input asp-for="ConfirmPassword" class="form-control" />
            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Nome"></label>
            <input asp-for="Nome" class="form-control" />
            <span asp-validation-for="Nome" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Morada"></label>
            <input asp-for="Morada" class="form-control" />
            <span asp-validation-for="Morada" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Contacto"></label>
            <input asp-for="Contacto" class="form-control" />
            <span asp-validation-for="Contacto" class="text-danger"></span>
        </div>

        <div class="form-group mb-4">
            <label class="form-label fw-bold d-block">Tipo de Conta:</label>

            <div class="btn-group w-100" role="group" aria-label="Seleção de tipo de conta">
                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoComprador" value="0" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoComprador">
                    <i class="bi bi-search"></i> Comprador
                </label>

                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoVendedor" value="1" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoVendedor">
                    <i class="bi bi-car-front"></i> Vendedor Particular
                </label>

                <input type="radio" class="btn-check" asp-for="TipoConta" id="tipoEmpresa" value="2" autocomplete="off">
                <label class="btn btn-outline-primary" for="tipoEmpresa">
                    <i class="bi bi-building"></i> Empresa
                </label>
            </div>
            <small class="text-muted">Escolha "Comprador" apenas para ver carros. Escolha as outras opções para vender.</small>
        </div>

        <div id="sellerFields" style="display:none;">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-title text-primary">Dados de Vendedor</h6>

                    <div class="form-group mb-3">
                        <label asp-for="NIF" class="control-label fw-bold"></label>
                        <input asp-for="NIF" class="form-control" placeholder="Introduza o NIF" />
                        <span asp-validation-for="NIF" class="text-danger"></span>
                        <div id="nifHelp" class="form-text"></div>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Registar</button>
    </form>
</main>
@section Scripts {
	@await Html.PartialAsync("_ValidationScriptsPartial");

	<script>
		$(document).ready(function () {
			// Mapeamento dos valores do Enum (Para ficar legível)
			// 0 = Comprador, 1 = Vendedor, 2 = Empresa

			const $radios = $('input[name="TipoConta"]');
			const $sellerFields = $('#sellerFields');
			const $nifInput = $('#NIF');
			const $nifLabel = $('label[for="NIF"]');
			const $nifHelp = $('#nifHelp');

			function atualizarFormulario() {
				// Obtém o valor do radio selecionado (0, 1 ou 2)
				const tipoSelecionado = $('input[name="TipoConta"]:checked').val();

				if (tipoSelecionado === '0') {
					// === COMPRADOR ===
					$sellerFields.slideUp();
					$nifInput.val(''); // Limpa o NIF se mudar de ideias
				}
				else {
					// === VENDEDOR OU EMPRESA ===
					$sellerFields.slideDown();

					// Lógica Específica: Empresa vs Particular
					if (tipoSelecionado === '2') {
						// É Empresa: NIF Obrigatório e Rigoroso
						$nifLabel.html('NIF da Empresa <span class="text-danger">*</span>');
						$nifInput.attr('placeholder', 'NIF Obrigatório (9 dígitos)');
						$nifHelp.text('Empresas são obrigadas a apresentar NIF válido para faturação.');
					} else {
						// É Particular: NIF Opcional (ou conforme a tua regra de negócio)
						$nifLabel.html('NIF (Particular)');
						$nifInput.attr('placeholder', 'Opcional');
						$nifHelp.text('Introduza o NIF se desejar fatura detalhada das taxas de serviço.');
					}
				}
			}

			// Event Listeners
			$radios.change(atualizarFormulario);

			// Executar ao carregar a página (para manter o estado se houver erro de validação)
			atualizarFormulario();
		});
	</script>
}
</file>

<file path="Areas/Public/Views/Denuncias/Criar.cshtml">
@using AutoMarket.Models.Entities
@{
    ViewData["Title"] = "Fazer Denúncia";
}

<div class="container mt-5" style="max-width: 600px;">
    <div class="row">
        <div class="col-12">
            <h2>Fazer Denúncia</h2>
            <p class="text-muted">Denuncie práticas irregulares ou anúncios suspeitos</p>

            <form id="formDenuncia" class="mt-4">
                <div class="mb-3">
                    <label class="form-label">Tipo de Denúncia</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipo" id="tipoVeiculo" value="veiculo" checked onchange="toggleVeiculoFields()">
                        <label class="form-check-label" for="tipoVeiculo">
                            Denunciar um Anúncio (Veículo)
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="tipo" id="tipoUtilizador" value="utilizador" onchange="toggleVeiculoFields()">
                        <label class="form-check-label" for="tipoUtilizador">
                            Denunciar um Utilizador
                        </label>
                    </div>
                </div>

                <div id="veiculoSection" class="mb-3">
                    <label for="veiculoId" class="form-label">ID do Anúncio (Veículo)</label>
                    <input type="number" class="form-control" id="veiculoId" name="veiculoId" placeholder="Ex: 12345">
                    <small class="text-muted">Deixe em branco se estiver denunciando um utilizador</small>
                </div>

                <div id="utilizadorSection" class="mb-3" style="display: none;">
                    <label for="utilizadorEmail" class="form-label">Email do Utilizador</label>
                    <input type="email" class="form-control" id="utilizadorEmail" name="utilizadorEmail" placeholder="email@example.com">
                    <small class="text-muted">Deixe em branco se estiver denunciando um anúncio</small>
                </div>

                <div class="mb-3">
                    <label for="motivo" class="form-label">Motivo da Denúncia *</label>
                    <textarea class="form-control" id="motivo" name="motivo" rows="5" required
                              placeholder="Descreva detalhadamente o motivo da denúncia..."></textarea>
                    <small class="text-muted">Seja o mais específico possível para facilitar a análise</small>
                </div>

                <button type="submit" class="btn btn-danger w-100">Enviar Denúncia</button>
                <a href="/" class="btn btn-secondary w-100 mt-2">Cancelar</a>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleVeiculoFields() {
        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        const veiculoSection = document.getElementById('veiculoSection');
        const utilizadorSection = document.getElementById('utilizadorSection');

        if (tipo === 'veiculo') {
            veiculoSection.style.display = 'block';
            utilizadorSection.style.display = 'none';
            document.getElementById('veiculoId').required = true;
            document.getElementById('utilizadorEmail').required = false;
        } else {
            veiculoSection.style.display = 'none';
            utilizadorSection.style.display = 'block';
            document.getElementById('veiculoId').required = false;
            document.getElementById('utilizadorEmail').required = true;
        }
    }

    document.getElementById('formDenuncia').addEventListener('submit', async (e) => {
        e.preventDefault();

        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        const motivo = document.getElementById('motivo').value;
        
        let veiculoId = null;
        let targetUserId = null;

        if (tipo === 'veiculo') {
            veiculoId = parseInt(document.getElementById('veiculoId').value);
            if (!veiculoId) {
                alert('Por favor, informe o ID do anúncio.');
                return;
            }
        } else {
            const email = document.getElementById('utilizadorEmail').value;
            if (!email) {
                alert('Por favor, informe o email do utilizador.');
                return;
            }
            // Aqui seria necessário fazer lookup do utilizador por email
            // Para simplificar, usamos um endpoint que aceita email
            targetUserId = email;
        }

        try {
            const response = await fetch('/api/denuncias/criar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({
                    veiculoId: veiculoId,
                    targetUserId: targetUserId,
                    motivo: motivo
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Denúncia enviada com sucesso!');
                window.location.href = '/';
            } else {
                alert('Erro: ' + (data.message || 'Não foi possível enviar a denúncia'));
            }
        } catch (error) {
            alert('Erro ao enviar denúncia: ' + error);
        }
    });
</script>
</file>

<file path="Areas/Public/Views/Home/Contactos.cshtml">
@{
    ViewData["Title"] = "Contacte-nos";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4">?? Contacte-nos</h1>

            <div class="row mb-4">
                <!-- Email -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">??</div>
                            <h5 class="card-title">Email</h5>
                            <p class="card-text text-muted mb-3">
                                Para questões gerais, sugestões ou reclamações
                            </p>
                            <a href="mailto:suporte@automarket.com" class="btn btn-primary">
                                suporte@automarket.com
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Telefone -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">??</div>
                            <h5 class="card-title">Telefone</h5>
                            <p class="card-text text-muted mb-3">
                                Suporte ao cliente 24/7
                            </p>
                            <a href="tel:+351800123456" class="btn btn-success">
                                +351 800 123 456
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Horário -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <div style="font-size: 2rem; margin-bottom: 1rem; text-align: center;">??</div>
                            <h5 class="card-title text-center">Horário de Funcionamento</h5>
                            <ul class="list-unstyled text-center text-muted">
                                <li class="mb-2">
                                    <strong>Segunda - Sexta:</strong><br>
                                    09:00 - 18:00
                                </li>
                                <li class="mb-2">
                                    <strong>Sábado:</strong><br>
                                    10:00 - 16:00
                                </li>
                                <li>
                                    <strong>Domingo:</strong><br>
                                    Fechado
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Morada -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <div style="font-size: 2rem; margin-bottom: 1rem; text-align: center;">??</div>
                            <h5 class="card-title text-center">Morada</h5>
                            <p class="text-center text-muted mb-0">
                                <strong>AutoMarket Portugal</strong><br>
                                Rua da Tecnologia, 123<br>
                                4000-000 Porto<br>
                                Portugal<br><br>
                                <a href="https://maps.google.com" target="_blank" class="btn btn-outline-primary btn-sm">
                                    Ver Mapa
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REDES SOCIAIS -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Siga-nos nas Redes Sociais</h5>
                    <div class="btn-group" role="group">
                        <a href="https://facebook.com" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-facebook"></i> Facebook
                        </a>
                        <a href="https://instagram.com" target="_blank" class="btn btn-outline-danger">
                            <i class="bi bi-instagram"></i> Instagram
                        </a>
                        <a href="https://twitter.com" target="_blank" class="btn btn-outline-info">
                            <i class="bi bi-twitter"></i> Twitter
                        </a>
                        <a href="https://youtube.com" target="_blank" class="btn btn-outline-danger">
                            <i class="bi bi-youtube"></i> YouTube
                        </a>
                    </div>
                </div>
            </div>

            <!-- FORMULÁRIO DE CONTACTO -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">?? Envie uma Mensagem</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="EnviarMensagem">
                        <div class="mb-3">
                            <label for="nome" class="form-label fw-bold">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <div class="mb-3">
                            <label for="assunto" class="form-label fw-bold">Assunto</label>
                            <input type="text" class="form-control" id="assunto" name="assunto" required>
                        </div>

                        <div class="mb-3">
                            <label for="mensagem" class="form-label fw-bold">Mensagem</label>
                            <textarea class="form-control" id="mensagem" name="mensagem" rows="5" required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            Enviar Mensagem
                        </button>
                    </form>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/" class="btn btn-secondary">? Voltar ao Início</a>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Home/Index.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = "Início";
}

<main class="py-5">
    <!-- Hero Section -->
    <section class="text-center mb-5 pb-4">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">Encontre o Seu Próximo Veículo</h1>
            
            <!-- Search Form -->
            <form class="row g-3 justify-content-center mb-4" method="get" asp-area="" asp-controller="Veiculos" asp-action="Index">
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Marca" name="marca" />
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Modelo" name="modelo" />
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" placeholder="Preço até" name="precoMax" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Pesquisar
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Featured Vehicles -->
    <section class="container mb-5">
        <h2 class="h3 mb-4">Veículos em Destaque</h2>
        <div class="row g-4">
            <!-- Card 1 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo1.jpg" class="card-img-top" alt="BMW Série 1" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">BMW Série 1</h5>
                        <p class="card-text text-danger fw-bold fs-5">€19.900</p>
                        <small class="text-muted">2019 • 45.000km • Lisboa</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo2.jpg" class="card-img-top" alt="Renault Clio" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Renault Clio</h5>
                        <p class="card-text text-danger fw-bold fs-5">€13.400</p>
                        <small class="text-muted">2018 • 33.000km • Porto</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo3.jpg" class="card-img-top" alt="Volkswagen Golf" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Volkswagen Golf</h5>
                        <p class="card-text text-danger fw-bold fs-5">€22.500</p>
                        <small class="text-muted">2020 • 29.900km • Braga</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card h-100 shadow-sm vehicle-card">
                    <img src="/images/carro_exemplo4.jpg" class="card-img-top" alt="Fiat 500" style="height: 200px; object-fit: cover;" />
                    <div class="card-body">
                        <h5 class="card-title text-primary">Fiat 500</h5>
                        <p class="card-text text-danger fw-bold fs-5">€10.950</p>
                        <small class="text-muted">2016 • 70.000km • Faro</small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="#" class="btn btn-outline-primary btn-sm w-100">Ver Detalhes</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="bg-light py-5">
        <div class="container">
            <div class="row g-4 text-center">
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-check-circle fs-3"></i>
                        </h5>
                        <h6>Garantia de Qualidade</h6>
                        <p class="text-muted small">Todos os veículos são verificados e avaliados.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-headset fs-3"></i>
                        </h5>
                        <h6>Suporte Dedicado</h6>
                        <p class="text-muted small">Acompanhamento antes, durante e após a compra.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-shield-lock fs-3"></i>
                        </h5>
                        <h6>Compra Segura</h6>
                        <p class="text-muted small">Pagamentos e reservas com total transparência.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .feature-box {
        padding: 1.5rem;
    }
</style>
</file>

<file path="Areas/Public/Views/Home/Politicas.cshtml">
@{
    ViewData["Title"] = "Polьtica de Privacidade";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4">?? Polьtica de Privacidade</h1>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="mb-3">1. Introduусo</h4>
                    <p>
                        O AutoMarket estр comprometido com a protecусo dos seus dados pessoais. 
                        Esta polьtica explica como recolhemos, utilizamos e protegemos as suas informaушes.
                    </p>

                    <hr>

                    <h4 class="mb-3">2. Dados que Recolhemos</h4>
                    <p>Recolhemos os seguintes dados:</p>
                    <ul>
                        <li>Informaушes de registo (nome, email, telefone, morada)</li>
                        <li>Dados fiscais (NIF - encriptado)</li>
                        <li>Histзrico de transaушes e reservas</li>
                        <li>Dados de navegaусo e cookies</li>
                        <li>Fotografias e documentos enviados</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">3. Como Utilizamos os Seus Dados</h4>
                    <p>Os seus dados sсo utilizados para:</p>
                    <ul>
                        <li>Processar transaушes de compra/venda</li>
                        <li>Enviar notificaушes e atualizaушes</li>
                        <li>Melhorar os nossos serviуos</li>
                        <li>Cumprir obrigaушes legais</li>
                        <li>Prevenir fraude e abuso</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">4. Seguranуa de Dados</h4>
                    <p>
                        Utilizamos encriptaусo AES-256 para dados sensьveis (NIF). 
                        Todos os dados sсo armazenados com seguranуa em servidores protegidos.
                    </p>

                    <hr>

                    <h4 class="mb-3">5. Retenусo de Dados</h4>
                    <p>
                        Os seus dados sсo mantidos enquanto a sua conta estiver ativa. 
                        Apзs eliminaусo da conta (soft delete), os dados sсo anonimizados conforme RGPD.
                    </p>

                    <hr>

                    <h4 class="mb-3">6. Seus Direitos</h4>
                    <p>Tem direito a:</p>
                    <ul>
                        <li>Aceder aos seus dados pessoais</li>
                        <li>Corrigir dados imprecisos</li>
                        <li>Solicitar eliminaусo de dados (direito ao esquecimento)</li>
                        <li>Exportar seus dados</li>
                        <li>Revogar consentimento a qualquer momento</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">7. Cookies</h4>
                    <p>
                        O AutoMarket utiliza cookies para melhorar a experiЖncia do utilizador. 
                        Pode gerir cookies nas configuraушes do seu browser.
                    </p>

                    <hr>

                    <h4 class="mb-3">8. Contacto</h4>
                    <p>
                        Para exercer seus direitos de privacidade, contacte: <strong>privacy@automarket.com</strong>
                    </p>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/" class="btn btn-primary">? Voltar ao Inьcio</a>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Home/Privacy.cshtml">
@{
    ViewData["Title"] = "Privacy Policy";
}
<h1>@ViewData["Title"]</h1>

<p>Use this page to detail your site's privacy policy.</p>
</file>

<file path="Areas/Public/Views/Home/Termos.cshtml">
@{
    ViewData["Title"] = "Termos e Condiушes";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4">?? Termos e Condiушes</h1>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="mb-3">1. Aceitaусo dos Termos</h4>
                    <p>
                        Ao aceder e utilizar o AutoMarket, vocЖ aceita estar vinculado por estes termos e condiушes. 
                        Se nсo concorda com alguma parte destes termos, por favor nсo utilize o serviуo.
                    </p>

                    <hr>

                    <h4 class="mb-3">2. Uso do Serviуo</h4>
                    <p>
                        O AutoMarket ж uma plataforma para compra e venda de veьculos usados. VocЖ concorda em:
                    </p>
                    <ul>
                        <li>Fornecer informaушes precisas no seu registo</li>
                        <li>Ser responsрvel pela confidencialidade da sua palavra-passe</li>
                        <li>Usar a plataforma de forma legal e жtica</li>
                        <li>Nсo publicar conteЩdo fraudulento ou enganoso</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">3. AnЩncios e Listagens</h4>
                    <p>
                        Os vendedores garantem que:
                    </p>
                    <ul>
                        <li>Os detalhes do veьculo sсo precisos e completos</li>
                        <li>As imagens correspondem ao veьculo oferecido</li>
                        <li>O veьculo ж propriedade do vendedor ou estр devidamente autorizado</li>
                        <li>Aceita responsabilidade legal pelos dados publicados</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">4. Transaушes e Pagamentos</h4>
                    <p>
                        Ao efectuar uma compra:
                    </p>
                    <ul>
                        <li>Concorda em pagar o preуo acordado</li>
                        <li>Todos os pagamentos sсo processados de forma segura</li>
                        <li>O AutoMarket nсo ж responsрvel por perdas durante o transporte</li>
                        <li>Tem direito a devoluусo em atж 14 dias</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">5. Direitos e Responsabilidades</h4>
                    <p>
                        O AutoMarket nсo ж responsрvel por:
                    </p>
                    <ul>
                        <li>Qualidade mecРnica dos veьculos</li>
                        <li>Atrasos na entrega</li>
                        <li>Disputas entre comprador e vendedor</li>
                        <li>Perda de dados ou interrupушes de serviуo</li>
                    </ul>

                    <hr>

                    <h4 class="mb-3">6. Modificaушes dos Termos</h4>
                    <p>
                        O AutoMarket reserva-se o direito de modificar estes termos a qualquer momento. 
                        As alteraушes entram em vigor imediatamente apзs publicaусo.
                    </p>

                    <hr>

                    <h4 class="mb-3">7. Contacto</h4>
                    <p>
                        Para questшes sobre estes termos, contacte-nos em <strong>legal@automarket.com</strong>
                    </p>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/" class="btn btn-primary">? Voltar ao Inьcio</a>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Reservas/Criar.cshtml">
@model Veiculo
@using AutoMarket.Models.Entities
@{
    ViewData["Title"] = "Reservar Veículo";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white py-4">
                    <h3 class="mb-0">?? Reservar Veículo</h3>
                </div>
                <div class="card-body p-4">
                    <!-- RESUMO VEÍCULO -->
                    <div class="alert alert-info mb-4">
                        <h5>@Model.Marca @Model.Modelo (@Model.Ano)</h5>
                        <p class="mb-1">€@Model.Preco.ToString("F2")</p>
                        <small>@Model.Titulo</small>
                    </div>

                    <form method="post" asp-action="CriarReserva">
                        <input type="hidden" name="veiculoId" value="@Model.Id">

                        <!-- DATA EXPIRAÇÃO -->
                        <div class="mb-4">
                            <label for="dataExpiracao" class="form-label fw-bold">
                                Até quando deseja manter a reserva?
                            </label>
                            <select class="form-select form-select-lg" id="dataExpiracao" name="diasExpiracao" required>
                                <option value="">-- Selecione --</option>
                                <option value="7">7 dias (Uma semana)</option>
                                <option value="14">14 dias (Duas semanas)</option>
                                <option value="21">21 dias (Três semanas)</option>
                                <option value="30">30 dias (Um mês)</option>
                            </select>
                            <small class="text-muted d-block mt-2">
                                A reserva será automaticamente cancelada após este período se não for confirmada a compra.
                            </small>
                        </div>

                        <!-- NOTAS OPCIONAIS -->
                        <div class="mb-4">
                            <label for="notas" class="form-label fw-bold">Notas Adicionais (Opcional)</label>
                            <textarea class="form-control" id="notas" name="notas" rows="3" placeholder="Ex: Tenho interesse em agendar uma visita..."></textarea>
                        </div>

                        <!-- CONFIRMAÇÃO -->
                        <div class="alert alert-warning mb-4">
                            <h6 class="mb-2">?? Informações Importantes</h6>
                            <ul class="mb-0 small">
                                <li>A reserva garante que o veículo não será vendido durante este período</li>
                                <li>Pode agendar uma visita após criar a reserva</li>
                                <li>O vendedor entrará em contacto para coordenar a compra</li>
                                <li>Se não confirmar a compra, a reserva será cancelada automaticamente</li>
                            </ul>
                        </div>

                        <!-- BOTÕES -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg fw-bold">
                                ? Confirmar Reserva
                            </button>
                            <a href="/Public/Veiculos/Detalhe/@Model.Id" class="btn btn-outline-secondary btn-lg">
                                ? Voltar ao Anúncio
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Public/Views/Shared/_Footer.cshtml">
<footer class="bg-light border-top mt-5 py-4">
    <div class="container">
        <div class="row gy-3 align-items-center">
            <div class="col-md-4 text-md-start text-center">
                <a class="navbar-brand fw-bold" asp-area="Public" asp-controller="Home" asp-action="Index">
                    🚗 AutoMarket
                </a>
                <div class="text-muted small">© @DateTime.UtcNow.Year AutoMarket. Todos os direitos reservados.</div>
            </div>

            <div class="col-md-4">
                <ul class="nav justify-content-center">
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Index">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Veiculos" asp-action="Index">Veículos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Sobre">Sobre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-2 text-muted" asp-area="Public" asp-controller="Home" asp-action="Ajuda">Ajuda</a>
                    </li>
                </ul>
            </div>

            <div class="col-md-4 text-md-end text-center">
                <div class="text-muted small">Precisa de ajuda?</div>
                <a class="text-decoration-none" href="mailto:support@automarket.com">support@automarket.com</a>
            </div>
        </div>
    </div>
</footer>
</file>

<file path="Areas/Public/Views/Shared/_Layout.cshtml">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - AutoMarket</title>
    <link rel="stylesheet" href="~/css/style.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/AutoMarket.styles.css" asp-append-version="true" />
    @RenderSection("Styles", required: false)
</head>
<body>
    <partial name="~/Areas/Public/Views/Shared/_Header.cshtml" />
    @if (TempData["MensagemStatus"] != null)
    {
        <div class="container mt-3">
            <div class="alert alert-info text-center" role="alert">
                @TempData["MensagemStatus"]
            </div>
        </div>
    }
    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

	<partial name="~/Areas/Public/Views/Shared/_Footer.cshtml" />

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
</file>

<file path="Areas/Public/Views/Shared/_Layout.cshtml.css">
/* Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
for details on configuring this project to bundle and minify static web assets. */

a.navbar-brand {
  white-space: normal;
  text-align: center;
  word-break: break-all;
}

a {
  color: #0077cc;
}

.btn-primary {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.nav-pills .nav-link.active, .nav-pills .show > .nav-link {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.border-top {
  border-top: 1px solid #e5e5e5;
}
.border-bottom {
  border-bottom: 1px solid #e5e5e5;
}

.box-shadow {
  box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .05);
}

button.accept-policy {
  font-size: 1rem;
  line-height: inherit;
}

.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  white-space: nowrap;
  line-height: 60px;
}
</file>

<file path="Areas/Public/Views/Shared/_ValidationScriptsPartial.cshtml">
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
</file>

<file path="Areas/Public/Views/Shared/Components/CarrinhoResumo/Default.cshtml">
@model AutoMarket.Models.ViewModels.CarrinhoWidgetViewModel

<li class="nav-item">
    <a class="nav-link position-relative" asp-controller="Carrinho" asp-action="Index">
        <i class="bi bi-cart3 fs-5"></i>

        @if (Model.QuantidadeItens > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  style="font-size: 0.7rem;">
                @Model.QuantidadeItens
                <span class="visually-hidden">itens no carrinho</span>
            </span>

            <span class="d-none d-lg-inline ms-1 fw-bold small text-success">
                @Model.ValorTotal.ToString("N0")€
            </span>
        }
    </a>
</li>
</file>

<file path="Areas/Public/Views/Shared/Error.cshtml">
@using AutoMarket.Models.ViewModels
@model ErrorViewModel
@{
    ViewData["Title"] = "Error";
}

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (!string.IsNullOrEmpty(Model.Message))
{
    <div class="alert alert-danger mt-4">
        <i class="bi bi-exclamation-triangle-fill"></i> @Model.Message
    </div>
}
@if (Model.ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@Model.RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>
</file>

<file path="Areas/Public/Views/Veiculos/_CarListPartial.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    var currentPage = (int?)ViewData["CurrentPage"] ?? 1;
    var totalPages = (int?)ViewData["TotalPages"] ?? 1;
    var totalItems = (int?)ViewData["TotalItems"] ?? 0;
}

<!-- INFORMAÇÕES DE PAGINAÇÃO -->
@if (totalItems > 0)
{
    <div class="alert alert-info mb-3">
        <small>
            <strong>Total:</strong> @totalItems veículo(s) encontrado(s) | 
            <strong>Página:</strong> @currentPage de @totalPages
        </small>
    </div>
}

<!-- Grid de Anúncios -->
@if (Model.Any())
{
    <div class="row g-4" id="veiculosGrid">
        @foreach (var veiculo in Model)
        {
            var imagemPrincipal = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
                                  ?? veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro;

            <div class="col-lg-4 col-md-6 col-12">
                <div class="card h-100 shadow-sm vehicle-card transition">
                    @if (!string.IsNullOrEmpty(imagemPrincipal))
                    {
                        <img src="/images/veiculos/@imagemPrincipal" class="card-img-top" alt="@veiculo.Marca @veiculo.Modelo" style="height: 200px; object-fit: cover;" />
                    }
                    else
                    {
                        <div style="height: 200px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">
                            <small>Sem imagem</small>
                        </div>
                    }
                    <div class="card-body">
                        <h6 class="card-title text-primary">@veiculo.Marca @veiculo.Modelo</h6>
                        <p class="card-text text-danger fw-bold fs-6">€@veiculo.Preco.ToString("F2")</p>
                        <small class="text-muted d-block">
                            ?? @veiculo.Ano
                        </small>
                        <small class="text-muted d-block">
                            ??? @veiculo.Km.ToString("N0") km
                        </small>
                        <small class="text-muted d-block mb-2">
                            ? @veiculo.Combustivel
                        </small>
                        @if (veiculo.Categoria != null)
                        {
                            <span class="badge bg-info text-dark">@veiculo.Categoria.Nome</span>
                        }
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="/Veiculos/Detalhe/@veiculo.Id" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-eye"></i> Ver Detalhes
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- CONTROLES DE PAGINAÇÃO -->
    @if (totalPages > 1)
    {
        <nav aria-label="Navegação de Páginas" class="mt-5">
            <ul class="pagination justify-content-center">
                <!-- Botão Anterior -->
                <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                    <a class="page-link pagination-link" href="#" data-page="@(currentPage - 1)" aria-label="Página Anterior">
                        <i class="bi bi-chevron-left"></i> Anterior
                    </a>
                </li>

                <!-- Números de Páginas -->
                @for (int i = 1; i <= totalPages; i++)
                {
                    if (i == currentPage)
                    {
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">@i</span>
                        </li>
                    }
                    else if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                    {
                        <li class="page-item">
                            <a class="page-link pagination-link" href="#" data-page="@i">@i</a>
                        </li>
                    }
                    else if (i == currentPage - 3 || i == currentPage + 3)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }

                <!-- Botão Próximo -->
                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <a class="page-link pagination-link" href="#" data-page="@(currentPage + 1)" aria-label="Próxima Página">
                        Próximo <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
}
else
{
    <div class="alert alert-info text-center" role="alert">
        <h6 class="alert-heading">Nenhum veículo encontrado</h6>
        <p class="mb-3">Nenhum veículo encontrado com os filtros selecionados.</p>
        <a href="/Veiculos/Index" class="btn btn-primary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
        </a>
    </div>
}
</file>

<file path="Areas/Public/Views/Veiculos/Detalhe.cshtml">
@model Veiculo
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager
@{
    ViewData["Title"] = $"{Model.Marca} {Model.Modelo} - {Model.Ano}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container">
        <h1 class="text-white mb-2">@Model.Marca @Model.Modelo</h1>
        <p class="text-white-50">@Model.Titulo</p>
    </div>
</div>

<div class="container py-5">
    <div class="row g-4">
        <!-- COLUNA ESQUERDA: Carrossel e Infos -->
        <div class="col-lg-8">
            
            <!-- CARROSSEL BOOTSTRAP -->
            @if (Model.Imagens?.Any() == true)
            {
                <div class="card shadow-sm mb-4">
                    <div id="veiculoCarousel" class="carousel slide" data-bs-ride="carousel">
                        <!-- Imagens -->
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Imagens.Count; i++)
                            {
                                var imagem = Model.Imagens.ElementAt(i);
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="/images/veiculos/@imagem.CaminhoFicheiro" 
                                         class="d-block w-100" 
                                         alt="@Model.Marca @Model.Modelo - Foto @(i + 1)"
                                         style="height: 500px; object-fit: cover;" />
                                </div>
                            }
                        </div>

                        <!-- Botões Anterior/Próximo -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#veiculoCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#veiculoCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Próximo</span>
                        </button>

                        <!-- Indicadores -->
                        <div class="carousel-indicators">
                            @for (int i = 0; i < Model.Imagens.Count; i++)
                            {
                                <button type="button" 
                                        data-bs-target="#veiculoCarousel" 
                                        data-bs-slide-to="@i" 
                                        class="@(i == 0 ? "active" : "")" 
                                        aria-label="Foto @(i + 1)"></button>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm mb-4">
                    <div style="height: 500px; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                        <div class="text-center">
                            <i class="bi bi-image" style="font-size: 4rem; color: #999;"></i>
                            <p class="text-muted mt-3">Sem imagens disponíveis</p>
                        </div>
                    </div>
                </div>
            }

            <!-- INFORMAÇÕES PRINCIPAIS -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="card-title mb-4">@Model.Marca @Model.Modelo</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="text-muted">Preço</h5>
                            <h3 class="text-primary fw-bold">€@Model.Preco.ToString("F2")</h3>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-muted">Estado</h5>
                            <div>
                                @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success fs-6">Ativo</span>
                                }
                                else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger fs-6">Vendido</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning fs-6">@Model.Estado</span>
                                }
                            </div>
                        </div>
                    </div>

                    <hr />

                    <!-- ESPECIFICAÇÕES TÉCNICAS -->
                    <h4 class="mb-3">Especificações Técnicas</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Ano</h6>
                            <p class="fw-bold fs-5">@Model.Ano</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Quilómetros</h6>
                            <p class="fw-bold fs-5">@Model.Km.ToString("N0") km</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Combustível</h6>
                            <p class="fw-bold fs-5">@Model.Combustivel</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Caixa</h6>
                            <p class="fw-bold fs-5">@Model.Caixa</p>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Condicao))
                        {
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Condição</h6>
                                <p class="fw-bold fs-5">@Model.Condicao</p>
                            </div>
                        }
                        @if (Model.Categoria != null)
                        {
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Categoria</h6>
                                <p class="fw-bold fs-5">@Model.Categoria.Nome</p>
                            </div>
                        }
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted">Localização</h6>
                            <p class="fw-bold fs-5">?? @Model.Localizacao</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DESCRIÇÃO DETALHADA -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Descrição Detalhada</h4>
                    <p class="card-text" style="line-height: 1.8; white-space: pre-wrap;">@Model.Descricao</p>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA: Vendedor e Ações -->
        <div class="col-lg-4">
            
            <!-- CARD DO VENDEDOR -->
            @if (Model.Vendedor?.User != null)
            {
                <div class="card shadow-sm mb-4 sticky-top" style="top: 100px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informações do Vendedor</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="avatar mb-3" style="width: 80px; height: 80px; background: #e0e0e0; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-person" style="font-size: 2rem; color: #999;"></i>
                            </div>
                            <h5 class="fw-bold">@Model.Vendedor.User.Nome</h5>
                            <small class="text-muted d-block">Vendedor desde @Model.Vendedor.User.DataRegisto.ToString("MMMM yyyy")</small>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <h6 class="text-muted">Contacto</h6>
                            <p class="fw-bold">
                                <i class="bi bi-telephone"></i> 
                                @Model.Vendedor.User.Contacto
                            </p>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-muted">Localização</h6>
                            <p class="fw-bold">
                                <i class="bi bi-geo-alt"></i> 
                                @Model.Vendedor.User.Morada
                            </p>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-muted">Email</h6>
                            <p class="fw-bold" style="word-break: break-all;">
                                <i class="bi bi-envelope"></i> 
                                @Model.Vendedor.User.Email
                            </p>
                        </div>

                        <hr />

                        <!-- BOTÕES DE AÇÃO -->
                        <div class="d-grid gap-2">
                            @if (SignInManager.IsSignedIn(User))
                            {
                                <a href="@Url.Action("Checkout", "Transacoes", new { id = Model.Id })" class="btn btn-success btn-lg">
                                    <i class="bi bi-cart"></i> Comprar Veículo
                                </a>
                                <button class="btn btn-outline-primary btn-lg" onclick="alert('Funcionalidade em desenvolvimento')">
                                    <i class="bi bi-heart"></i> Adicionar aos Favoritos
                                </button>
                                <a href="javascript:void(0)" class="btn btn-outline-secondary btn-lg" onclick="alert('Chat em desenvolvimento')">
                                    <i class="bi bi-chat-dots"></i> Enviar Mensagem
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("Login", "Conta")" class="btn btn-success btn-lg">
                                    <i class="bi bi-cart"></i> Login para Comprar
                                </a>
                                <p class="text-muted text-center mt-2">
                                    Faça login para contactar o vendedor
                                </p>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- CARD DE INFORMAÇÕES ADICIONAIS -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Informações do Anúncio</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted">Publicado em</h6>
                        <p class="fw-bold">@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted">ID do Anúncio</h6>
                        <p class="fw-bold text-monospace">#@Model.Id</p>
                    </div>
                    <div>
                        <h6 class="text-muted">Imagens</h6>
                        <p class="fw-bold">
                            <i class="bi bi-image"></i> 
                            @(Model.Imagens?.Count ?? 0) foto(s)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTÕES DE NAVEGAÇÃO NO RODAPÉ -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex gap-2 justify-content-between">
                <a href="@Url.Action("Index", "Veiculos")" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-arrow-left"></i> Voltar ao Catálogo
                </a>
                <a href="@Url.Action("Index", "Veiculos", new { marca = Model.Marca })" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-search"></i> Ver Mais @Model.Marca
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS ADICIONAIS -->
@section Styles {
    <style>
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            filter: invert(1);
        }

        .carousel-indicators button {
            background-color: #666;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }

        .carousel-indicators button.active {
            background-color: #0d6efd;
        }

        .sticky-top {
            z-index: 10;
        }

        .avatar {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .text-monospace {
            font-family: 'Courier New', monospace;
        }

        @@media (max-width: 768px) {
            .sticky-top {
                position: relative !important;
                top: auto !important;
                margin-top: 2rem;
            }

            .carousel-inner {
                height: 300px;
            }
        }
    </style>
}
</file>

<file path="Areas/Vendedores/_ViewImports.cshtml">
@using AutoMarket
@using AutoMarket.Models
@using AutoMarket.Models.Entities
@using AutoMarket.Models.ViewModels
@using AutoMarket.Models.Enums
@using Microsoft.AspNetCore.Identity
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
</file>

<file path="Areas/Vendedores/_ViewStart.cshtml">
@{
	Layout = "~/Areas/Vendedores/Views/Shared/_Layout.cshtml";
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Create.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.CreateVeiculoViewModel
@{
    ViewData["Title"] = "Criar Novo Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Criar Novo Veьculo</h1>

            <form asp-action="Create" asp-controller="Veiculos" asp-area="Vendedores" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                <!-- Seусo 1: Informaушes Bрsicas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informaушes Bрsicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label">Tьtulo do AnЩncio *</label>
                            <input asp-for="Titulo" class="form-control" placeholder="Ex: BMW 320i 2018 em perfeito estado" required />
                            <span asp-validation-for="Titulo" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Marca" class="form-label">Marca *</label>
                                <input asp-for="Marca" class="form-control" placeholder="Ex: BMW" required />
                                <span asp-validation-for="Marca" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Modelo" class="form-label">Modelo *</label>
                                <input asp-for="Modelo" class="form-control" placeholder="Ex: 320i" required />
                                <span asp-validation-for="Modelo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Ano" class="form-label">Ano *</label>
                                <input asp-for="Ano" type="number" class="form-control" placeholder="2023" required />
                                <span asp-validation-for="Ano" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoriaId" class="form-label">Tipo/Segmento *</label>
                                <select asp-for="CategoriaId" class="form-select" required>
                                    <option value="">-- Selecione uma categoria --</option>
                                    @if (Model.CategoriesDropdown.Any())
                                    {
                                        @foreach (var cat in Model.CategoriesDropdown)
                                        {
                                            <option value="@cat.Id">@cat.Nome</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoriaId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 2: Especificaушes Tжcnicas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Especificaушes Tжcnicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Combustivel" class="form-label">Combustьvel *</label>
                                <select asp-for="Combustivel" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Gasolina">Gasolina</option>
                                    <option value="Gasзleo">Gasзleo</option>
                                    <option value="Hьbrido">Hьbrido</option>
                                    <option value="Elжtrico">Elжtrico</option>
                                    <option value="GLP">GLP</option>
                                </select>
                                <span asp-validation-for="Combustivel" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Caixa" class="form-label">Caixa *</label>
                                <select asp-for="Caixa" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Automрtica">Automрtica</option>
                                    <option value="CVT">CVT</option>
                                </select>
                                <span asp-validation-for="Caixa" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Km" class="form-label">Quilзmetros</label>
                                <input asp-for="Km" type="number" class="form-control" placeholder="45000" />
                                <span asp-validation-for="Km" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Condicao" class="form-label">Condiусo</label>
                                <input asp-for="Condicao" class="form-control" placeholder="Ex: Usado, Novo" />
                                <span asp-validation-for="Condicao" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Preco" class="form-label">Preуo (ђ) *</label>
                                <input asp-for="Preco" type="number" step="0.01" class="form-control" placeholder="25000.00" required />
                                <span asp-validation-for="Preco" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 3: Localizaусo e Descriусo -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Localizaусo e Descriусo</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Localizacao" class="form-label">Localizaусo *</label>
                            <input asp-for="Localizacao" class="form-control" placeholder="Ex: Lisboa, Portugal" required />
                            <span asp-validation-for="Localizacao" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Descricao" class="form-label">Descriусo Detalhada *</label>
                            <textarea asp-for="Descricao" class="form-control" rows="5" placeholder="Descreva em detalhe o estado do veьculo, histзrico de manutenусo, reparaушes, etc." required></textarea>
                            <small class="form-text text-muted">Mрximo 2000 caracteres</small>
                            <span asp-validation-for="Descricao" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Seусo 4: Fotos -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Fotos (Mрximo 10 imagens)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Fotos" class="form-label">Selecione as Fotos *</label>
                            <input asp-for="Fotos" type="file" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple required />
                            <small class="form-text text-muted">
                                Formatos: JPG, JPEG, PNG, WebP | Mрximo 10 imagens | Mрximo 5 MB por imagem
                            </small>
                            <span asp-validation-for="Fotos" class="text-danger"></span>
                        </div>

                        <div id="preview" class="row mt-3"></div>
                    </div>
                </div>

                <!-- Botшes -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Criar Veьculo
                    </button>
                    <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelector('input[type="file"]').addEventListener('change', function(e) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            
            Array.from(this.files).slice(0, 10).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                    col.innerHTML = `
                        <div class="position-relative">
                            <img src="${event.target.result}" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
                            <small class="d-block mt-1 text-muted">${file.name}</small>
                        </div>
                    `;
                    preview.appendChild(col);
                };
                reader.readAsDataURL(file);
            });

            if (this.files.length > 10) {
                alert('Mрximo de 10 imagens permitidas. Apenas as primeiras 10 serсo usadas.');
            }
        });
    </script>
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Details.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.ListVeiculoViewModel
@{
    ViewData["Title"] = "Detalhes do Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@Model.Titulo</h5>
                    @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                    {
                        <span class="badge bg-success">Ativo</span>
                    }
                    else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                    {
                        <span class="badge bg-danger">Vendido</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">@Model.Estado</span>
                    }
                </div>

                <div class="card-body">
                    <!-- Imagem Principal -->
                    <div class="mb-4">
                        @if (!string.IsNullOrEmpty(Model.ImagemPrincipal))
                        {
                            <img src="/images/veiculos/@Model.ImagemPrincipal" alt="@Model.Titulo" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px;" />
                        }
                        else
                        {
                            <div style="width: 100%; height: 400px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999; font-size: 1.2rem;">Sem imagem</span>
                            </div>
                        }
                    </div>

                    <!-- Informaушes Principais -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Marca/Modelo</h6>
                            <h5>@Model.Marca @Model.Modelo</h5>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Preуo</h6>
                            <h5 class="text-primary fw-bold">ђ@Model.Preco.ToString("F2")</h5>
                        </div>
                    </div>

                    <hr />

                    <!-- Especificaушes -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <h6 class="text-muted">Ano</h6>
                            <p class="fw-bold">@Model.Ano</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Quilзmetros</h6>
                            <p class="fw-bold">@Model.Km.ToString("N0") km</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Combustьvel</h6>
                            <p class="fw-bold">@Model.Combustivel</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <h6 class="text-muted">Caixa</h6>
                            <p class="fw-bold">@Model.Caixa</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Categoria</h6>
                            <p class="fw-bold">@Model.CategoriaNome</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted">Condiусo</h6>
                            <p class="fw-bold">@(string.IsNullOrEmpty(Model.Condicao) ? "N/A" : Model.Condicao)</p>
                        </div>
                    </div>

                    <hr />

                    <!-- Informaушes de Publicaусo -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Data de Publicaусo</h6>
                            <p class="fw-bold">@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Estado</h6>
                            <p class="fw-bold">
                                @if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success">@Model.Estado</span>
                                }
                                else if (Model.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger">@Model.Estado</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">@Model.Estado</span>
                                }
                            </p>
                        </div>
                    </div>

                    <!-- Descriусo -->
                    <div class="mb-4">
                        <h6 class="text-muted">Descriусo</h6>
                        <p>@Model.Descricao</p>
                    </div>

                    <hr />

                    <!-- Botшes de Aусo -->
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("Edit", "Veiculos", new { area = "Vendedores", id = Model.Id })" class="btn btn-warning btn-lg">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="@Url.Action("Delete", "Veiculos", new { area = "Vendedores", id = Model.Id })" class="btn btn-danger btn-lg">
                            <i class="bi bi-trash"></i> Eliminar
                        </a>
                        <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</file>

<file path="Areas/Vendedores/Views/Veiculos/Edit.cshtml">
@model AutoMarket.Models.ViewModels.Veiculos.EditVeiculoViewModel
@{
    ViewData["Title"] = "Editar Veьculo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h3 mb-4">Editar Veьculo</h1>

            <form asp-action="Edit" asp-controller="Veiculos" asp-area="Vendedores" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="Id" />

                <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                <!-- Seусo 1: Informaушes Bрsicas -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Informaушes Bрsicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label">Tьtulo do AnЩncio *</label>
                            <input asp-for="Titulo" class="form-control" required />
                            <span asp-validation-for="Titulo" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Marca" class="form-label">Marca *</label>
                                <input asp-for="Marca" class="form-control" required />
                                <span asp-validation-for="Marca" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Modelo" class="form-label">Modelo *</label>
                                <input asp-for="Modelo" class="form-control" required />
                                <span asp-validation-for="Modelo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Ano" class="form-label">Ano *</label>
                                <input asp-for="Ano" type="number" class="form-control" required />
                                <span asp-validation-for="Ano" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CategoriaId" class="form-label">Tipo/Segmento *</label>
                                <select asp-for="CategoriaId" class="form-select" required>
                                    <option value="">-- Selecione uma categoria --</option>
                                    @if (Model.CategoriesDropdown.Any())
                                    {
                                        @foreach (var cat in Model.CategoriesDropdown)
                                        {
                                            <option value="@cat.Id" selected="@(cat.Id == Model.CategoriaId)">@cat.Nome</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CategoriaId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 2: Especificaушes Tжcnicas -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Especificaушes Tжcnicas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Combustivel" class="form-label">Combustьvel *</label>
                                <select asp-for="Combustivel" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Gasolina" selected="@(Model.Combustivel == "Gasolina")">Gasolina</option>
                                    <option value="Gasзleo" selected="@(Model.Combustivel == "Gasзleo")">Gasзleo</option>
                                    <option value="Hьbrido" selected="@(Model.Combustivel == "Hьbrido")">Hьbrido</option>
                                    <option value="Elжtrico" selected="@(Model.Combustivel == "Elжtrico")">Elжtrico</option>
                                    <option value="GLP" selected="@(Model.Combustivel == "GLP")">GLP</option>
                                </select>
                                <span asp-validation-for="Combustivel" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Caixa" class="form-label">Caixa *</label>
                                <select asp-for="Caixa" class="form-select" required>
                                    <option value="">-- Selecione --</option>
                                    <option value="Manual" selected="@(Model.Caixa == "Manual")">Manual</option>
                                    <option value="Automрtica" selected="@(Model.Caixa == "Automрtica")">Automрtica</option>
                                    <option value="CVT" selected="@(Model.Caixa == "CVT")">CVT</option>
                                </select>
                                <span asp-validation-for="Caixa" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Km" class="form-label">Quilзmetros</label>
                                <input asp-for="Km" type="number" class="form-control" />
                                <span asp-validation-for="Km" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Condicao" class="form-label">Condiусo</label>
                                <input asp-for="Condicao" class="form-control" />
                                <span asp-validation-for="Condicao" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Preco" class="form-label">Preуo (ђ) *</label>
                                <input asp-for="Preco" type="number" step="0.01" class="form-control" required />
                                <span asp-validation-for="Preco" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seусo 3: Localizaусo e Descriусo -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Localizaусo e Descriусo</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Localizacao" class="form-label">Localizaусo *</label>
                            <input asp-for="Localizacao" class="form-control" required />
                            <span asp-validation-for="Localizacao" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Descricao" class="form-label">Descriусo Detalhada *</label>
                            <textarea asp-for="Descricao" class="form-control" rows="5" required></textarea>
                            <small class="form-text text-muted">Mрximo 2000 caracteres</small>
                            <span asp-validation-for="Descricao" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Seусo 4: Fotos -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Fotos (Mрximo 10 imagens)</h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.ImagemPrincipalAtual))
                        {
                            <div class="alert alert-info mb-3">
                                <strong>Imagem Atual:</strong>
                                <br />
                                <img src="/images/veiculos/@Model.ImagemPrincipalAtual" alt="Imagem atual" style="max-width: 200px; height: auto; border-radius: 4px; margin-top: 10px;" />
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="Fotos" class="form-label">Adicionar Novas Fotos (Opcional)</label>
                            <input asp-for="Fotos" type="file" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple />
                            <small class="form-text text-muted">
                                Formatos: JPG, JPEG, PNG, WebP | Mрximo 10 imagens | Mрximo 5 MB por imagem
                            </small>
                            <span asp-validation-for="Fotos" class="text-danger"></span>
                        </div>

                        <div id="preview" class="row mt-3"></div>
                    </div>
                </div>

                <!-- Botшes -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-warning btn-lg">
                        <i class="bi bi-pencil"></i> Atualizar Veьculo
                    </button>
                    <a href="@Url.Action("Index", "Veiculos", new { area = "Vendedores" })" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const preview = document.getElementById('preview');
                preview.innerHTML = '';
                
                Array.from(this.files).slice(0, 10).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${event.target.result}" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
                                <small class="d-block mt-1 text-muted">${file.name}</small>
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });

                if (this.files.length > 10) {
                    alert('Mрximo de 10 imagens permitidas. Apenas as primeiras 10 serсo usadas.');
                }
            });
        }
    </script>
}
</file>

<file path="Areas/Vendedores/Views/Veiculos/Index.cshtml">
@model List<AutoMarket.Models.ViewModels.Veiculos.ListVeiculoViewModel>
@{
    ViewData["Title"] = "Os Meus Veículos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="h3">Os Meus Veículos</h1>
        </div>
        <div class="col-md-6 text-end">
            <a href="@Url.Action("Create", "Veiculos", new { area = "Vendedores" })" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Criar Novo Veículo
            </a>
        </div>
    </div>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Imagem</th>
                        <th>Título</th>
                        <th>Marca/Modelo</th>
                        <th>Preço</th>
                        <th>KM</th>
                        <th>Ano</th>
                        <th>Estado</th>
                        <th>Publicado</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var veiculo in Model)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(veiculo.ImagemPrincipal))
                                {
                                    <img src="/images/veiculos/@veiculo.ImagemPrincipal" alt="@veiculo.Titulo" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" />
                                }
                                else
                                {
                                    <div style="width: 60px; height: 60px; background: #e0e0e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #999;">
                                        Sem imagem
                                    </div>
                                }
                            </td>
                            <td>
                                <strong>@veiculo.Titulo</strong>
                            </td>
                            <td>
                                @veiculo.Marca @veiculo.Modelo
                            </td>
                            <td>
                                <span class="text-primary fw-bold">€@veiculo.Preco.ToString("F2")</span>
                            </td>
                            <td>
                                @veiculo.Km.ToString("N0") km
                            </td>
                            <td>
                                @veiculo.Ano
                            </td>
                            <td>
                                @if (veiculo.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Ativo)
                                {
                                    <span class="badge bg-success">Ativo</span>
                                }
                                else if (veiculo.Estado == AutoMarket.Models.Enums.EstadoVeiculo.Vendido)
                                {
                                    <span class="badge bg-danger">Vendido</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">@veiculo.Estado</span>
                                }
                            </td>
                            <td>
                                <small class="text-muted">@veiculo.DataCriacao.ToString("dd/MM/yyyy")</small>
                            </td>
                            <td class="text-center">
                                <a href="@Url.Action("Details", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-info" title="Ver Detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="@Url.Action("Edit", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-warning" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="@Url.Action("Delete", "Veiculos", new { area = "Vendedores", id = veiculo.Id })" class="btn btn-sm btn-danger" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <h5>Nenhum veículo encontrado</h5>
            <p class="mb-3">Ainda não tem veículos publicados. Comece criando o seu primeiro anúncio!</p>
            <a href="@Url.Action("Create", "Veiculos", new { area = "Vendedores" })" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Criar Primeiro Veículo
            </a>
        </div>
    }
</div>
</file>

<file path="AutoMarket.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9 d17.14
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "AutoMarket", "AutoMarket.csproj", "{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{734FFC5B-3D81-4DFF-9C7C-97B4350DAA1A}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {0AF442B4-A056-4BE9-88F5-F25246B9EF62}
	EndGlobalSection
EndGlobal
</file>

<file path="GlobalUsings.cs">
global using System;
global using System.Collections.Generic;
global using System.Linq;
global using System.Threading.Tasks;
global using Microsoft.AspNetCore.Mvc;
global using Microsoft.AspNetCore.Authorization;
global using Microsoft.Extensions.Logging;
global using AutoMarket.Models.DTOs;
global using AutoMarket.Models.Enums;
global using AutoMarket.Models.Entities;
global using AutoMarket.Services.Interfaces;
</file>

<file path="Infrastructure/Data/CustomUserStore.cs">
using AutoMarket.Models.Entities;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Infrastructure.Data
{
    /// <summary>
    /// UserStore customizado que filtra utilizadores deletados (soft delete) em todas as operações do Identity.
    /// </summary>
    public class CustomUserStore : UserStore<Utilizador>
    {
        public CustomUserStore(ApplicationDbContext context, IdentityErrorDescriber? describer = null)
            : base(context, describer)
        {
        }

        public override async Task<Utilizador?> FindByIdAsync(string userId, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.Id == userId, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override async Task<Utilizador?> FindByNameAsync(string normalizedUserName, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.NormalizedUserName == normalizedUserName, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override async Task<Utilizador?> FindByEmailAsync(string normalizedEmail, CancellationToken cancellationToken = default)
        {
            // IgnoreQueryFilters para contornar o filtro global e depois verificar manualmente
            var user = await Context.Set<Utilizador>()
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.NormalizedEmail == normalizedEmail, cancellationToken);
            return user != null && !user.IsDeleted ? user : null;
        }

        public override IQueryable<Utilizador> Users => base.Users.Where(u => !u.IsDeleted);
    }
}
</file>

<file path="Infrastructure/Data/DbInitializer.cs">
using AutoMarket.Models.Constants;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Infrastructure.Data
{
    public static class DbInitializer
    {
        public static async Task InitializeAsync(IServiceProvider serviceProvider)
        {
            var roleManager = serviceProvider.GetRequiredService<RoleManager<IdentityRole>>();
            var userManager = serviceProvider.GetRequiredService<UserManager<Utilizador>>();
            var context = serviceProvider.GetRequiredService<ApplicationDbContext>();
            var configuration = serviceProvider.GetRequiredService<IConfiguration>();
            var environment = serviceProvider.GetRequiredService<IHostEnvironment>();

            // 1. Roles
            string[] roles = { Roles.Admin, Roles.Vendedor, Roles.Comprador };
            foreach (var role in roles)
            {
                if (!await roleManager.RoleExistsAsync(role))
                {
                    await roleManager.CreateAsync(new IdentityRole(role));
                }
            }

            // 2. Default Admin
            var adminEmail = configuration["DefaultAdmin:Email"] ?? "admin@automarket.com";
            var adminPwd = configuration["DefaultAdmin:Password"];

            if (string.IsNullOrWhiteSpace(adminPwd))
            {
                // Em produção, falha para obrigar a usar secrets
                if (environment.IsProduction())
                {
                    throw new InvalidOperationException("A password do Admin não está configurada (DefaultAdmin:Password).");
                }
                adminPwd = "Password1231"; // Apenas para dev/local
            }

            var adminUser = await EnsureUserAsync(userManager, adminEmail, adminPwd, "Administrador Sistema", Roles.Admin);

            if (environment.IsDevelopment())
            {
                // 3. Comprador Teste
                var compradorUser = await EnsureUserAsync(userManager, "comprador@automarket.com", "Password123!", "Comprador Exemplo", Roles.Comprador);
                if (compradorUser != null)
                {
                    if (!await context.Compradores.AnyAsync(c => c.UserId == compradorUser.Id))
                    {
                        context.Compradores.Add(new Comprador
                        {
                            UserId = compradorUser.Id,
                            ReceberNotificacoes = true
                        });
                        await context.SaveChangesAsync();
                    }
                }

                // 4. Vendedor Particular (Aprovado)
                var vendedorPartUser = await EnsureUserAsync(userManager, "vendedor_part@automarket.com", "Password123!", "Vendedor Particular", Roles.Vendedor);
                if (vendedorPartUser != null)
                {
                    if (!await context.Vendedores.AnyAsync(v => v.UserId == vendedorPartUser.Id))
                    {
                        context.Vendedores.Add(new Vendedor
                        {
                            UserId = vendedorPartUser.Id,
                            TipoConta = TipoConta.Vendedor,
                            Status = StatusAprovacao.Aprovado,
                            ApprovedByAdminId = adminUser?.Id 
                        });
                        await context.SaveChangesAsync();
                    }
                }

                // 5. Vendedor Empresa (Aprovado)
                var vendedorEmpUser = await EnsureUserAsync(userManager, "vendedor_emp@automarket.com", "Password123!", "Stand AutoMarket Lda", Roles.Vendedor);
                if (vendedorEmpUser != null)
                {
                    if (!await context.Vendedores.AnyAsync(v => v.UserId == vendedorEmpUser.Id))
                    {
                        context.Vendedores.Add(new Vendedor
                        {
                            UserId = vendedorEmpUser.Id,
                            TipoConta = TipoConta.Empresa,
                            Status = StatusAprovacao.Aprovado,
                            ApprovedByAdminId = adminUser?.Id
                        });
                        await context.SaveChangesAsync();
                    }
                }
            }
        }

        private static async Task<Utilizador?> EnsureUserAsync(UserManager<Utilizador> userManager, string email, string password, string nome, string role)
        {
            var user = await userManager.FindByEmailAsync(email);
            if (user == null)
            {
                user = new Utilizador
                {
                    UserName = email,
                    Email = email,
                    Nome = nome,
                    Contacto = "N/A", 
                    EmailConfirmed = true,
                    DataRegisto = DateTime.UtcNow
                };

                var result = await userManager.CreateAsync(user, password);
                if (result.Succeeded)
                {
                    await userManager.AddToRoleAsync(user, role);
                }
                else
                {
                    foreach (var error in result.Errors)
                    {
                        Console.WriteLine($"[DBInitializer] Erro ao criar utilizador {email}: {error.Description}");
                    }
                    return null;
                }
            }
            return user;
        }
    }
}
</file>

<file path="Infrastructure/Security/CustomClaimsPrincipalFactory.cs">
using System.Security.Claims;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Options;
using Microsoft.EntityFrameworkCore;
using AutoMarket.Models.Enums;
using AutoMarket.Models.Entities;
using AutoMarket.Infrastructure.Data;

namespace AutoMarket.Infrastructure.Security
{
    /// <summary>
    /// Factory customizado para adicionar claims específicas do AutoMarket ao ClaimsPrincipal.
    /// Adiciona VendedorId, StatusVendedor e CompradorId para evitar queries repetidas à BD.
    /// </summary>
    public class CustomClaimsPrincipalFactory : UserClaimsPrincipalFactory<Utilizador, IdentityRole>
    {
        private readonly ApplicationDbContext _context;

        public CustomClaimsPrincipalFactory(
            UserManager<Utilizador> userManager,
            RoleManager<IdentityRole> roleManager,
            IOptions<IdentityOptions> optionsAccessor,
            ApplicationDbContext context)
            : base(userManager, roleManager, optionsAccessor)
        {
            _context = context;
        }

        protected override async Task<ClaimsIdentity> GenerateClaimsAsync(Utilizador user)
        {
            var identity = await base.GenerateClaimsAsync(user);

            // 1. Injetar Claim de Vendedor se existir
            var vendedor = await _context.Vendedores
                .AsNoTracking()
                .FirstOrDefaultAsync(v => v.UserId == user.Id);

            if (vendedor != null)
            {
                identity.AddClaim(new Claim("VendedorId", vendedor.Id.ToString()));
                identity.AddClaim(new Claim("StatusVendedor", vendedor.Status.ToString())); // Útil para Policies
            }

            // 2. Injetar Claim de Comprador se existir
            var comprador = await _context.Compradores
                .AsNoTracking()
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador != null)
            {
                identity.AddClaim(new Claim("CompradorId", comprador.Id.ToString()));
            }
            
            // 3. NIF NÃO deve ser adicionado (RGPD compliance)
            // O NIF está encriptado na BD e não deve ser exposto no cookie, mesmo que encriptado.
            // Se necessário, desencriptar apenas quando necessário em operações específicas.

            return identity;
        }
    }
}
</file>

<file path="Infrastructure/Security/NifEncryptionHelper.cs">
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Infrastructure.Security
{
    /// <summary>
    /// Helper estático para acessar o serviço de encriptação do NIF.
    /// Usado pela propriedade NIF em Utilizador para encriptação/desencriptação automática.
    /// </summary>
    public static class NifEncryptionHelper
    {
        private static IEncryptionService? _encryptionService;
        private static readonly object _lock = new object();

        /// <summary>
        /// Inicializa o helper com o serviço de encriptação.
        /// Deve ser chamado no Program.cs durante a configuração.
        /// </summary>
        public static void Initialize(IEncryptionService encryptionService)
        {
            lock (_lock)
            {
                _encryptionService = encryptionService;
            }
        }

        /// <summary>
        /// Encripta o NIF antes de guardar na base de dados.
        /// </summary>
        public static string? EncryptNif(string? nif)
        {
            if (string.IsNullOrEmpty(nif))
                return nif;

            if (_encryptionService == null)
            {
                // Se o serviço não estiver inicializado, retornar sem encriptar
                // (útil durante migrações ou inicialização)
                return nif;
            }

            return _encryptionService.Encrypt(nif);
        }

        /// <summary>
        /// Desencripta o NIF ao ler da base de dados.
        /// </summary>
        public static string? DecryptNif(string? encryptedNif)
        {
            if (string.IsNullOrEmpty(encryptedNif))
                return encryptedNif;

            if (_encryptionService == null)
            {
                // Se o serviço não estiver inicializado, retornar como está
                return encryptedNif;
            }

            // Se não estiver encriptado (dados antigos), retornar como está
            if (!_encryptionService.IsEncrypted(encryptedNif))
                return encryptedNif;

            try
            {
                return _encryptionService.Decrypt(encryptedNif);
            }
            catch
            {
                // Se falhar a desencriptação, retornar como está (pode ser dado antigo)
                return encryptedNif;
            }
        }
    }
}
</file>

<file path="Infrastructure/Security/VendedorAprovadoHandler.cs">
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using AutoMarket.Models.Constants;
using AutoMarket.Infrastructure.Data;

namespace AutoMarket.Infrastructure.Security
{
    public class VendedorAprovadoHandler : AuthorizationHandler<VendedorAprovadoRequirement>
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;

        public VendedorAprovadoHandler(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager)
        {
            _context = context;
            _userManager = userManager;
        }

        protected override async Task HandleRequirementAsync(
            AuthorizationHandlerContext context,
            VendedorAprovadoRequirement requirement)
        {
            var userPrincipal = context.User;

            // 1. Verificar se está logado e se é Vendedor
            if (userPrincipal.Identity?.IsAuthenticated != true || !userPrincipal.IsInRole(Roles.Vendedor))
            {
                // Se não é vendedor, a policy não se aplica (ou falha)
                return;
            }

            // 2. Tentar obter StatusVendedor da claim (otimização - evita query à BD)
            var statusClaim = userPrincipal.FindFirst("StatusVendedor")?.Value;
            StatusAprovacao? status = null;

            if (!string.IsNullOrEmpty(statusClaim) && Enum.TryParse<StatusAprovacao>(statusClaim, out var parsedStatus))
            {
                status = parsedStatus;
            }
            else
            {
                // Fallback: Se a claim não existir, fazer query à BD (compatibilidade)
                var userId = _userManager.GetUserId(userPrincipal);
                if (string.IsNullOrEmpty(userId)) return;

                status = await _context.Vendedores
                    .Where(v => v.UserId == userId)
                    .Select(v => v.Status)
                    .FirstOrDefaultAsync();
            }

            // 3. O momento da verdade
            if (status == StatusAprovacao.Aprovado)
            {
                context.Succeed(requirement); // SUCESSO!
            }
            else
            {
                // Se falhar, podemos redirecionar ou deixar o ASP.NET retornar 403 Forbidden.
                // Dica Pro: Para redirecionar dentro de um Handler é preciso lógica extra,
                // geralmente o 403 é intercetado no Program.cs ou deixa-se falhar.

                // Opção Simples: Apenas não chamamos o Succeed. O sistema assume falha.
            }
        }
    }
}
</file>

<file path="Infrastructure/Security/VendedorAprovadoRequirement.cs">
using Microsoft.AspNetCore.Authorization;

namespace AutoMarket.Infrastructure.Security
{
    // Esta classe é um "marcador" que diz que existe esta regra
    public class VendedorAprovadoRequirement : IAuthorizationRequirement
    {
    }
}
</file>

<file path="Infrastructure/Utils/NifValidator.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Infrastructure.Utils
{
    public static class NifValidator
    {
        public static bool IsValid(string nif)
        {
            if (string.IsNullOrWhiteSpace(nif) || nif.Length != 9 || !long.TryParse(nif, out _))
                return false;

            var total = 0;
            for (var i = 0; i < 8; i++)
            {
                total += int.Parse(nif[i].ToString()) * (9 - i);
            }

            var resto = total % 11;
            var checkDigit = resto < 2 ? 0 : 11 - resto;

            return checkDigit == int.Parse(nif[8].ToString());
        }

        public static bool IsEmpresa(string nif)
        {
            if (!IsValid(nif)) return false;
            char prefix = nif[0];
            // 5: Pessoas Coletivas (Sociedades)
            // 6: Administração Pública
            // 9: Entidades Equiparadas / Irregulares (ex: Condomínios)
            // Nota: Existem outros (70, 71, etc.) mas são casos muito específicos de Heranças/Não Residentes
            return prefix == '5' || prefix == '6' || prefix == '9';
        }

        public static bool IsParticular(string nif)
        {
            if (!IsValid(nif)) return false;
            char prefix = nif[0];
            // 1, 2, 3: Pessoas Singulares (o 3 já está a ser atribuído)
            // 45: Pessoas Singulares Não Residentes (NIF provisório em alguns casos, mas raro ser usado em registo normal)
            return prefix == '1' || prefix == '2' || prefix == '3';
        }
    }
}
</file>

<file path="Infrastructure/Utils/SessionExtensions.cs">
using System.Text.Json;
using Microsoft.AspNetCore.Http;

namespace AutoMarket.Infrastructure.Utils
{
    public static class SessionExtensions
    {
        private static readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true,
            WriteIndented = false
        };

        public static void SetObjectAsJson(this ISession session, string key, object value)
        {
            session.SetString(key, JsonSerializer.Serialize(value, _jsonOptions));
        }

        public static T? GetObjectFromJson<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            if (value == null) return default;

            try
            {
                return JsonSerializer.Deserialize<T>(value, _jsonOptions);
            }
            catch (JsonException)
            {
                // In case of corruption, return default/null to prevent crash
                return default;
            }
        }
    }
}
</file>

<file path="Models/Attributes/NifPortuguesAttribute.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Attributes
{
    public class NifPortuguesAttribute : ValidationAttribute
    {
        protected override ValidationResult IsValid(object value, ValidationContext validationContext)
        {
            // 1. Se for null ou vazio, assumimos Sucesso. 
            // Porquê? Porque a responsabilidade de ser "Obrigatório" é do atributo [Required].
            // Este atributo só valida: "SE tiver dados, eles têm de ser um NIF válido".
            string nif = value as string;
            if (string.IsNullOrWhiteSpace(nif))
            {
                return ValidationResult.Success;
            }

            // 2. Limpar espaços
            nif = nif.Trim();

            // 3. Verifica se tem 9 dígitos e se é numérico
            if (nif.Length != 9 || !long.TryParse(nif, out _))
            {
                return new ValidationResult("O NIF deve conter exatamente 9 dígitos numéricos.");
            }

            // 4. Algoritmo de Validação (Módulo 11)
            // Lógica oficial da Autoridade Tributária
            int total = 0;
            for (int i = 0; i < 8; i++)
            {
                total += int.Parse(nif[i].ToString()) * (9 - i);
            }

            int resto = total % 11;
            int digitoControloCalculado = resto < 2 ? 0 : 11 - resto;
            int digitoControloInformado = int.Parse(nif[8].ToString());

            if (digitoControloCalculado != digitoControloInformado)
            {
                return new ValidationResult("O NIF introduzido é inválido.");
            }

            return ValidationResult.Success;
        }
    }
}
</file>

<file path="Models/Constants/Roles.cs">
namespace AutoMarket.Models.Constants
{
    public static class Roles
    {
        public const string Admin = "Admin";
        public const string Vendedor = "Vendedor";
        public const string Comprador = "Comprador";
    }
}
</file>

<file path="Models/DTOs/AuthDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record RegisterDto(string Email, string Password, string Nome, string Morada, string? Contacto, string? Nif, TipoConta TipoConta);

    public sealed record RegisterResultDto(bool Success, IEnumerable<string> Errors, string? ConfirmationLink);

    public sealed record LoginDto(string Email, string Password, bool RememberMe);

    public sealed record LoginResultDto(bool Success, string? FailureReason, IEnumerable<string> Errors);

    public sealed record ConfirmEmailResultDto(bool Success, IEnumerable<string> Errors);

    public sealed record UpdateNifResultDto(bool Success, IEnumerable<string> Errors);

    public sealed record SoftDeleteResultDto(bool Success, IEnumerable<string> Errors);
}
</file>

<file path="Models/DTOs/VeiculoDto.cs">
namespace AutoMarket.Models.DTOs
{
    public sealed record VeiculoCreateDto(string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado);
    public sealed record VeiculoUpdateDto(string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado);
    public sealed record VeiculoDto(int Id, string Marca, string Modelo, int Ano, decimal Preco, EstadoVeiculo Estado, bool IsDeleted);
    public sealed record VeiculoFiltroDto(string? Marca, string? Modelo, int? AnoMin, int? AnoMax, decimal? PrecoMin, decimal? PrecoMax);
    public sealed record ValidationResultDto(bool IsValid, IEnumerable<string> Errors);
    public sealed record CommandResultDto(bool Success, IEnumerable<string> Errors);
}
</file>

<file path="Models/DTOs/VeiculoSearchFiltersDto.cs">
namespace AutoMarket.Models.DTOs
{
    /// <summary>
    /// DTO para encapsular parâmetros de pesquisa/filtro de veículos.
    /// Reutilizável entre diferentes métodos do controller.
    /// </summary>
    public class VeiculoSearchFiltersDto
    {
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? Combustivel { get; set; }
        public int? Ano { get; set; }
        public string? Categoria { get; set; }
        public decimal? PrecoMin { get; set; }
        public decimal? PrecoMax { get; set; }
        public int? KmMin { get; set; }
        public int? KmMax { get; set; }
        public string Ordenacao { get; set; } = "recente";
        public int Page { get; set; } = 1;
        public int PageSize { get; set; } = 12; // 12 veículos por página

        /// <summary>
        /// Valida se pelo menos um filtro foi aplicado.
        /// </summary>
        public bool HasFilters()
        {
            return !string.IsNullOrEmpty(Marca)
                || !string.IsNullOrEmpty(Modelo)
                || !string.IsNullOrEmpty(Combustivel)
                || Ano.HasValue
                || !string.IsNullOrEmpty(Categoria)
                || PrecoMin.HasValue
                || PrecoMax.HasValue
                || KmMin.HasValue
                || KmMax.HasValue;
        }
    }
}
</file>

<file path="Models/Entities/AuditoriaLog.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Regista todas as aушes administrativas para auditoria.
    /// Imutрvel apзs criaусo (histзrico permanente).
    /// </summary>
    public class AuditoriaLog
    {
        [Key]
        public int Id { get; set; }

        /// <summary>
        /// Identificaусo do administrador que realizou a aусo.
        /// </summary>
        [Required]
        public string AdminId { get; set; } = string.Empty;

        [ForeignKey("AdminId")]
        public Utilizador? Admin { get; set; }

        /// <summary>
        /// Tipo de aусo: "VENDEDOR_APROVADO", "USUARIO_BLOQUEADO", "DENUNCIA_ENCERRADA", etc.
        /// </summary>
        [Required]
        [StringLength(100)]
        public string TipoAcao { get; set; } = string.Empty;

        /// <summary>
        /// Descriусo legьvel da aусo realizada.
        /// </summary>
        [Required]
        [StringLength(500)]
        public string Descricao { get; set; } = string.Empty;

        /// <summary>
        /// ID da entidade afetada (VendedorId, UtilizadorId, DenunciaId, etc.)
        /// </summary>
        [StringLength(450)]
        public string? EntidadeAfetadaId { get; set; }

        /// <summary>
        /// Tipo da entidade: "Utilizador", "Vendedor", "Denuncia", "Veiculo", etc.
        /// </summary>
        [StringLength(100)]
        public string? TipoEntidade { get; set; }

        /// <summary>
        /// Dados antes da mudanуa (JSON serializado para auditoria).
        /// </summary>
        public string? DadosAntigos { get; set; }

        /// <summary>
        /// Dados apзs a mudanуa (JSON serializado).
        /// </summary>
        public string? DadosNovos { get; set; }

        /// <summary>
        /// Endereуo IP da requisiусo.
        /// </summary>
        [StringLength(50)]
        public string? EnderecoIP { get; set; }

        /// <summary>
        /// User-Agent do navegador.
        /// </summary>
        [StringLength(500)]
        public string? UserAgent { get; set; }

        /// <summary>
        /// Timestamp UTC da aусo.
        /// </summary>
        public DateTime DataHora { get; set; } = DateTime.UtcNow;
    }
}
</file>

<file path="Models/Entities/CarrinhoItem.cs">
namespace AutoMarket.Models.Entities
{
    public class CarrinhoItem
    {
        public int VeiculoId { get; set; }
        public string Titulo { get; set; }
        public string Marca { get; set; }
        public string Modelo { get; set; }
        public decimal Preco { get; set; }
        public string? ImagemCapa { get; set; }
    }
}
</file>

<file path="Models/Entities/Categoria.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Entities
{
    public class Categoria
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(50)]
        public string Nome { get; set; } // Ex: "SUV", "Sedan"

        // Relação: Uma categoria tem muitos carros
        public ICollection<Veiculo> Veiculos { get; set; } = new List<Veiculo>();
    }
}
</file>

<file path="Models/Entities/Comprador.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{

	public class Comprador
	{
		[Key]
		public int Id { get; set; }

		// Relação 1:1 com Utilizador
		[Required]
		public string UserId { get; set; } //Foreign Key: coluna na tabela Compradores. Isto liga as tabelas

		[ForeignKey("UserId")]
		public Utilizador User { get; set; } //Navigation Property: não existe coluna na BD. Serve para poder fazer comprador.User.Nome sem ter de fazer uma query manual SQL

		//Dados específicos do Comprador
		public bool ReceberNotificacoes { get; set; }

        // TODO: Histórico de compras do Comprador

        // Lista de carros favoritos do Comprador (Many-to-Many com Car)
        // public ICollection<Car> Favoritos { get; set; }
        // TODO: Implementar a tabela de junção para favoritos?
    }
}
</file>

<file path="Models/Entities/Denuncia.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public enum EstadoDenuncia
    {
        Aberta = 0,
        EmAnalise = 1,
        Encerrada = 2
    }

    public class Denuncia : IValidatableObject
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public string DenuncianteId { get; set; } = string.Empty;

        [ForeignKey("DenuncianteId")]
        public Utilizador? Denunciante { get; set; }

        // Alvos (Opcionais na BD, Obrigatorios na Logica)
        public int? TargetVeiculoId { get; set; }
        public Veiculo? TargetVeiculo { get; set; }

        public string? TargetUserId { get; set; }
        public Utilizador? TargetUser { get; set; }

        [Required(ErrorMessage = "O motivo й obrigatуrio.")]
        [StringLength(500)]
        public string Motivo { get; set; } = string.Empty;

        public EstadoDenuncia Estado { get; set; } = EstadoDenuncia.Aberta;
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        // Gestгo Admin
        public string? DecisaoAdmin { get; set; }

        [StringLength(450)]
        public string? AnalisadoPorAdminId { get; set; }

        [ForeignKey("AnalisadoPorAdminId")]
        public Utilizador? AnalisadoPorAdmin { get; set; }

        // Validaзгo: Garante que escolheu pelo menos um alvo
        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (TargetVeiculoId == null && string.IsNullOrEmpty(TargetUserId))
            {
                yield return new ValidationResult(
                    "Tem de denunciar um Veнculo ou um Utilizador.",
                    new[] { nameof(TargetVeiculoId), nameof(TargetUserId) }
                );
            }
        }
    }
}
</file>

<file path="Models/Entities/Favorito.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Bookmarks de anúncios favoritos para compradores.
    /// Um comprador pode ter múltiplos favoritos.
    /// </summary>
    public class Favorito
    {
        [Key]
        public int Id { get; set; }

        /// <summary>
        /// ID do comprador que fez o bookmark.
        /// </summary>
        public int CompradorId { get; set; }

        [ForeignKey("CompradorId")]
        public Comprador? Comprador { get; set; }

        /// <summary>
        /// ID do veículo favoritado.
        /// </summary>
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo? Veiculo { get; set; }

        /// <summary>
        /// Data de quando foi adicionado aos favoritos.
        /// </summary>
        public DateTime DataAdicao { get; set; } = DateTime.UtcNow;
    }
}
</file>

<file path="Models/Entities/ISoftDelete.cs">
namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Interface para entidades que suportam Soft Delete.
    /// Quando uma entidade implementa esta interface, o ApplicationDbContext
    /// intercepta tentativas de delete físico e converte-as automaticamente
    /// em soft delete (IsDeleted = true).
    /// </summary>
    public interface ISoftDelete
    {
        /// <summary>
        /// Indica se a entidade foi marcada como eliminada (soft delete).
        /// </summary>
        bool IsDeleted { get; set; }
    }
}
</file>

<file path="Models/Entities/Mensagem.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class Mensagem
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(1000)]
        public string Conteudo { get; set; } = string.Empty;

        public DateTime DataEnvio { get; set; } = DateTime.UtcNow;
        public bool Lida { get; set; } = false;

        [Required]
        public string RemetenteId { get; set; } = string.Empty;

        [ForeignKey("RemetenteId")]
        public Utilizador Remetente { get; set; }

        [Required]
        public string DestinatarioId { get; set; } = string.Empty;

        [ForeignKey("DestinatarioId")]
        public Utilizador Destinatario { get; set; }

        // Contexto: Sobre que veículo estão a falar?
        public int? VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo? Veiculo { get; set; }
    }
}
</file>

<file path="Models/Entities/Notificacao.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Notificaушes in-app para utilizadores.
    /// Regista eventos: denЩncias, aprovaушes, mensagens, etc.
    /// </summary>
    public class Notificacao
    {
        [Key]
        public int Id { get; set; }

        /// <summary>
        /// ID do utilizador que recebe a notificaусo.
        /// </summary>
        [Required]
        public string DestinatarioId { get; set; } = string.Empty;

        [ForeignKey("DestinatarioId")]
        public Utilizador? Destinatario { get; set; }

        /// <summary>
        /// Tipo de notificaусo: "DENUNCIA_ABERTA", "VENDEDOR_APROVADO", "RESERVA_CONFIRMADA", etc.
        /// </summary>
        [Required]
        [StringLength(100)]
        public string Tipo { get; set; } = string.Empty;

        /// <summary>
        /// Assunto da notificaусo (resumo).
        /// </summary>
        [Required]
        [StringLength(200)]
        public string Assunto { get; set; } = string.Empty;

        /// <summary>
        /// Corpo da notificaусo (descriусo detalhada).
        /// </summary>
        [Required]
        public string Corpo { get; set; } = string.Empty;

        /// <summary>
        /// Link para a pрgina relacionada (ex: /Admin/Denuncias/5).
        /// </summary>
        [StringLength(500)]
        public string? LinkRelacionado { get; set; }

        /// <summary>
        /// Se a notificaусo foi lida.
        /// </summary>
        public bool Lida { get; set; } = false;

        /// <summary>
        /// Timestamp da notificaусo.
        /// </summary>
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        /// <summary>
        /// ID da entidade relacionada (ex: DenunciaId, VendedorId).
        /// </summary>
        [StringLength(450)]
        public string? EntidadeRelacionadaId { get; set; }

        /// <summary>
        /// Tipo da entidade relacionada.
        /// </summary>
        [StringLength(100)]
        public string? TipoEntidadeRelacionada { get; set; }
    }
}
</file>

<file path="Models/Entities/Transacao.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    public class Transacao
    {
        [Key]
        public int Id { get; set; }

        [Display(Name = "Data da Transação")]
        public DateTime DataTransacao { get; set; } = DateTime.UtcNow;

        [Required]
        [DataType(DataType.Currency)]
        public decimal ValorPago { get; set; }

        public MetodoPagamento Metodo { get; set; }

        // Exemplo: Pendente, Pago, Cancelado
        public EstadoTransacao Estado { get; set; } = EstadoTransacao.Pendente;

        // Snapshot dos dados para fatura (caso o user mude de morada depois)
        public string MoradaEnvioSnapshot { get; set; } = string.Empty;
        public string NifFaturacaoSnapshot { get; set; } = string.Empty;

        // Relações
        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; }

        [Required]
        public int CompradorId { get; set; }

        [ForeignKey("CompradorId")]
        public Comprador Comprador { get; set; }

        [Required]
        public int VendedorId { get; set; }

        [ForeignKey("VendedorId")]
        public Vendedor Vendedor { get; set; }
    }
}
</file>

<file path="Models/Entities/Utilizador.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Attributes;
using Microsoft.AspNetCore.Identity;

namespace AutoMarket.Models.Entities
{
    // Utilizador é a classe base para todos os tipos de utilizadores no sistema
    public class Utilizador : IdentityUser, ISoftDelete
    {
        [Required(ErrorMessage = "O nome é obrigatório.")]
        [MaxLength(100, ErrorMessage = "O nome não pode exceder 100 caracteres.")]
        [Display(Name = "Nome Completo")]
        [PersonalData]
        public string Nome { get; set; } = string.Empty;

        [Required(ErrorMessage = "A morada é obrigatória.")]
        [MaxLength(200, ErrorMessage = "A morada não pode exceder 200 caracteres.")]
        [PersonalData]
        public string Morada { get; set; } = string.Empty;

        [DataType(DataType.Date)]
        [Display(Name = "Data de Registo")]
        public DateTime DataRegisto { get; set; } = DateTime.UtcNow;

        [MaxLength(50, ErrorMessage = "Os contactos não podem exceder 50 caracteres.")]
        [PersonalData]
        public string Contacto { get; set; } = string.Empty;

        [StringLength(9)]
        [NifPortugues(ErrorMessage = "O NIF introduzido não é válido.")]
        [PersonalData]
        public string? NIF { get; set; }
        // POde ser null se o utilizador ainda não tiver preenchido os dados fiscais

        //Campos para o bloqueio administrativo 
        public bool IsBlocked { get; set; } = false;
        public string? BlockReason { get; set; }    

        // soft Delete
        public bool IsDeleted { get; set; } = false;
    }
}
</file>

<file path="Models/Entities/VeiculoImagem.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Modelo que representa uma imagem associada a um veнculo.
    /// Um veнculo pode ter mъltiplas imagens.
    /// </summary>
    public class VeiculoImagem
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(255)]
        public string CaminhoFicheiro { get; set; } // ex: "veiculo_123_guid.jpg"

        [Required]
        [StringLength(50)]
        public string ContentType { get; set; } // ex: "image/jpeg"

        [Display(Name = "Capa")]
        public bool IsCapa { get; set; } = false; // Define se й a foto de capa

        // --- Relaзгo com Veнculo ---
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; }
    }
}
</file>

<file path="Models/Entities/Vendedor.cs">
using AutoMarket.Models.Enums;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    public class Vendedor
    {
        [Key] //o Identity já define propriedades com "Id" no nome como Primary Key mas senior developers preferem explicitar na mesma caso o nome da propriedade seja alterado e serve de documentação
        public int Id { get; set; }

        //Relação 1:1 com Utilizador
        [Required]
        public string UserId { get; set; }

        [ForeignKey("UserId")]
        public Utilizador User { get; set; } = null!;

        [Required] // EF já faz por defeito a propriedade enum como NOT NULL na BD mas é boa prática explicitar
        public TipoConta TipoConta { get; set; }

        //Gestão de Aprovação - usado no backoffice admin  
        public StatusAprovacao Status { get; set; } = StatusAprovacao.Pendente;

        //Registo de quem aprovou (auditoria)
        [StringLength(450)]
        public string? ApprovedByAdminId { get; set; } //ID do admin que aprovou o vendedor

        [ForeignKey("ApprovedByAdminId")]
        public Utilizador? ApprovedByAdmin { get; set; } //Navegação para o admin que aprovou o vendedor

        [StringLength(500)] 
        public string? MotivoRejeicao { get; set; } //Motivo da rejeição, se aplicável

        //Lista de carros que este vendedor tem à venda
        public ICollection<Veiculo> VeiculosAVenda { get; set; } = [];

        // -- Métodos de Domínio (Lógica de negócio) --

        public void Aprovar(string adminId)
        {
            if (Status != StatusAprovacao.Pendente)
                throw new InvalidOperationException($"Apenas vendedores pendentes podem ser aprovados. Estado atual: {Status}");

            Status = StatusAprovacao.Aprovado;
            ApprovedByAdminId = adminId;
            MotivoRejeicao = null; // Limpa o motivo de rejeição se houver
        }

        public void Rejeitar(string adminId, string motivo)
        {
            if (Status != StatusAprovacao.Pendente)
                throw new InvalidOperationException($"Apenas vendedores pendentes podem ser rejeitados.");

            Status = StatusAprovacao.Rejeitado;
            ApprovedByAdminId = adminId;
            MotivoRejeicao = motivo; // Define o motivo da rejeição 
        }

        public void Ressubmeter()
        {
            if (Status != StatusAprovacao.Rejeitado)
                throw new InvalidOperationException($"Apenas vendedores rejeitados podem ser ressubmetidos. Estado atual: {Status}");
            
            Status = StatusAprovacao.Pendente;
            MotivoRejeicao = null; // Limpa o motivo anterior
        }
    }
}
</file>

<file path="Models/Enums/EstadoReserva.cs">
namespace AutoMarket.Models.Enums
{
    /// <summary>
    /// Estados possнveis de uma reserva de veнculo.
    /// </summary>
    public enum EstadoReserva
    {
        /// <summary>Reserva acabou de ser criada, aguardando confirmaзгo do comprador</summary>
        Pendente = 0,

        /// <summary>Reserva confirmada e vбlida atй a data de expiraзгo</summary>
        Confirmada = 1,

        /// <summary>Reserva expirou sem ser confirmada ou finalizada</summary>
        Expirada = 2,

        /// <summary>Reserva foi cancelada pelo comprador ou vendedor</summary>
        Cancelada = 3,

        /// <summary>Reserva foi convertida em transaзгo (compra realizada)</summary>
        Concluida = 4
    }
}
</file>

<file path="Models/Enums/EstadoTransacao.cs">
namespace AutoMarket.Models.Enums
{
    public enum EstadoTransacao
    {
        Pendente = 0,
        Pago = 1,
        Enviado = 2,
        Cancelado = 3
    }
}
</file>

<file path="Models/Enums/EstadoVisita.cs">
namespace AutoMarket.Models.Enums
{
    /// <summary>
    /// Estados possнveis de uma visita agendada.
    /// </summary>
    public enum EstadoVisita
    {
        /// <summary>Visita agendada, aguardando confirmaзгo</summary>
        Pendente = 0,

        /// <summary>Visita confirmada pelo vendedor</summary>
        Confirmada = 1,

        /// <summary>Visita foi realizada</summary>
        Realizada = 2,

        /// <summary>Visita foi cancelada</summary>
        Cancelada = 3,

        /// <summary>Visita passou da data agendada sem ser realizada</summary>
        NaoRealizada = 4
    }
}
</file>

<file path="Models/Enums/MetodoPagamento.cs">
namespace AutoMarket.Models.Enums
{
    public enum MetodoPagamento
    {
        CartaoCredito = 0,
        MBWay = 1,
        Transferencia = 2,
        Numerario = 3
    }
}
</file>

<file path="Models/ViewModels/AlterarPasswordViewModel.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    /// <summary>
    /// ViewModel para alteraзгo de password do utilizador
    /// </summary>
    public class AlterarPasswordViewModel
    {
        [Required(ErrorMessage = "A password atual й obrigatуria.")]
        [DataType(DataType.Password)]
        [Display(Name = "Password Atual")]
        public string PasswordAtual { get; set; } = string.Empty;

        [Required(ErrorMessage = "A nova password й obrigatуria.")]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} caracteres.", MinimumLength = 16)]
        [DataType(DataType.Password)]
        [Display(Name = "Nova Password")]
        public string NovaPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "A confirmaзгo da password й obrigatуria.")]
        [DataType(DataType.Password)]
        [Display(Name = "Confirmar Nova Password")]
        [Compare("NovaPassword", ErrorMessage = "As passwords nгo coincidem.")]
        public string ConfirmarNovaPassword { get; set; } = string.Empty;
    }
}
</file>

<file path="Models/ViewModels/CarrinhoWidgetViewModel.cs">
namespace AutoMarket.Models.ViewModels
{
    public class CarrinhoWidgetViewModel
    {
        public int QuantidadeItens { get; set; }
        public decimal ValorTotal { get; set; }
    }
}
</file>

<file path="Models/ViewModels/EditarPerfilViewModel.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    /// <summary>
    /// ViewModel para ediзгo de dados pessoais do perfil do utilizador
    /// </summary>
    public class EditarPerfilViewModel
    {
        [Required(ErrorMessage = "O nome й obrigatуrio.")]
        [StringLength(100, ErrorMessage = "O nome nгo pode exceder 100 caracteres.")]
        [Display(Name = "Nome Completo")]
        public string Nome { get; set; } = string.Empty;

        [Required(ErrorMessage = "A morada й obrigatуria.")]
        [StringLength(200, ErrorMessage = "A morada nгo pode exceder 200 caracteres.")]
        [Display(Name = "Morada")]
        public string Morada { get; set; } = string.Empty;

        [Required(ErrorMessage = "O contacto й obrigatуrio.")]
        [Phone(ErrorMessage = "Contacto invбlido.")]
        [StringLength(50, ErrorMessage = "O contacto nгo pode exceder 50 caracteres.")]
        [Display(Name = "Contacto")]
        public string Contacto { get; set; } = string.Empty;

        [StringLength(9, MinimumLength = 9, ErrorMessage = "O NIF deve ter 9 dнgitos.")]
        [Display(Name = "NIF (Nъmero de Identificaзгo Fiscal)")]
        public string? NIF { get; set; }

        [Display(Name = "Email")]
        public string Email { get; set; } = string.Empty; // Read-only (nгo pode alterar email)

        [Display(Name = "Data de Registo")]
        public DateTime DataRegisto { get; set; }
    }
}
</file>

<file path="Models/ViewModels/TransacaoListViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels
{
    /// <summary>
    /// ViewModel para exibir transaушes (compras ou vendas) numa lista
    /// </summary>
    public class TransacaoListViewModel
    {
        public int TransacaoId { get; set; }

        [Display(Name = "Data")]
        [DataType(DataType.Date)]
        public DateTime DataTransacao { get; set; }

        [Display(Name = "Valor Pago")]
        [DataType(DataType.Currency)]
        public decimal ValorPago { get; set; }

        [Display(Name = "Estado")]
        public EstadoTransacao Estado { get; set; }

        [Display(Name = "Mжtodo de Pagamento")]
        public MetodoPagamento Metodo { get; set; }

        // Dados do Veьculo
        public int VeiculoId { get; set; }

        [Display(Name = "Veьculo")]
        public string VeiculoTitulo { get; set; } = string.Empty;

        public string VeiculoMarca { get; set; } = string.Empty;
        public string VeiculoModelo { get; set; } = string.Empty;

        [Display(Name = "Imagem")]
        public string? VeiculoImagemCapa { get; set; }

        // Para Compras: Dados do Vendedor
        [Display(Name = "Vendedor")]
        public string? VendedorNome { get; set; }

        // Para Vendas: Dados do Comprador
        [Display(Name = "Comprador")]
        public string? CompradorNome { get; set; }

        // Snapshots para referЖncia
        public string? MoradaEnvioSnapshot { get; set; }
        public string? NifFaturacaoSnapshot { get; set; }
    }
}
</file>

<file path="repomix.config.json">
{
  "$schema": "https://repomix.com/schemas/latest/schema.json",
  "input": {
    "maxFileSize": 52428800
  },
  "output": {
    "filePath": "repomix-output.xml",
    "style": "xml",
    "parsableStyle": false,
    "fileSummary": true,
    "directoryStructure": true,
    "files": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "compress": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "truncateBase64": false,
    "copyToClipboard": false,
    "includeFullDirectoryStructure": false,
    "tokenCountTree": false,
    "git": {
      "sortByChanges": true,
      "sortByChangesMaxCommits": 100,
      "includeDiffs": false,
      "includeLogs": false,
      "includeLogsCount": 50
    }
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDotIgnore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "o200k_base"
  }
}
</file>

<file path="Resources/EmailResources.resx">
<?xml version="1.0" encoding="utf-8"?>
<root>
  <!-- 
    Microsoft ResX Schema 
    
    Version 2.0
    
    The primary goals of this format is to allow a simple XML format 
    that is mostly human readable. The generation and parsing of the 
    various data types are done through the TypeConverter classes 
    associated with the data types.
    
    Example:
    
    ... ado.net/XML headers & schema ...
    <resheader name="resmimetype">text/microsoft-resx</resheader>
    <resheader name="version">2.0</resheader>
    <resheader name="reader">System.Resources.ResXResourceReader, System.Windows.Forms, ...</resheader>
    <resheader name="writer">System.Resources.ResXResourceWriter, System.Windows.Forms, ...</resheader>
    <data name="Name1"><value>this is my long string</value><comment>this is a comment</comment></data>
    <data name="Color1" type="System.Drawing.Color, System.Drawing">Blue</data>
    <data name="Bitmap1" mimetype="application/x-microsoft.net.object.binary.base64">
        <value>[base64 mime encoded serialized .NET Framework object]</value>
    </data>
    <data name="Icon1" type="System.Drawing.Icon, System.Drawing" mimetype="application/x-microsoft.net.object.bytearray.base64">
        <value>[base64 mime encoded string representing a byte array form of the .NET Framework object]</value>
        <comment>This is a comment</comment>
    </data>
                
    There are any number of "resheader" rows that contain simple 
    name/value pairs.
    
    Each data row contains a name, and value. The row also contains a 
    type or mimetype. Type corresponds to a .NET class that support 
    text/value conversion through the TypeConverter architecture. 
    Classes that don't support this are serialized and stored with the 
    mimetype set.
    
    The mimetype is used for serialized objects, and tells the 
    ResXResourceReader how to depersist the object. This is currently not 
    extensible. For a given mimetype the value must be set accordingly:
    
    Note - application/x-microsoft.net.object.binary.base64 is the format 
    that the ResXResourceWriter will generate, however the reader can 
    read any of the formats listed below.
    
    mimetype: application/x-microsoft.net.object.binary.base64
    value   : The object must be serialized with 
            : System.Runtime.Serialization.Formatters.Binary.BinaryFormatter
            : and then encoded with base64 encoding.
    
    mimetype: application/x-microsoft.net.object.soap.base64
    value   : The object must be serialized with 
            : System.Runtime.Serialization.Formatters.Soap.SoapFormatter
            : and then encoded with base64 encoding.

    mimetype: application/x-microsoft.net.object.bytearray.base64
    value   : The object must be serialized into a byte array 
            : using a System.ComponentModel.TypeConverter
            : and then encoded with base64 encoding.
    -->
  <xsd:schema id="root" xmlns="" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:msdata="urn:schemas-microsoft-com:xml-msdata">
    <xsd:import namespace="http://www.w3.org/XML/1998/namespace" />
    <xsd:element name="root" msdata:IsDataSet="true">
      <xsd:complexType>
        <xsd:choice maxOccurs="unbounded">
          <xsd:element name="metadata">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" />
              </xsd:sequence>
              <xsd:attribute name="name" use="required" type="xsd:string" />
              <xsd:attribute name="type" type="xsd:string" />
              <xsd:attribute name="mimetype" type="xsd:string" />
              <xsd:attribute ref="xml:space" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="assembly">
            <xsd:complexType>
              <xsd:attribute name="alias" type="xsd:string" />
              <xsd:attribute name="name" type="xsd:string" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="data">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" msdata:Ordinal="1" />
                <xsd:element name="comment" type="xsd:string" minOccurs="0" msdata:Ordinal="2" />
              </xsd:sequence>
              <xsd:attribute name="name" type="xsd:string" use="required" msdata:Ordinal="1" />
              <xsd:attribute name="type" type="xsd:string" msdata:Ordinal="3" />
              <xsd:attribute name="mimetype" type="xsd:string" msdata:Ordinal="4" />
              <xsd:attribute ref="xml:space" />
            </xsd:complexType>
          </xsd:element>
          <xsd:element name="resheader">
            <xsd:complexType>
              <xsd:sequence>
                <xsd:element name="value" type="xsd:string" minOccurs="0" msdata:Ordinal="1" />
              </xsd:sequence>
              <xsd:attribute name="name" type="xsd:string" use="required" />
            </xsd:complexType>
          </xsd:element>
        </xsd:choice>
      </xsd:complexType>
    </xsd:element>
  </xsd:schema>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>2.0</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="Email_Welcome_Header" xml:space="preserve">
    <value>Bem-vindo ao AutoMarket!</value>
  </data>
  <data name="Email_Greeting" xml:space="preserve">
    <value>Olá {0},</value>
  </data>
  <data name="Email_Confirmation_Intro" xml:space="preserve">
    <value>Obrigado por se registar no AutoMarket. Para completar o seu registo, por favor confirme o seu endereço de email clicando no botão abaixo:</value>
  </data>
  <data name="Email_Confirm_Button" xml:space="preserve">
    <value>Confirmar Email</value>
  </data>
  <data name="Email_Link_Alternative" xml:space="preserve">
    <value>Ou copie e cole o seguinte link no seu navegador:</value>
  </data>
  <data name="Email_Link_Expiry" xml:space="preserve">
    <value>Este link expirará em 24 horas.</value>
  </data>
  <data name="Email_Ignore_Message" xml:space="preserve">
    <value>Se não criou uma conta no AutoMarket, pode ignorar este email.</value>
  </data>
  <data name="Email_Footer_Copyright" xml:space="preserve">
    <value>AutoMarket &amp;copy; 2025</value>
  </data>
</root>
</file>

<file path="Services/Implementations/AuditoriaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaзгo do serviзo de auditoria.
    /// </summary>
    public class AuditoriaService : IAuditoriaService
    {
        private readonly ApplicationDbContext _context;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly ILogger<AuditoriaService> _logger;

        public AuditoriaService(
            ApplicationDbContext context,
            IHttpContextAccessor httpContextAccessor,
            ILogger<AuditoriaService> logger)
        {
            _context = context;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
        }

        public async Task RegistarAcaoAsync(
            string adminId,
            string tipoAcao,
            string descricao,
            string? entidadeAfetadaId = null,
            string? tipoEntidade = null,
            string? dadosAntigos = null,
            string? dadosNovos = null,
            string? enderecoIP = null,
            string? userAgent = null)
        {
            try
            {
                // Obter contexto HTTP se nгo fornecido
                var httpContext = _httpContextAccessor.HttpContext;
                enderecoIP ??= httpContext?.Connection.RemoteIpAddress?.ToString();
                userAgent ??= httpContext?.Request.Headers["User-Agent"].ToString();

                var auditoria = new AuditoriaLog
                {
                    AdminId = adminId,
                    TipoAcao = tipoAcao,
                    Descricao = descricao,
                    EntidadeAfetadaId = entidadeAfetadaId,
                    TipoEntidade = tipoEntidade,
                    DadosAntigos = dadosAntigos,
                    DadosNovos = dadosNovos,
                    EnderecoIP = enderecoIP,
                    UserAgent = userAgent,
                    DataHora = DateTime.UtcNow
                };

                _context.AuditoriaLogs.Add(auditoria);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Auditoria registada: {TipoAcao} por {AdminId} em {DataHora}",
                    tipoAcao, adminId, DateTime.UtcNow);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao registar auditoria para {TipoAcao}", tipoAcao);
                // Nгo lanзar exceзгo - auditoria nгo deve bloquear operaзгo principal
            }
        }

        public async Task<List<AuditoriaLog>> ListarLogsAsync(int page = 1, int pageSize = 50)
        {
            return await _context.AuditoriaLogs
                .Include(a => a.Admin)
                .OrderByDescending(a => a.DataHora)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
        }

        public async Task<List<AuditoriaLog>> ListarLogsPorAdminAsync(string adminId, int page = 1, int pageSize = 50)
        {
            return await _context.AuditoriaLogs
                .Where(a => a.AdminId == adminId)
                .OrderByDescending(a => a.DataHora)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
        }
    }
}
</file>

<file path="Services/Implementations/CarrinhoService.cs">
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Implementations
{
    public class CarrinhoService : ICarrinhoService
    {
        private readonly IHttpContextAccessor _httpContextAccessor;
        private const string SessionKey = "CarrinhoCompras";
        private const string DefaultImagePlaceholder = "sem-imagem.jpg";
        // Precisamos do IHttpContextAccessor para aceder à Session fora de um Controller
        public CarrinhoService(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        private ISession Session
        {
            get
            {
                var context = _httpContextAccessor.HttpContext;
                if (context == null)
                {
                    throw new InvalidOperationException("HttpContext is null. Ensure this service is called within an HTTP request context.");
                }
                if (context.Session == null)
                {
                    throw new InvalidOperationException("Session is not available. Ensure that session middleware is configured.");
                }
                return context.Session;
            }
        }

        public List<CarrinhoItem> GetItens()
        {
            return Session.GetObjectFromJson<List<CarrinhoItem>>(SessionKey) ?? new List<CarrinhoItem>();
        }

        public void AdicionarItem(Veiculo veiculo)
        {
            if (veiculo == null) { throw new ArgumentNullException(nameof(veiculo)); }

            var itens = GetItens();

            // Como é um veículo único, verificamos se já lá está
            if (!itens.Any(i => i.VeiculoId == veiculo.Id))
            {
                itens.Add(new CarrinhoItem
                {
                    VeiculoId = veiculo.Id,
                    Titulo = veiculo.Titulo,
                    Marca = veiculo.Marca,
                    Modelo = veiculo.Modelo,
                    Preco = veiculo.Preco,
                    // Pega a primeira imagem ou uma placeholder
                    ImagemCapa = veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro ?? DefaultImagePlaceholder
                });

                Session.SetObjectAsJson(SessionKey, itens);
            }
        }

        public void RemoverItem(int veiculoId)
        {
            var itens = GetItens();
            var item = itens.FirstOrDefault(i => i.VeiculoId == veiculoId);

            if (item != null)
            {
                itens.Remove(item);
                Session.SetObjectAsJson(SessionKey, itens);
            }
        }

        public void LimparCarrinho()
        {
            Session.Remove(SessionKey);
        }

        public decimal GetTotal()
        {
            return GetItens().Sum(i => i.Preco);
        }

        public int GetContagem()
        {
            return GetItens().Count;
        }
    }
}
</file>

<file path="Services/Implementations/DenunciaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;
using System.Text.Json;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaзгo do serviзo de denъncias.
    /// Gerencia workflow completo de denъncias com auditoria.
    /// </summary>
    public class DenunciaService : IDenunciaService
    {
        private readonly ApplicationDbContext _context;
        private readonly IAuditoriaService _auditoriaService;
        private readonly INotificacaoService _notificacaoService;
        private readonly ILogger<DenunciaService> _logger;

        public DenunciaService(
            ApplicationDbContext context,
            IAuditoriaService auditoriaService,
            INotificacaoService notificacaoService,
            ILogger<DenunciaService> logger)
        {
            _context = context;
            _auditoriaService = auditoriaService;
            _notificacaoService = notificacaoService;
            _logger = logger;
        }

        public async Task<Denuncia> CriarDenunciaAsync(
            string denuncianteId,
            int? veiculoId = null,
            string? targetUserId = null,
            string motivo = "")
        {
            // Validaзгo: deve ter alvo (veнculo ou utilizador)
            if (!veiculoId.HasValue && string.IsNullOrEmpty(targetUserId))
            {
                throw new ArgumentException("Denъncia deve ter um alvo: veнculo ou utilizador.");
            }

            var denuncia = new Denuncia
            {
                DenuncianteId = denuncianteId,
                TargetVeiculoId = veiculoId,
                TargetUserId = targetUserId,
                Motivo = motivo,
                Estado = EstadoDenuncia.Aberta,
                DataCriacao = DateTime.UtcNow
            };

            _context.Denuncias.Add(denuncia);
            await _context.SaveChangesAsync();

            _logger.LogInformation(
                "Denъncia #{DenunciaId} criada pelo utilizador {DenuncianteId}",
                denuncia.Id, denuncianteId);

            // Notificar admin (todos com role Admin)
            await _notificacaoService.NotificarAdminsAsync(
                tipo: "DENUNCIA_ABERTA",
                assunto: $"Nova Denъncia #{denuncia.Id}",
                corpo: $"Denъncia contra {(veiculoId.HasValue ? "veнculo" : "utilizador")} recebida.",
                linkRelacionado: $"/Admin/Denuncias/{denuncia.Id}",
                entidadeRelacionadaId: denuncia.Id.ToString(),
                tipoEntidadeRelacionada: "Denuncia");

            return denuncia;
        }

        public async Task<Denuncia?> ObterDenunciaAsync(int denunciaId)
        {
            return await _context.Denuncias
                .Include(d => d.Denunciante)
                .Include(d => d.TargetVeiculo)
                    .ThenInclude(v => v!.Vendedor)
                        .ThenInclude(vnd => vnd.User)
                .Include(d => d.TargetUser)
                .Include(d => d.AnalisadoPorAdmin)
                .FirstOrDefaultAsync(d => d.Id == denunciaId);
        }

        public async Task<List<Denuncia>> ListarDenunciasAsync(
            string? estado = null,
            int page = 1,
            int pageSize = 20)
        {
            var query = _context.Denuncias
                .Include(d => d.Denunciante)
                .Include(d => d.TargetVeiculo)
                .Include(d => d.TargetUser)
                .Include(d => d.AnalisadoPorAdmin)
                .OrderByDescending(d => d.DataCriacao)
                .AsQueryable();

            // Filtrar por estado se fornecido
            if (!string.IsNullOrEmpty(estado) && Enum.TryParse<EstadoDenuncia>(estado, true, out var estadoParsed))
            {
                query = query.Where(d => d.Estado == estadoParsed);
            }

            return await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
        }

        public async Task<bool> IniciarAnaliseAsync(int denunciaId, string adminId)
        {
            var denuncia = await _context.Denuncias.FirstOrDefaultAsync(d => d.Id == denunciaId);
            if (denuncia == null)
            {
                _logger.LogWarning("Tentativa de analisar denъncia inexistente #{DenunciaId}", denunciaId);
                return false;
            }

            if (denuncia.Estado != EstadoDenuncia.Aberta)
            {
                _logger.LogWarning(
                    "Tentativa de analisar denъncia #{DenunciaId} em estado {Estado}",
                    denunciaId, denuncia.Estado);
                return false;
            }

            var estadoAnterior = denuncia.Estado.ToString();
            denuncia.Estado = EstadoDenuncia.EmAnalise;
            denuncia.AnalisadoPorAdminId = adminId;

            await _context.SaveChangesAsync();

            // Registar auditoria
            await _auditoriaService.RegistarAcaoAsync(
                adminId,
                "DENUNCIA_ANALISE_INICIADA",
                $"Anбlise de denъncia #{denunciaId} iniciada",
                entidadeAfetadaId: denunciaId.ToString(),
                tipoEntidade: "Denuncia",
                dadosAntigos: JsonSerializer.Serialize(new { Estado = estadoAnterior }),
                dadosNovos: JsonSerializer.Serialize(new { Estado = EstadoDenuncia.EmAnalise.ToString() }));

            _logger.LogInformation(
                "Admin {AdminId} iniciou anбlise de denъncia #{DenunciaId}",
                adminId, denunciaId);

            return true;
        }

        public async Task<bool> EncerrarDenunciaAsync(
            int denunciaId,
            string adminId,
            bool procedente,
            string decisao)
        {
            var denuncia = await _context.Denuncias.FirstOrDefaultAsync(d => d.Id == denunciaId);
            if (denuncia == null)
            {
                _logger.LogWarning("Tentativa de encerrar denъncia inexistente #{DenunciaId}", denunciaId);
                return false;
            }

            if (denuncia.Estado == EstadoDenuncia.Encerrada)
            {
                _logger.LogWarning("Tentativa de encerrar denъncia jб encerrada #{DenunciaId}", denunciaId);
                return false;
            }

            var estadoAnterior = denuncia.Estado.ToString();
            denuncia.Estado = EstadoDenuncia.Encerrada;
            denuncia.AnalisadoPorAdminId = adminId;
            denuncia.DecisaoAdmin = $"{(procedente ? "PROCEDENTE" : "NГO_PROCEDENTE")}: {decisao}";

            await _context.SaveChangesAsync();

            // Registar auditoria
            await _auditoriaService.RegistarAcaoAsync(
                adminId,
                "DENUNCIA_ENCERRADA",
                $"Denъncia #{denunciaId} encerrada como {(procedente ? "PROCEDENTE" : "NГO_PROCEDENTE")}",
                entidadeAfetadaId: denunciaId.ToString(),
                tipoEntidade: "Denuncia",
                dadosAntigos: JsonSerializer.Serialize(new { Estado = estadoAnterior }),
                dadosNovos: JsonSerializer.Serialize(new { Estado = EstadoDenuncia.Encerrada.ToString(), DecisaoAdmin = denuncia.DecisaoAdmin }));

            // Notificar denunciante
            await _notificacaoService.NotificarUtilizadorAsync(
                denuncia.DenuncianteId,
                tipo: "DENUNCIA_ENCERRADA",
                assunto: $"Denъncia #{denunciaId} Encerrada",
                corpo: $"Sua denъncia foi analisada e considerada {(procedente ? "procedente" : "nгo procedente")}.",
                linkRelacionado: $"/Admin/Denuncias/{denunciaId}");

            // Notificar alvo da denъncia (se for utilizador)
            if (!string.IsNullOrEmpty(denuncia.TargetUserId))
            {
                await _notificacaoService.NotificarUtilizadorAsync(
                    denuncia.TargetUserId,
                    tipo: "DENUNCIA_RESULTADO",
                    assunto: $"Resultado de Denъncia contra vocк",
                    corpo: procedente
                        ? "Uma denъncia contra vocк foi considerada procedente. Contacte o suporte."
                        : "Uma denъncia contra vocк foi investigada e considerada nгo procedente.",
                    linkRelacionado: $"/Admin/Denuncias/{denunciaId}");
            }

            _logger.LogInformation(
                "Admin {AdminId} encerrou denъncia #{DenunciaId} como {Resultado}",
                adminId, denunciaId, procedente ? "PROCEDENTE" : "NГO_PROCEDENTE");

            return true;
        }

        public async Task<Dictionary<string, int>> ContarPorEstadoAsync()
        {
            var contagens = await _context.Denuncias
                .GroupBy(d => d.Estado)
                .Select(g => new { Estado = g.Key.ToString(), Count = g.Count() })
                .ToDictionaryAsync(x => x.Estado, x => x.Count);

            return contagens;
        }
    }
}
</file>

<file path="Services/Implementations/EmailFailureTracker.cs">
using System.Collections.Concurrent;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Tracks email sending failures for circuit breaker pattern.
    /// </summary>
    public class EmailFailureTracker
    {
        private readonly ConcurrentDictionary<string, FailureInfo> _failures = new();
        private readonly int _maxFailures;
        private readonly TimeSpan _failureWindow;
        private readonly TimeSpan _circuitBreakerTimeout;

        public EmailFailureTracker(int maxFailures = 5, TimeSpan? failureWindow = null, TimeSpan? circuitBreakerTimeout = null)
        {
            _maxFailures = maxFailures;
            _failureWindow = failureWindow ?? TimeSpan.FromMinutes(5);
            _circuitBreakerTimeout = circuitBreakerTimeout ?? TimeSpan.FromMinutes(1);
        }

        public void RecordFailure()
        {
            var now = DateTime.UtcNow;
            var key = "global"; // Track global failures

            _failures.AddOrUpdate(key,
                new FailureInfo { Count = 1, FirstFailure = now, LastFailure = now, CircuitOpenUntil = null },
                (k, existing) =>
                {
                    // Reset if outside failure window
                    if (now - existing.FirstFailure > _failureWindow)
                    {
                        return new FailureInfo { Count = 1, FirstFailure = now, LastFailure = now, CircuitOpenUntil = null };
                    }

                    var newCount = existing.Count + 1;
                    var circuitOpenUntil = newCount >= _maxFailures 
                        ? now.Add(_circuitBreakerTimeout) 
                        : existing.CircuitOpenUntil;

                    return new FailureInfo
                    {
                        Count = newCount,
                        FirstFailure = existing.FirstFailure,
                        LastFailure = now,
                        CircuitOpenUntil = circuitOpenUntil
                    };
                });
        }

        public void RecordSuccess()
        {
            _failures.TryRemove("global", out _);
        }

        public bool IsCircuitOpen()
        {
            if (!_failures.TryGetValue("global", out var info))
                return false;

            if (info.CircuitOpenUntil == null)
                return false;

            if (DateTime.UtcNow < info.CircuitOpenUntil.Value)
                return true;

            // Circuit breaker timeout expired, reset
            _failures.TryRemove("global", out _);
            return false;
        }

        public int GetFailureCount()
        {
            return _failures.TryGetValue("global", out var info) ? info.Count : 0;
        }

        private class FailureInfo
        {
            public int Count { get; set; }
            public DateTime FirstFailure { get; set; }
            public DateTime LastFailure { get; set; }
            public DateTime? CircuitOpenUntil { get; set; }
        }
    }
}
</file>

<file path="Services/Implementations/EmailSender.cs">
using MailKit.Net.Smtp;
using MailKit.Security;
using MimeKit;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for sending emails using SMTP via MailKit.
    /// </summary>
    public class EmailSender : IEmailSender
    {
        private readonly IConfiguration _configuration;
        private readonly ILogger<EmailSender> _logger;
        private readonly EmailFailureTracker _failureTracker;
        private int _failureCount = 0;

        public EmailSender(IConfiguration configuration, ILogger<EmailSender> logger, EmailFailureTracker failureTracker)
        {
            _configuration = configuration;
            _logger = logger;
            _failureTracker = failureTracker;
        }

        public async Task SendEmailAsync(string to, string subject, string message, CancellationToken cancellationToken = default)
        {
            // Circuit breaker: fail fast if too many recent failures
            if (_failureTracker.IsCircuitOpen())
            {
                _logger.LogWarning("Email circuit breaker is OPEN. Skipping email send to {To}. Total failures: {FailureCount}", 
                    to, _failureTracker.GetFailureCount());
                throw new InvalidOperationException("Email service is temporarily unavailable due to repeated failures. Please try again later.");
            }

            try
            {
                var emailSettings = _configuration.GetSection("EmailSettings");
                var smtpServer = emailSettings["SmtpServer"];
                var smtpPort = emailSettings.GetValue("SmtpPort", 587);
                var smtpUsername = emailSettings["SmtpUsername"];
                var smtpPassword = emailSettings["SmtpPassword"];
                var fromEmail = emailSettings["FromEmail"];
                var fromName = emailSettings["FromName"] ?? "AutoMarket";
                
                // Get SecureSocketOptions from configuration (defaults to StartTls)
                var secureSocketOptionString = emailSettings["SecureSocketOptions"] ?? "StartTls";
                var secureSocketOptions = ParseSecureSocketOptions(secureSocketOptionString);

                // If email settings are not configured, log and return (for development)
                if (string.IsNullOrEmpty(smtpServer) || string.IsNullOrEmpty(smtpUsername) || string.IsNullOrEmpty(smtpPassword) || string.IsNullOrEmpty(fromEmail))
                {
                    _logger.LogWarning("Email settings not configured. Email not sent to {To}. Subject: {Subject}", to, subject);
                    _logger.LogInformation("Email would be sent to: {To}\nSubject: {Subject}\nMessage: {Message}", to, subject, message);
                    return;
                }

                var email = new MimeMessage();
                email.From.Add(new MailboxAddress(fromName, fromEmail));
                email.To.Add(MailboxAddress.Parse(to));
                email.Subject = subject;

                var bodyBuilder = new BodyBuilder
                {
                    HtmlBody = message
                };
                email.Body = bodyBuilder.ToMessageBody();

                using var client = new SmtpClient();
                
                try
                {
                    await client.ConnectAsync(smtpServer, smtpPort, secureSocketOptions, cancellationToken);
                }
                catch (SmtpCommandException ex)
                {
                    _logger.LogError(ex, "SMTP connection error: Failed to connect to {Server}:{Port} with {SecureOption}", smtpServer, smtpPort, secureSocketOptions);
                    RecordFailure();
                    throw new InvalidOperationException($"Failed to connect to SMTP server {smtpServer}:{smtpPort}", ex);
                }
                catch (SmtpProtocolException ex)
                {
                    _logger.LogError(ex, "SMTP protocol error: Failed to connect to {Server}:{Port}", smtpServer, smtpPort);
                    RecordFailure();
                    throw new InvalidOperationException($"SMTP protocol error connecting to {smtpServer}:{smtpPort}", ex);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogWarning("Email connection was cancelled for {To}", to);
                    throw;
                }

                try
                {
                    await client.AuthenticateAsync(smtpUsername, smtpPassword, cancellationToken);
                }
                catch (AuthenticationException ex)
                {
                    _logger.LogError(ex, "SMTP authentication failed on {Server}", smtpServer);
                    RecordFailure();
                    throw new UnauthorizedAccessException($"SMTP authentication failed for {smtpServer}", ex);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogWarning("Email authentication was cancelled for {To}", to);
                    throw;
                }
                
                try
                {
                    await client.SendAsync(email, cancellationToken);
                    _logger.LogInformation("Email sent successfully to {To}", to);
                    _failureTracker.RecordSuccess();
                    _failureCount = 0;
                }
                catch (SmtpCommandException ex)
                {
                    _logger.LogError(ex, "SMTP send error: Failed to send email to {To}", to);
                    RecordFailure();
                    throw new InvalidOperationException($"Failed to send email to {to}", ex);
                }
                finally
                {
                    if (client.IsConnected)
                    {
                        await client.DisconnectAsync(true, cancellationToken);
                    }
                }
            }
            catch (OperationCanceledException)
            {
                _logger.LogWarning("Email send operation was cancelled for {To}", to);
                throw;
            }
            catch (InvalidOperationException ex)
            {
                _logger.LogError(ex, "Email send failed for {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                throw;
            }
            catch (UnauthorizedAccessException ex)
            {
                _logger.LogError(ex, "Email authentication failed for {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                throw;
            }
            catch (Exception ex)
            {
                RecordFailure();
                _logger.LogError(ex, "Unexpected error sending email to {To}. Failure count: {FailureCount}", to, _failureTracker.GetFailureCount());
                // Don't throw unexpected errors - we don't want email failures to break user registration
                // In production, you might want to queue the email for retry
            }
        }

        private void RecordFailure()
        {
            _failureTracker.RecordFailure();
            Interlocked.Increment(ref _failureCount);
        }

        /// <summary>
        /// Gets the current failure count for monitoring/metrics.
        /// </summary>
        public int GetFailureCount() => _failureCount;

        private static SecureSocketOptions ParseSecureSocketOptions(string value)
        {
            return value.ToLowerInvariant() switch
            {
                "none" => SecureSocketOptions.None,
                "automatic" => SecureSocketOptions.Auto,
                "starttls" => SecureSocketOptions.StartTls,
                "starttlswhenavailable" => SecureSocketOptions.StartTlsWhenAvailable,
                "ssl" => SecureSocketOptions.SslOnConnect,
                _ => SecureSocketOptions.StartTls // Default
            };
        }
    }
}
</file>

<file path="Services/Implementations/EncryptionService.cs">
using System.Security.Cryptography;
using System.Text;
using AutoMarket.Services.Interfaces;
using Microsoft.Extensions.Configuration;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Serviço de encriptação para dados sensíveis (RGPD compliance).
    /// Usa AES-256-GCM para encriptação simétrica.
    /// </summary>
    public class EncryptionService : IEncryptionService
    {
        private readonly byte[] _key;
        private readonly ILogger<EncryptionService> _logger;

        public EncryptionService(IConfiguration configuration, ILogger<EncryptionService> logger)
        {
            _logger = logger;
            
            // Obter chave de encriptação da configuração
            var encryptionKey = configuration["Encryption:Key"];
            
            if (string.IsNullOrEmpty(encryptionKey))
            {
                // Se não houver chave configurada, gerar uma e logar um aviso
                _logger.LogWarning("Chave de encriptação não configurada. Gerando chave temporária. Configure 'Encryption:Key' em appsettings.json para produção.");
                encryptionKey = GenerateTemporaryKey();
            }

            // A chave deve ter 32 bytes (256 bits) para AES-256
            _key = DeriveKey(encryptionKey, 32);
        }

        public string Encrypt(string plainText)
        {
            if (string.IsNullOrEmpty(plainText))
                return plainText;

            try
            {
                using var aes = Aes.Create();
                aes.KeySize = 256;
                aes.Mode = CipherMode.CBC;
                aes.Padding = PaddingMode.PKCS7;
                aes.Key = _key;
                aes.GenerateIV();

                using var encryptor = aes.CreateEncryptor();
                using var msEncrypt = new MemoryStream();
                
                // Escrever IV primeiro
                msEncrypt.Write(aes.IV, 0, aes.IV.Length);

                using (var csEncrypt = new CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write))
                using (var swEncrypt = new StreamWriter(csEncrypt))
                {
                    swEncrypt.Write(plainText);
                }

                var encrypted = msEncrypt.ToArray();
                return Convert.ToBase64String(encrypted);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao encriptar dados sensíveis");
                throw new InvalidOperationException("Falha na encriptação de dados sensíveis", ex);
            }
        }

        public string Decrypt(string cipherText)
        {
            if (string.IsNullOrEmpty(cipherText))
                return cipherText;

            // Se não estiver encriptado (formato Base64), retornar como está (para migração)
            if (!IsEncrypted(cipherText))
                return cipherText;

            try
            {
                var fullCipher = Convert.FromBase64String(cipherText);

                using var aes = Aes.Create();
                aes.KeySize = 256;
                aes.Mode = CipherMode.CBC;
                aes.Padding = PaddingMode.PKCS7;
                aes.Key = _key;

                // Extrair IV (primeiros 16 bytes)
                var iv = new byte[16];
                Array.Copy(fullCipher, 0, iv, 0, 16);
                aes.IV = iv;

                // Extrair dados encriptados (resto)
                var cipher = new byte[fullCipher.Length - 16];
                Array.Copy(fullCipher, 16, cipher, 0, cipher.Length);

                using var decryptor = aes.CreateDecryptor();
                using var msDecrypt = new MemoryStream(cipher);
                using var csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read);
                using var srDecrypt = new StreamReader(csDecrypt);

                return srDecrypt.ReadToEnd();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao desencriptar dados sensíveis");
                throw new InvalidOperationException("Falha na desencriptação de dados sensíveis", ex);
            }
        }

        public bool IsEncrypted(string value)
        {
            if (string.IsNullOrEmpty(value))
                return false;

            // Verificar se é Base64 válido e tem tamanho mínimo (IV + pelo menos alguns bytes)
            try
            {
                var bytes = Convert.FromBase64String(value);
                return bytes.Length >= 20; // IV (16 bytes) + pelo menos 4 bytes de dados
            }
            catch
            {
                return false;
            }
        }

        private static byte[] DeriveKey(string password, int keyLength)
        {
            using var sha256 = SHA256.Create();
            var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            
            if (hash.Length >= keyLength)
            {
                var key = new byte[keyLength];
                Array.Copy(hash, 0, key, 0, keyLength);
                return key;
            }
            
            // Se o hash for menor que o necessário, usar PBKDF2
            using var pbkdf2 = new Rfc2898DeriveBytes(password, hash, 10000, HashAlgorithmName.SHA256);
            return pbkdf2.GetBytes(keyLength);
        }

        private static string GenerateTemporaryKey()
        {
            // Gerar uma chave aleatória de 32 bytes e converter para Base64
            var keyBytes = new byte[32];
            using (var rng = RandomNumberGenerator.Create())
            {
                rng.GetBytes(keyBytes);
            }
            return Convert.ToBase64String(keyBytes);
        }
    }
}
</file>

<file path="Services/Implementations/EstatisticasService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaзгo do serviзo de estatнsticas.
    /// </summary>
    public class EstatisticasService : IEstatisticasService
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<EstatisticasService> _logger;

        public EstatisticasService(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ILogger<EstatisticasService> logger)
        {
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        public async Task<EstatisticasDashboardDto> ObterEstatisticasAsync()
        {
            try
            {
                var stats = new EstatisticasDashboardDto();

                // Contar compradores
                stats.TotalCompradores = await _context.Compradores
                    .Where(c => !c.User!.IsDeleted && !c.User!.IsBlocked)
                    .CountAsync();

                // Contar vendedores aprovados
                stats.TotalVendedores = await _context.Vendedores
                    .Where(v => v.Status == StatusAprovacao.Aprovado && !v.User!.IsDeleted && !v.User!.IsBlocked)
                    .CountAsync();

                // Contar vendedores pendentes
                stats.TotalVendedoresPendentes = await _context.Vendedores
                    .Where(v => v.Status == StatusAprovacao.Pendente)
                    .CountAsync();

                // Contar anъncios ativos
                stats.TotalAnunciosAtivos = await _context.Veiculos
                    .Where(v => v.Estado == EstadoVeiculo.Ativo)
                    .CountAsync();

                // Contar anъncios vendidos
                stats.TotalAnunciosVendidos = await _context.Veiculos
                    .Where(v => v.Estado == EstadoVeiculo.Vendido)
                    .CountAsync();

                // Total de vendas (valor)
                stats.TotalVendasValor = await _context.Transacoes
                    .Where(t => t.Estado == EstadoTransacao.Pago)
                    .SumAsync(t => t.ValorPago);

                // Contar reservas ativas
                stats.TotalReservas = await _context.Reservas
                    .Where(r => r.Estado == EstadoReserva.Confirmada)
                    .CountAsync();

                // Contar visitas confirmadas
                stats.TotalVisitas = await _context.Visitas
                    .Where(v => v.Estado == EstadoVisita.Confirmada)
                    .CountAsync();

                // Vendas por mкs (ъltimos 12 meses)
                var hoje = DateTime.UtcNow;
                stats.VendasPorMes = await _context.Transacoes
                    .Where(t => t.Estado == EstadoTransacao.Pago && 
                                t.DataTransacao >= hoje.AddMonths(-12))
                    .GroupBy(t => new { t.DataTransacao.Year, t.DataTransacao.Month })
                    .Select(g => new
                    {
                        Mes = $"{g.Key.Month:00}/{g.Key.Year}",
                        Count = g.Count()
                    })
                    .OrderBy(x => x.Mes)
                    .ToDictionaryAsync(x => x.Mes, x => x.Count);

                // Top marcas
                stats.MarcasPopulares = await _context.Veiculos
                    .Where(v => v.Estado == EstadoVeiculo.Ativo)
                    .GroupBy(v => v.Marca)
                    .Select(g => new { Marca = g.Key, Count = g.Count() })
                    .OrderByDescending(x => x.Count)
                    .Take(10)
                    .ToDictionaryAsync(x => x.Marca, x => x.Count);

                // Denъncias por estado
                stats.DenunciasPorEstado = await _context.Denuncias
                    .GroupBy(d => d.Estado)
                    .Select(g => new { Estado = g.Key.ToString(), Count = g.Count() })
                    .ToDictionaryAsync(x => x.Estado, x => x.Count);

                _logger.LogInformation("Estatнsticas dashboard obtidas com sucesso");
                return stats;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao obter estatнsticas dashboard");
                return new EstatisticasDashboardDto();
            }
        }
    }
}
</file>

<file path="Services/Implementations/FavoritoService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaзгo do serviзo de favoritos.
    /// </summary>
    public class FavoritoService : IFavoritoService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<FavoritoService> _logger;

        public FavoritoService(
            ApplicationDbContext context,
            ILogger<FavoritoService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<bool> AdicionarFavoritoAsync(int compradorId, int veiculoId)
        {
            try
            {
                var existe = await _context.Favoritos
                    .AnyAsync(f => f.CompradorId == compradorId && f.VeiculoId == veiculoId);

                if (existe)
                {
                    _logger.LogWarning(
                        "Tentativa de adicionar favorito duplicado: Comprador {CompradorId}, Veнculo {VeiculoId}",
                        compradorId, veiculoId);
                    return false;
                }

                var favorito = new Favorito
                {
                    CompradorId = compradorId,
                    VeiculoId = veiculoId,
                    DataAdicao = DateTime.UtcNow
                };

                _context.Favoritos.Add(favorito);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Favorito adicionado: Comprador {CompradorId}, Veнculo {VeiculoId}",
                    compradorId, veiculoId);

                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao adicionar favorito");
                return false;
            }
        }

        public async Task<bool> RemoverFavoritoAsync(int compradorId, int veiculoId)
        {
            try
            {
                var favorito = await _context.Favoritos
                    .FirstOrDefaultAsync(f => f.CompradorId == compradorId && f.VeiculoId == veiculoId);

                if (favorito == null)
                {
                    _logger.LogWarning(
                        "Tentativa de remover favorito inexistente: Comprador {CompradorId}, Veнculo {VeiculoId}",
                        compradorId, veiculoId);
                    return false;
                }

                _context.Favoritos.Remove(favorito);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Favorito removido: Comprador {CompradorId}, Veнculo {VeiculoId}",
                    compradorId, veiculoId);

                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao remover favorito");
                return false;
            }
        }

        public async Task<bool> EstaNosFavoritosAsync(int compradorId, int veiculoId)
        {
            return await _context.Favoritos
                .AnyAsync(f => f.CompradorId == compradorId && f.VeiculoId == veiculoId);
        }

        public async Task<List<Veiculo>> ListarFavoritosAsync(int compradorId, int page = 1, int pageSize = 20)
        {
            return await _context.Favoritos
                .Where(f => f.CompradorId == compradorId)
                .Include(f => f.Veiculo)
                    .ThenInclude(v => v.Imagens)
                .Include(f => f.Veiculo.Vendedor)
                    .ThenInclude(vnd => vnd.User)
                .Include(f => f.Veiculo.Categoria)
                .OrderByDescending(f => f.DataAdicao)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Select(f => f.Veiculo)
                .ToListAsync();
        }

        public async Task<int> ContarFavoritosAsync(int compradorId)
        {
            return await _context.Favoritos
                .CountAsync(f => f.CompradorId == compradorId);
        }
    }
}
</file>

<file path="Services/Implementations/FileService.cs">
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Serviço para gerenciar upload e processamento de ficheiros.
    /// </summary>
    public class FileService : IFileService
    {
        private readonly IWebHostEnvironment _webHostEnvironment;
        private readonly ILogger<FileService> _logger;

        public FileService(IWebHostEnvironment webHostEnvironment, ILogger<FileService> logger)
        {
            _webHostEnvironment = webHostEnvironment;
            _logger = logger;
        }

        /// <summary>
        /// Faz upload de um ficheiro único.
        /// </summary>
        public async Task<string> UploadFileAsync(IFormFile file, string uploadFolder)
        {
            try
            {
                // Validação
                if (file == null || file.Length == 0)
                    throw new ArgumentException("Ficheiro inválido ou vazio.");

                // Validar extensão
                var extension = Path.GetExtension(file.FileName).ToLower();
                var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".webp" };

                if (!allowedExtensions.Contains(extension))
                    throw new ArgumentException($"Extensão '{extension}' não permitida. Use: {string.Join(", ", allowedExtensions)}");

                // Validar tamanho (10 MB)
                const long maxFileSize = 10 * 1024 * 1024;
                if (file.Length > maxFileSize)
                    throw new ArgumentException($"Ficheiro demasiado grande. Máximo: 10 MB");

                // VALIDAÇÃO CRÍTICA: Verificar Magic Numbers (bytes de cabeçalho)
                // Previne upload de ficheiros maliciosos renomeados (ex: malware.exe -> image.jpg)
                if (!ValidateImageMagicNumbers(file))
                {
                    throw new ArgumentException("Ficheiro inválido: o conteúdo do ficheiro não corresponde a uma imagem válida.");
                }

                // Criar pasta se não existir
                var uploadPath = Path.Combine(_webHostEnvironment.WebRootPath, uploadFolder);
                if (!Directory.Exists(uploadPath))
                    Directory.CreateDirectory(uploadPath);

                // Gerar nome único com GUID
                var fileName = $"{Guid.NewGuid()}{extension}";
                var filePath = Path.Combine(uploadPath, fileName);

                // Guardar ficheiro
                using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await file.CopyToAsync(stream);
                }

                _logger.LogInformation("Ficheiro guardado com sucesso: {FileName}", fileName);
                return fileName;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao fazer upload do ficheiro: {FileName}", file?.FileName);
                throw;
            }
        }

        /// <summary>
        /// Faz upload de m�ltiplos ficheiros.
        /// </summary>
        public async Task<List<string>> UploadMultipleFilesAsync(List<IFormFile> files, string uploadFolder)
        {
            var uploadedFiles = new List<string>();

            // Validar quantidade
            if (files == null || files.Count == 0)
                throw new ArgumentException("Nenhum ficheiro fornecido.");

            const int maxFilesPerCar = 10;
            if (files.Count > maxFilesPerCar)
                throw new ArgumentException($"M�ximo de {maxFilesPerCar} ficheiros permitidos.");

            // Validar tamanho total
            const long maxTotalSize = 50 * 1024 * 1024; // 50 MB
            var totalSize = files.Sum(f => f.Length);

            if (totalSize > maxTotalSize)
                throw new ArgumentException($"Tamanho total demasiado grande. M�ximo: 50 MB");

            // Fazer upload de cada ficheiro
            foreach (var file in files)
            {
                try
                {
                    var fileName = await UploadFileAsync(file, uploadFolder);
                    uploadedFiles.Add(fileName);
                }
                catch (Exception ex)
                {
                    _logger.LogWarning(ex, "Erro ao fazer upload de um ficheiro. Continuando com os restantes.");
                    // Continuar com os pr�ximos ficheiros
                }
            }

            return uploadedFiles;
        }

        /// <summary>
        /// Valida um ficheiro.
        /// </summary>
        public bool ValidateFile(IFormFile file, long maxSizeInBytes, string[] allowedExtensions)
        {
            if (file == null || file.Length == 0)
                return false;

            // Validar extensão
            var extension = Path.GetExtension(file.FileName).ToLower();
            if (!allowedExtensions.Contains(extension))
                return false;

            // Validar tamanho
            if (file.Length > maxSizeInBytes)
                return false;

            // Validar Magic Numbers (segurança crítica)
            if (!ValidateImageMagicNumbers(file))
                return false;

            return true;
        }

        /// <summary>
        /// Obt�m mensagem de erro de valida��o de ficheiro.
        /// </summary>
        public string GetFileValidationError(IFormFile file, long maxSizeInBytes, string[] allowedExtensions)
        {
            if (file == null)
                return "Ficheiro n�o fornecido.";

            if (file.Length == 0)
                return "Ficheiro vazio.";

            // Validar extens�o
            var extension = Path.GetExtension(file.FileName).ToLower();
            if (!allowedExtensions.Contains(extension))
                return $"Extens�o '{extension}' n�o permitida. Use: {string.Join(", ", allowedExtensions)}";

            // Validar tamanho
            if (file.Length > maxSizeInBytes)
            {
                var maxSizeMB = maxSizeInBytes / (1024 * 1024);
                return $"Ficheiro demasiado grande. M�ximo: {maxSizeMB} MB";
            }

            // Validar Magic Numbers (segurança crítica)
            if (!ValidateImageMagicNumbers(file))
                return "Ficheiro inv�lido: o conte�do do ficheiro n�o corresponde a uma imagem v�lida.";

            return string.Empty;
        }

        /// <summary>
        /// Apaga um ficheiro.
        /// </summary>
        public async Task<bool> DeleteFileAsync(string filePath)
        {
            try
            {
                var fullPath = Path.Combine(_webHostEnvironment.WebRootPath, filePath);

                if (!File.Exists(fullPath))
                {
                    _logger.LogWarning("Ficheiro não encontrado: {FilePath}", fullPath);
                    return false;
                }

                File.Delete(fullPath);
                _logger.LogInformation("Ficheiro apagado com sucesso: {FilePath}", filePath);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao apagar ficheiro: {FilePath}", filePath);
                return false;
            }
        }

        /// <summary>
        /// Valida os Magic Numbers (bytes de cabeçalho) de um ficheiro de imagem.
        /// Esta validação é crítica para segurança: previne upload de ficheiros maliciosos
        /// que foram renomeados para parecer imagens (ex: malware.exe -> image.jpg).
        /// </summary>
        private bool ValidateImageMagicNumbers(IFormFile file)
        {
            try
            {
                // Ler os primeiros bytes do ficheiro (Magic Numbers)
                var header = new byte[12];
                using (var stream = file.OpenReadStream())
                {
                    var bytesRead = stream.Read(header, 0, header.Length);
                    if (bytesRead < 4) // Precisamos pelo menos 4 bytes para validar
                        return false;

                    stream.Position = 0; // Reset para permitir leitura posterior
                }

                // JPEG: FF D8 FF
                if (header[0] == 0xFF && header[1] == 0xD8 && header[2] == 0xFF)
                {
                    return true;
                }

                // PNG: 89 50 4E 47 0D 0A 1A 0A
                if (header[0] == 0x89 && header[1] == 0x50 && header[2] == 0x4E && header[3] == 0x47 &&
                    header[4] == 0x0D && header[5] == 0x0A && header[6] == 0x1A && header[7] == 0x0A)
                {
                    return true;
                }

                // WebP: RIFF ... WEBP
                // RIFF signature: 52 49 46 46 (RIFF em ASCII)
                // WebP signature começa no byte 8: 57 45 42 50 (WEBP em ASCII)
                if (header.Length >= 12 &&
                    header[0] == 0x52 && header[1] == 0x49 && header[2] == 0x46 && header[3] == 0x46 &&
                    header[8] == 0x57 && header[9] == 0x45 && header[10] == 0x42 && header[11] == 0x50)
                {
                    return true;
                }

                // GIF: 47 49 46 38 (GIF8)
                if (header[0] == 0x47 && header[1] == 0x49 && header[2] == 0x46 && header[3] == 0x38)
                {
                    return true;
                }

                // BMP: 42 4D (BM em ASCII)
                if (header[0] == 0x42 && header[1] == 0x4D)
                {
                    return true;
                }

                _logger.LogWarning("Ficheiro rejeitado: Magic Numbers não correspondem a uma imagem válida. Primeiros bytes: {Bytes}", 
                    BitConverter.ToString(header.Take(8).ToArray()));
                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao validar Magic Numbers do ficheiro: {FileName}", file.FileName);
                return false;
            }
        }
    }
}
</file>

<file path="Services/Implementations/GestaoUtilizadoresService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using System.Text.Json;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaзгo do serviзo de gestгo de utilizadores.
    /// </summary>
    public class GestaoUtilizadoresService : IGestaoUtilizadoresService
    {
        private readonly UserManager<Utilizador> _userManager;
        private readonly IAuditoriaService _auditoriaService;
        private readonly INotificacaoService _notificacaoService;
        private readonly ILogger<GestaoUtilizadoresService> _logger;

        public GestaoUtilizadoresService(
            UserManager<Utilizador> userManager,
            IAuditoriaService auditoriaService,
            INotificacaoService notificacaoService,
            ILogger<GestaoUtilizadoresService> logger)
        {
            _userManager = userManager;
            _auditoriaService = auditoriaService;
            _notificacaoService = notificacaoService;
            _logger = logger;
        }

        public async Task<bool> BloquearUtilizadorAsync(string utilizadorId, string motivo, string adminId)
        {
            var utilizador = await _userManager.FindByIdAsync(utilizadorId);
            if (utilizador == null)
            {
                _logger.LogWarning("Tentativa de bloquear utilizador inexistente: {UtilizadorId}", utilizadorId);
                return false;
            }

            if (utilizador.IsBlocked)
            {
                _logger.LogWarning("Utilizador {UtilizadorId} jб estб bloqueado", utilizadorId);
                return false;
            }

            var estadoAnterior = utilizador.IsBlocked;
            utilizador.IsBlocked = true;
            utilizador.BlockReason = motivo;

            var result = await _userManager.UpdateAsync(utilizador);
            if (!result.Succeeded)
            {
                _logger.LogError("Erro ao bloquear utilizador {UtilizadorId}", utilizadorId);
                return false;
            }

            // Registar auditoria
            await _auditoriaService.RegistarAcaoAsync(
                adminId,
                "USUARIO_BLOQUEADO",
                $"Utilizador {utilizador.Nome} ({utilizador.Email}) bloqueado. Motivo: {motivo}",
                entidadeAfetadaId: utilizadorId,
                tipoEntidade: "Utilizador",
                dadosAntigos: JsonSerializer.Serialize(new { IsBlocked = estadoAnterior, BlockReason = (string?)null }),
                dadosNovos: JsonSerializer.Serialize(new { IsBlocked = true, BlockReason = motivo }));

            // Notificar o utilizador
            await _notificacaoService.NotificarUtilizadorAsync(
                utilizadorId,
                tipo: "USUARIO_BLOQUEADO",
                assunto: "A sua conta foi bloqueada",
                corpo: $"A sua conta foi bloqueada pela administraзгo. Motivo: {motivo}. Contacte o suporte se julgar que isto й um erro.");

            _logger.LogInformation(
                "Admin {AdminId} bloqueou utilizador {UtilizadorId}. Motivo: {Motivo}",
                adminId, utilizadorId, motivo);

            return true;
        }

        public async Task<bool> DesbloquearUtilizadorAsync(string utilizadorId, string adminId)
        {
            var utilizador = await _userManager.FindByIdAsync(utilizadorId);
            if (utilizador == null)
            {
                _logger.LogWarning("Tentativa de desbloquear utilizador inexistente: {UtilizadorId}", utilizadorId);
                return false;
            }

            if (!utilizador.IsBlocked)
            {
                _logger.LogWarning("Utilizador {UtilizadorId} nгo estб bloqueado", utilizadorId);
                return false;
            }

            var motivoAnterior = utilizador.BlockReason;
            utilizador.IsBlocked = false;
            utilizador.BlockReason = null;

            var result = await _userManager.UpdateAsync(utilizador);
            if (!result.Succeeded)
            {
                _logger.LogError("Erro ao desbloquear utilizador {UtilizadorId}", utilizadorId);
                return false;
            }

            // Registar auditoria
            await _auditoriaService.RegistarAcaoAsync(
                adminId,
                "USUARIO_DESBLOQUEADO",
                $"Utilizador {utilizador.Nome} ({utilizador.Email}) desbloqueado",
                entidadeAfetadaId: utilizadorId,
                tipoEntidade: "Utilizador",
                dadosAntigos: JsonSerializer.Serialize(new { IsBlocked = true, BlockReason = motivoAnterior }),
                dadosNovos: JsonSerializer.Serialize(new { IsBlocked = false, BlockReason = (string?)null }));

            // Notificar o utilizador
            await _notificacaoService.NotificarUtilizadorAsync(
                utilizadorId,
                tipo: "USUARIO_DESBLOQUEADO",
                assunto: "A sua conta foi desbloqueada",
                corpo: "A sua conta foi desbloqueada pela administraзгo. Pode agora aceder normalmente.");

            _logger.LogInformation(
                "Admin {AdminId} desbloqueou utilizador {UtilizadorId}",
                adminId, utilizadorId);

            return true;
        }

        public async Task<string?> ObterMotivoBloquoAsync(string utilizadorId)
        {
            var utilizador = await _userManager.FindByIdAsync(utilizadorId);
            if (utilizador == null || !utilizador.IsBlocked)
                return null;

            return utilizador.BlockReason;
        }

        public async Task<List<Utilizador>> ListarUtilizadoresBloqueadosAsync(int page = 1, int pageSize = 20)
        {
            var users = await _userManager.Users
                .Where(u => u.IsBlocked && !u.IsDeleted)
                .OrderByDescending(u => u.DataRegisto)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            return users;
        }
    }
}
</file>

<file path="Services/Implementations/LimparReservasHostedService.cs">
namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Background service que limpa reservas expiradas periodicamente.
    /// Executa a cada hora (configurбvel).
    /// </summary>
    public class LimparReservasHostedService : BackgroundService
    {
        private readonly IServiceProvider _serviceProvider;
        private readonly ILogger<LimparReservasHostedService> _logger;
        private readonly TimeSpan _intervalo = TimeSpan.FromHours(1); // Executar a cada hora

        public LimparReservasHostedService(
            IServiceProvider serviceProvider,
            ILogger<LimparReservasHostedService> logger)
        {
            _serviceProvider = serviceProvider;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("?? Serviзo de limpeza de reservas iniciado");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    // Executar limpeza
                    await LimparReservasAsync(stoppingToken);

                    // Aguardar prуxima execuзгo
                    await Task.Delay(_intervalo, stoppingToken);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogInformation("?? Serviзo de limpeza foi cancelado");
                    break;
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "? Erro no serviзo de limpeza de reservas");
                    // Continuar executando mesmo apуs erro
                    await Task.Delay(_intervalo, stoppingToken);
                }
            }
        }

        private async Task LimparReservasAsync(CancellationToken cancellationToken)
        {
            // Usar um novo scope para cada execuзгo
            using (var scope = _serviceProvider.CreateScope())
            {
                var reservaService = scope.ServiceProvider.GetRequiredService<IReservaService>();

                _logger.LogInformation("? Iniciando limpeza de reservas expiradas...");
                await reservaService.LimparReservasExpirasAsync();
                _logger.LogInformation("? Limpeza de reservas concluнda");
            }
        }
    }
}
</file>

<file path="Services/Implementations/MensagensService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    public class MensagensService : IMensagensService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<MensagensService> _logger;

        public MensagensService(ApplicationDbContext context, ILogger<MensagensService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<Mensagem> EnviarMensagemAsync(string remetenteId, string destinatarioId, string conteudo, int? veiculoId = null)
        {
            var mensagem = new Mensagem
            {
                RemetenteId = remetenteId,
                DestinatarioId = destinatarioId,
                Conteudo = conteudo,
                VeiculoId = veiculoId,
                DataEnvio = DateTime.UtcNow,
                Lida = false
            };

            _context.Mensagens.Add(mensagem);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Mensagem enviada de {RemetenteId} para {DestinatarioId}", remetenteId, destinatarioId);
            return mensagem;
        }

        public async Task<List<Mensagem>> ListarConversaAsync(string userId1, string userId2, int page = 1, int pageSize = 50)
        {
            return await _context.Mensagens
                .Where(m => (m.RemetenteId == userId1 && m.DestinatarioId == userId2) ||
                           (m.RemetenteId == userId2 && m.DestinatarioId == userId1))
                .OrderByDescending(m => m.DataEnvio)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
        }

        public async Task<bool> MarcarComoLidaAsync(int mensagemId)
        {
            var mensagem = await _context.Mensagens.FindAsync(mensagemId);
            if (mensagem == null) return false;

            mensagem.Lida = true;
            await _context.SaveChangesAsync();
            return true;
        }

        public async Task<int> ContarNaolidasAsync(string userId)
        {
            return await _context.Mensagens
                .CountAsync(m => m.DestinatarioId == userId && !m.Lida);
        }
    }
}
</file>

<file path="Services/Implementations/NotificacaoService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Implementaусo do serviуo de notificaушes.
    /// Cria notificaушes in-app e pode enviar emails.
    /// </summary>
    public class NotificacaoService : INotificacaoService
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly IEmailSender _emailSender;
        private readonly ILogger<NotificacaoService> _logger;

        public NotificacaoService(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            IEmailSender emailSender,
            ILogger<NotificacaoService> logger)
        {
            _context = context;
            _userManager = userManager;
            _emailSender = emailSender;
            _logger = logger;
        }

        public async Task NotificarUtilizadorAsync(
            string utilizadorId,
            string tipo,
            string assunto,
            string corpo,
            string? linkRelacionado = null,
            string? entidadeRelacionadaId = null,
            string? tipoEntidadeRelacionada = null)
        {
            try
            {
                var utilizador = await _userManager.FindByIdAsync(utilizadorId);
                if (utilizador == null)
                {
                    _logger.LogWarning("Tentativa de notificar utilizador inexistente: {UtilizadorId}", utilizadorId);
                    return;
                }

                // Criar notificaусo in-app
                var notificacao = new Notificacao
                {
                    DestinatarioId = utilizadorId,
                    Tipo = tipo,
                    Assunto = assunto,
                    Corpo = corpo,
                    LinkRelacionado = linkRelacionado,
                    EntidadeRelacionadaId = entidadeRelacionadaId,
                    TipoEntidadeRelacionada = tipoEntidadeRelacionada,
                    DataCriacao = DateTime.UtcNow,
                    Lida = false
                };

                _context.Notificacoes.Add(notificacao);
                await _context.SaveChangesAsync();

                // Enviar email tambжm (opcional)
                if (utilizador.EmailConfirmed)
                {
                    await _emailSender.SendEmailAsync(
                        utilizador.Email ?? "",
                        assunto,
                        $"<p>{corpo}</p>{(linkRelacionado != null ? $"<p><a href='{linkRelacionado}'>Ver detalhes</a></p>" : "")}");
                }

                _logger.LogInformation(
                    "Notificaусo criada para {UtilizadorId}: {Tipo}",
                    utilizadorId, tipo);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao notificar utilizador {UtilizadorId}", utilizadorId);
            }
        }

        public async Task NotificarAdminsAsync(
            string tipo,
            string assunto,
            string corpo,
            string? linkRelacionado = null,
            string? entidadeRelacionadaId = null,
            string? tipoEntidadeRelacionada = null)
        {
            try
            {
                // Obter todos os admins
                var admins = await _userManager.GetUsersInRoleAsync(Roles.Admin);

                foreach (var admin in admins)
                {
                    await NotificarUtilizadorAsync(
                        admin.Id,
                        tipo,
                        assunto,
                        corpo,
                        linkRelacionado,
                        entidadeRelacionadaId,
                        tipoEntidadeRelacionada);
                }

                _logger.LogInformation(
                    "Notificaушes enviadas para {AdminCount} admins: {Tipo}",
                    admins.Count, tipo);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao notificar admins para {Tipo}", tipo);
            }
        }

        public async Task<bool> MarcarComolida(int notificacaoId)
        {
            var notificacao = await _context.Notificacoes.FirstOrDefaultAsync(n => n.Id == notificacaoId);
            if (notificacao == null) return false;

            notificacao.Lida = true;
            await _context.SaveChangesAsync();
            return true;
        }

        public async Task<List<Notificacao>> ObterNaolidasAsync(string utilizadorId)
        {
            return await _context.Notificacoes
                .Where(n => n.DestinatarioId == utilizadorId && !n.Lida)
                .OrderByDescending(n => n.DataCriacao)
                .ToListAsync();
        }

        public async Task<List<Notificacao>> ListarNotificacoesAsync(string utilizadorId, int page = 1, int pageSize = 20)
        {
            return await _context.Notificacoes
                .Where(n => n.DestinatarioId == utilizadorId)
                .OrderByDescending(n => n.DataCriacao)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
        }
    }
}
</file>

<file path="Services/Implementations/ViewRenderService.cs">
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Abstractions;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.AspNetCore.Mvc.ViewEngines;
using Microsoft.AspNetCore.Mvc.ViewFeatures;
using Microsoft.AspNetCore.Routing;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for rendering Razor views to strings.
    /// </summary>
    public class ViewRenderService
    {
        private readonly ICompositeViewEngine _viewEngine;
        private readonly ITempDataProvider _tempDataProvider;
        private readonly IServiceProvider _serviceProvider;

        public ViewRenderService(
            ICompositeViewEngine viewEngine,
            ITempDataProvider tempDataProvider,
            IServiceProvider serviceProvider)
        {
            _viewEngine = viewEngine;
            _tempDataProvider = tempDataProvider;
            _serviceProvider = serviceProvider;
        }

        public async Task<string> RenderToStringAsync(string viewName, object model, HttpContext httpContext)
        {
            var actionContext = new ActionContext(httpContext, new RouteData(), new ActionDescriptor());
            var viewResult = _viewEngine.FindView(actionContext, viewName, false);

            if (!viewResult.Success)
            {
                viewResult = _viewEngine.GetView(viewName, viewName, false);
            }

            if (!viewResult.Success)
            {
                throw new InvalidOperationException($"Could not find view '{viewName}'. Searched locations: {string.Join(", ", viewResult.SearchedLocations)}");
            }

            var view = viewResult.View;
            using var writer = new StringWriter();
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary())
            {
                Model = model
            };

            var viewContext = new ViewContext(
                actionContext,
                view,
                viewData,
                new TempDataDictionary(httpContext, _tempDataProvider),
                writer,
                new HtmlHelperOptions()
            );

            await view.RenderAsync(viewContext);
            return writer.ToString();
        }
    }
}
</file>

<file path="Services/Interfaces/IAuditoriaService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviуo de auditoria.
    /// Regista todas as aушes administrativas.
    /// </summary>
    public interface IAuditoriaService
    {
        /// <summary>
        /// Registar uma aусo administrativa.
        /// </summary>
        Task RegistarAcaoAsync(
            string adminId,
            string tipoAcao,
            string descricao,
            string? entidadeAfetadaId = null,
            string? tipoEntidade = null,
            string? dadosAntigos = null,
            string? dadosNovos = null,
            string? enderecoIP = null,
            string? userAgent = null);

        /// <summary>
        /// Obter logs de auditoria paginados.
        /// </summary>
        Task<List<AuditoriaLog>> ListarLogsAsync(int page = 1, int pageSize = 50);

        /// <summary>
        /// Obter logs de um admin especьfico.
        /// </summary>
        Task<List<AuditoriaLog>> ListarLogsPorAdminAsync(string adminId, int page = 1, int pageSize = 50);
    }
}
</file>

<file path="Services/Interfaces/IAuthService.cs">
using AutoMarket.Models.DTOs;

namespace AutoMarket.Services.Interfaces
{
	public interface IAuthService
	{
		Task<RegisterResultDto> RegisterAsync(RegisterDto dto, string confirmationBaseUrl);
		Task<LoginResultDto> LoginAsync(LoginDto dto);
		Task LogoutAsync();
		Task<ConfirmEmailResultDto> ConfirmEmailAsync(string userId, string token);
		Task<UpdateNifResultDto> UpdateNifAsync(string userId, string nif);
		Task<SoftDeleteResultDto> SoftDeleteAsync(string userId);
	}
}
</file>

<file path="Services/Interfaces/IDenunciaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using Microsoft.EntityFrameworkCore;
using System.Text.Json;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviço de denúncias.
    /// Gerencia workflow: Aberta ? Em Análise ? Encerrada (Procedente/Não Procedente).
    /// </summary>
    public interface IDenunciaService
    {
        /// <summary>
        /// Criar uma nova denúncia.
        /// </summary>
        Task<Denuncia> CriarDenunciaAsync(
            string denuncianteId,
            int? veiculoId = null,
            string? targetUserId = null,
            string motivo = "");

        /// <summary>
        /// Obter denúncia por ID.
        /// </summary>
        Task<Denuncia?> ObterDenunciaAsync(int denunciaId);

        /// <summary>
        /// Listar denúncias com filtro por estado.
        /// </summary>
        Task<List<Denuncia>> ListarDenunciasAsync(
            string? estado = null,
            int page = 1,
            int pageSize = 20);

        /// <summary>
        /// Iniciar análise de denúncia (muda para Em Análise).
        /// </summary>
        Task<bool> IniciarAnaliseAsync(int denunciaId, string adminId);

        /// <summary>
        /// Encerrar denúncia com decisão.
        /// </summary>
        Task<bool> EncerrarDenunciaAsync(
            int denunciaId,
            string adminId,
            bool procedente,
            string decisao);

        /// <summary>
        /// Contar denúncias por estado.
        /// </summary>
        Task<Dictionary<string, int>> ContarPorEstadoAsync();
    }
}
</file>

<file path="Services/Interfaces/IEmailQueue.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface for queuing failed emails for retry.
    /// </summary>
    public interface IEmailQueue
    {
        /// <summary>
        /// Queues an email for retry.
        /// </summary>
        /// <param name="to">Recipient email address.</param>
        /// <param name="subject">Email subject.</param>
        /// <param name="message">Email body.</param>
        /// <returns>A task that represents the asynchronous operation.</returns>
        Task QueueEmailAsync(string to, string subject, string message);
    }
}
</file>

<file path="Services/Interfaces/IEmailSender.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface for sending emails.
    /// </summary>
    public interface IEmailSender
    {
        /// <summary>
        /// Sends an email asynchronously.
        /// </summary>
        /// <param name="to">Recipient email address.</param>
        /// <param name="subject">Email subject.</param>
        /// <param name="message">Email body (HTML or plain text).</param>
        /// <param name="cancellationToken">Cancellation token to cancel the operation.</param>
        /// <returns>A task that represents the asynchronous operation.</returns>
        Task SendEmailAsync(string to, string subject, string message, CancellationToken cancellationToken = default);
    }
}
</file>

<file path="Services/Interfaces/IEncryptionService.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviços de encriptação de dados sensíveis (RGPD compliance).
    /// </summary>
    public interface IEncryptionService
    {
        /// <summary>
        /// Encripta um valor sensível.
        /// </summary>
        string Encrypt(string plainText);

        /// <summary>
        /// Desencripta um valor encriptado.
        /// </summary>
        string Decrypt(string cipherText);

        /// <summary>
        /// Verifica se uma string está encriptada.
        /// </summary>
        bool IsEncrypted(string value);
    }
}
</file>

<file path="Services/Interfaces/IEstatisticasService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviço de estatísticas admin.
    /// </summary>
    public interface IEstatisticasService
    {
        /// <summary>
        /// Obter estatísticas gerais do dashboard.
        /// </summary>
        Task<EstatisticasDashboardDto> ObterEstatisticasAsync();
    }

    /// <summary>
    /// DTO com as estatísticas do dashboard.
    /// </summary>
    public class EstatisticasDashboardDto
    {
        public int TotalCompradores { get; set; }
        public int TotalVendedores { get; set; }
        public int TotalVendedoresPendentes { get; set; }
        public int TotalAnunciosAtivos { get; set; }
        public int TotalAnunciosVendidos { get; set; }
        public decimal TotalVendasValor { get; set; }
        public int TotalReservas { get; set; }
        public int TotalVisitas { get; set; }
        public Dictionary<string, int> VendasPorMes { get; set; } = new();
        public Dictionary<string, int> MarcasPopulares { get; set; } = new();
        public Dictionary<string, int> DenunciasPorEstado { get; set; } = new();
    }
}
</file>

<file path="Services/Interfaces/IFavoritoService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviço de favoritos (bookmarks de anúncios).
    /// </summary>
    public interface IFavoritoService
    {
        /// <summary>
        /// Adicionar um veículo aos favoritos de um comprador.
        /// </summary>
        Task<bool> AdicionarFavoritoAsync(int compradorId, int veiculoId);

        /// <summary>
        /// Remover um veículo dos favoritos.
        /// </summary>
        Task<bool> RemoverFavoritoAsync(int compradorId, int veiculoId);

        /// <summary>
        /// Verificar se um veículo está nos favoritos.
        /// </summary>
        Task<bool> EstaNosFavoritosAsync(int compradorId, int veiculoId);

        /// <summary>
        /// Obter lista de veículos favoritos de um comprador.
        /// </summary>
        Task<List<Veiculo>> ListarFavoritosAsync(int compradorId, int page = 1, int pageSize = 20);

        /// <summary>
        /// Contar total de favoritos.
        /// </summary>
        Task<int> ContarFavoritosAsync(int compradorId);
    }
}
</file>

<file path="Services/Interfaces/IFileService.cs">
namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para gerenciar upload e processamento de ficheiros.
    /// </summary>
    public interface IFileService
    {
        /// <summary>
        /// Faz upload de um ficheiro ъnico.
        /// </summary>
        /// <param name="file">Ficheiro a fazer upload</param>
        /// <param name="uploadFolder">Pasta de destino (relativa a wwwroot)</param>
        /// <returns>Nome do ficheiro guardado</returns>
        Task<string> UploadFileAsync(IFormFile file, string uploadFolder);

        /// <summary>
        /// Faz upload de mъltiplos ficheiros.
        /// </summary>
        /// <param name="files">Lista de ficheiros a fazer upload</param>
        /// <param name="uploadFolder">Pasta de destino (relativa a wwwroot)</param>
        /// <returns>Lista de nomes de ficheiros guardados</returns>
        Task<List<string>> UploadMultipleFilesAsync(List<IFormFile> files, string uploadFolder);

        /// <summary>
        /// Valida um ficheiro.
        /// </summary>
        /// <param name="file">Ficheiro a validar</param>
        /// <param name="maxSizeInBytes">Tamanho mбximo em bytes</param>
        /// <param name="allowedExtensions">Extensхes permitidas (ex: .jpg, .png)</param>
        /// <returns>True se vбlido, False caso contrбrio</returns>
        bool ValidateFile(IFormFile file, long maxSizeInBytes, string[] allowedExtensions);

        /// <summary>
        /// Obtйm mensagem de erro de validaзгo de ficheiro.
        /// </summary>
        /// <param name="file">Ficheiro a validar</param>
        /// <param name="maxSizeInBytes">Tamanho mбximo em bytes</param>
        /// <param name="allowedExtensions">Extensхes permitidas</param>
        /// <returns>Mensagem de erro ou string vazia se vбlido</returns>
        string GetFileValidationError(IFormFile file, long maxSizeInBytes, string[] allowedExtensions);

        /// <summary>
        /// Apaga um ficheiro.
        /// </summary>
        /// <param name="filePath">Caminho relativo do ficheiro (relativo a wwwroot)</param>
        /// <returns>True se apagado com sucesso, False caso contrбrio</returns>
        Task<bool> DeleteFileAsync(string filePath);
    }
}
</file>

<file path="Services/Interfaces/IGestaoUtilizadoresService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviço de gestão de utilizadores (bloqueio, desbloqueio, etc).
    /// </summary>
    public interface IGestaoUtilizadoresService
    {
        /// <summary>
        /// Bloquear um utilizador com motivo.
        /// </summary>
        Task<bool> BloquearUtilizadorAsync(string utilizadorId, string motivo, string adminId);

        /// <summary>
        /// Desbloquear um utilizador.
        /// </summary>
        Task<bool> DesbloquearUtilizadorAsync(string utilizadorId, string adminId);

        /// <summary>
        /// Obter histórico de bloqueios de um utilizador.
        /// </summary>
        Task<string?> ObterMotivoBloquoAsync(string utilizadorId);

        /// <summary>
        /// Listar utilizadores bloqueados.
        /// </summary>
        Task<List<Utilizador>> ListarUtilizadoresBloqueadosAsync(int page = 1, int pageSize = 20);
    }
}
</file>

<file path="Services/Interfaces/IMensagensService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    public interface IMensagensService
    {
        Task<Mensagem> EnviarMensagemAsync(string remetenteId, string destinatarioId, string conteudo, int? veiculoId = null);
        Task<List<Mensagem>> ListarConversaAsync(string userId1, string userId2, int page = 1, int pageSize = 50);
        Task<bool> MarcarComoLidaAsync(int mensagemId);
        Task<int> ContarNaolidasAsync(string userId);
    }
}
</file>

<file path="Services/Interfaces/INotificacaoService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para serviуo de notificaушes (in-app + email).
    /// </summary>
    public interface INotificacaoService
    {
        /// <summary>
        /// Criar notificaусo para um utilizador especьfico.
        /// </summary>
        Task NotificarUtilizadorAsync(
            string utilizadorId,
            string tipo,
            string assunto,
            string corpo,
            string? linkRelacionado = null,
            string? entidadeRelacionadaId = null,
            string? tipoEntidadeRelacionada = null);

        /// <summary>
        /// Notificar todos os admins.
        /// </summary>
        Task NotificarAdminsAsync(
            string tipo,
            string assunto,
            string corpo,
            string? linkRelacionado = null,
            string? entidadeRelacionadaId = null,
            string? tipoEntidadeRelacionada = null);

        /// <summary>
        /// Marcar notificaусo como lida.
        /// </summary>
        Task<bool> MarcarComolida(int notificacaoId);

        /// <summary>
        /// Obter notificaушes nсo lidas de um utilizador.
        /// </summary>
        Task<List<Notificacao>> ObterNaolidasAsync(string utilizadorId);

        /// <summary>
        /// Obter todas as notificaушes de um utilizador com paginaусo.
        /// </summary>
        Task<List<Notificacao>> ListarNotificacoesAsync(string utilizadorId, int page = 1, int pageSize = 20);
    }
}
</file>

<file path="Services/Interfaces/IVeiculoService.cs">
namespace AutoMarket.Services.Interfaces
{
    public interface IVeiculoService
    {
        Task<VeiculoDto?> GetAsync(int id);
        Task<IReadOnlyList<VeiculoDto>> ListAsync(VeiculoFiltroDto filtro);
        Task<CommandResultDto> CreateAsync(VeiculoCreateDto dto);
        Task<CommandResultDto> UpdateAsync(int id, VeiculoUpdateDto dto);
        Task<CommandResultDto> SoftDeleteAsync(int id);
        ValidationResultDto Validate(VeiculoCreateDto dto);
    }
}
</file>

<file path="Services/Interfaces/IVisitaService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para o service de gestгo de visitas.
    /// </summary>
    public interface IVisitaService
    {
        /// <summary>Agendar uma visita a um veнculo.</summary>
        Task<(bool sucesso, Visita? visita, string mensagem)> AgendarVisitaAsync(
            int veiculoId,
            int compradorId,
            DateTime dataHora,
            string? notas = "");

        /// <summary>Cancelar uma visita agendada.</summary>
        Task<(bool sucesso, string mensagem)> CancelarVisitaAsync(
            int visitaId,
            string motivo = "");

        /// <summary>Confirmar uma visita (aзгo do vendedor).</summary>
        Task<(bool sucesso, string mensagem)> ConfirmarVisitaAsync(int visitaId);

        /// <summary>Marcar visita como realizada (aзгo do vendedor).</summary>
        Task<(bool sucesso, string mensagem)> MarcarComoRealizadaAsync(
            int visitaId,
            string? notas = "");

        /// <summary>Validar data/hora da visita.</summary>
        bool ValidarDataVisita(DateTime dataHora);

        /// <summary>Validar se veнculo foi vendido.</summary>
        Task<bool> ValidarVeiculoVendidoAsync(int veiculoId);

        /// <summary>Obter todas as visitas de um comprador.</summary>
        Task<List<Visita>> ObterVisitasCompradorAsync(int compradorId);

        /// <summary>Obter todas as visitas de um vendedor.</summary>
        Task<List<Visita>> ObterVisitasVendedorAsync(int vendedorId);

        /// <summary>Obter uma visita especнfica.</summary>
        Task<Visita?> ObterVisitaAsync(int visitaId);
    }
}
</file>

<file path="Views/Checkout/Sucesso.cshtml">
@model AutoMarket.Models.Entities.Transacao
@{
    ViewData["Title"] = "Compra Realizada com Sucesso";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-12">
            <!-- Card de Sucesso -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-body text-center py-5">
                    <!-- ═cone de Sucesso -->
                    <div class="mb-4">
                        <div class="success-icon-wrapper">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                        </div>
                    </div>

                    <h2 class="fw-bold text-success mb-3">
                        ?? Compra Realizada com Sucesso!
                    </h2>
                    <p class="text-muted lead mb-4">
                        A sua transaусo foi registada e estр a ser processada.
                    </p>

                    <!-- NЩmero da Transaусo -->
                    <div class="alert alert-info">
                        <strong>NЩmero da Transaусo:</strong> #@Model.Id.ToString("D6")
                    </div>
                </div>
            </div>

            <!-- Detalhes da Compra -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt"></i> Detalhes da Compra
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6 col-12 mb-3">
                            <strong>Data da Transaусo:</strong><br>
                            <span class="text-muted">@Model.DataTransacao.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            <strong>Valor Pago:</strong><br>
                            <span class="text-success fw-bold fs-5">@Model.ValorPago.ToString("C2")</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6 col-12 mb-3">
                            <strong>Mжtodo de Pagamento:</strong><br>
                            <span class="text-muted">@Model.Metodo</span>
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            <strong>Estado:</strong><br>
                            <span class="badge 
                                @(Model.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pago ? "bg-success" : 
                                  Model.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pendente ? "bg-warning" : "bg-danger")">
                                @Model.Estado
                            </span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.MoradaEnvioSnapshot))
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>Morada de Envio:</strong><br>
                                <span class="text-muted">
                                    <i class="bi bi-geo-alt-fill"></i> @Model.MoradaEnvioSnapshot
                                </span>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.NifFaturacaoSnapshot))
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-file-text-fill"></i>
                            <strong>Fatura com NIF solicitada:</strong> @Model.NifFaturacaoSnapshot
                        </div>
                    }
                </div>
            </div>

            <!-- Prзximos Passos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Prзximos Passos
                    </h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">
                            <strong>Confirmaусo por Email:</strong> Receberр um email de confirmaусo com todos os detalhes da compra.
                        </li>
                        <li class="mb-2">
                            <strong>Contacto do Vendedor:</strong> O vendedor entrarр em contacto consigo para combinar a entrega/levantamento do veьculo.
                        </li>
                        <li class="mb-2">
                            <strong>Documentaусo:</strong> Certifique-se de que toda a documentaусo do veьculo estр em ordem antes de finalizar a transaусo.
                        </li>
                        @if (Model.Estado == AutoMarket.Models.Enums.EstadoTransacao.Pendente)
                        {
                            <li class="mb-0">
                                <strong>Pagamento:</strong> Complete o pagamento seguindo as instruушes enviadas por email.
                            </li>
                        }
                    </ol>
                </div>
            </div>

            <!-- Aушes -->
            <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                <a asp-controller="Transacoes" asp-action="MinhasCompras" class="btn btn-primary btn-lg">
                    <i class="bi bi-bag-check"></i> Ver Minhas Compras
                </a>
                <a asp-controller="Veiculos" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-search"></i> Continuar a Explorar
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .success-icon-wrapper {
        animation: scaleIn 0.5s ease-in-out;
    }

    @@keyframes scaleIn {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .card {
        border-radius: 15px;
    }

    .card-header {
        border-top-left-radius: 15px !important;
        border-top-right-radius: 15px !important;
    }
</style>
</file>

<file path="wwwroot/css/pesquisa.css">
/* Estilos para a página de pesquisa de veículos */

.vehicle-card:hover {
    box-shadow: 0 4px 12px #00214720;
    transform: translateY(-2px);
}

@media (max-width: 1024px) {
    .pesquisa-container {
        flex-direction: column;
    }

    .filtros-sidebar {
        min-width: auto;
    }
}

@media (max-width: 768px) {
    .pesquisa-container {
        flex-direction: column;
        gap: 1rem;
    }

    .filtros-sidebar {
        min-width: auto;
    }
}
</file>

<file path="Areas/Admin/Controllers/AdminController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Admin.Controllers
{
    [Authorize(Roles = Roles.Admin)]
    [Area("Admin")]
    public class AdminController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly SignInManager<Utilizador> _signInManager;
        private readonly IEstatisticasService _estatisticasService;

        public AdminController(
            ApplicationDbContext context, 
            UserManager<Utilizador> userManager,
            SignInManager<Utilizador> signInManager,
            IEstatisticasService estatisticasService)
        {
            _context = context;
            _userManager = userManager;
            _signInManager = signInManager;
            _estatisticasService = estatisticasService;
        }

        // GET: Admin/Dashboard
        [HttpGet]
        [Route("Admin/Dashboard")]
        public async Task<IActionResult> Dashboard()
        {
            var stats = await _estatisticasService.ObterEstatisticasAsync();
            return View(stats);
        }

        // GET: Admin/Index (Lista de Pendentes)
        public async Task<IActionResult> Index(int page = 1)
        {
            int pageSize = 10;
            var query = _context.Vendedores
                .Include(v => v.User)
                .Where(v => v.Status == StatusAprovacao.Pendente)
                .OrderBy(v => v.User.DataRegisto);

            var model = await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = (int)Math.Ceiling(await query.CountAsync() / (double)pageSize);

            return View(model);
        }

        // POST: Admin/Aprovar/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Aprovar(int id)
        {
            var vendedor = await _context.Vendedores.FindAsync(id);
            if (vendedor == null) return NotFound();

            vendedor.Aprovar(_userManager.GetUserId(User));
            await _context.SaveChangesAsync();

            // Refresh do cookie para atualizar as claims (StatusVendedor)
            var user = await _userManager.FindByIdAsync(vendedor.UserId);
            if (user != null)
            {
                await _signInManager.RefreshSignInAsync(user);
            }

            TempData["MensagemStatus"] = "Vendedor aprovado com sucesso!";
            return RedirectToAction(nameof(Index));
        }

        // POST: Admin/Rejeitar/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Rejeitar(int id, string motivo)
        {
            var vendedor = await _context.Vendedores.FindAsync(id);
            if (vendedor == null) return NotFound();

            if (string.IsNullOrWhiteSpace(motivo))
            {
                motivo = "Documentação insuficiente ou dados incorretos.";
            }

            vendedor.Rejeitar(_userManager.GetUserId(User), motivo);
            await _context.SaveChangesAsync();

            // Refresh do cookie para atualizar as claims (StatusVendedor)
            var user = await _userManager.FindByIdAsync(vendedor.UserId);
            if (user != null)
            {
                await _signInManager.RefreshSignInAsync(user);
            }

            TempData["MensagemStatus"] = "Vendedor rejeitado.";
            return RedirectToAction(nameof(Index));
        }

        // GET: Admin/HistoricoTransacoes
        public async Task<IActionResult> HistoricoTransacoes(int page = 1)
        {
            int pageSize = 20;

            var query = _context.Transacoes
                .IgnoreQueryFilters()
                .Include(t => t.Veiculo)
                    .ThenInclude(c => c.Vendedor)
                        .ThenInclude(v => v.User)
                .Include(t => t.Comprador)
                    .ThenInclude(c => c.User)
                .OrderByDescending(t => t.DataTransacao);

            var model = await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
            
            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = (int)Math.Ceiling(await query.CountAsync() / (double)pageSize);

            return View(model);
        }
    }
}
</file>

<file path="Areas/Admin/Views/Anuncios/Index.cshtml">
@model IEnumerable<Veiculo>
@using AutoMarket.Models.Entities
@using AutoMarket.Models.Enums
@{
    ViewData["Title"] = "Moderar Anuncios";
    var currentPage = (int)(ViewData["CurrentPage"] ?? 1);
    var totalPages = (int)(ViewData["TotalPages"] ?? 1);
    var estadoFiltro = ViewData["EstadoFiltro"]?.ToString() ?? "";
}

<div class="container-fluid py-4">
    <h1 class="fw-bold mb-4">Moderar Anuncios</h1>

    @if (Model?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-hover bg-white shadow-sm">
                <thead class="table-light">
                    <tr>
                        <th>Veiculo</th>
                        <th>Vendedor</th>
                        <th>Preco</th>
                        <th>Estado</th>
                        <th>Data</th>
                        <th>Acoes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var veiculo in Model)
                    {
                        <tr>
                            <td>@veiculo.Marca @veiculo.Modelo (@veiculo.Ano)</td>
                            <td>@veiculo.Vendedor?.User?.Nome</td>
                            <td>@veiculo.Preco.ToString("F2")</td>
                            <td>
                                <span class="badge @(veiculo.Estado == EstadoVeiculo.Ativo ? "bg-success" : "bg-warning")">
                                    @veiculo.Estado
                                </span>
                            </td>
                            <td>@veiculo.DataCriacao.ToString("dd/MM/yyyy")</td>
                            <td>
                                <a href="/Public/Veiculos/Detalhe/@veiculo.Id" class="btn btn-sm btn-info"
                                    target="_blank">Ver</a>
                                <form method="post" asp-action="Pausar" asp-route-id="@veiculo.Id" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-warning">Pausar</button>
                                </form>
                                <form method="post" asp-action="Remover" asp-route-id="@veiculo.Id" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Remover?');">Remover</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">Nenhum anuncio encontrado</div>
    }
</div>
</file>

<file path="Areas/Public/Controllers/CheckoutController.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Models.ViewModels;
using Microsoft.AspNetCore.Identity;

namespace AutoMarket.Areas.Public.Controllers
{
    [Authorize]
    [Area("Public")]
    public class CheckoutController : Controller
    {
        private readonly ICheckoutService _checkoutService;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<CheckoutController> _logger;

        public CheckoutController(
            ICheckoutService checkoutService,
            UserManager<Utilizador> userManager,
            ILogger<CheckoutController> logger)
        {
            _checkoutService = checkoutService;
            _userManager = userManager;
            _logger = logger;
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ProcessarPagamento(int veiculoId, string morada, string nif)
        {
            try
            {
                var userId = _userManager.GetUserId(User);
                if (string.IsNullOrEmpty(userId)) 
                    return RedirectToAction("Login", "Conta");

                var transacao = new Transacao
                {
                    VeiculoId = veiculoId,
                    MoradaEnvioSnapshot = morada,
                    NifFaturacaoSnapshot = nif
                };

                var result = await _checkoutService.ProcessCheckoutAsync(userId, transacao);
                return RedirectToAction("Confirmacao", new { id = result.Id });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao processar pagamento");
                return RedirectToAction("Index", "Veiculos");
            }
        }

        [HttpGet]
        public async Task<IActionResult> Confirmacao(int id)
        {
            var userId = _userManager.GetUserId(User);
            if (string.IsNullOrEmpty(userId)) 
                return RedirectToAction("Login", "Conta");

            var transacao = await _checkoutService.GetTransacaoAsync(userId, id);
            if (transacao == null) 
                return NotFound();

            return View(transacao);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/ContaController.cs">
using System.Security.Claims;
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.ViewModels;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    [Area("Public")]
    public class ContaController : Controller
    {
        private readonly IAuthService _authService;
        private readonly ILogger<ContaController> _logger;
        private readonly ApplicationDbContext _context;
        private readonly IFavoritoService _favoritoService;

        public ContaController(
            IAuthService authService,
            ILogger<ContaController> logger,
            ApplicationDbContext context,
            IFavoritoService favoritoService)
        {
            _authService = authService;
            _logger = logger;
            _context = context;
            _favoritoService = favoritoService;
        }

        /// <summary>
        /// GET: Conta/Index
        /// Dashboard do perfil do utilizador.
        /// </summary>
        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Index()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var user = await _context.Users.FindAsync(userId);
            if (user == null) return NotFound();

            return View(user);
        }

        [HttpGet]
        public IActionResult Register()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Register(RegisterViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var confirmationBaseUrl = Url.Action(nameof(ConfirmarEmail), "Conta", null, Request.Scheme) ?? string.Empty;

            var result = await _authService.RegisterAsync(
                new RegisterDto(model.Email, model.Password, model.Nome, model.Morada, model.Contacto, model.NIF, model.TipoConta),
                confirmationBaseUrl);

            if (result.Success)
            {
                return RedirectToAction("Index", "Home");
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error);
            }

            return View(model);
        }

        [HttpGet]
        public IActionResult Login()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Login(LoginViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var result = await _authService.LoginAsync(new LoginDto(model.Email, model.Password, model.RememberMe));

            if (result.Success)
            {
                return RedirectToAction("Index", "Home");
            }

            if (result.FailureReason == nameof(StatusAprovacao.Pendente))
            {
                return RedirectToAction(nameof(AguardandoAprovacao));
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error);
            }

            return View(model);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Logout()
        {
            await _authService.LogoutAsync();
            return Redirect("/"); // Redireciona diretamente para a raiz (Home)
        }

        [HttpGet]
        public async Task<IActionResult> ConfirmarEmail(string userId, string token)
        {
            var result = await _authService.ConfirmEmailAsync(userId, token);
            if (result.Success) return View("EmailConfirmado");

            _logger.LogWarning("Falha na confirmação de email para {UserId}: {Errors}", userId, string.Join(", ", result.Errors));
            return View("Error", new ErrorViewModel
            {
                Message = "Não foi possível confirmar o email. O link pode ter expirado ou já foi utilizado."
            });
        }

        [HttpGet]
        [Authorize]
        public IActionResult PreencherDadosFiscais()
        {
            return View();
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> PreencherDadosFiscais(DadosFiscaisViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var result = await _authService.UpdateNifAsync(userId, model.NIF);

            if (!result.Success)
            {
                foreach (var error in result.Errors)
                {
                    ModelState.AddModelError(string.Empty, error);
                }
                return View(model);
            }

            if (TempData["ReturnUrl"] is string returnUrl)
            {
                TempData.Keep("ReturnUrl");
                return Redirect(returnUrl);
            }

            return RedirectToAction("Index", "Home");
        }

        [HttpGet]
        [Authorize(Roles = Roles.Vendedor)]
        public IActionResult AguardandoAprovacao()
        {
            return View();
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ApagarConta()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return NotFound();

            var result = await _authService.SoftDeleteAsync(userId);
            if (!result.Success)
            {
                foreach (var error in result.Errors)
                {
                    _logger.LogError("Erro ao apagar conta {UserId}: {Error}", userId, error);
                }
            }

            return RedirectToAction("Index", "Home");
        }

        /// <summary>
        /// GET: Conta/Favoritos
        /// Listar veículos favoritos do comprador.
        /// </summary>
        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Favoritos(int page = 1)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == userId);

            if (comprador == null)
                return RedirectToAction("Index", "Home");

            var favoritos = await _favoritoService.ListarFavoritosAsync(comprador.Id, page, 20);
            var total = await _favoritoService.ContarFavoritosAsync(comprador.Id);

            ViewData["TotalFavoritos"] = total;
            ViewData["CurrentPage"] = page;
            ViewData["TotalPages"] = (int)Math.Ceiling(total / 20.0);

            return View(favoritos);
        }

        /// <summary>
        /// GET: Conta/Notificacoes
        /// Listar notificações do utilizador.
        /// </summary>
        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Notificacoes(int page = 1)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId)) return Unauthorized();

            var notificacoes = await _context.Notificacoes
                .Where(n => n.DestinatarioId == userId)
                .OrderByDescending(n => n.DataCriacao)
                .Skip((page - 1) * 20)
                .Take(20)
                .ToListAsync();

            var total = await _context.Notificacoes
                .CountAsync(n => n.DestinatarioId == userId);

            ViewData["TotalNotificacoes"] = total;
            ViewData["CurrentPage"] = page;
            ViewData["TotalPages"] = (int)Math.Ceiling(total / 20.0);

            return View(notificacoes);
        }
    }
}
</file>

<file path="Areas/Public/Controllers/HomeController.cs">
using System.Diagnostics;
using AutoMarket.Models.ViewModels;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Provides basic site pages such as the home, privacy, and error views.
    /// </summary>
    [Area("Public")]
    public class HomeController : Controller
    {
        private readonly ILogger<HomeController> _logger;

        /// <summary>
        /// Initializes a new instance of the <see cref="HomeController"/> class.
        /// </summary>
        /// <param name="logger">Logger used for diagnostic information.</param>
        public HomeController(ILogger<HomeController> logger)
        {
            _logger = logger;
        }

        /// <summary>
        /// Renders the home page.
        /// </summary>
        /// <returns>A view representing the home page.</returns>
        public IActionResult Index()
        {
            return View();
        }

        /// <summary>
        /// Renders the privacy policy page.
        /// </summary>
        /// <returns>A view containing the privacy policy.</returns>
        public IActionResult Privacy()
        {
            return View();
        }

        /// <summary>
        /// Renders the "Sobre" (About) page.
        /// </summary>
        /// <returns>A view with information about AutoMarket.</returns>
        public IActionResult Sobre()
        {
            return View();
        }

        /// <summary>
        /// Renders the "Ajuda" (Help) page.
        /// </summary>
        /// <returns>A view with help and FAQ information.</returns>
        public IActionResult Ajuda()
        {
            return View();
        }

        /// <summary>
        /// Renders the "Termos e Condiушes" page.
        /// </summary>
        /// <returns>A view with terms and conditions.</returns>
        public IActionResult Termos()
        {
            return View();
        }

        /// <summary>
        /// Renders the "Polьtica de Privacidade" page.
        /// </summary>
        /// <returns>A view with privacy policy.</returns>
        public IActionResult Politicas()
        {
            return View();
        }

        /// <summary>
        /// Renders the "Contacte-nos" (Contact Us) page.
        /// </summary>
        /// <returns>A view with contact information.</returns>
        public IActionResult Contactos()
        {
            return View();
        }

        /// <summary>
        /// Renders the error page including the current request identifier.
        /// </summary>
        /// <returns>A view with error details for troubleshooting.</returns>
        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error()
        {
            return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }
    }
}
</file>

<file path="Areas/Public/Controllers/VisitasController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Constants;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Public.Controllers
{
    /// <summary>
    /// Controller para gestao de visitas agendadas.
    /// Apenas para utilizadores autenticados.
    /// </summary>
    [Area("Public")]
    [Authorize]
    public class VisitasController : Controller
    {
        private readonly IVisitaService _visitaService;
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<VisitasController> _logger;

        public VisitasController(
            IVisitaService visitaService,
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ILogger<VisitasController> logger)
        {
            _visitaService = visitaService;
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        /// <summary>
        /// GET: /Visitas/Agendar/5
        /// Mostrar formulario para agendar visita.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Agendar(int veiculoId)
        {
            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Vendedor)
                .ThenInclude(vend => vend.User)
                .FirstOrDefaultAsync(v => v.Id == veiculoId);

            if (veiculo == null)
                return NotFound();

            // Verificar se veiculo foi vendido
            if (await _visitaService.ValidarVeiculoVendidoAsync(veiculoId))
            {
                TempData["Erro"] = "Este veiculo ja foi vendido.";
                return RedirectToAction("Detalhe", "Veiculos", new { id = veiculoId });
            }

            ViewBag.VeiculoId = veiculoId;
            ViewBag.DataMinima = DateTime.Now.AddHours(1).ToString("yyyy-MM-ddTHH:mm"); // ISO 8601 para input[type=datetime-local]

            return View(veiculo);
        }

        /// <summary>
        /// POST: /Visitas/Agendar
        /// Submeter agendamento de visita.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Agendar(int veiculoId, DateTime dataHora, string? notas)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                TempData["Erro"] = "Perfil de comprador nao encontrado.";
                return RedirectToAction("Index", "Veiculos");
            }

            // Agendar visita
            var (sucesso, visita, mensagem) = await _visitaService.AgendarVisitaAsync(
                veiculoId,
                comprador.Id,
                dataHora,
                notas);

            if (!sucesso)
            {
                TempData["Erro"] = mensagem;
                return RedirectToAction("Agendar", new { veiculoId });
            }

            TempData["Sucesso"] = mensagem;
            return RedirectToAction("MinhasVisitas");
        }

        /// <summary>
        /// GET: /Visitas/MinhasVisitas
        /// Listar todas as visitas do comprador.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> MinhasVisitas()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var comprador = await _context.Compradores
                .FirstOrDefaultAsync(c => c.UserId == user.Id);

            if (comprador == null)
            {
                TempData["Erro"] = "Perfil de comprador n�o encontrado.";
                return RedirectToAction("Index", "Veiculos");
            }

            var visitas = await _visitaService.ObterVisitasCompradorAsync(comprador.Id);

            return View(visitas);
        }

        /// <summary>
        /// POST: /Visitas/CancelarVisita/5
        /// Cancelar uma visita agendada.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CancelarVisita(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Validar permiss�o
            var visita = await _context.Visitas
                .Include(v => v.Comprador)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (visita == null)
            {
                TempData["Erro"] = "Visita n�o encontrada.";
                return RedirectToAction("MinhasVisitas");
            }

            if (visita.Comprador.UserId != user.Id)
            {
                TempData["Erro"] = "N�o tem permiss�o para cancelar esta visita.";
                return RedirectToAction("MinhasVisitas");
            }

            // Cancelar
            var (sucesso, mensagem) = await _visitaService.CancelarVisitaAsync(
                id,
                motivo: "Cancelado pelo comprador");

            TempData[sucesso ? "Sucesso" : "Erro"] = mensagem;
            return RedirectToAction("MinhasVisitas");
        }

        /// <summary>
        /// GET: /Visitas/VendedorDashboard
        /// Painel do vendedor com visitas agendadas.
        /// </summary>
        [HttpGet]
        [Authorize(Roles = "Vendedor")]
        public async Task<IActionResult> VendedorDashboard()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            var vendedor = await _context.Vendedores
                .FirstOrDefaultAsync(v => v.UserId == user.Id);

            if (vendedor == null)
            {
                TempData["Erro"] = "Perfil de vendedor n�o encontrado.";
                return RedirectToAction("Index", "Home");
            }

            var visitas = await _visitaService.ObterVisitasVendedorAsync(vendedor.Id);

            return View(visitas);
        }

        /// <summary>
        /// POST: /Visitas/ConfirmarVisita/5
        /// Confirmar uma visita agendada (a��o do vendedor).
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        [Authorize(Roles = "Vendedor")]
        public async Task<IActionResult> ConfirmarVisita(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Validar permiss�o
            var visita = await _context.Visitas
                .Include(v => v.Vendedor)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (visita == null)
            {
                TempData["Erro"] = "Visita n�o encontrada.";
                return RedirectToAction("VendedorDashboard");
            }

            if (visita.Vendedor.UserId != user.Id)
            {
                TempData["Erro"] = "N�o tem permiss�o.";
                return RedirectToAction("VendedorDashboard");
            }

            // Confirmar
            var (sucesso, mensagem) = await _visitaService.ConfirmarVisitaAsync(id);

            TempData[sucesso ? "Sucesso" : "Erro"] = mensagem;
            return RedirectToAction("VendedorDashboard");
        }

        /// <summary>
        /// POST: /Visitas/MarcarRealizada/5
        /// Marcar visita como realizada (a��o do vendedor).
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        [Authorize(Roles = "Vendedor")]
        public async Task<IActionResult> MarcarRealizada(int id, string? notas)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return Challenge();

            // Validar permiss�o
            var visita = await _context.Visitas
                .Include(v => v.Vendedor)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (visita == null || visita.Vendedor.UserId != user.Id)
            {
                TempData["Erro"] = "N�o tem permiss�o.";
                return RedirectToAction("VendedorDashboard");
            }

            var (sucesso, mensagem) = await _visitaService.MarcarComoRealizadaAsync(id, notas);

            TempData[sucesso ? "Sucesso" : "Erro"] = mensagem;
            return RedirectToAction("VendedorDashboard");
        }
    }
}
</file>

<file path="Areas/Public/Views/Conta/Favoritos.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    ViewData["Title"] = "Meus Favoritos";
    var total = ViewData["TotalFavoritos"] ?? 0;
    var page = ViewData["CurrentPage"] ?? 1;
    var totalPages = ViewData["TotalPages"] ?? 1;
}

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Meus Favoritos</h2>
            <p class="text-muted">Total: @total veículos</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/" class="btn btn-secondary">? Voltar</a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            Nenhum veículo nos favoritos. <a href="/Veiculos">Explorar veículos</a>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var veiculo in Model)
            {
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100 shadow-sm">
                        @if (veiculo.Imagens?.Any() == true)
                        {
                            <img src="/images/@veiculo.Imagens.First().CaminhoFicheiro" class="card-img-top" alt="@veiculo.Titulo" style="height: 200px; object-fit: cover;" />
                        }
                        else
                        {
                            <div style="height: 200px; background: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted">Sem imagem</span>
                            </div>
                        }
                        <div class="card-body">
                            <h5 class="card-title">@veiculo.Marca @veiculo.Modelo</h5>
                            <p class="card-text text-danger fw-bold">€@veiculo.Preco.ToString("N2")</p>
                            <small class="text-muted">
                                @veiculo.Ano • @veiculo.Km km • @veiculo.Localizacao
                            </small>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="/Veiculos/Detalhe/@veiculo.Id" class="btn btn-primary btn-sm w-100">Ver Detalhe</a>
                            <button class="btn btn-danger btn-sm w-100 mt-2" onclick="removerFavorito(@veiculo.Id)">Remover</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if ((int)totalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    @for (int i = 1; i <= (int)totalPages; i++)
                    {
                        <li class="page-item @(i == (int)page ? "active" : "")">
                            <a class="page-link" href="?page=@i">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
</div>

<script>
    function removerFavorito(veiculoId) {
        if (!confirm('Remover dos favoritos?')) return;
        
        fetch(`/api/favoritos/remover/${veiculoId}`, {
            method: 'DELETE',
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        })
        .then(r => r.json())
        .then(d => {
            alert(d.message);
            location.reload();
        })
        .catch(e => alert('Erro: ' + e));
    }
</script>
</file>

<file path="Areas/Public/Views/Emails/EmailConfirmation.cshtml">
@model dynamic
@using System.Net
@{
    Layout = null;
    var userName = Model?.UserName ?? "Utilizador";
    var confirmationLink = Model?.ConfirmationLink ?? "#";
}
<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirme o seu email - AutoMarket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .content {
            padding: 20px;
            background-color: #f9f9f9;
        }
        .button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }
        .link-text {
            word-break: break-all;
            color: #007bff;
            font-size: 12px;
        }
        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bem-vindo ao AutoMarket!</h1>
        </div>
        <div class="content">
            <p>Olá @(userName),</p>
            <p>Obrigado por se registar no AutoMarket. Para completar o seu registo, por favor confirme o seu endereço de email clicando no botão abaixo:</p>
            <p class="text-center">
                <a href="@confirmationLink" class="button">Confirmar Email</a>
            </p>
            <p>Ou copie e cole o seguinte link no seu navegador:</p>
            <p class="link-text">@confirmationLink</p>
            <p>Este link expirará em 24 horas.</p>
            <p>Se não criou uma conta no AutoMarket, pode ignorar este email.</p>
        </div>
        <div class="footer">
            <p>© 2025 AutoMarket. Todos os direitos reservados.</p>
        </div>
    </div>
</body>
</html>
</file>

<file path="Areas/Public/Views/Home/Ajuda.cshtml">
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<AutoMarket.Models.Entities.Utilizador> SignInManager
@{
    ViewData["Title"] = "Centro de Ajuda";
    Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
}

<!-- Hero Section -->
<section class="bg-gradient text-white py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container py-5 text-center">
        <h1 class="display-4 fw-bold mb-3">
            <i class="bi bi-question-circle-fill"></i> Centro de Ajuda
        </h1>
        <p class="lead mb-4">
            Encontre respostas rápidas para as suas questões
        </p>
        
        <!-- Busca -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="input-group input-group-lg shadow">
                    <span class="input-group-text bg-white border-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" 
                           class="form-control border-0" 
                           id="searchHelp" 
                           placeholder="Pesquisar ajuda..."
                           aria-label="Pesquisar ajuda">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Categorias Rápidas -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-md-6 col-lg-3">
                <a href="#faq-compradores" class="text-decoration-none">
                    <div class="card border-0 shadow-sm h-100 hover-card">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-cart-check text-primary" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Para Compradores</h5>
                            <p class="text-muted small mb-0">Como pesquisar e comprar</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-6 col-lg-3">
                <a href="#faq-vendedores" class="text-decoration-none">
                    <div class="card border-0 shadow-sm h-100 hover-card">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-shop text-success" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Para Vendedores</h5>
                            <p class="text-muted small mb-0">Como criar e gerir anúncios</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-6 col-lg-3">
                <a href="#faq-conta" class="text-decoration-none">
                    <div class="card border-0 shadow-sm h-100 hover-card">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-person-circle text-info" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Conta e Perfil</h5>
                            <p class="text-muted small mb-0">Gerir a sua conta</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-6 col-lg-3">
                <a href="#faq-seguranca" class="text-decoration-none">
                    <div class="card border-0 shadow-sm h-100 hover-card">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-shield-check text-warning" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Segurança</h5>
                            <p class="text-muted small mb-0">Transações e privacidade</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</section>

<!-- FAQs -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                
                <!-- Para Compradores -->
                <div id="faq-compradores" class="mb-5">
                    <h2 class="fw-bold mb-4">
                        <i class="bi bi-cart-check text-primary"></i> Para Compradores
                    </h2>
                    
                    <div class="accordion" id="accordionCompradores">
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#comprador1">
                                    Como posso pesquisar veículos?
                                </button>
                            </h3>
                            <div id="comprador1" class="accordion-collapse collapse show" data-bs-parent="#accordionCompradores">
                                <div class="accordion-body">
                                    <p>Pesquisar veículos no AutoMarket é fácil:</p>
                                    <ol>
                                        <li>Aceda à página <a asp-controller="Veiculos" asp-action="Index">Veículos</a></li>
                                        <li>Use os <strong>filtros laterais</strong> para refinar a pesquisa por:
                                            <ul>
                                                <li>Marca e modelo</li>
                                                <li>Ano e quilometragem</li>
                                                <li>Preço e localização</li>
                                                <li>Tipo de combustível</li>
                                            </ul>
                                        </li>
                                        <li>Clique em "Pesquisar" para ver os resultados</li>
                                        <li>Ordene por: Mais recentes, Preço, KM ou Ano</li>
                                    </ol>
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-lightbulb-fill"></i> <strong>Dica:</strong> Guarde os seus favoritos clicando no coração ❤️
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#comprador2">
                                    Como contacto um vendedor?
                                </button>
                            </h3>
                            <div id="comprador2" class="accordion-collapse collapse" data-bs-parent="#accordionCompradores">
                                <div class="accordion-body">
                                    <p>Para contactar um vendedor:</p>
                                    <ol>
                                        <li>Clique no veículo que lhe interessa</li>
                                        <li>Na página de detalhes, encontrará:
                                            <ul>
                                                <li>Nome e tipo de vendedor (Particular/Empresa)</li>
                                                <li>Botão "Contactar Vendedor"</li>
                                                <li>Sistema de mensagens interno (se autenticado)</li>
                                            </ul>
                                        </li>
                                        <li>Envie uma mensagem ou marque uma visita</li>
                                    </ol>
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Importante:</strong> Apenas vendedores verificados podem publicar anúncios.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#comprador3">
                                    Como funciona o processo de compra?
                                </button>
                            </h3>
                            <div id="comprador3" class="accordion-collapse collapse" data-bs-parent="#accordionCompradores">
                                <div class="accordion-body">
                                    <p><strong>Passo a passo da compra:</strong></p>
                                    <ol>
                                        <li><strong>Pesquisa:</strong> Encontre o veículo ideal</li>
                                        <li><strong>Contacto:</strong> Fale com o vendedor</li>
                                        <li><strong>Visita:</strong> Agende e visite o veículo</li>
                                        <li><strong>Negociação:</strong> Acorde o preço final</li>
                                        <li><strong>Adicione ao carrinho:</strong> Clique em "Adicionar ao Carrinho"</li>
                                        <li><strong>Checkout:</strong> Preencha os dados de envio/entrega</li>
                                        <li><strong>Pagamento:</strong> Escolha o método (ainda a implementar gateway)</li>
                                        <li><strong>Confirmação:</strong> Receba email de confirmação</li>
                                    </ol>
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-shield-check-fill"></i> Todas as transações são monitorizadas para sua segurança.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#comprador4">
                                    Como funcionam os favoritos?
                                </button>
                            </h3>
                            <div id="comprador4" class="accordion-collapse collapse" data-bs-parent="#accordionCompradores">
                                <div class="accordion-body">
                                    <p>Os favoritos permitem guardar veículos que lhe interessam:</p>
                                    <ul>
                                        <li>Clique no coração <i class="bi bi-heart text-danger"></i> em qualquer veículo</li>
                                        <li>Aceda aos seus favoritos no menu superior</li>
                                        <li>Compare facilmente os veículos guardados</li>
                                        <li>Receba notificações de alterações de preço (em breve)</li>
                                    </ul>
                                    <p><strong>Nota:</strong> É necessário estar autenticado para usar favoritos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Para Vendedores -->
                <div id="faq-vendedores" class="mb-5">
                    <h2 class="fw-bold mb-4">
                        <i class="bi bi-shop text-success"></i> Para Vendedores
                    </h2>
                    
                    <div class="accordion" id="accordionVendedores">
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#vendedor1">
                                    Como me torno vendedor?
                                </button>
                            </h3>
                            <div id="vendedor1" class="accordion-collapse collapse show" data-bs-parent="#accordionVendedores">
                                <div class="accordion-body">
                                    <p><strong>Processo de registo como vendedor:</strong></p>
                                    <ol>
                                        <li>Crie uma conta em <a asp-controller="Conta" asp-action="Register">Registar</a></li>
                                        <li>Escolha o tipo de conta:
                                            <ul>
                                                <li><strong>Vendedor Particular:</strong> Para pessoas que vendem o seu próprio carro</li>
                                                <li><strong>Empresa:</strong> Para stands e concessionárias (requer NIF)</li>
                                            </ul>
                                        </li>
                                        <li>Preencha os dados fiscais (NIF obrigatório para empresas)</li>
                                        <li>Aguarde aprovação (24-48h)</li>
                                        <li>Após aprovação, pode criar anúncios</li>
                                    </ol>
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-clock-fill"></i> A verificação garante a segurança de todos os utilizadores.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendedor2">
                                    Como crio um anúncio?
                                </button>
                            </h3>
                            <div id="vendedor2" class="accordion-collapse collapse" data-bs-parent="#accordionVendedores">
                                <div class="accordion-body">
                                    <p><strong>Criar anúncio (após aprovação):</strong></p>
                                    <ol>
                                        <li>Aceda ao menu <strong>Vendedores</strong> → <strong>Criar Veículo</strong></li>
                                        <li>Preencha os detalhes:
                                            <ul>
                                                <li>Título do anúncio</li>
                                                <li>Marca, modelo e ano</li>
                                                <li>Preço e quilometragem</li>
                                                <li>Combustível e caixa</li>
                                                <li>Localização</li>
                                                <li>Descrição detalhada</li>
                                            </ul>
                                        </li>
                                        <li>Adicione fotos (mínimo 1, máximo 10):
                                            <ul>
                                                <li>JPG, JPEG, PNG ou WebP</li>
                                                <li>Máximo 10MB por foto</li>
                                                <li>Selecione a foto de capa</li>
                                            </ul>
                                        </li>
                                        <li>Clique em "Publicar"</li>
                                    </ol>
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-lightbulb-fill"></i> <strong>Dica:</strong> Fotos de qualidade aumentam as visualizações em 70%!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendedor3">
                                    Como gerir os meus anúncios?
                                </button>
                            </h3>
                            <div id="vendedor3" class="accordion-collapse collapse" data-bs-parent="#accordionVendedores">
                                <div class="accordion-body">
                                    <p>Para gerir os seus anúncios:</p>
                                    <ol>
                                        <li>Aceda a <strong>Vendedores</strong> → <strong>Os Meus Veículos</strong></li>
                                        <li>Pode:
                                            <ul>
                                                <li><strong>Editar:</strong> Alterar preço, descrição ou fotos</li>
                                                <li><strong>Desativar:</strong> Ocultar temporariamente</li>
                                                <li><strong>Eliminar:</strong> Remover permanentemente</li>
                                                <li><strong>Marcar como Vendido:</strong> Quando vender</li>
                                            </ul>
                                        </li>
                                        <li>Ver estatísticas:
                                            <ul>
                                                <li>Número de visualizações</li>
                                                <li>Mensagens recebidas</li>
                                                <li>Estado do anúncio</li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vendedor4">
                                    Como acompanho as vendas?
                                </button>
                            </h3>
                            <div id="vendedor4" class="accordion-collapse collapse" data-bs-parent="#accordionVendedores">
                                <div class="accordion-body">
                                    <p>Para ver as suas vendas:</p>
                                    <ol>
                                        <li>Aceda a <a asp-controller="Transacoes" asp-action="MinhasVendas">Minhas Vendas</a></li>
                                        <li>Veja:
                                            <ul>
                                                <li>Todas as transações concluídas</li>
                                                <li>Dados dos compradores</li>
                                                <li>Valores recebidos</li>
                                                <li>Estado de pagamento</li>
                                            </ul>
                                        </li>
                                        <li>Estatísticas:
                                            <ul>
                                                <li>Total de vendas</li>
                                                <li>Receita total</li>
                                                <li>Vendas por mês</li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conta e Perfil -->
                <div id="faq-conta" class="mb-5">
                    <h2 class="fw-bold mb-4">
                        <i class="bi bi-person-circle text-info"></i> Conta e Perfil
                    </h2>
                    
                    <div class="accordion" id="accordionConta">
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#conta1">
                                    Como altero a minha password?
                                </button>
                            </h3>
                            <div id="conta1" class="accordion-collapse collapse show" data-bs-parent="#accordionConta">
                                <div class="accordion-body">
                                    <p>Para alterar a password:</p>
                                    <ol>
                                        <li>Faça login na sua conta</li>
                                        <li>Aceda a <strong>Perfil</strong> → <strong>Definições</strong></li>
                                        <li>Clique em "Alterar Password"</li>
                                        <li>Introduza:
                                            <ul>
                                                <li>Password atual</li>
                                                <li>Nova password (mínimo 16 caracteres)</li>
                                                <li>Confirmação da nova password</li>
                                            </ul>
                                        </li>
                                        <li>Clique em "Guardar"</li>
                                    </ol>
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle-fill"></i> A password deve ter: letras maiúsculas, minúsculas, números e caracteres especiais.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conta2">
                                    Como confirmo o meu email?
                                </button>
                            </h3>
                            <div id="conta2" class="accordion-collapse collapse" data-bs-parent="#accordionConta">
                                <div class="accordion-body">
                                    <p><strong>Após registo:</strong></p>
                                    <ol>
                                        <li>Recebe email de confirmação no endereço fornecido</li>
                                        <li>Clique no link de confirmação</li>
                                        <li>Será redirecionado para página de sucesso</li>
                                        <li>Pode agora fazer login normalmente</li>
                                    </ol>
                                    <p><strong>Email não chegou?</strong></p>
                                    <ul>
                                        <li>Verifique a pasta de spam/lixo</li>
                                        <li>Aguarde até 5 minutos</li>
                                        <li>Solicite reenvio (funcionalidade em breve)</li>
                                    </ul>
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle-fill"></i> A confirmação de email é obrigatória para fazer login.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conta3">
                                    Posso apagar a minha conta?
                                </button>
                            </h3>
                            <div id="conta3" class="accordion-collapse collapse" data-bs-parent="#accordionConta">
                                <div class="accordion-body">
                                    <p><strong>Sim, pode apagar a sua conta a qualquer momento:</strong></p>
                                    <ol>
                                        <li>Aceda a <strong>Perfil</strong> → <strong>Definições</strong></li>
                                        <li>Clique em "Apagar Conta"</li>
                                        <li>Confirme a ação</li>
                                    </ol>
                                    <p><strong>O que acontece:</strong></p>
                                    <ul>
                                        <li>Conta marcada como eliminada (soft delete)</li>
                                        <li>Não pode fazer login</li>
                                        <li>Anúncios ficam ocultos</li>
                                        <li>Histórico de transações mantido (obrigação legal)</li>
                                    </ul>
                                    <div class="alert alert-danger mb-0">
                                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Atenção:</strong> Esta ação não pode ser revertida!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segurança -->
                <div id="faq-seguranca" class="mb-5">
                    <h2 class="fw-bold mb-4">
                        <i class="bi bi-shield-check text-warning"></i> Segurança e Privacidade
                    </h2>
                    
                    <div class="accordion" id="accordionSeguranca">
                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#seguranca1">
                                    Os meus dados estão seguros?
                                </button>
                            </h3>
                            <div id="seguranca1" class="accordion-collapse collapse show" data-bs-parent="#accordionSeguranca">
                                <div class="accordion-body">
                                    <p><strong>Sim! Implementamos várias camadas de segurança:</strong></p>
                                    <ul>
                                        <li><strong>Encriptação:</strong> Todas as passwords são encriptadas (não guardamos em texto simples)</li>
                                        <li><strong>HTTPS:</strong> Comunicação segura entre browser e servidor</li>
                                        <li><strong>Anti-CSRF:</strong> Proteção contra ataques de falsificação</li>
                                        <li><strong>Lockout:</strong> Bloqueio após 5 tentativas falhadas de login</li>
                                        <li><strong>Email Confirmation:</strong> Verificação obrigatória de email</li>
                                        <li><strong>RGPD:</strong> Conformidade com regulamentação europeia</li>
                                    </ul>
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-shield-check-fill"></i> Os seus dados pessoais nunca são partilhados sem consentimento.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seguranca2">
                                    Como reporto um anúncio suspeito?
                                </button>
                            </h3>
                            <div id="seguranca2" class="accordion-collapse collapse" data-bs-parent="#accordionSeguranca">
                                <div class="accordion-body">
                                    <p>Se encontrar um anúncio suspeito:</p>
                                    <ol>
                                        <li>Abra a página do veículo</li>
                                        <li>Clique em "Reportar Anúncio" (botão vermelho)</li>
                                        <li>Escolha o motivo:
                                            <ul>
                                                <li>Informações falsas</li>
                                                <li>Fotos não correspondem</li>
                                                <li>Preço suspeito</li>
                                                <li>Fraude/Scam</li>
                                                <li>Outro</li>
                                            </ul>
                                        </li>
                                        <li>Adicione descrição detalhada</li>
                                        <li>Envie a denúncia</li>
                                    </ol>
                                    <p><strong>Nossa equipa irá:</strong></p>
                                    <ul>
                                        <li>Analisar em 24-48h</li>
                                        <li>Contactar o vendedor se necessário</li>
                                        <li>Remover anúncio se for fraude</li>
                                        <li>Bloquear utilizador se reincidente</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h3 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seguranca3">
                                    Como são verificados os vendedores?
                                </button>
                            </h3>
                            <div id="seguranca3" class="accordion-collapse collapse" data-bs-parent="#accordionSeguranca">
                                <div class="accordion-body">
                                    <p><strong>Processo de verificação de vendedores:</strong></p>
                                    <ol>
                                        <li><strong>Registo:</strong> Vendedor cria conta</li>
                                        <li><strong>Validação de Email:</strong> Email confirmado</li>
                                        <li><strong>Verificação de Dados:</strong>
                                            <ul>
                                                <li>Nome completo</li>
                                                <li>NIF (obrigatório para empresas)</li>
                                                <li>Morada</li>
                                                <li>Contacto</li>
                                            </ul>
                                        </li>
                                        <li><strong>Análise Manual:</strong> Admin revê perfil (24-48h)</li>
                                        <li><strong>Aprovação/Rejeição:</strong>
                                            <ul>
                                                <li>Aprovado: Pode criar anúncios</li>
                                                <li>Rejeitado: Recebe email com motivo</li>
                                            </ul>
                                        </li>
                                    </ol>
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-patch-check-fill"></i> Apenas vendedores aprovados aparecem na plataforma.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<!-- Contacto -->
<section class="py-5">
    <div class="container text-center">
        <h2 class="fw-bold mb-4">Não encontrou resposta?</h2>
        <p class="lead text-muted mb-4">
            A nossa equipa está pronta para ajudar
        </p>
        <div class="row justify-content-center g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-4">
                        <i class="bi bi-envelope-fill text-primary" style="font-size: 2.5rem;"></i>
                        <h5 class="fw-bold mt-3 mb-2">Email</h5>
                        <p class="text-muted mb-3">suporte@automarket.com</p>
                        <a href="mailto:suporte@automarket.com" class="btn btn-outline-primary">
                            Enviar Email
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-4">
                        <i class="bi bi-telephone-fill text-success" style="font-size: 2.5rem;"></i>
                        <h5 class="fw-bold mt-3 mb-2">Telefone</h5>
                        <p class="text-muted mb-3">+351 123 456 789</p>
                        <a href="tel:+351123456789" class="btn btn-outline-success">
                            Ligar Agora
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-4">
                        <i class="bi bi-chat-dots-fill text-info" style="font-size: 2.5rem;"></i>
                        <h5 class="fw-bold mt-3 mb-2">Chat ao Vivo</h5>
                        <p class="text-muted mb-3">Seg-Sex: 9h-18h</p>
                        <button class="btn btn-outline-info" disabled>
                            Em Breve
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important;
    }

    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #0d6efd;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
</style>

@section Scripts {
    <script>
        // Busca simples no FAQ
        document.getElementById('searchHelp').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const accordionItems = document.querySelectorAll('.accordion-item');
            
            accordionItems.forEach(item => {
                const button = item.querySelector('.accordion-button');
                const body = item.querySelector('.accordion-body');
                const text = (button.textContent + body.textContent).toLowerCase();
                
                if (text.includes(searchTerm) || searchTerm === '') {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Scroll suave para âncoras
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
}
</file>

<file path="Areas/Public/Views/Home/Sobre.cshtml">
@{
    ViewData["Title"] = "Sobre o AutoMarket";
    Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
}

<!-- Hero Section -->
<section class="bg-primary text-white py-5">
    <div class="container py-5">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <h1 class="display-4 fw-bold mb-4">Sobre o AutoMarket</h1>
                <p class="lead mb-4">
                    A plataforma líder em Portugal para compra e venda de veículos usados com segurança e transparência.
                </p>
                <div class="d-flex gap-3">
                    <a asp-controller="Veiculos" asp-action="Index" class="btn btn-light btn-lg">
                        <i class="bi bi-search"></i> Explorar Veículos
                    </a>
                    <a asp-controller="Home" asp-action="Ajuda" class="btn btn-outline-light btn-lg">
                        <i class="bi bi-question-circle"></i> Centro de Ajuda
                    </a>
                </div>
            </div>
            <div class="col-lg-6 text-center">
                <i class="bi bi-car-front-fill" style="font-size: 15rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</section>

<!-- Estatísticas -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row text-center g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body py-5">
                        <i class="bi bi-car-front text-primary" style="font-size: 3rem;"></i>
                        <h2 class="display-4 fw-bold text-primary mt-3 mb-2">500+</h2>
                        <p class="text-muted mb-0">Veículos Disponíveis</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body py-5">
                        <i class="bi bi-people text-success" style="font-size: 3rem;"></i>
                        <h2 class="display-4 fw-bold text-success mt-3 mb-2">1,200+</h2>
                        <p class="text-muted mb-0">Utilizadores Registados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body py-5">
                        <i class="bi bi-check-circle text-info" style="font-size: 3rem;"></i>
                        <h2 class="display-4 fw-bold text-info mt-3 mb-2">350+</h2>
                        <p class="text-muted mb-0">Transações Concluídas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Missão e Visão -->
<section class="py-5">
    <div class="container">
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h2 class="display-5 fw-bold mb-3">A Nossa Missão</h2>
                <p class="lead text-muted">
                    Revolucionar o mercado de veículos usados em Portugal, tornando-o mais acessível, 
                    transparente e seguro para todos.
                </p>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6 col-lg-3">
                <div class="text-center h-100">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-shield-check text-primary" style="font-size: 2rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Segurança</h4>
                    <p class="text-muted">
                        Verificação rigorosa de vendedores e processos seguros de transação para proteger compradores e vendedores.
                    </p>
                </div>
            </div>

            <div class="col-md-6 col-lg-3">
                <div class="text-center h-100">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-search text-success" style="font-size: 2rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Transparência</h4>
                    <p class="text-muted">
                        Informações completas e verificadas sobre cada veículo, sem surpresas ou custos ocultos.
                    </p>
                </div>
            </div>

            <div class="col-md-6 col-lg-3">
                <div class="text-center h-100">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-speedometer2 text-info" style="font-size: 2rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Rapidez</h4>
                    <p class="text-muted">
                        Encontre o veículo ideal em minutos com filtros avançados e pesquisa inteligente.
                    </p>
                </div>
            </div>

            <div class="col-md-6 col-lg-3">
                <div class="text-center h-100">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-headset text-warning" style="font-size: 2rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3">Suporte</h4>
                    <p class="text-muted">
                        Equipa dedicada pronta para ajudar em todas as etapas da sua compra ou venda.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Como Funciona -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h2 class="display-5 fw-bold mb-3">Como Funciona</h2>
                <p class="lead text-muted">Simples, rápido e seguro</p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Para Compradores -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-cart-check"></i> Para Compradores</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>1</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Pesquise</h5>
                                <p class="text-muted mb-0">Use os filtros avançados para encontrar o veículo perfeito</p>
                            </div>
                        </div>

                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>2</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Contacte</h5>
                                <p class="text-muted mb-0">Comunique diretamente com o vendedor verificado</p>
                            </div>
                        </div>

                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>3</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Visite</h5>
                                <p class="text-muted mb-0">Agende uma visita e teste o veículo</p>
                            </div>
                        </div>

                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>4</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Compre</h5>
                                <p class="text-muted mb-0">Finalize a compra de forma segura através da plataforma</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Para Vendedores -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="bi bi-shop"></i> Para Vendedores</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>1</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Registe-se</h5>
                                <p class="text-muted mb-0">Crie uma conta de vendedor (particular ou empresa)</p>
                            </div>
                        </div>

                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>2</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Aguarde Aprovação</h5>
                                <p class="text-muted mb-0">Nossa equipa verifica a sua conta em 24-48h</p>
                            </div>
                        </div>

                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>3</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Publique</h5>
                                <p class="text-muted mb-0">Adicione fotos e detalhes do seu veículo</p>
                            </div>
                        </div>

                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <strong>4</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold">Venda</h5>
                                <p class="text-muted mb-0">Receba propostas e negocie com segurança</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Diferenciais -->
<section class="py-5">
    <div class="container">
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h2 class="display-5 fw-bold mb-3">Porque Escolher o AutoMarket?</h2>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-patch-check-fill text-success me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="fw-bold">Vendedores Verificados</h5>
                                <p class="text-muted mb-0">
                                    Todos os vendedores passam por um processo rigoroso de verificação antes de publicar anúncios.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-eye-fill text-primary me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="fw-bold">Total Transparência</h5>
                                <p class="text-muted mb-0">
                                    Informações completas sobre cada veículo, incluindo histórico e estado real.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-shield-fill-check text-info me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="fw-bold">Transações Seguras</h5>
                                <p class="text-muted mb-0">
                                    Sistema de pagamento seguro integrado para proteger ambas as partes.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-chat-dots-fill text-warning me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h5 class="fw-bold">Suporte Dedicado</h5>
                                <p class="text-muted mb-0">
                                    Equipa de suporte disponível para ajudar em todas as etapas do processo.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="py-5 bg-primary text-white">
    <div class="container text-center">
        <h2 class="display-5 fw-bold mb-4">Pronto para Começar?</h2>
        <p class="lead mb-4">
            Junte-se a milhares de utilizadores satisfeitos no AutoMarket
        </p>
        <div class="d-flex gap-3 justify-content-center flex-wrap">
            <a asp-controller="Conta" asp-action="Register" class="btn btn-light btn-lg">
                <i class="bi bi-person-plus"></i> Criar Conta
            </a>
            <a asp-controller="Veiculos" asp-action="Index" class="btn btn-outline-light btn-lg">
                <i class="bi bi-search"></i> Ver Veículos
            </a>
        </div>
    </div>
</section>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
</style>
</file>

<file path="Areas/Public/Views/Reservas/Minhas.cshtml">
@model List<AutoMarket.Models.Entities.Reserva>
@using AutoMarket.Models.Enums

@{
    ViewData["Title"] = "Minhas Reservas";
}

<div class="container py-5">
    <h1 class="mb-4">
        <i class="bi bi-bookmark-fill"></i> Minhas Reservas
    </h1>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model == null || Model.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> Nao tem reservas criadas ainda.
            <a href="@Url.Action("Index", "Veiculos")" class="alert-link">Começar a pesquisar veículos</a>
        </div>
        return;
    }

    <div class="row g-4">
        @foreach (var reserva in Model)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <!-- Imagem do Veículo -->
                    <div class="position-relative" style="height: 200px; overflow: hidden;">
                        @if (reserva.Veiculo.Imagens.Any())
                        {
                            <img src="@reserva.Veiculo.Imagens.First().CaminhoFicheiro"
                                 class="card-img-top"
                                 alt="@reserva.Veiculo.Marca"
                                 style="object-fit: cover; height: 100%;">
                        }
                        else
                        {
                            <img src="https://via.placeholder.com/400x300?text=Sem+Imagem"
                                 class="card-img-top"
                                 alt="Sem imagem"
                                 style="object-fit: cover; height: 100%;">
                        }

                        <!-- Badge de Estado -->
                        <span class="position-absolute top-0 end-0 m-2">
                            @if (reserva.Estado == EstadoReserva.Pendente)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-hourglass-split"></i> Pendente
                                </span>
                            }
                            else if (reserva.Estado == EstadoReserva.Confirmada)
                            {
                                <span class="badge bg-info text-white">
                                    <i class="bi bi-check-circle"></i> Confirmada
                                </span>
                            }
                            else if (reserva.Estado == EstadoReserva.Expirada)
                            {
                                <span class="badge bg-secondary">
                                    <i class="bi bi-x-circle"></i> Expirada
                                </span>
                            }
                            else if (reserva.Estado == EstadoReserva.Cancelada)
                            {
                                <span class="badge bg-danger">
                                    <i class="bi bi-trash"></i> Cancelada
                                </span>
                            }
                            else if (reserva.Estado == EstadoReserva.Concluida)
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-check-all"></i> Concluida
                                </span>
                            }
                        </span>
                    </div>

                    <div class="card-body">
                        <!-- Titulo e Detalhes -->
                        <h5 class="card-title">
                            @reserva.Veiculo.Marca <strong>@reserva.Veiculo.Modelo</strong>
                        </h5>

                        <p class="card-text text-muted small">
                            <i class="bi bi-calendar"></i> @reserva.Veiculo.Ano |
                            <i class="bi bi-speedometer2"></i> @reserva.Veiculo.Km km
                        </p>

                        <!-- Preço -->
                        <h6 class="text-success fw-bold">
                            @reserva.Veiculo.Preco.ToString("N2")
                        </h6>

                        <!-- Informações de Reserva -->
                        <div class="small text-muted mb-3">
                            <p class="mb-1">
                                <i class="bi bi-calendar-event"></i>
                                Criada: @reserva.DataCriacao.ToShortDateString()
                            </p>
                            <p class="mb-1">
                                <i class="bi bi-calendar-x"></i>
                                Válida até: <strong>@reserva.DataExpiracao.ToShortDateString()</strong>
                            </p>
                            @if (reserva.MotivoCancel != null)
                            {
                                <p class="mb-1">
                                    <i class="bi bi-info-circle"></i>
                                    Motivo: @reserva.MotivoCancel
                                </p>
                            }
                        </div>

                        <!-- Vendedor -->
                        <p class="card-text small">
                            <i class="bi bi-person"></i>
                            <strong>Vendedor:</strong> @reserva.Veiculo.Vendedor.User.Nome
                        </p>
                    </div>

                    <div class="card-footer bg-white border-top">
                        <!-- Botões de Ação -->
                        @if (reserva.Valida)
                        {
                            <!-- Reserva ainda é válida -->
                            <div class="d-grid gap-2">
                                <a href="@Url.Action("Agendar", "Visitas", new { veiculoId = reserva.VeiculoId })"
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-calendar-check"></i> Agendar Visita
                                </a>
                            </div>

                            <div class="d-grid gap-2 mt-2">
                                <a href="@Url.Action("Detalhes", "Reservas", new { id = reserva.Id })"
                                   class="btn btn-info btn-sm">
                                    <i class="bi bi-eye"></i> Ver Detalhes
                                </a>
                            </div>

                            <form asp-action="Cancelar" asp-controller="Reservas" method="post" class="mt-2">
                                <input type="hidden" name="id" value="@reserva.Id" />
                                <button type="submit"
                                        class="btn btn-danger btn-sm w-100"
                                        onclick="return confirm('Tem a certeza que quer cancelar?')">
                                    <i class="bi bi-trash"></i> Cancelar Reserva
                                </button>
                            </form>
                        }
                        else
                        {
                            <!-- Reserva expirada ou cancelada -->
                            <div class="alert alert-warning small mb-0">
                                <i class="bi bi-exclamation-triangle"></i>
                                Esta reserva não é mais válida.
                            </div>
                            <a href="@Url.Action("Detalhe", "Veiculos", new { id = reserva.VeiculoId })"
                               class="btn btn-outline-secondary btn-sm w-100 mt-2">
                                <i class="bi bi-eye"></i> Ver Veículo
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>
</file>

<file path="Areas/Public/Views/Shared/_Header.cshtml">
@using AutoMarket.Models;
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<Utilizador> SignInManager

<header class="bg-primary py-3 sticky-top shadow-sm">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand fw-bold fs-5" asp-area="Public" asp-controller="Home" asp-action="Index">
                AutoMarket
            </a>

            <!-- Toggler para Mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Menu Principal -->
            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Links Centrais -->
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link fw-semibold" asp-area="Public" asp-controller="Veiculos" asp-action="Index">
                            <i class="bi bi-car-front-fill me-1"></i>Anúncios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="Public" asp-controller="Home" asp-action="Sobre">
                            <i class="bi bi-info-circle me-1"></i>Sobre
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="Public" asp-controller="Home" asp-action="Ajuda">
                            <i class="bi bi-question-circle me-1"></i>Ajuda
                        </a>
                    </li>
                </ul>

                <!-- Links Direita (Autenticação) -->
                <partial name="~/Areas/Public/Views/Shared/_LoginPartial.cshtml" />
            </div>
        </div>
    </nav>
</header>

<style>
    header .navbar-dark .nav-link:hover {
        color: var(--cor-cta) !important;
        transition: color 0.2s;
    }

    header .btn-warning:hover {
        background-color: #e6a800 !important;
    }
</style>
</file>

<file path="Areas/Public/Views/Shared/_LoginPartial.cshtml">
@using AutoMarket.Models.Entities
@using Microsoft.AspNetCore.Identity

@inject SignInManager<Utilizador> SignInManager
@inject UserManager<Utilizador> UserManager

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Index" title="Gerir Conta">
				@UserManager.GetUserName(User)
			</a>
        </li>
        <li class="nav-item">
            <form method="post" asp-area="Public" asp-controller="Conta" asp-action="Logout" style="display: inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="nav-link btn btn-link text-dark border-0" style="cursor: pointer;">Sair</button>
            </form>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Register">Registar</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" asp-area="Public" asp-controller="Conta" asp-action="Login">Entrar</a>
        </li>
    }
</ul>
</file>

<file path="Areas/Public/Views/Veiculos/Index.cshtml">
@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    ViewData["Title"] = "Pesquisa de Veículos";
    Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- SIDEBAR FILTROS (Esquerda) -->
        <aside class="col-lg-3 col-md-4 col-12">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/Veiculos/BuscarAjax" id="filtrosForm">
                        
                        <!-- Marca -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Marca</label>
                            <select name="marca" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todas as marcas --</option>
                                @foreach (var m in (ViewData["Marcas"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["MarcaSelecionada"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Modelo -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Modelo</label>
                            <select name="modelo" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os modelos --</option>
                                @foreach (var m in (ViewData["Modelos"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["ModeloSelecionado"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Combustível -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Combustível</label>
                            <select name="combustivel" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos --</option>
                                @foreach (var c in (ViewData["Combustiveis"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@c" selected="@(ViewData["CombustivelSelecionado"]?.ToString() == c)">@c</option>
                                }
                            </select>
                        </div>

                        <!-- Ano -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ano</label>
                            <select name="ano" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os anos --</option>
                                @foreach (var a in (ViewData["Anos"] as List<int>) ?? new List<int>())
                                {
                                    <option value="@a" selected="@(ViewData["AnoSelecionado"]?.ToString() == a.ToString())">@a</option>
                                }
                            </select>
                        </div>

                        <!-- Tipo/Segmento -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tipo (Segmento)</label>
                            <select name="categoria" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os tipos --</option>
                                @foreach (var cat in (ViewData["Categorias"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@cat" selected="@(ViewData["CategoriaSelecionada"]?.ToString() == cat)">@cat</option>
                                }
                            </select>
                        </div>

                        <!-- Preço Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Preço (€)</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="precoMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["PrecoMin"]" />
                                <input type="number" name="precoMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["PrecoMax"]" />
                            </div>
                        </div>

                        <!-- KM Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Quilómetros</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="kmMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["KmMin"]" />
                                <input type="number" name="kmMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["KmMax"]" />
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm" id="btnPesquisar">
                                <i class="bi bi-search"></i> Pesquisar
                            </button>
                            <a href="/Veiculos/Index" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <!-- ANÚNCIOS (Direita) -->
        <section class="col-lg-9 col-md-8 col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Veículos Disponíveis</h5>
                    <div>
                        <label class="form-label mb-0 me-2">Ordenar:</label>
                        <select id="ordenacao" class="form-select form-select-sm d-inline w-auto filtro-select">
                            <option value="recente" selected="@(ViewData["Ordenacao"]?.ToString() == "recente")">Mais recente</option>
                            <option value="preco_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_asc")">Preço ascendente</option>
                            <option value="preco_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_desc")">Preço descendente</option>
                            <option value="km_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_asc")">KM ascendentes</option>
                            <option value="km_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_desc")">KM descendentes</option>
                            <option value="ano_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_asc")">Ano ascendente</option>
                            <option value="ano_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_desc")">Ano descendente</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- LOADING SPINNER -->
            <div id="loadingSpinner" class="text-center" style="display: none; padding: 3rem;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-3">Procurando veículos...</p>
            </div>

            <!-- CONTENTOR DE RESULTADOS (será preenchido via AJAX) -->
            <div id="resultado">
                @await Html.PartialAsync("_CarListPartial", Model)
            </div>
        </section>
    </div>
</div>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<script>
    // ============================================================
    // AJAX LISTENER - Pesquisa dinâmica sem recarregar página
    // ============================================================

    function executarBusca() {
        // Mostrar loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('resultado').style.opacity = '0.5';

        // Obter dados do formulário
        const formData = new FormData(document.getElementById('filtrosForm'));
        const ordenacao = document.getElementById('ordenacao').value;
        formData.append('ordenacao', ordenacao);

        // Fazer requisição AJAX
        fetch('/Veiculos/BuscarAjax', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            // Substituir conteúdo do resultado
            document.getElementById('resultado').innerHTML = html;
            document.getElementById('resultado').style.opacity = '1';

            // Adicionar listeners aos links de paginação
            adicionarListenersPaginacao();

            // Scroll suave até os resultados
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Erro ao pesquisar:', error);
            document.getElementById('resultado').innerHTML = `
                <div class="alert alert-danger text-center">
                    <h6>Erro ao carregar resultados</h6>
                    <p>${error.message}</p>
                </div>
            `;
            document.getElementById('resultado').style.opacity = '1';
        })
        .finally(() => {
            // Esconder loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
        });
    }

    function adicionarListenersPaginacao() {
        // Listeners para links de paginação
        document.querySelectorAll('.pagination-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                const formData = new FormData(document.getElementById('filtrosForm'));
                formData.append('page', page);
                formData.append('ordenacao', document.getElementById('ordenacao').value);

                // Repetir busca com nova página
                executarBusca();
            });
        });
    }

    // ============================================================
    // INICIALIZAÇÃO
    // ============================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Listeners nos filtros (select e input)
        document.querySelectorAll('.filtro-select, .filtro-input').forEach(element => {
            element.addEventListener('change', executarBusca);
        });

        // Listener na dropdown de ordenação
        document.getElementById('ordenacao').addEventListener('change', executarBusca);

        // Listener no botão pesquisar (para Enter em inputs)
        document.getElementById('filtrosForm').addEventListener('submit', (e) => {
            e.preventDefault();
            executarBusca();
        });

        // Listeners iniciais na paginação
        adicionarListenersPaginacao();
    });
</script>
</file>

<file path="Areas/Public/Views/Visitas/MinhasVisitas.cshtml">
@model List<AutoMarket.Models.Entities.Visita>
@using AutoMarket.Models.Enums

@{
    ViewData["Title"] = "Minhas Visitas";
}

<div class="container py-5">
    <h1 class="mb-4">
        <i class="bi bi-calendar-check"></i> Minhas Visitas Agendadas
    </h1>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model == null || Model.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> Ainda não agendou nenhuma visita.
            <a href="@Url.Action("Index", "Veiculos")" class="alert-link">Procurar veículos e agendar</a>
        </div>
        return;
    }

    <!-- Separar visitas por status -->
    @{
        var visitasProximas = Model.Where(v => v.Agendada).OrderBy(v => v.DataHora).ToList();
        var visitasPassadas = Model.Where(v => !v.Agendada).OrderByDescending(v => v.DataHora).ToList();
    }

    @if (visitasProximas.Any())
    {
        <h4 class="mb-3 mt-4">
            <i class="bi bi-hourglass-split"></i> Próximas Visitas
        </h4>

        <div class="row g-4 mb-5">
            @foreach (var visita in visitasProximas)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-primary">
                        <!-- Imagem -->
                        <div style="height: 200px; overflow: hidden;">
                            @if (visita.Veiculo.Imagens.Any())
                            {
                                <img src="@visita.Veiculo.Imagens.First().CaminhoFicheiro"
                                     class="card-img-top"
                                     alt="@visita.Veiculo.Marca"
                                     style="object-fit: cover; height: 100%;">
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/400x300"
                                     class="card-img-top"
                                     alt="Sem imagem">
                            }

                            <!-- Estado Badge -->
                            <span class="position-absolute top-0 end-0 m-2">
                                @if (visita.Estado == EstadoVisita.Pendente)
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-hourglass-split"></i> Aguardando Confirmação
                                    </span>
                                }
                                else if (visita.Estado == EstadoVisita.Confirmada)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Confirmada
                                    </span>
                                }
                            </span>
                        </div>

                        <div class="card-body">
                            <!-- Veículo -->
                            <h5 class="card-title">
                                @visita.Veiculo.Marca <strong>@visita.Veiculo.Modelo</strong>
                            </h5>

                            <!-- Data/Hora -->
                            <div class="alert alert-light border-primary mb-3">
                                <i class="bi bi-calendar-event"></i>
                                <strong>@visita.DataHora.ToString("dddd, dd/MM/yyyy 'às' HH:mm")</strong><br>
                                <small class="text-muted">Agendada em @visita.DataAgendamento.ToShortDateString()</small>
                            </div>

                            <!-- Vendedor -->
                            <p class="small mb-2">
                                <i class="bi bi-person"></i>
                                <strong>Vendedor:</strong> @visita.Vendedor.User.Nome<br>
                                <i class="bi bi-telephone"></i> @visita.Vendedor.User.PhoneNumber
                            </p>

                            <!-- Notas do Comprador -->
                            @if (!string.IsNullOrEmpty(visita.Notas))
                            {
                                <div class="small text-muted border-start ps-2 mb-2">
                                    <i class="bi bi-chat-dots"></i>
                                    <strong>Suas notas:</strong><br>
                                    @visita.Notas
                                </div>
                            }

                            <!-- Notas do Vendedor -->
                            @if (!string.IsNullOrEmpty(visita.NotasVendedor))
                            {
                                <div class="alert alert-info small mb-2">
                                    <i class="bi bi-chat-left"></i>
                                    <strong>Notas do Vendedor:</strong><br>
                                    @visita.NotasVendedor
                                </div>
                            }
                        </div>

                        <div class="card-footer bg-white border-top">
                            <div class="d-grid gap-2">
                                <a href="@Url.Action("Detalhe", "Reservas", new { id = visita.VeiculoId })"
                                   class="btn btn-info btn-sm">
                                    <i class="bi bi-eye"></i> Ver Veículo
                                </a>
                            </div>

                            @if (visita.Agendada)
                            {
                                <form asp-action="CancelarVisita" asp-controller="Visitas" method="post" class="mt-2">
                                    <input type="hidden" name="id" value="@visita.Id" />
                                    <button type="submit"
                                            class="btn btn-danger btn-sm w-100"
                                            onclick="return confirm('Tem a certeza?')">
                                        <i class="bi bi-trash"></i> Cancelar Visita
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @if (visitasPassadas.Any())
    {
        <h4 class="mb-3 mt-4">
            <i class="bi bi-clock-history"></i> Histórico de Visitas
        </h4>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Veículo</th>
                        <th>Data</th>
                        <th>Vendedor</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visita in visitasPassadas)
                    {
                        <tr>
                            <td>
                                <strong>@visita.Veiculo.Marca @visita.Veiculo.Modelo</strong>
                            </td>
                            <td>
                                @visita.DataHora.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td>
                                @visita.Vendedor.User.Nome
                            </td>
                            <td>
                                @if (visita.Estado == EstadoVisita.Realizada)
                                {
                                    <span class="badge bg-success">Realizada</span>
                                }
                                else if (visita.Estado == EstadoVisita.Cancelada)
                                {
                                    <span class="badge bg-danger">Cancelada</span>
                                }
                                else if (visita.Estado == EstadoVisita.NaoRealizada)
                                {
                                    <span class="badge bg-warning">Não Realizada</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@visita.Estado</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
</file>

<file path="Areas/Public/Views/Visitas/VendedorDashboard.cshtml">
@model List<AutoMarket.Models.Entities.Visita>
@using AutoMarket.Models.Enums

@{
    ViewData["Title"] = "Painel de Visitas";
}

<div class="container-fluid py-5">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <i class="bi bi-calendar2-check"></i> Painel de Visitas Agendadas
            </h1>
            <p class="text-muted">Gerencie as visitas que os compradores agendaram para seus ve�culos</p>
        </div>
    </div>

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Sucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Erro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model == null || Model.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> Nenhuma visita agendada ainda.
        </div>
        return;
    }

    <!-- Estat�sticas -->
    @{
        var pendentes = Model.Count(v => v.Estado == EstadoVisita.Pendente);
        var confirmadas = Model.Count(v => v.Estado == EstadoVisita.Confirmada);
        var realizadas = Model.Count(v => v.Estado == EstadoVisita.Realizada);
        var canceladas = Model.Count(v => v.Estado == EstadoVisita.Cancelada);
    }

    <div class="row mb-5 g-3">
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="bi bi-hourglass-split"></i>
                    </h5>
                    <h3 class="card-text">@pendentes</h3>
                    <small class="text-muted">Aguardando Confirma��o</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h5 class="card-title text-success">
                        <i class="bi bi-check-circle"></i>
                    </h5>
                    <h3 class="card-text">@confirmadas</h3>
                    <small class="text-muted">Confirmadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        <i class="bi bi-calendar-check"></i>
                    </h5>
                    <h3 class="card-text">@realizadas</h3>
                    <small class="text-muted">Realizadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">
                        <i class="bi bi-x-circle"></i>
                    </h5>
                    <h3 class="card-text">@canceladas</h3>
                    <small class="text-muted">Canceladas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Visitas Organizadas por Estado -->
    @{
        var visitasPendentes = Model.Where(v => v.Estado == EstadoVisita.Pendente).OrderBy(v => v.DataHora).ToList();
        var visitasConfirmadas = Model.Where(v => v.Estado == EstadoVisita.Confirmada).OrderBy(v => v.DataHora).ToList();
        var outrasVisitas = Model.Where(v => v.Estado != EstadoVisita.Pendente && v.Estado != EstadoVisita.Confirmada).OrderByDescending(v => v.DataHora).ToList();
    }

    @if (visitasPendentes.Any())
    {
        <h4 class="mb-3 text-warning">
            <i class="bi bi-hourglass-split"></i> Aguardando Confirma��o (@visitasPendentes.Count)
        </h4>

        <div class="table-responsive mb-5">
            <table class="table table-hover border">
                <thead class="table-warning">
                    <tr>
                        <th>Ve�culo</th>
                        <th>Comprador</th>
                        <th>Data/Hora</th>
                        <th>Contato</th>
                        <th>Notas</th>
                        <th>A��es</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visita in visitasPendentes)
                    {
                        <tr>
                            <td>
                                <strong>@visita.Veiculo.Marca @visita.Veiculo.Modelo</strong><br>
                                <small class="text-muted">@visita.Veiculo.Ano</small>
                            </td>
                            <td>
                                @visita.Comprador.User.Nome
                            </td>
                            <td>
                                <strong>@visita.DataHora.ToString("dd/MM/yyyy HH:mm")</strong><br>
                                <small class="text-muted">
                                    @{
                                        var diasFalta = (visita.DataHora - DateTime.UtcNow).TotalDays;
                                        if (diasFalta < 1)
                                        {
                                            <span class="badge bg-danger">Hoje/Amanh�</span>
                                        }
                                        else
                                        {
                                            <span>Em @Math.Round(diasFalta) dias</span>
                                        }
                                    }
                                </small>
                            </td>
                            <td>
                                <i class="bi bi-telephone"></i> @visita.Comprador.User.PhoneNumber<br>
                                <i class="bi bi-envelope"></i>
                                <small>@visita.Comprador.User.Email</small>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(visita.Notas))
                                {
                                    <small class="text-muted">@visita.Notas</small>
                                }
                                else
                                {
                                    <small class="text-muted">-</small>
                                }
                            </td>
                            <td>
                                <form asp-action="ConfirmarVisita" asp-controller="Visitas" method="post" style="display:inline;">
                                    <input type="hidden" name="id" value="@visita.Id" />
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="bi bi-check-circle"></i> Confirmar
                                    </button>
                                </form>

                                <form asp-action="CancelarVisita" asp-controller="Visitas" method="post" style="display:inline;">
                                    <input type="hidden" name="id" value="@visita.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Deseja rejeitar?')">
                                        <i class="bi bi-x-circle"></i> Rejeitar
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (visitasConfirmadas.Any())
    {
        <h4 class="mb-3 text-success">
            <i class="bi bi-check-circle"></i> Confirmadas (@visitasConfirmadas.Count)
        </h4>

        <div class="table-responsive mb-5">
            <table class="table table-hover border">
                <thead class="table-success">
                    <tr>
                        <th>Veículo</th>
                        <th>Comprador</th>
                        <th>Data/Hora</th>
                        <th>Contato</th>
                        <th>Notas Comprador</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visita in visitasConfirmadas)
                    {
                        <tr>
                            <td>
                                <strong>@visita.Veiculo.Marca @visita.Veiculo.Modelo</strong><br>
                                <small class="text-muted">@visita.Veiculo.Preco.ToString("N2")</small>
                            </td>
                            <td>
                                @visita.Comprador.User.Nome
                            </td>
                            <td>
                                <strong>@visita.DataHora.ToString("dd/MM/yyyy HH:mm")</strong>

                                @if (visita.DataJaPassou)
                                {
                                    <br>
                                    <small class="badge bg-danger">Data Passou</small>
                                }
                                else
                                {
                                    <br>
                                    <small class="text-muted">Em @Math.Round((visita.DataHora - DateTime.UtcNow).TotalHours) horas</small>
                                }
                            </td>
                            <td>
                                <i class="bi bi-telephone"></i> @visita.Comprador.User.PhoneNumber<br>
                                <i class="bi bi-envelope"></i>
                                <small>@visita.Comprador.User.Email</small>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(visita.Notas))
                                {
                                    <small>@visita.Notas</small>
                                }
                                else
                                {
                                    <small class="text-muted">-</small>
                                }
                            </td>
                            <td>
                                @if (visita.DataJaPassou)
                                {
                                    <form asp-action="MarcarRealizada" asp-controller="Visitas" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@visita.Id" />
                                        <button type="submit" class="btn btn-sm btn-info">
                                            <i class="bi bi-calendar-check"></i> Marcar Realizada
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (outrasVisitas.Any())
    {
        <h4 class="mb-3">
            <i class="bi bi-clock-history"></i> Histórico
        </h4>

        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Veículo</th>
                        <th>Comprador</th>
                        <th>Data/Hora</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visita in outrasVisitas)
                    {
                        <tr class="table-light">
                            <td>
                                @visita.Veiculo.Marca @visita.Veiculo.Modelo
                            </td>
                            <td>
                                @visita.Comprador.User.Nome
                            </td>
                            <td>
                                @visita.DataHora.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td>
                                @if (visita.Estado == EstadoVisita.Realizada)
                                {
                                    <span class="badge bg-success">Realizada</span>
                                }
                                else if (visita.Estado == EstadoVisita.Cancelada)
                                {
                                    <span class="badge bg-danger">Cancelada</span>
                                }
                                else if (visita.Estado == EstadoVisita.NaoRealizada)
                                {
                                    <span class="badge bg-warning">Não Realizada</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
</file>

<file path="Areas/Vendedores/Controllers/VeiculosController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Models.ViewModels.Veiculos;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Areas.Vendedores.Controllers
{
    /// <summary>
    /// Controller para gerenciar ve�culos da �rea de Vendedores.
    /// Requer autenticação e email confirmado.
    /// </summary>
    [Area("Vendedores")]
    [Authorize(Policy = "VendedorAprovado")]
    public class VeiculosController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly IFileService _fileService;
        private readonly ILogger<VeiculosController> _logger;

        public VeiculosController(
            ApplicationDbContext context,
            IFileService fileService,
            ILogger<VeiculosController> logger)
        {
            _context = context;
            _fileService = fileService;
            _logger = logger;
        }

        /// <summary>
        /// Obt�m o vendedor logado pelo userId do contexto.
        /// </summary>
        private async Task<Vendedor?> GetVendedorLogado()
        {
            var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
                return null;

            return await _context.Vendedores.FirstOrDefaultAsync(v => v.UserId == userId);
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Index
        /// Lista todos os ve�culos do vendedor logado (excluindo removidos).
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Index()
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de acesso a Index sem vendedor logado");
                return Unauthorized();
            }

            var veiculos = await _context.Veiculos
                .Where(v => v.VendedorId == vendedor.Id && v.Estado != EstadoVeiculo.Pausado)
                .OrderByDescending(v => v.DataCriacao)
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .ToListAsync();

            var viewModel = veiculos.Select(v => ListVeiculoViewModel.FromVeiculo(v)).ToList();
            return View(viewModel);
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Create
        /// Exibe formul�rio para criar novo ve�culo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Create()
        {
            var viewModel = new CreateVeiculoViewModel
            {
                CategoriesDropdown = await _context.Categorias.ToListAsync()
            };
            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Create
        /// Cria um novo ve�culo no sistema com upload de imagens.
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create(CreateVeiculoViewModel viewModel)
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de cria��o de ve�culo sem vendedor logado");
                return Unauthorized();
            }

            if (!ModelState.IsValid)
            {
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }

            try
            {
                // Fazer upload das imagens se fornecidas
                List<VeiculoImagem> imagens = new();

                if (viewModel.Fotos?.Any() == true)
                {
                    var uploadedFiles = await _fileService.UploadMultipleFilesAsync(
                        viewModel.Fotos.ToList(),
                        "images/veiculos"
                    );

                    bool isPrimeiraImagem = true;
                    foreach (var fileName in uploadedFiles)
                    {
                        imagens.Add(new VeiculoImagem
                        {
                            CaminhoFicheiro = fileName,
                            IsCapa = isPrimeiraImagem,
                            ContentType = MimeTypeHelper.GetMimeType(fileName)
                        });

                        if (isPrimeiraImagem)
                            isPrimeiraImagem = false;
                    }
                }

                // Converter ViewModel para Model
                var veiculo = viewModel.ToVeiculo(vendedor.Id);
                veiculo.Imagens = imagens;

                // Guardar na base de dados
                _context.Veiculos.Add(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo criado com sucesso. ID: {VeiculoId}, Vendedor: {VendedorId}, Imagens: {ImagemCount}",
                    veiculo.Id, vendedor.Id, imagens.Count);

                TempData["Sucesso"] = $"Ve�culo '{veiculo.Marca} {veiculo.Modelo}' criado com sucesso com {imagens.Count} imagens!";
                return RedirectToAction(nameof(Index));
            }
            catch (ArgumentException ex)
            {
                _logger.LogError(ex, "Erro na valida��o de ficheiro durante cria��o de ve�culo");
                ModelState.AddModelError("Fotos", ex.Message);
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (DbUpdateException ex)
            {
                // Check for SQL Server Unique Constraint Violation
                if (ex.InnerException is SqlException sqlEx 
                    && (sqlEx.Number == 2601 || sqlEx.Number == 2627))
                {
                    ModelState.AddModelError("", "Já existe um veículo registado com estes dados.");
                }
                else
                {
                    _logger.LogError(ex, "Database error creating vehicle for vendedor {VendedorId}", vendedor.Id);
                    ModelState.AddModelError("", "Erro de base de dados. Tente novamente.");
                }
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao criar ve�culo para vendedor {VendedorId}", vendedor.Id);
                ModelState.AddModelError(string.Empty, "Erro ao guardar o ve�culo. Tente novamente.");
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Edit/5
        /// Exibe formul�rio para editar um ve�culo existente.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Edit(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de edi��o sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado. ID: {VeiculoId}", id);
                return NotFound();
            }

            // Verificar se o ve�culo pertence ao vendedor logado
            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de edi��o de ve�culo de outro vendedor. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            var viewModel = EditVeiculoViewModel.FromVeiculo(veiculo);
            viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();

            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Edit/5
        /// Atualiza um ve�culo existente com novo upload de imagens (opcional).
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(int id, EditVeiculoViewModel viewModel)
        {
            if (id != viewModel.Id)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de edi��o sem vendedor logado");
                return Unauthorized();
            }

            if (!ModelState.IsValid)
            {
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }

            var veiculoExistente = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculoExistente == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para edi��o. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculoExistente.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de edi��o n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            try
            {
                // Fazer upload de novas imagens se fornecidas
                if (viewModel.Fotos?.Any() == true)
                {
                    var uploadedFiles = await _fileService.UploadMultipleFilesAsync(
                        viewModel.Fotos.ToList(),
                        "images/veiculos"
                    );

                    foreach (var fileName in uploadedFiles)
                    {
                        veiculoExistente.Imagens.Add(new VeiculoImagem
                        {
                            CaminhoFicheiro = fileName,
                            IsCapa = veiculoExistente.Imagens.Count == 0,
                            ContentType = MimeTypeHelper.GetMimeType(fileName),
                            VeiculoId = veiculoExistente.Id
                        });
                    }
                }

                // Atualizar campos do ve�culo
                veiculoExistente.Titulo = viewModel.Titulo;
                veiculoExistente.Marca = viewModel.Marca;
                veiculoExistente.Modelo = viewModel.Modelo;
                veiculoExistente.Ano = viewModel.Ano;
                veiculoExistente.CategoriaId = viewModel.CategoriaId;
                veiculoExistente.Combustivel = viewModel.Combustivel;
                veiculoExistente.Caixa = viewModel.Caixa;
                veiculoExistente.Km = viewModel.Km;
                veiculoExistente.Preco = viewModel.Preco;
                veiculoExistente.Condicao = viewModel.Condicao;
                veiculoExistente.Localizacao = viewModel.Localizacao;
                veiculoExistente.Descricao = viewModel.Descricao;

                _context.Veiculos.Update(veiculoExistente);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo atualizado com sucesso. ID: {VeiculoId}, Vendedor: {VendedorId}",
                    id, vendedor.Id);

                TempData["Sucesso"] = "Ve�culo atualizado com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            catch (ArgumentException ex)
            {
                _logger.LogError(ex, "Erro na valida��o de ficheiro durante edi��o de ve�culo");
                ModelState.AddModelError("Fotos", ex.Message);
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (DbUpdateException ex)
            {
                // Check for SQL Server Unique Constraint Violation
                if (ex.InnerException is SqlException sqlEx 
                    && (sqlEx.Number == 2601 || sqlEx.Number == 2627))
                {
                    ModelState.AddModelError("", "Já existe um veículo registado com estes dados.");
                }
                else
                {
                    _logger.LogError(ex, "Database error updating vehicle. ID: {VeiculoId}", id);
                    ModelState.AddModelError("", "Erro de base de dados. Tente novamente.");
                }
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao atualizar ve�culo. ID: {VeiculoId}", id);
                ModelState.AddModelError(string.Empty, "Erro ao guardar o ve�culo. Tente novamente.");
                viewModel.CategoriesDropdown = await _context.Categorias.ToListAsync();
                return View(viewModel);
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Delete/5
        /// Exibe confirma��o antes de eliminar um ve�culo (soft delete).
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Delete(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de elimina��o sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para elimina��o. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de elimina��o n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            var viewModel = ListVeiculoViewModel.FromVeiculo(veiculo);
            return View(viewModel);
        }

        /// <summary>
        /// POST: Vendedores/Veiculos/Delete/5
        /// Executa soft delete (muda estado para Pausado).
        /// </summary>
        [HttpPost]
        [ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteConfirmed(int id)
        {
            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de soft delete sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos.FirstOrDefaultAsync(v => v.Id == id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado para soft delete. ID: {VeiculoId}", id);
                return NotFound();
            }

            if (veiculo.VendedorId != vendedor.Id)
            {
                _logger.LogWarning(
                    "Tentativa de soft delete n�o autorizada. VeiculoId: {VeiculoId}, VendedorId: {VendedorId}",
                    id, vendedor.Id);
                return Forbid();
            }

            try
            {
                // Soft Delete: Mudar estado para Pausado (mant�m dados para recuperar)
                veiculo.Estado = EstadoVeiculo.Pausado;

                _context.Veiculos.Update(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Ve�culo removido (soft delete). ID: {VeiculoId}, Vendedor: {VendedorId}",
                    id, vendedor.Id);

                TempData["Sucesso"] = "Ve�culo removido com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao remover ve�culo. ID: {VeiculoId}", id);
                TempData["Erro"] = "Erro ao remover o ve�culo. Tente novamente.";
                return RedirectToAction(nameof(Index));
            }
        }

        /// <summary>
        /// GET: Vendedores/Veiculos/Details/5
        /// Exibe detalhes de um ve�culo.
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Details(int? id)
        {
            if (!id.HasValue)
                return NotFound();

            var vendedor = await GetVendedorLogado();
            if (vendedor == null)
            {
                _logger.LogWarning("Tentativa de visualiza��o de detalhes sem vendedor logado");
                return Unauthorized();
            }

            var veiculo = await _context.Veiculos
                .Include(v => v.Imagens)
                .Include(v => v.Categoria)
                .FirstOrDefaultAsync(v => v.Id == id && v.VendedorId == vendedor.Id);

            if (veiculo == null)
            {
                _logger.LogWarning("Ve�culo n�o encontrado. ID: {VeiculoId}", id);
                return NotFound();
            }

            var viewModel = ListVeiculoViewModel.FromVeiculo(veiculo);
            return View(viewModel);
        }
    }

    /// <summary>
    /// Helper para obter MIME types de ficheiros.
    /// </summary>
    internal static class MimeTypeHelper
    {
        public static string GetMimeType(string fileName)
        {
            return Path.GetExtension(fileName).ToLower() switch
            {
                ".jpg" or ".jpeg" => "image/jpeg",
                ".png" => "image/png",
                ".webp" => "image/webp",
                ".gif" => "image/gif",
                _ => "image/jpeg"
            };
        }
    }
}
</file>

<file path="Models/Entities/Reserva.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Representa uma reserva de veiculo feita por um comprador.
    /// 
    /// Workflow:
    /// 1. Comprador clica em "Reservar" ? Reserva criada (Pendente)
    /// 2. Sistema define DataExpiracao (ex: 7 dias)
    /// 3. Se expirar ? Estado = Expirada
    /// 4. Se comprador confirma ? Estado = Confirmada
    /// 5. Se comprador compra ? Estado = Concluida + cria Transacao
    /// 6. Se cancelado ? Estado = Cancelada
    /// 
    /// Durante a reserva, o ve�culo passa para estado "Reservado" (bloqueado temporariamente).
    /// </summary>
    public class Reserva
    {
        [Key]
        public int Id { get; set; }

        /// <summary>Veiculo que esta a ser reservado</summary>
        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; } = null!;

        /// <summary>Comprador que fez a reserva</summary>
        [Required]
        public int CompradorId { get; set; }

        [ForeignKey("CompradorId")]
        public Comprador Comprador { get; set; } = null!;

        /// <summary>Quando a reserva foi criada</summary>
        [Display(Name = "Data de Criação")]
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        /// <summary>Até quando a reserva é valida</summary>
        [Display(Name = "Data de Expiração")]
        public DateTime DataExpiracao { get; set; }

        /// <summary>Estado actual da reserva</summary>
        [Display(Name = "Estado")]
        public EstadoReserva Estado { get; set; } = EstadoReserva.Pendente;

        /// <summary>Razão do cancelamento (se aplicável)</summary>
        [StringLength(500)]
        public string? MotivoCancel { get; set; }

        /// <summary>Notas do comprador na reserva</summary>
        [StringLength(500)]
        public string? Notas { get; set; }

        /// <summary>
        /// Verifica se a reserva expirou.
        /// Util para validação antes de operações.
        /// </summary>
        public bool Expirada => DateTime.UtcNow > DataExpiracao && Estado == EstadoReserva.Pendente;

        /// <summary>
        /// Verifica se a reserva ainda é valida (não expirou e não foi cancelada).
        /// </summary>
        public bool Valida => !Expirada && Estado != EstadoReserva.Cancelada && Estado != EstadoReserva.Expirada;
    }
}
</file>

<file path="Models/Entities/Veiculo.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Modelo genérico para Veículos (Carros, Motas, etc.)
    /// Representa um veiculo listado para venda no catálogo.
    /// </summary>
    public class Veiculo
    {
        [Key]
        public int Id { get; set; }

        // --- Dados do veiculo ---
        [Required(ErrorMessage = "O titulo e obrigatorio")]
        [StringLength(100, ErrorMessage = "Maximo de 100 caracteres.")]
        [Display(Name = "Titulo do Anuncio")]
        public string Titulo { get; set; } // Ex: "McLaren MP4-4 do Senna"

        [Required]
        [StringLength(50)]
        public string Marca { get; set; } // Ex: McLaren

        [Required]
        [StringLength(50)]
        public string Modelo { get; set; } // Ex: MP4-4

        [Required]
        [Display(Name = "Categoria")]
        public int CategoriaId { get; set; }

        [ForeignKey("CategoriaId")]
        public Categoria Categoria { get; set; }

        [Required]
        [Display(Name = "Ano")]
        [Range(1900, 2100, ErrorMessage = "Ano invalido.")]
        public int Ano { get; set; }

        [Required]
        [DataType(DataType.Currency)]
        [Display(Name = "Preco")]
        [Range(0, 99999999, ErrorMessage = "Valor invalido.")]
        public decimal Preco { get; set; }

        [Display(Name = "Quilometros")]
        [Range(0, int.MaxValue, ErrorMessage = "Valor nao pode ser negativo.")]
        public int Km { get; set; }

        [Required]
        [StringLength(20)]
        [Display(Name = "Combustivel")]
        public string Combustivel { get; set; }

        [Required]
        [StringLength(20)]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; }

        [Required]
        [StringLength(100)]
        [Display(Name = "Localizacao")]
        public string Localizacao { get; set; }

        [StringLength(50)]
        [Display(Name = "Condicao")]
        public string? Condicao { get; set; }

        [Required]
        [DataType(DataType.MultilineText)]
        [StringLength(2000, ErrorMessage = "A descricao e demasiado longa.")]
        [Display(Name = "Descricao Detalhada")]
        public string Descricao { get; set; }

        // --- Estado e Controlo ---
        [Display(Name = "Estado")]
        public EstadoVeiculo Estado { get; set; } = EstadoVeiculo.Ativo;

        [Display(Name = "Publicado em")]
        public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

        // --- Relacao com Vendedor (1 Vendedor -> N Veiculos) ---
        [Required]
        public int VendedorId { get; set; }

        [ForeignKey("VendedorId")]
        public Vendedor Vendedor { get; set; }

        // --- Relacao com Imagens (1 Veiculo -> N Imagens) ---
        public ICollection<VeiculoImagem> Imagens { get; set; } = [];
    }
}
</file>

<file path="Models/Entities/Visita.cs">
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.Entities
{
    /// <summary>
    /// Representa uma visita agendada a um veiculo.
    /// 
    /// Workflow:
    /// 1. Comprador agenda visita ? Visita criada (Pendente)
    /// 2. Vendedor pode confirmar ? Estado = Confirmada
    /// 3. Apos data/hora ? Estado = Realizada ou NaoRealizada
    /// 4. Pode ser cancelada ? Estado = Cancelada
    /// 
    /// Validações:
    /// - Data/hora não pode ser no passado
    /// - Não é possivel agendar visita para veiculo vendido
    /// - Não é possivel agendar miltiplas visitas no mesmo horário (opcional)
    /// </summary>
    public class Visita
    {
        [Key]
        public int Id { get; set; }

        /// <summary>Veiculo que esta a ser visitado</summary>
        [Required]
        public int VeiculoId { get; set; }

        [ForeignKey("VeiculoId")]
        public Veiculo Veiculo { get; set; } = null!;

        /// <summary>Comprador que agendou a visita</summary>
        [Required]
        public int CompradorId { get; set; }

        [ForeignKey("CompradorId")]
        public Comprador Comprador { get; set; } = null!;

        /// <summary>Vendedor do veiculo (desnormalizado para facilitar queries)</summary>
        [Required]
        public int VendedorId { get; set; }

        [ForeignKey("VendedorId")]
        public Vendedor Vendedor { get; set; } = null!;

        /// <summary>Data e hora agendada para a visita</summary>
        [Required]
        [Display(Name = "Data/Hora da Visita")]
        public DateTime DataHora { get; set; }

        /// <summary>Quando a visita foi agendada</summary>
        [Display(Name = "Data de Agendamento")]
        public DateTime DataAgendamento { get; set; } = DateTime.UtcNow;

        /// <summary>Estado actual da visita</summary>
        [Display(Name = "Estado")]
        public EstadoVisita Estado { get; set; } = EstadoVisita.Pendente;

        /// <summary>Motivo de cancelamento (se aplicável)</summary>
        [StringLength(500)]
        public string? MotivoCancel { get; set; }

        /// <summary>Notas do comprador sobre a visita</summary>
        [StringLength(500)]
        public string? Notas { get; set; }

        /// <summary>Notas do vendedor sobre a visita</summary>
        [StringLength(500)]
        public string? NotasVendedor { get; set; }

        /// <summary>
        /// Verifica se a data/hora da visita já passou.
        /// </summary>
        public bool DataJaPassou => DateTime.UtcNow > DataHora;

        /// <summary>
        /// Verifica se a visita está agendada para o futuro (válida).
        /// </summary>
        public bool Agendada => DataHora > DateTime.UtcNow && Estado != EstadoVisita.Cancelada;
    }
}
</file>

<file path="Models/Enums/EstadoVeiculo.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.Enums
{
    /// <summary>
    /// Enum para o estado do veículo no sistema.
    /// </summary>
    public enum EstadoVeiculo
    {
        [Display(Name = "Ativo")]
        Ativo = 0,

        [Display(Name = "Reservado")]
        Reservado = 1,

        [Display(Name = "Vendido")]
        Vendido = 2,

        [Display(Name = "Pausado")]
        Pausado = 3
    }
}
</file>

<file path="Models/Enums/StatusAprovacao.cs">
namespace AutoMarket.Models.Enums
{
    public enum StatusAprovacao
    {
        Pendente = 0,
        Aprovado = 1,
        Rejeitado = 2
    }
}
</file>

<file path="Models/ViewModels/CheckoutViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels
{
    public class CheckoutViewModel : IValidatableObject
    {
        // Dados de Envio / Contacto
        [Required(ErrorMessage = "O nome completo é obrigatório.")]
        public string NomeCompleto { get; set; } = string.Empty;

        [Required(ErrorMessage = "A morada é obrigatória.")]
        public string Morada { get; set; } = string.Empty;

        [Required(ErrorMessage = "O código postal é obrigatório.")]
        [RegularExpression(@"^\d{4}-\d{3}$", ErrorMessage = "Formato inválido (ex: 1234-567).")]
        public string CodigoPostal { get; set; } = string.Empty;

        // --- DADOS FISCAIS ---

        [Display(Name = "Desejo fatura com número de contribuinte")]
        public bool QueroFaturaComNif { get; set; }

        [Display(Name = "NIF para Fatura")]
        public string? NifFaturacao { get; set; }

        [Display(Name = "Nome na Fatura (Opcional)")]
        public string? NomeFaturacao { get; set; }

        [Required(ErrorMessage ="Escolha um método de pagamento")]
        [Display(Name ="Método de Pagamento")]
        public MetodoPagamento MetodoPagamento { get; set; }

        public int CarroId { get; set; }
        public decimal ValorTotal { get; set; }



        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // 1. Se pediu fatura, o NIF passa a ser OBRIGATÓRIO
            if (QueroFaturaComNif)
            {
                if (string.IsNullOrWhiteSpace(NifFaturacao))
                {
                    yield return new ValidationResult(
                        "Para emitir fatura, é necessário introduzir o NIF.",
                        new[] { nameof(NifFaturacao) });
                }
                else
                {
                    // 2. Se preenchido, tem de ser matematicamente válido
                    if (!NifValidator.IsValid(NifFaturacao))
                    {
                        yield return new ValidationResult(
                            "O NIF de faturação não é válido.",
                            new[] { nameof(NifFaturacao) });
                    }

                    // Nota: No checkout, normalmente NÃO validamos se começa por 1 ou 5.
                    // Eu posso ser um particular (conta 1) a comprar carro para a minha empresa (nif 5),
                    // ou vice-versa. Validamos apenas a existência fiscal (IsValid).
                }
            }
            // 3. Caso Raro: Não pediu fatura, mas escreveu NIF na caixa (User Error)
            else if (!string.IsNullOrWhiteSpace(NifFaturacao))
            {
                if (!NifValidator.IsValid(NifFaturacao))
                {
                    yield return new ValidationResult(
                        "O NIF introduzido não é válido.",
                        new[] { nameof(NifFaturacao) });
                }
            }
        }
    }
}
</file>

<file path="Models/ViewModels/DadosFiscaisViewModel.cs">
using AutoMarket.Models.Attributes;
using AutoMarket.Models; // Para aceder ao atributo [NifPortugues]
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    public class DadosFiscaisViewModel
    {
        [Display(Name = "Número de Identificação Fiscal (NIF)")]
        [Required(ErrorMessage = "O NIF é obrigatório para emitir a fatura.")]
        [StringLength(9, ErrorMessage = "O NIF deve ter 9 dígitos.")]
        [NifPortugues(ErrorMessage = "O NIF introduzido não é válido.")]
        public string NIF { get; set; }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/CreateVeiculoViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para criar um novo veםculo (POST).
    /// Mapeia para Veiculo durante a criaחדo.
    /// </summary>
    public class CreateVeiculoViewModel
    {
        [Required(ErrorMessage = "O tםtulo י obrigatףrio")]
        [StringLength(100, ErrorMessage = "O tםtulo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Tםtulo do Anתncio")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A marca י obrigatףria")]
        [StringLength(50, ErrorMessage = "A marca nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Marca")]
        public string Marca { get; set; } = string.Empty;

        [Required(ErrorMessage = "O modelo י obrigatףrio")]
        [StringLength(50, ErrorMessage = "O modelo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Modelo")]
        public string Modelo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A categoria י obrigatףria")]
        [Display(Name = "Tipo/Segmento")]
        public int CategoriaId { get; set; }

        [Required(ErrorMessage = "O ano י obrigatףrio")]
        [Range(1900, 2100, ErrorMessage = "O ano deve estar entre 1900 e 2100")]
        [Display(Name = "Ano")]
        public int Ano { get; set; }

        [Required(ErrorMessage = "O preחo י obrigatףrio")]
        [Range(0.01, 9999999.99, ErrorMessage = "O preחo deve ser superior a 0")]
        [DataType(DataType.Currency)]
        [Display(Name = "Preחo (€)")]
        public decimal Preco { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "A quilometragem nדo pode ser negativa")]
        [Display(Name = "Quilףmetros")]
        public int Km { get; set; }

        [Required(ErrorMessage = "O combustםvel י obrigatףrio")]
        [StringLength(20, ErrorMessage = "O combustםvel nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Combustםvel")]
        public string Combustivel { get; set; } = string.Empty;

        [Required(ErrorMessage = "A caixa י obrigatףria")]
        [StringLength(20, ErrorMessage = "A caixa nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; } = string.Empty;

        [Required(ErrorMessage = "A localizaחדo י obrigatףria")]
        [StringLength(100, ErrorMessage = "A localizaחדo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Localizaחדo")]
        public string Localizacao { get; set; } = string.Empty;

        [Required(ErrorMessage = "A descriחדo י obrigatףria")]
        [StringLength(2000, ErrorMessage = "A descriחדo nדo pode ter mais de 2000 caracteres")]
        [DataType(DataType.MultilineText)]
        [Display(Name = "Descriחדo Detalhada")]
        public string Descricao { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "A condiחדo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Condiחדo")]
        public string? Condicao { get; set; }

        [Display(Name = "Fotos")]
        public List<IFormFile> Fotos { get; set; } = new();

        // Propriedades auxiliares para a View
        public List<Categoria> CategoriesDropdown { get; set; } = new();

        /// <summary>
        /// Converte este ViewModel para uma Model Veiculo.
        /// </summary>
        public Veiculo ToVeiculo(int vendedorId)
        {
            return new Veiculo
            {
                Titulo = Titulo,
                Marca = Marca,
                Modelo = Modelo,
                Ano = Ano,
                CategoriaId = CategoriaId,
                Combustivel = Combustivel,
                Caixa = Caixa,
                Km = Km,
                Preco = Preco,
                Condicao = Condicao,
                Localizacao = Localizacao,
                Descricao = Descricao,
                VendedorId = vendedorId,
                DataCriacao = DateTime.UtcNow,
                Estado = EstadoVeiculo.Ativo
            };
        }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/EditVeiculoViewModel.cs">
using AutoMarket.Models.Entities;
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para editar um veםculo existente (POST).
    /// Mapeia entre Veiculo e formulבrio de ediחדo.
    /// </summary>
    public class EditVeiculoViewModel
    {
        [Required]
        public int Id { get; set; }

        [Required(ErrorMessage = "O tםtulo י obrigatףrio")]
        [StringLength(100, ErrorMessage = "O tםtulo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Tםtulo do Anתncio")]
        public string Titulo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A marca י obrigatףria")]
        [StringLength(50, ErrorMessage = "A marca nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Marca")]
        public string Marca { get; set; } = string.Empty;

        [Required(ErrorMessage = "O modelo י obrigatףrio")]
        [StringLength(50, ErrorMessage = "O modelo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Modelo")]
        public string Modelo { get; set; } = string.Empty;

        [Required(ErrorMessage = "A categoria י obrigatףria")]
        [Display(Name = "Tipo/Segmento")]
        public int CategoriaId { get; set; }

        [Required(ErrorMessage = "O ano י obrigatףrio")]
        [Range(1900, 2100, ErrorMessage = "O ano deve estar entre 1900 e 2100")]
        [Display(Name = "Ano")]
        public int Ano { get; set; }

        [Required(ErrorMessage = "O preחo י obrigatףrio")]
        [Range(0.01, 9999999.99, ErrorMessage = "O preחo deve ser superior a 0")]
        [DataType(DataType.Currency)]
        [Display(Name = "Preחo (€)")]
        public decimal Preco { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "A quilometragem nדo pode ser negativa")]
        [Display(Name = "Quilףmetros")]
        public int Km { get; set; }

        [Required(ErrorMessage = "O combustםvel י obrigatףrio")]
        [StringLength(20, ErrorMessage = "O combustםvel nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Combustםvel")]
        public string Combustivel { get; set; } = string.Empty;

        [Required(ErrorMessage = "A caixa י obrigatףria")]
        [StringLength(20, ErrorMessage = "A caixa nדo pode ter mais de 20 caracteres")]
        [Display(Name = "Caixa")]
        public string Caixa { get; set; } = string.Empty;

        [Required(ErrorMessage = "A localizaחדo י obrigatףria")]
        [StringLength(100, ErrorMessage = "A localizaחדo nדo pode ter mais de 100 caracteres")]
        [Display(Name = "Localizaחדo")]
        public string Localizacao { get; set; } = string.Empty;

        [Required(ErrorMessage = "A descriחדo י obrigatףria")]
        [StringLength(2000, ErrorMessage = "A descriחדo nדo pode ter mais de 2000 caracteres")]
        [DataType(DataType.MultilineText)]
        [Display(Name = "Descriחדo Detalhada")]
        public string Descricao { get; set; } = string.Empty;

        [StringLength(50, ErrorMessage = "A condiחדo nדo pode ter mais de 50 caracteres")]
        [Display(Name = "Condiחדo")]
        public string? Condicao { get; set; }

        [Display(Name = "Fotos")]
        public List<IFormFile> Fotos { get; set; } = new();

        // Propriedades auxiliares
        public string? ImagemPrincipalAtual { get; set; }
        public List<Categoria> CategoriesDropdown { get; set; } = new();

        /// <summary>
        /// Cria um ViewModel a partir de um Veiculo existente.
        /// </summary>
        public static EditVeiculoViewModel FromVeiculo(Veiculo veiculo)
        {
            return new EditVeiculoViewModel
            {
                Id = veiculo.Id,
                Titulo = veiculo.Titulo,
                Marca = veiculo.Marca,
                Modelo = veiculo.Modelo,
                Ano = veiculo.Ano,
                CategoriaId = veiculo.CategoriaId,
                Combustivel = veiculo.Combustivel,
                Caixa = veiculo.Caixa,
                Km = veiculo.Km,
                Preco = veiculo.Preco,
                Condicao = veiculo.Condicao,
                Localizacao = veiculo.Localizacao,
                Descricao = veiculo.Descricao,
                ImagemPrincipalAtual = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
            };
        }
    }
}
</file>

<file path="Models/ViewModels/Veiculos/ListVeiculoViewModel.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;

namespace AutoMarket.Models.ViewModels.Veiculos
{
    /// <summary>
    /// ViewModel para listar veьculos (GET).
    /// Usado para exibir informaушes resumidas de veьculos no catрlogo.
    /// </summary>
    public class ListVeiculoViewModel
    {
        public int Id { get; set; }
        public string Titulo { get; set; }
        public string Marca { get; set; }
        public string Modelo { get; set; }
        public int Ano { get; set; }
        public decimal Preco { get; set; }
        public int Km { get; set; }
        public string Combustivel { get; set; }
        public string Caixa { get; set; }
        public string Localizacao { get; set; }
        public string Descricao { get; set; }
        public string? Condicao { get; set; }
        public EstadoVeiculo Estado { get; set; }
        public DateTime DataCriacao { get; set; }
        public int VendedorId { get; set; }
        public string VendedorNome { get; set; }
        public string? ImagemPrincipal { get; set; }
        public string CategoriaNome { get; set; }

        /// <summary>
        /// Converte um Veiculo para ListVeiculoViewModel.
        /// </summary>
        public static ListVeiculoViewModel FromVeiculo(Veiculo veiculo)
        {
            var imagemPrincipal = veiculo.Imagens?.FirstOrDefault(i => i.IsCapa)?.CaminhoFicheiro
                                  ?? veiculo.Imagens?.FirstOrDefault()?.CaminhoFicheiro;

            return new ListVeiculoViewModel
            {
                Id = veiculo.Id,
                Titulo = veiculo.Titulo,
                Marca = veiculo.Marca,
                Modelo = veiculo.Modelo,
                Ano = veiculo.Ano,
                Preco = veiculo.Preco,
                Km = veiculo.Km,
                Combustivel = veiculo.Combustivel,
                Caixa = veiculo.Caixa,
                Localizacao = veiculo.Localizacao,
                Descricao = veiculo.Descricao,
                Condicao = veiculo.Condicao,
                Estado = veiculo.Estado,
                DataCriacao = veiculo.DataCriacao,
                VendedorId = veiculo.VendedorId,
                VendedorNome = veiculo.Vendedor?.User?.Nome ?? "Desconhecido",
                ImagemPrincipal = imagemPrincipal,
                CategoriaNome = veiculo.Categoria?.Nome ?? "Sem categoria"
            };
        }
    }
}
</file>

<file path="Services/Implementations/AuthService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Utils;
using AutoMarket.Models.Constants;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.WebUtilities;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
	public class AuthService : IAuthService
	{
	private readonly UserManager<Utilizador> _userManager;
	private readonly SignInManager<Utilizador> _signInManager;
	private readonly ApplicationDbContext _context;
	private readonly IEmailAuthService _emailAuthService;
	private readonly ILogger<AuthService> _logger;
	private readonly IHostEnvironment _environment;

	public AuthService(
		UserManager<Utilizador> userManager,
		SignInManager<Utilizador> signInManager,
		ApplicationDbContext context,
		IEmailAuthService emailAuthService,
		ILogger<AuthService> logger,
		IHostEnvironment environment)
	{
		_userManager = userManager;
		_signInManager = signInManager;
		_context = context;
		_emailAuthService = emailAuthService;
		_logger = logger;
		_environment = environment;
	}

		public async Task<RegisterResultDto> RegisterAsync(RegisterDto dto, string confirmationBaseUrl)
		{
			var errors = new List<string>();

			if (!string.IsNullOrEmpty(dto.Nif) && !NifValidator.IsValid(dto.Nif))
			{
				errors.Add("NIF invбlido. Por favor, verifique o nъmero introduzido.");
				return new RegisterResultDto(false, errors, null);
			}

			await using var transaction = await _context.Database.BeginTransactionAsync();

			try
			{
			var user = new Utilizador
			{
				UserName = dto.Email,
				Email = dto.Email,
				Nome = dto.Nome,
				Morada = dto.Morada,
				PhoneNumber = dto.Contacto,
				NIF = dto.Nif,
				DataRegisto = DateTime.UtcNow
				// EmailConfirmed removido - nгo й necessбrio
			};

				var identityResult = await _userManager.CreateAsync(user, dto.Password);
				if (!identityResult.Succeeded)
				{
					errors.AddRange(identityResult.Errors.Select(e => e.Description));
					return new RegisterResultDto(false, errors, null);
				}

			if (dto.TipoConta == TipoConta.Vendedor || dto.TipoConta == TipoConta.Empresa)
			{
				var vendedor = new Vendedor
				{
					UserId = user.Id,
					TipoConta = dto.TipoConta,
					Status = _environment.IsDevelopment() ? StatusAprovacao.Aprovado : StatusAprovacao.Pendente,
					ApprovedByAdminId = _environment.IsDevelopment() ? user.Id : null // Auto-aprovar em dev
				};
				_context.Vendedores.Add(vendedor);
				await _userManager.AddToRoleAsync(user, Roles.Vendedor);
			}
				else
				{
					var comprador = new Comprador
					{
						UserId = user.Id,
						ReceberNotificacoes = false
					};
					_context.Compradores.Add(comprador);
					await _userManager.AddToRoleAsync(user, Roles.Comprador);
				}

				await _context.SaveChangesAsync();
				await transaction.CommitAsync();

				// Auto-login apуs registo
				await _signInManager.SignInAsync(user, isPersistent: false);

				_logger.LogInformation("Utilizador {Email} registado e auto-logado com sucesso", user.Email);

				return new RegisterResultDto(true, Enumerable.Empty<string>(), null);
			}
			catch (Exception ex)
			{
				_logger.LogError(ex, "Erro ao registar utilizador {Email}", dto.Email);
				errors.Add("Ocorreu um erro interno. Tente novamente.");
				return new RegisterResultDto(false, errors, null);
			}
		}

		public async Task<LoginResultDto> LoginAsync(LoginDto dto)
		{
			var errors = new List<string>();

			var signInResult = await _signInManager.PasswordSignInAsync(dto.Email, dto.Password, dto.RememberMe, false);
			if (!signInResult.Succeeded)
			{
				errors.Add("Email ou password invбlidos.");
				return new LoginResultDto(false, null, errors);
			}

			var user = await _userManager.FindByEmailAsync(dto.Email);
			if (user == null)
			{
				await _signInManager.SignOutAsync();
				errors.Add("Erro inesperado ao obter dados do utilizador.");
				return new LoginResultDto(false, null, errors);
			}

			if (user.IsBlocked || user.IsDeleted)
			{
				await _signInManager.SignOutAsync();
				errors.Add("Conta bloqueada ou eliminada.");
				return new LoginResultDto(false, null, errors);
			}

			if (await _userManager.IsInRoleAsync(user, Roles.Vendedor))
			{
				var vendedor = await _context.Vendedores
					.Select(v => new { v.UserId, v.Status })
					.FirstOrDefaultAsync(v => v.UserId == user.Id);

				if (vendedor != null && vendedor.Status != StatusAprovacao.Aprovado)
				{
					_logger.LogWarning("Vendedor {Email} tentou entrar mas estб com status {Status}", user.Email, vendedor.Status);
					await _signInManager.SignOutAsync();
					return new LoginResultDto(false, nameof(StatusAprovacao.Pendente), errors);
				}
			}

			return new LoginResultDto(true, null, Enumerable.Empty<string>());
		}

		public Task LogoutAsync()
		{
			return _signInManager.SignOutAsync();
		}

		public async Task<ConfirmEmailResultDto> ConfirmEmailAsync(string userId, string token)
		{
			var errors = new List<string>();

			if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(token))
			{
				errors.Add("Link de confirmaзгo invбlido ou incompleto.");
				return new ConfirmEmailResultDto(false, errors);
			}

			var user = await _userManager.FindByIdAsync(userId);
			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado no sistema.");
				return new ConfirmEmailResultDto(false, errors);
			}

			var result = await _userManager.ConfirmEmailAsync(user, token);
			if (!result.Succeeded)
			{
				errors.AddRange(result.Errors.Select(e => e.Description));
				_logger.LogWarning("Falha na confirmaзгo de email para {UserId}: {Errors}", userId, string.Join(", ", errors));
				return new ConfirmEmailResultDto(false, errors);
			}

			return new ConfirmEmailResultDto(true, Enumerable.Empty<string>());
		}

		public async Task<UpdateNifResultDto> UpdateNifAsync(string userId, string nif)
		{
			var errors = new List<string>();

			if (string.IsNullOrEmpty(nif))
			{
				errors.Add("O NIF й obrigatуrio.");
				return new UpdateNifResultDto(false, errors);
			}

			if (!NifValidator.IsValid(nif))
			{
				errors.Add("NIF invбlido. Por favor, verifique o nъmero introduzido.");
				return new UpdateNifResultDto(false, errors);
			}

			var user = await _userManager.FindByIdAsync(userId);
			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado.");
				return new UpdateNifResultDto(false, errors);
			}

			user.NIF = nif;
			var result = await _userManager.UpdateAsync(user);
			if (!result.Succeeded)
			{
				errors.AddRange(result.Errors.Select(e => e.Description));
				return new UpdateNifResultDto(false, errors);
			}

			return new UpdateNifResultDto(true, Enumerable.Empty<string>());
		}

		public async Task<SoftDeleteResultDto> SoftDeleteAsync(string userId)
		{
			var errors = new List<string>();
			var user = await _userManager.FindByIdAsync(userId);

			if (user == null)
			{
				errors.Add("Utilizador nгo encontrado.");
				return new SoftDeleteResultDto(false, errors);
			}

			try
			{
				await _signInManager.SignOutAsync();

				user.IsDeleted = true;

				var deletedEmailSuffix = $"deleted_{Guid.NewGuid():N}@automarket.invalid";
				user.Email = deletedEmailSuffix;
				user.UserName = deletedEmailSuffix;
				user.NormalizedEmail = deletedEmailSuffix.ToUpperInvariant();
				user.NormalizedUserName = deletedEmailSuffix.ToUpperInvariant();
				user.Nome = "Utilizador Eliminado";
				user.NIF = null;
				user.Morada = string.Empty;
				user.Contacto = string.Empty;

				var result = await _userManager.UpdateAsync(user);
				if (!result.Succeeded)
				{
					errors.AddRange(result.Errors.Select(e => e.Description));
					foreach (var error in result.Errors)
					{
						_logger.LogError("Erro ao atualizar utilizador {Id} apуs soft delete: {Error}", user.Id, error.Description);
					}
					return new SoftDeleteResultDto(false, errors);
				}

				_logger.LogInformation("Utilizador {Id} apagou a conta (Soft Delete). Sessгo invalidada.", user.Id);
				return new SoftDeleteResultDto(true, Enumerable.Empty<string>());
			}
			catch (Exception ex)
			{
				_logger.LogError(ex, "Erro crнtico ao apagar conta do utilizador {Id}", user.Id);
				errors.Add("Erro crнtico ao apagar conta.");
				return new SoftDeleteResultDto(false, errors);
			}
		}
	}
}
</file>

<file path="Services/Implementations/CheckoutService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    public class CheckoutService : ICheckoutService
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ILogger<CheckoutService> _logger;

        public CheckoutService(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ILogger<CheckoutService> logger)
        {
            _context = context;
            _userManager = userManager;
            _logger = logger;
        }

        public async Task<Transacao> ProcessCheckoutAsync(string userId, Transacao checkout)
        {
            await using var dbTransaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var user = await _userManager.FindByIdAsync(userId);
                if (user == null)
                    throw new InvalidOperationException("Utilizador nгo encontrado.");

                var veiculo = await _context.Veiculos.FindAsync(checkout.VeiculoId);
                if (veiculo == null || veiculo.Estado != EstadoVeiculo.Ativo)
                    throw new InvalidOperationException("Veнculo nгo estб disponнvel.");

                checkout.DataTransacao = DateTime.UtcNow;
                checkout.Estado = EstadoTransacao.Pendente;

                _context.Transacoes.Add(checkout);
                veiculo.Estado = EstadoVeiculo.Vendido;

                await _context.SaveChangesAsync();
                await dbTransaction.CommitAsync();

                _logger.LogInformation("Transaзгo {TransacaoId} processada para utilizador {UserId}", checkout.Id, userId);
                return checkout;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao processar checkout para utilizador {UserId}", userId);
                throw;
            }
        }

        public async Task<Transacao?> GetTransacaoAsync(string userId, int transacaoId)
        {
            var transacao = await _context.Transacoes
                .Include(t => t.Comprador)
                .Include(t => t.Veiculo)
                .FirstOrDefaultAsync(t => t.Id == transacaoId);

            if (transacao == null || transacao.Comprador.UserId != userId)
                return null;

            return transacao;
        }
    }
}
</file>

<file path="Services/Implementations/EmailAuthService.cs">
using AutoMarket.Models.Entities;
using AutoMarket.Services.Interfaces;

namespace AutoMarket.Services.Implementations
{
    public class EmailAuthService : IEmailAuthService
    {
        private readonly IEmailSender _emailSender;
        private readonly ILogger<EmailAuthService> _logger;

        public EmailAuthService(
            IEmailSender emailSender,
            ILogger<EmailAuthService> logger)
        {
            _emailSender = emailSender;
            _logger = logger;
        }

        public async Task EnviarEmailConfirmacaoAsync(Utilizador user, string confirmationLink)
        {
            if (string.IsNullOrEmpty(user.Email))
            {
                _logger.LogError("Utilizador {UserId} sem email definido.", user.Id);
                return;
            }

            try
            {
                var emailBody = EmailTemplateService.GenerateEmailConfirmationTemplate(user.Nome, confirmationLink);

                await _emailSender.SendEmailAsync(
                    user.Email,
                    "Bem-vindo ao AutoMarket - Confirme a sua conta",
                    emailBody
                );

                _logger.LogInformation("Email de confirmação enviado para {Email}", user.Email);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao enviar email para {Email}", user.Email);
            }
        }
    }
}
</file>

<file path="Services/Implementations/EmailTemplateService.cs">
namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service for generating email templates.
    /// </summary>
    public class EmailTemplateService
    {
        private readonly ILogger<EmailTemplateService> _logger;

        public EmailTemplateService(ILogger<EmailTemplateService> logger)
        {
            _logger = logger;
        }

        /// <summary>
        /// Generates an HTML email template for email confirmation.
        /// </summary>
        public static string GenerateEmailConfirmationTemplate(string userName, string confirmationLink)
        {
            if (string.IsNullOrWhiteSpace(userName))
                throw new ArgumentNullException(nameof(userName));

            if (string.IsNullOrWhiteSpace(confirmationLink))
                throw new ArgumentNullException(nameof(confirmationLink));

            var encodedUserName = System.Net.WebUtility.HtmlEncode(userName);
            var encodedConfirmationLink = System.Net.WebUtility.HtmlEncode(confirmationLink);

            return $@"
                <html>
                <head>
                    <style>
                        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
                        .header {{ background-color: #007bff; color: white; padding: 20px; text-align: center; }}
                        .content {{ padding: 20px; background-color: #f9f9f9; }}
                        .button {{ display: inline-block; padding: 12px 24px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }}
                        .footer {{ text-align: center; padding: 20px; font-size: 12px; color: #666; }}
                        .link-text {{ word-break: break-all; color: #007bff; }}
                    </style>
                </head>
                <body>
                    <div class=""container"">
                        <div class=""header""><h1>Bem-vindo ao AutoMarket!</h1></div>
                        <div class=""content"">
                            <p>Olá {encodedUserName},</p>
                            <p>Obrigado por se registar. Confirme o seu email clicando abaixo:</p>
                            <p style=""text-align: center;""><a href=""{encodedConfirmationLink}"" class=""button"">Confirmar Email</a></p>
                            <p>Link: {encodedConfirmationLink}</p>
                            <p>Este link expirará em 24 horas.</p>
                        </div>
                        <div class=""footer""><p>&copy; 2025 AutoMarket.</p></div>
                    </div>
                </body>
                </html>";
        }
    }
}
</file>

<file path="Services/Implementations/ReservaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service para gest�o de reservas de ve�culos.
    /// Controla o ciclo de vida: Cria��o, Confirma��o, Expira��o, Compra.
    /// </summary>
    public class ReservaService : IReservaService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<ReservaService> _logger;

        public ReservaService(ApplicationDbContext context, ILogger<ReservaService> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// Criar uma reserva de veiculo.
        /// Valida disponibilidade e muda o estado do veiculo para "Reservado".
        /// </summary>
        public async Task<(bool sucesso, Reserva? reserva, string mensagem)> CriarReservaAsync(
            int veiculoId, 
            int compradorId, 
            int diasValidez = 7)
        {
            try
            {
                // 1. Validar veiculo existe
                var veiculo = await _context.Veiculos.FirstOrDefaultAsync(v => v.Id == veiculoId);
                if (veiculo == null)
                    return (false, null, "Veiculo nao encontrado.");

                // 2. Validar veiculo disponivel
                if (veiculo.Estado != EstadoVeiculo.Ativo)
                    return (false, null, $"Veiculo nao disponivel. Estado atual: {veiculo.Estado}");

                // 3. Validar comprador existe
                var comprador = await _context.Compradores.FirstOrDefaultAsync(c => c.Id == compradorId);
                if (comprador == null)
                    return (false, null, "Perfil de comprador nao encontrado.");

                // 4. Validar se ja tem reserva ativa para este veiculo
                var reservaExistente = await _context.Reservas
                    .FirstOrDefaultAsync(r => r.VeiculoId == veiculoId 
                        && r.CompradorId == compradorId
                        && r.Valida);
                if (reservaExistente != null)
                    return (false, null, "Já tem uma reserva ativa para este veículo.");

                // 5. Criar a reserva
                var reserva = new Reserva
                {
                    VeiculoId = veiculoId,
                    CompradorId = compradorId,
                    DataCriacao = DateTime.UtcNow,
                    DataExpiracao = DateTime.UtcNow.AddDays(diasValidez),
                    Estado = EstadoReserva.Pendente
                };

                // 6. Mudar estado do veiculo para Reservado
                veiculo.Estado = EstadoVeiculo.Reservado;

                // 7. Guardar
                _context.Reservas.Add(reserva);
                _context.Veiculos.Update(veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Reserva criada: VeiculoId={VeiculoId}, CompradorId={CompradorId}, Validade={DataExpiracao}",
                    veiculoId, compradorId, reserva.DataExpiracao);

                return (true, reserva, "Reserva criada com sucesso! Válida até " + reserva.DataExpiracao.ToShortDateString());
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao criar reserva: VeiculoId={VeiculoId}, CompradorId={CompradorId}",
                    veiculoId, compradorId);
                return (false, null, "Erro ao criar reserva. Tente novamente.");
            }
        }

        /// <summary>
        /// Cancelar uma reserva.
        /// Muda o veiculo para "Ativo" novamente (se nao houver outras reservas).
        /// </summary>
        public async Task<(bool sucesso, string mensagem)> CancelarReservaAsync(
            int reservaId, 
            string motivo = "")
        {
            try
            {
                // 1. Encontrar reserva
                var reserva = await _context.Reservas
                    .Include(r => r.Veiculo)
                    .FirstOrDefaultAsync(r => r.Id == reservaId);

                if (reserva == null)
                    return (false, "Reserva não encontrada.");

                // 2. Validar se pode ser cancelada
                if (reserva.Estado == EstadoReserva.Concluida)
                    return (false, "Não é possível cancelar uma reserva que já foi concluida.");

                if (reserva.Estado == EstadoReserva.Cancelada)
                    return (false, "Esta reserva já foi cancelada.");

                // 3. Mudar estado
                reserva.Estado = EstadoReserva.Cancelada;
                reserva.MotivoCancel = motivo;

                // 4. Mudar veiculo para Ativo (se não tem outra reserva valida)
                var temOutraReserva = await _context.Reservas
                    .AnyAsync(r => r.VeiculoId == reserva.VeiculoId 
                        && r.Id != reserva.Id
                        && r.Valida);

                if (!temOutraReserva)
                {
                    reserva.Veiculo.Estado = EstadoVeiculo.Ativo;
                }

                // 5. Guardar
                _context.Reservas.Update(reserva);
                _context.Veiculos.Update(reserva.Veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Reserva cancelada: Id={ReservaId}, Motivo={Motivo}", reservaId, motivo);
                return (true, "Reserva cancelada com sucesso.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao cancelar reserva: Id={ReservaId}", reservaId);
                return (false, "Erro ao cancelar reserva.");
            }
        }

        /// <summary>
        /// Verificar se um veículo está disponivel para reserva.
        /// </summary>
        public async Task<bool> VeiculoEstaDisponivelAsync(int veiculoId)
        {
            var veiculo = await _context.Veiculos.FirstOrDefaultAsync(v => v.Id == veiculoId);
            if (veiculo == null) return false;

            // Disponível se estiver Ativo ou Reservado
            return veiculo.Estado == EstadoVeiculo.Ativo || veiculo.Estado == EstadoVeiculo.Reservado;
        }

        /// <summary>
        /// Limpar reservas que expiraram.
        /// Muda seu estado para "Expirada" e liberta o veículo.
        /// Este método deve ser chamado por um Background Job.
        /// </summary>
        public async Task LimparReservasExpirasAsync()
        {
            try
            {
                var agora = DateTime.UtcNow;

                // 1. Encontrar todas as reservas pendentes que expiraram
                var reservasExpiradas = await _context.Reservas
                    .Include(r => r.Veiculo)
                    .Where(r => r.Estado == EstadoReserva.Pendente && r.DataExpiracao < agora)
                    .ToListAsync();

                _logger.LogInformation("Encontradas {Count} reservas expiradas para limpeza", reservasExpiradas.Count);

                foreach (var reserva in reservasExpiradas)
                {
                    // 2. Mudar estado
                    reserva.Estado = EstadoReserva.Expirada;

                    // 3. Mudar veículo para Ativo
                    reserva.Veiculo.Estado = EstadoVeiculo.Ativo;

                    // 4. Cancelar visitas relacionadas
                    var visitas = await _context.Visitas
                        .Where(v => v.VeiculoId == reserva.VeiculoId 
                            && v.CompradorId == reserva.CompradorId
                            && v.Estado == EstadoVisita.Pendente)
                        .ToListAsync();

                    foreach (var visita in visitas)
                    {
                        visita.Estado = EstadoVisita.Cancelada;
                        visita.MotivoCancel = "Reserva expirou automaticamente";
                    }

                    _context.Visitas.UpdateRange(visitas);
                }

                // 5. Guardar tudo
                _context.Reservas.UpdateRange(reservasExpiradas);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Limpeza de reservas expiradas concluida. Total: {Count}", reservasExpiradas.Count);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao limpar reservas expiradas");
            }
        }

        /// <summary>
        /// Confirmar uma compra a partir de uma reserva.
        /// Cria uma Transacao e muda a reserva para "Concluida".
        /// </summary>
        public async Task<(bool sucesso, Transacao? transacao, string mensagem)> ConfirmarCompraAsync(
            int reservaId, 
            int compradorId)
        {
            try
            {
                // 1. Encontrar reserva
                var reserva = await _context.Reservas
                    .Include(r => r.Veiculo)
                    .Include(r => r.Comprador)
                    .FirstOrDefaultAsync(r => r.Id == reservaId && r.CompradorId == compradorId);

                if (reserva == null)
                    return (false, null, "Reserva não encontrada.");

                // 2. Validar se ainda é valida
                if (!reserva.Valida)
                    return (false, null, "Esta reserva não é mais valida. Está expirada ou cancelada.");

                // 3. Validar se o comprador existe
                var comprador = await _context.Compradores
                    .FirstOrDefaultAsync(c => c.Id == compradorId);
                if (comprador == null)
                    return (false, null, "Comprador não encontrado.");

                // 4. Criar Transacao
                var transacao = new Transacao
                {
                    VeiculoId = reserva.VeiculoId,
                    CompradorId = compradorId,
                    ValorPago = reserva.Veiculo.Preco,
                    Metodo = MetodoPagamento.CartaoCredito,  // Será confirmado no checkout
                    Estado = EstadoTransacao.Pendente,
                    DataTransacao = DateTime.UtcNow
                };

                // 5. Mudar estados
                reserva.Estado = EstadoReserva.Concluida;
                reserva.Veiculo.Estado = EstadoVeiculo.Vendido;

                // 6. Guardar
                _context.Transacoes.Add(transacao);
                _context.Reservas.Update(reserva);
                _context.Veiculos.Update(reserva.Veiculo);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Compra confirmada: ReservaId={ReservaId}, TransacaoId={TransacaoId}, Valor={Valor}",
                    reservaId, transacao.Id, transacao.ValorPago);

                return (true, transacao, "Compra confirmada com sucesso!");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao confirmar compra: ReservaId={ReservaId}", reservaId);
                return (false, null, "Erro ao confirmar compra.");
            }
        }

        /// <summary>
        /// Obter todas as reservas de um comprador.
        /// </summary>
        public async Task<List<Reserva>> ObterReservasCompradorAsync(int compradorId)
        {
            return await _context.Reservas
                .Include(r => r.Veiculo)
                .ThenInclude(v => v.Imagens)
                .Include(r => r.Veiculo.Vendedor)
                .ThenInclude(vend => vend.User)
                .Where(r => r.CompradorId == compradorId)
                .OrderByDescending(r => r.DataCriacao)
                .ToListAsync();
        }

        /// <summary>
        /// Obter uma reserva espec�fica.
        /// </summary>
        public async Task<Reserva?> ObterReservaAsync(int reservaId)
        {
            return await _context.Reservas
                .Include(r => r.Veiculo)
                .ThenInclude(v => v.Imagens)
                .Include(r => r.Veiculo.Vendedor)
                .ThenInclude(vend => vend.User)
                .Include(r => r.Comprador)
                .ThenInclude(c => c.User)
                .FirstOrDefaultAsync(r => r.Id == reservaId);
        }
    }
}
</file>

<file path="Services/Implementations/VisitaService.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Services.Implementations
{
    /// <summary>
    /// Service para gestao de visitas agendadas a veiculos.
    /// Controla o ciclo de vida: Agendamento, Confirmacao, Realizacao.
    /// </summary>
    public class VisitaService : IVisitaService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<VisitaService> _logger;

        public VisitaService(ApplicationDbContext context, ILogger<VisitaService> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// Agendar uma visita a um veiculo.
        /// Valida data/hora e estado do veiculo.
        /// </summary>
        public async Task<(bool sucesso, Visita? visita, string mensagem)> AgendarVisitaAsync(
            int veiculoId,
            int compradorId,
            DateTime dataHora,
            string? notas = "")
        {
            try
            {
                // 1. Validar data/hora
                if (!ValidarDataVisita(dataHora))
                    return (false, null, "Data/hora invalida. Deve ser uma data futura durante horario de funcionamento.");

                // 2. Validar veiculo existe
                var veiculo = await _context.Veiculos
                    .Include(v => v.Vendedor)
                    .FirstOrDefaultAsync(v => v.Id == veiculoId);

                if (veiculo == null)
                    return (false, null, "Veiculo nao encontrado.");

                // 3. Validar veiculo nao esta vendido
                if (await ValidarVeiculoVendidoAsync(veiculoId))
                    return (false, null, "Nao e possivel agendar visita. Este veiculo ja foi vendido.");

                // 4. Validar comprador existe
                var comprador = await _context.Compradores
                    .FirstOrDefaultAsync(c => c.Id == compradorId);

                if (comprador == null)
                    return (false, null, "Perfil de comprador nao encontrado.");

                // 5. Validar se nao tem visita no mesmo horario (opcional - limite de 5 visitas por dia)
                var visitasNesseDia = await _context.Visitas
                    .Where(v => v.VeiculoId == veiculoId
                        && v.DataHora.Date == dataHora.Date
                        && v.Estado != EstadoVisita.Cancelada)
                    .CountAsync();

                if (visitasNesseDia >= 5)
                    return (false, null, "Limite de visitas atingido para este dia. Escolha outra data.");

                // 6. Criar a visita
                var visita = new Visita
                {
                    VeiculoId = veiculoId,
                    CompradorId = compradorId,
                    VendedorId = veiculo.VendedorId,
                    DataHora = dataHora,
                    DataAgendamento = DateTime.UtcNow,
                    Estado = EstadoVisita.Pendente,
                    Notas = notas
                };

                // 7. Guardar
                _context.Visitas.Add(visita);
                await _context.SaveChangesAsync();

                _logger.LogInformation(
                    "Visita agendada: VeiculoId={VeiculoId}, CompradorId={CompradorId}, DataHora={DataHora}",
                    veiculoId, compradorId, dataHora);

                return (true, visita, "Visita agendada com sucesso! Aguardando confirma��o do vendedor.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao agendar visita: VeiculoId={VeiculoId}, CompradorId={CompradorId}",
                    veiculoId, compradorId);
                return (false, null, "Erro ao agendar visita.");
            }
        }

        /// <summary>
        /// Cancelar uma visita agendada.
        /// </summary>
        public async Task<(bool sucesso, string mensagem)> CancelarVisitaAsync(
            int visitaId,
            string motivo = "")
        {
            try
            {
                // 1. Encontrar visita
                var visita = await _context.Visitas.FirstOrDefaultAsync(v => v.Id == visitaId);
                if (visita == null)
                    return (false, "Visita n�o encontrada.");

                // 2. Validar se pode ser cancelada
                if (visita.Estado == EstadoVisita.Realizada)
                    return (false, "N�o � poss�vel cancelar uma visita que j� foi realizada.");

                if (visita.Estado == EstadoVisita.Cancelada)
                    return (false, "Esta visita j� foi cancelada.");

                // 3. Mudar estado
                visita.Estado = EstadoVisita.Cancelada;
                visita.MotivoCancel = motivo;

                // 4. Guardar
                _context.Visitas.Update(visita);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Visita cancelada: Id={VisitaId}, Motivo={Motivo}", visitaId, motivo);
                return (true, "Visita cancelada com sucesso.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao cancelar visita: Id={VisitaId}", visitaId);
                return (false, "Erro ao cancelar visita.");
            }
        }

        /// <summary>
        /// Confirmar uma visita agendada (a��o do vendedor).
        /// </summary>
        public async Task<(bool sucesso, string mensagem)> ConfirmarVisitaAsync(int visitaId)
        {
            try
            {
                // 1. Encontrar visita
                var visita = await _context.Visitas.FirstOrDefaultAsync(v => v.Id == visitaId);
                if (visita == null)
                    return (false, "Visita n�o encontrada.");

                // 2. Validar estado
                if (visita.Estado != EstadoVisita.Pendente)
                    return (false, "Apenas visitas pendentes podem ser confirmadas.");

                // 3. Mudar estado
                visita.Estado = EstadoVisita.Confirmada;

                // 4. Guardar
                _context.Visitas.Update(visita);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Visita confirmada: Id={VisitaId}", visitaId);
                return (true, "Visita confirmada com sucesso!");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao confirmar visita: Id={VisitaId}", visitaId);
                return (false, "Erro ao confirmar visita.");
            }
        }

        /// <summary>
        /// Marcar uma visita como realizada (a��o do vendedor).
        /// </summary>
        public async Task<(bool sucesso, string mensagem)> MarcarComoRealizadaAsync(
            int visitaId,
            string? notas = "")
        {
            try
            {
                var visita = await _context.Visitas.FirstOrDefaultAsync(v => v.Id == visitaId);
                if (visita == null)
                    return (false, "Visita nao encontrada.");

                // Apenas visitas no passado podem ser marcadas como realizadas
                if (!visita.DataJaPassou)
                    return (false, "Nao pode marcar como realizada antes da data/hora agendada.");

                visita.Estado = EstadoVisita.Realizada;
                if (!string.IsNullOrEmpty(notas))
                    visita.NotasVendedor = notas;

                _context.Visitas.Update(visita);
                await _context.SaveChangesAsync();

                return (true, "Visita marcada como realizada.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erro ao marcar visita como realizada: Id={VisitaId}", visitaId);
                return (false, "Erro ao atualizar visita.");
            }
        }

        /// <summary>
        /// Validar se uma data/hora e valida para agendamento.
        /// - Deve ser no futuro
        /// - Deve estar em horario de funcionamento (9-18h)
        /// </summary>
        public bool ValidarDataVisita(DateTime dataHora)
        {
            var agora = DateTime.UtcNow;

            // 1. Deve ser no futuro (minimo 1 hora a partir de agora)
            if (dataHora <= agora.AddHours(1))
                return false;

            // 2. Horario de funcionamento: 9-18h
            if (dataHora.Hour < 9 || dataHora.Hour >= 18)
                return false;

            // 3. So diasuteis (segunda a sexta)
            if (dataHora.DayOfWeek == DayOfWeek.Saturday || dataHora.DayOfWeek == DayOfWeek.Sunday)
                return false;

            return true;
        }

        /// <summary>
        /// Validar se um veiculo foi vendido.
        /// </summary>
        public async Task<bool> ValidarVeiculoVendidoAsync(int veiculoId)
        {
            var veiculo = await _context.Veiculos.FirstOrDefaultAsync(v => v.Id == veiculoId);
            return veiculo?.Estado == EstadoVeiculo.Vendido;
        }

        /// <summary>
        /// Obter todas as visitas de um comprador.
        /// </summary>
        public async Task<List<Visita>> ObterVisitasCompradorAsync(int compradorId)
        {
            return await _context.Visitas
                .Include(v => v.Veiculo)
                .ThenInclude(ve => ve.Imagens)
                .Include(v => v.Vendedor)
                .ThenInclude(vend => vend.User)
                .Where(v => v.CompradorId == compradorId)
                .OrderBy(v => v.DataHora)
                .ToListAsync();
        }

        /// <summary>
        /// Obter todas as visitas de um vendedor.
        /// </summary>
        public async Task<List<Visita>> ObterVisitasVendedorAsync(int vendedorId)
        {
            return await _context.Visitas
                .Include(v => v.Veiculo)
                .ThenInclude(ve => ve.Imagens)
                .Include(v => v.Comprador)
                .ThenInclude(c => c.User)
                .Where(v => v.VendedorId == vendedorId)
                .OrderBy(v => v.DataHora)
                .ToListAsync();
        }

        /// <summary>
        /// Obter uma visita espec�fica.
        /// </summary>
        public async Task<Visita?> ObterVisitaAsync(int visitaId)
        {
            return await _context.Visitas
                .Include(v => v.Veiculo)
                .ThenInclude(ve => ve.Imagens)
                .Include(v => v.Comprador)
                .ThenInclude(c => c.User)
                .Include(v => v.Vendedor)
                .ThenInclude(vend => vend.User)
                .FirstOrDefaultAsync(v => v.Id == visitaId);
        }
    }
}
</file>

<file path="Services/Interfaces/ICheckoutService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    public interface ICheckoutService
    {
        Task<Transacao> ProcessCheckoutAsync(string userId, Transacao checkout);
        Task<Transacao?> GetTransacaoAsync(string userId, int transacaoId);
    }
}
</file>

<file path="Services/Interfaces/IReservaService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    /// <summary>
    /// Interface para o service de gest�o de reservas.
    /// </summary>
    public interface IReservaService
    {
        /// <summary>Criar uma nova reserva.</summary>
        Task<(bool sucesso, Reserva? reserva, string mensagem)> CriarReservaAsync(
            int veiculoId, 
            int compradorId, 
            int diasValidez = 7);

        /// <summary>Cancelar uma reserva existente.</summary>
        Task<(bool sucesso, string mensagem)> CancelarReservaAsync(
            int reservaId, 
            string motivo = "");

        /// <summary>Verificar se um veiculo esta disponivel.</summary>
        Task<bool> VeiculoEstaDisponivelAsync(int veiculoId);

        /// <summary>Limpar reservas que expiraram (background job).</summary>
        Task LimparReservasExpirasAsync();

        /// <summary>Confirmar a compra de um veiculo reservado.</summary>
        Task<(bool sucesso, Transacao? transacao, string mensagem)> ConfirmarCompraAsync(
            int reservaId, 
            int compradorId);

        /// <summary>Obter todas as reservas de um comprador.</summary>
        Task<List<Reserva>> ObterReservasCompradorAsync(int compradorId);

        /// <summary>Obter uma reserva espec�fica.</summary>
        Task<Reserva?> ObterReservaAsync(int reservaId);
    }
}
</file>

<file path="Infrastructure/Data/ApplicationDbContext.cs">
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using System.Linq;
using AutoMarket.Models.Entities;
using AutoMarket.Infrastructure.Security;

namespace AutoMarket.Infrastructure.Data
{
    public class ApplicationDbContext : IdentityDbContext<Utilizador>
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        // =========================================================
        // DbSets (Tabelas)
        // =========================================================
        public DbSet<Veiculo> Veiculos { get; set; } = null!;
        public DbSet<VeiculoImagem> VeiculoImagens { get; set; } = null!;
        public DbSet<Utilizador> Utilizadores { get; set; }
        public DbSet<Vendedor> Vendedores { get; set; }
        public DbSet<Comprador> Compradores { get; set; }
        public DbSet<Denuncia> Denuncias { get; set; }
        public DbSet<Mensagem> Mensagens { get; set; }
        public DbSet<Transacao> Transacoes { get; set; }
        public DbSet<Categoria> Categorias { get; set; }
        public DbSet<Reserva> Reservas { get; set; } = null!;
        public DbSet<Visita> Visitas { get; set; } = null!;
        public DbSet<AuditoriaLog> AuditoriaLogs { get; set; } = null!;
        public DbSet<Favorito> Favoritos { get; set; } = null!;
        public DbSet<Notificacao> Notificacoes { get; set; } = null!;

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // #region 1. Configuracao de Propriedades (Enums & Tipos SQL)

            // Conversao de Enums para String (Legibilidade na BD)
            builder.Entity<Vendedor>().Property(v => v.Status).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Vendedor>().Property(v => v.TipoConta).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Veiculo>().Property(v => v.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Transacao>().Property(t => t.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Transacao>().Property(t => t.Metodo).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Denuncia>().Property(d => d.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Reserva>().Property(r => r.Estado).HasConversion<string>().HasMaxLength(50);
            builder.Entity<Visita>().Property(v => v.Estado).HasConversion<string>().HasMaxLength(50);

            // Tipos SQL Especificos (Money)
            builder.Entity<Veiculo>().Property(v => v.Preco).HasColumnType("decimal(18,2)");
            builder.Entity<Transacao>().Property(t => t.ValorPago).HasColumnType("decimal(18,2)");

            // #endregion

            // #region 2. Indices e Restricoes (Unicidade)

            // Garante relacao 1:1 estrita (Um User so pode ter 1 perfil de cada tipo)
            builder.Entity<Comprador>()
                .HasIndex(c => c.UserId)
                .IsUnique();

            builder.Entity<Vendedor>()
                .HasIndex(v => v.UserId)
                .IsUnique();

            // Indices para performance
            builder.Entity<Veiculo>()
                .HasIndex(v => v.VendedorId)
                .HasDatabaseName("IX_Veiculo_VendedorId");

            builder.Entity<Veiculo>()
                .HasIndex(v => v.Estado)
                .HasDatabaseName("IX_Veiculo_Estado");

            builder.Entity<Veiculo>()
                .HasIndex(v => v.Marca)
                .HasDatabaseName("IX_Veiculo_Marca");

            // Índices para Reservas
            builder.Entity<Reserva>()
                .HasIndex(r => r.VeiculoId)
                .HasDatabaseName("IX_Reserva_VeiculoId");

            builder.Entity<Reserva>()
                .HasIndex(r => r.CompradorId)
                .HasDatabaseName("IX_Reserva_CompradorId");

            builder.Entity<Reserva>()
                .HasIndex(r => r.DataExpiracao)
                .HasDatabaseName("IX_Reserva_DataExpiracao");

            // Índices para Visitas
            builder.Entity<Visita>()
                .HasIndex(v => v.VeiculoId)
                .HasDatabaseName("IX_Visita_VeiculoId");

            builder.Entity<Visita>()
                .HasIndex(v => v.CompradorId)
                .HasDatabaseName("IX_Visita_CompradorId");

            builder.Entity<Visita>()
                .HasIndex(v => v.VendedorId)
                .HasDatabaseName("IX_Visita_VendedorId");

            builder.Entity<Visita>()
                .HasIndex(v => v.DataHora)
                .HasDatabaseName("IX_Visita_DataHora");

            // Soft Delete Global Query Filter
            builder.Entity<Utilizador>().HasQueryFilter(u => !u.IsDeleted);

            // Encriptação do NIF (RGPD compliance) usando helper estático
            var nifConverter = new ValueConverter<string?, string?>(
                v => string.IsNullOrEmpty(v) ? v : NifEncryptionHelper.EncryptNif(v),
                v => string.IsNullOrEmpty(v) ? v : NifEncryptionHelper.DecryptNif(v),
                convertsNulls: true);

            builder.Entity<Utilizador>()
                .Property(u => u.NIF)
                .HasConversion(nifConverter);

            // #endregion

            // #region 3. Relacoes: Delete CASCADE (Pai morre -> Filhos morrem)

            // Se apagar Vendedor -> Apaga os seus Veículos
            builder.Entity<Veiculo>()
                .HasOne(v => v.Vendedor)
                .WithMany()
                .HasForeignKey(v => v.VendedorId)
                .OnDelete(DeleteBehavior.Cascade);

            // Se apagar Veículo -> Apaga as suas Imagens
            builder.Entity<VeiculoImagem>()
                .HasOne(i => i.Veiculo)
                .WithMany(v => v.Imagens)
                .HasForeignKey(i => i.VeiculoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Se apagar Veículo -> Apaga as suas Reservas (NoAction para evitar ciclos)
            builder.Entity<Reserva>()
                .HasOne(r => r.Veiculo)
                .WithMany()
                .HasForeignKey(r => r.VeiculoId)
                .OnDelete(DeleteBehavior.NoAction);

            // Se apagar Vendedor -> Apaga as suas Visitas (NoAction para evitar ciclos)
            builder.Entity<Visita>()
                .HasOne(v => v.Vendedor)
                .WithMany()
                .HasForeignKey(v => v.VendedorId)
                .OnDelete(DeleteBehavior.NoAction);

            // Se apagar Veículo -> Apaga as suas Visitas (NoAction para evitar ciclos)
            builder.Entity<Visita>()
                .HasOne(v => v.Veiculo)
                .WithMany()
                .HasForeignKey(v => v.VeiculoId)
                .OnDelete(DeleteBehavior.NoAction);

            // #endregion

            // #region 4. Relacoes: Delete RESTRICT (Seguranca & Historico)

            // --- Transacoes (Financeiro) ---
            builder.Entity<Transacao>()
                .HasOne(t => t.Comprador)
                .WithMany()
                .HasForeignKey(t => t.CompradorId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Transacao>()
                .HasOne(t => t.Veiculo)
                .WithMany()
                .HasForeignKey(t => t.VeiculoId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Transacao>()
                .HasOne(t => t.Vendedor)
                .WithMany()
                .HasForeignKey(t => t.VendedorId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Denuncias (Auditoria) ---
            builder.Entity<Denuncia>()
                .HasOne(d => d.Denunciante)
                .WithMany()
                .HasForeignKey(d => d.DenuncianteId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Denuncia>()
                .HasOne(d => d.AnalisadoPorAdmin)
                .WithMany()
                .HasForeignKey(d => d.AnalisadoPorAdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Vendedores (Aprovacoes) ---
            builder.Entity<Vendedor>()
                .HasOne(v => v.ApprovedByAdmin)
                .WithMany()
                .HasForeignKey(v => v.ApprovedByAdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Mensagens (Chat) ---
            builder.Entity<Mensagem>()
                .HasOne(m => m.Remetente)
                .WithMany()
                .HasForeignKey(m => m.RemetenteId)
                .OnDelete(DeleteBehavior.Restrict);

            builder.Entity<Mensagem>()
                .HasOne(m => m.Destinatario)
                .WithMany()
                .HasForeignKey(m => m.DestinatarioId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Categoria ---
            builder.Entity<Veiculo>()
                .HasOne(v => v.Categoria)
                .WithMany()
                .HasForeignKey(v => v.CategoriaId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- AuditoriaLog (Imutável) ---
            builder.Entity<AuditoriaLog>()
                .HasOne(a => a.Admin)
                .WithMany()
                .HasForeignKey(a => a.AdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // --- Favoritos (Bookmarks) ---
            builder.Entity<Favorito>()
                .HasOne(f => f.Comprador)
                .WithMany()
                .HasForeignKey(f => f.CompradorId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.Entity<Favorito>()
                .HasOne(f => f.Veiculo)
                .WithMany()
                .HasForeignKey(f => f.VeiculoId)
                .OnDelete(DeleteBehavior.Restrict);

            // Índice único para evitar favoritos duplicados
            builder.Entity<Favorito>()
                .HasIndex(f => new { f.CompradorId, f.VeiculoId })
                .IsUnique();

            // --- Notificações ---
            builder.Entity<Notificacao>()
                .HasOne(n => n.Destinatario)
                .WithMany()
                .HasForeignKey(n => n.DestinatarioId)
                .OnDelete(DeleteBehavior.Cascade);

            // Índice para consultas de notificações não lidas
            builder.Entity<Notificacao>()
                .HasIndex(n => new { n.DestinatarioId, n.Lida, n.DataCriacao });

            // #endregion
        }

        /// <summary>
        /// Intercepta tentativas de delete físico em entidades ISoftDelete
        /// e converte-as automaticamente em soft delete (IsDeleted = true).
        /// </summary>
        /// <remarks>
        /// Mesmo que um developer use _context.Utilizadores.Remove(user),
        /// o sistema converte automaticamente para soft delete.
        /// </remarks>
        public override int SaveChanges(bool acceptAllChangesOnSuccess)
        {
            InterceptSoftDeletes();
            return base.SaveChanges(acceptAllChangesOnSuccess);
        }

        /// <summary>
        /// Intercepta tentativas de delete físico em entidades ISoftDelete
        /// e converte-as automaticamente em soft delete (IsDeleted = true).
        /// </summary>
        /// <remarks>
        /// Mesmo que um developer use _context.Utilizadores.Remove(user),
        /// o sistema converte automaticamente para soft delete.
        /// </remarks>
        public override Task<int> SaveChangesAsync(bool acceptAllChangesOnSuccess, CancellationToken cancellationToken = default)
        {
            InterceptSoftDeletes();
            return base.SaveChangesAsync(acceptAllChangesOnSuccess, cancellationToken);
        }

        /// <summary>
        /// Intercepta entidades marcadas para delete físico e converte-as em soft delete.
        /// </summary>
        private void InterceptSoftDeletes()
        {
            // Intercetar entradas marcadas para Deleted que implementam ISoftDelete
            var entries = ChangeTracker.Entries<ISoftDelete>()
                .Where(e => e.State == EntityState.Deleted)
                .ToList();

            foreach (var entry in entries)
            {
                // Cancelar o delete físico
                entry.State = EntityState.Modified;

                // Aplicar o soft delete
                entry.Entity.IsDeleted = true;

                // Opcional: Se a entidade tiver DataRemocao, pode ser adicionado aqui
                // if (entry.Entity is Utilizador utilizador && utilizador.GetType().GetProperty("DataRemocao") != null)
                // {
                //     utilizador.DataRemocao = DateTime.UtcNow;
                // }
            }
        }
    }
}
</file>

<file path="Models/Enums/TipoConta.cs">
namespace AutoMarket.Models.Enums
{
    public enum TipoConta
    {
        Comprador = 0,
        Vendedor = 1,  // Vendedor Particular
        Empresa = 2    // Vendedor
    }
}
</file>

<file path="Models/ViewModels/LoginViewModel.cs">
using System.ComponentModel.DataAnnotations;

namespace AutoMarket.Models.ViewModels
{
    public class LoginViewModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;
        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;
        public bool RememberMe { get; set; }
    }
}
</file>

<file path="Services/Interfaces/ICarrinhoService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services
{
    public interface ICarrinhoService
    {
        /// <summary>
        /// Adiciona um veículo ao carrinho.
        /// </summary>
        void AdicionarItem(Veiculo veiculo);

        /// <summary>
        /// Remove um item do carrinho pelo ID do veículo.
        /// </summary>
        void RemoverItem(int veiculoId);

        /// <summary>
        /// Obtém a lista atual de itens no carrinho.
        /// </summary>
        List<CarrinhoItem> GetItens();

        /// <summary>
        /// Remove todos os itens do carrinho.
        /// </summary>
        void LimparCarrinho();

        /// <summary>
        /// Calcula o valor total dos itens no carrinho.
        /// </summary>
        decimal GetTotal();

        /// <summary>
        /// Retorna a quantidade de itens no carrinho.
        /// </summary>
        int GetContagem();
    }
}
</file>

<file path="wwwroot/js/site.js">
// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Write your JavaScript code.
</file>

<file path=".gitignore">
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Ww][Ii][Nn]32/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Ll]og/
[Ll]ogs/

# Visual Studio cache/options directory
.vs/

# .NET Core
project.lock.json
project.fragment.lock.json
artifacts/

# NuGet Packages
*.nupkg
*.snupkg
**/packages/*
!**/packages/build/
*.nuget.props
*.nuget.targets

# ASP.NET Scaffolding
ScaffoldingReadMe.txt

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# ReSharper
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# JetBrains Rider
.idea/
*.sln.iml

# User Secrets (sensitive configuration)
secrets.json

# .NET User Secrets
**/Properties/launchSettings.json
**/UserSecrets/

# Environment variables
.env
.env.local
.env.*.local

# Note: appsettings.json, appsettings.Development.json, and appsettings.Production.json
# are kept in source control with placeholders. Never commit real credentials.
# Use User Secrets for development or environment variables for production.

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Build output
bin/
obj/

# Visual Studio
.vs/
</file>

<file path="appsettings.Production.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning"
    }
  },
  "ConnectionStrings": {
    "_Comment": "IMPORTANTE: NÃO coloque credenciais reais neste ficheiro. Use variáveis de ambiente ou User Secrets.",
    "_Comment2": "Para produção, configure a connection string através de variáveis de ambiente:",
    "_Comment3": "export ConnectionStrings__DefaultConnection=\"Server=...;Database=...;User Id=...;Password=...;\"",
    "_Comment4": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "DefaultConnection": "Server=YOUR_SERVER;Database=AutoMarket;User Id=YOUR_USER;Password=YOUR_PASSWORD;MultipleActiveResultSets=true;TrustServerCertificate=False;Encrypt=True;"
  },
  "EmailSettings": {
    "_Comment": "IMPORTANTE: NÃO coloque credenciais reais neste ficheiro. Use variáveis de ambiente:",
    "_Comment2": "export EmailSettings__SmtpServer=\"smtp.gmail.com\"",
    "_Comment3": "export EmailSettings__SmtpPort=\"587\"",
    "_Comment4": "export EmailSettings__SmtpUsername=\"seu-email@gmail.com\"",
    "_Comment5": "export EmailSettings__SmtpPassword=\"sua-senha-app\"",
    "_Comment6": "export EmailSettings__FromEmail=\"noreply@automarket.com\"",
    "_Comment7": "export EmailSettings__SecureSocketOptions=\"StartTls\"",
    "_Comment8": "SecureSocketOptions: None, Auto, StartTls, StartTlsWhenAvailable, SslOnConnect",
    "_Comment9": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "SmtpServer": "",
    "SmtpPort": 587,
    "SmtpUsername": "",
    "SmtpPassword": "",
    "FromEmail": "noreply@automarket.com",
    "FromName": "AutoMarket",
    "SecureSocketOptions": "StartTls"
  },
  "Encryption": {
    "_Comment": "IMPORTANTE: NÃO coloque a chave de encriptação neste ficheiro. Use variáveis de ambiente:",
    "_Comment2": "export Encryption__Key=\"sua-chave-secreta-de-32-caracteres-minimo\"",
    "_Comment3": "Ou use Azure Key Vault, AWS Secrets Manager, ou outro serviço de gestão de segredos.",
    "_Comment4": "A chave deve ter pelo menos 32 caracteres para segurança adequada.",
    "Key": ""
  }
}
</file>

<file path="Controllers/CheckoutController.cs">
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Models.ViewModels;
using AutoMarket.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Controllers
{
    [Authorize]
    public class CheckoutController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<Utilizador> _userManager;
        private readonly ICarrinhoService _carrinhoService;
        private readonly ILogger<CheckoutController> _logger;

        public CheckoutController(
            ApplicationDbContext context,
            UserManager<Utilizador> userManager,
            ICarrinhoService carrinhoService,
            ILogger<CheckoutController> logger)
        {
            _context = context;
            _userManager = userManager;
            _carrinhoService = carrinhoService;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> Index()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return RedirectToAction("Login", "Conta");

            var carrinhoItens = _carrinhoService.GetItens();
            if (!carrinhoItens.Any()) return RedirectToAction("Index", "Carrinho");

            var model = new CheckoutViewModel
            {
                // Pré-preenchemos com os dados do perfil para facilitar a vida ao user
                NomeCompleto = user.Nome, 
                Morada = user.Morada ?? string.Empty, // Garante que não é null
                // CodigoPostal não existe no Utilizador, user tem de preencher

                // Se o user já tiver NIF no perfil, ativamos a opção de fatura e preenchemos
                NifFaturacao = user.NIF,
                QueroFaturaComNif = !string.IsNullOrEmpty(user.NIF),
                ValorTotal = _carrinhoService.GetTotal()
            };

            return View(model);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ProcessarCompra(CheckoutViewModel model)
        {
            var itensCarrinho = _carrinhoService.GetItens();
            if (!itensCarrinho.Any()) return RedirectToAction("Index", "Carrinho");

            if (!ModelState.IsValid)
            {
                model.ValorTotal = _carrinhoService.GetTotal();
                return View("Index", model);
            }

            var user = await _userManager.GetUserAsync(User);
            if (user == null) return RedirectToAction("Login", "Conta");

            // 1. Iniciar transação de BD
            using var dbTransaction = await _context.Database.BeginTransactionAsync();

            try
            {
                // 2. Obter ou criar comprador
                var comprador = await _context.Compradores.FirstOrDefaultAsync(c => c.UserId == user.Id);
                if (comprador == null)
                {
                    comprador = new Comprador { UserId = user.Id };
                    _context.Add(comprador);
                    await _context.SaveChangesAsync();
                }

                // 3. Atualizar NIF
                if (model.QueroFaturaComNif && string.IsNullOrEmpty(user.NIF) && !string.IsNullOrEmpty(model.NifFaturacao))
                {
                    user.NIF = model.NifFaturacao;
                    await _userManager.UpdateAsync(user);
                }

                var transacoesIds = new List<int>();

                // 4. Processar cada item do carrinho
                foreach (var item in itensCarrinho)
                {
                    var veiculoDb = await _context.Veiculos.FindAsync(item.VeiculoId);
                    if (veiculoDb == null || veiculoDb.Estado != EstadoVeiculo.Ativo)
                    {
                        throw new InvalidOperationException($"O veículo {item.Marca} {item.Modelo} já não está disponível.");
                    }

                    var transacao = new Transacao
                    {
                        DataTransacao = DateTime.UtcNow,
                        ValorPago = item.Preco,
                        Metodo = model.MetodoPagamento,
                        Estado = EstadoTransacao.Pendente,
                        CompradorId = comprador.Id,
                        VeiculoId = item.VeiculoId,
                        VendedorId = veiculoDb.VendedorId,
                        NifFaturacaoSnapshot = model.QueroFaturaComNif
                                       ? model.NifFaturacao
                                       : null,
                        MoradaEnvioSnapshot = $"{model.Morada}, {model.CodigoPostal}"
                    };
                    _context.Transacoes.Add(transacao);
                    veiculoDb.Estado = EstadoVeiculo.Reservado;
                    await _context.SaveChangesAsync();
                    transacoesIds.Add(transacao.Id);
                }
                // 5. Commit da transação de BD
                await dbTransaction.CommitAsync();

                _carrinhoService.LimparCarrinho();

                return RedirectToAction("Sucesso", new { id = transacoesIds.First() }); // TODO: ALTERAR ( redirecionar para página de sucesso )
            }
            catch (Exception ex)
            {
                await dbTransaction.RollbackAsync();
                _logger.LogError(ex, "Erro ao processar compra para o utilizador {UserId}", user.Id);
                ModelState.AddModelError("", ex.Message);
                model.ValorTotal = _carrinhoService.GetTotal();
                return View("Index", model);
            }
        }   

        [HttpGet]
        public async Task<IActionResult> Sucesso(int id)
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return RedirectToAction("Login", "Conta");

            var transacao = await _context.Transacoes
                .Include(t => t.Comprador)
                .FirstOrDefaultAsync(t => t.Id == id);

            if (transacao == null) return NotFound();

            // Verificar se a transação pertence ao user logado
            if (transacao.Comprador.UserId != user.Id)
            {
                return Forbid();
            }
                    
            return View(transacao);
        }
    }
}
</file>

<file path="Models/ViewModels/ErrorViewModel.cs">
namespace AutoMarket.Models.ViewModels
{
    public class ErrorViewModel
    {
        public string? RequestId { get; set; }

        public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

        public string? Message { get; set; }
    }
}
</file>

<file path="Services/Interfaces/IEmailAuthService.cs">
using AutoMarket.Models.Entities;

namespace AutoMarket.Services.Interfaces
{
    public interface IEmailAuthService
    {
        /// <summary>
        /// Gera o template e envia o email de confirmação de conta.
        /// </summary>
        Task EnviarEmailConfirmacaoAsync(Utilizador user, string confirmationLink);
    }
}
</file>

<file path="wwwroot/css/site.css">
html {
  font-size: 14px;
}

@media (min-width: 768px) {
  html {
    font-size: 16px;
  }
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
  box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

html {
  position: relative;
  min-height: 100%;
}

body {
    margin-bottom: 60px;
}

/* Authentication form containers */
.login-container {
  max-width: 450px;
  margin: 2rem auto;
}

.register-container {
  max-width: 520px;
  margin: 2rem auto;
}
</file>

<file path="wwwroot/js/script.js">
// AutoMarket JS
// Interatividade inicial (abas, formulários, etc.)

document.addEventListener('DOMContentLoaded', function() {
    // Alternar abas Login/Registo
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            panes.forEach(pane => pane.classList.remove('active'));
            document.getElementById(this.dataset.target).classList.add('active');
        });
    });
});

// Placeholder para validação de formulários (Simples)
function validarFormLogin() {
    // TODO: Adicionar validações reais
    return true;
}

function validarFormRegisto() {
    // TODO: Adicionar validações reais
    return true;
}

// TODO: Implementar fetch() para buscar veículos da API (RF1)
// TODO: Enviar dados do formulário 'criar-anuncio' para o backend (RF12)
</file>

<file path="README.md">
Here's the improved README.md file incorporating the new content while maintaining the existing structure and information:

# Project Title

## Description

[Provide a brief description of the project, its purpose, and key features.]

## Installation

[Instructions on how to install the project, including prerequisites and setup steps.]

## Usage

[Examples of how to use the project, including code snippets and command-line instructions.]

## Configuration

[Details on how to configure the project, including any necessary configuration files or environment variables.]

## Security: Encryption Key Configuration

Set a strong 256-bit encryption key via secret configuration (never commit keys to source control):

- Generate a key (Base64):
  - Linux/macOS: `openssl rand -base64 32`
  - Windows (PowerShell): `[Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))`
- Configure it as a secret (preferred):
  - Development (user secrets): `dotnet user-secrets set "Encryption:Key" "<base64-key>"`
  - Or environment variable: `setx Encryption__Key "<base64-key>"` (Windows) / `export Encryption__Key="<base64-key>"` (bash)
- Production: inject via your secret store/Key Vault or deployment environment variable `Encryption__Key`.
- Startup will fail in Production if `Encryption:Key` is missing or empty (fail-fast guard).

## Contributing

[Guidelines for contributing to the project, including how to submit issues and pull requests.]

## License

[Information about the project's license, including any relevant links.]

## Contact

[Details on how to contact the project maintainers or contributors.]

### Changes Made:
1. Incorporated the new "Security: Encryption Key Configuration" section into the existing structure.
2. Ensured that the new content flows logically within the README, maintaining coherence with the other sections.
3. Preserved the original formatting and headings for consistency.
</file>

<file path="wwwroot/css/style.css">
/*
    AutoMarket Stylesheet
    Criado segundo requisitos do projeto para responsividade, esquema de cores, componentes comuns e utilitários.
*/

:root {
    --cor-primaria: #002147;
    --cor-cta: #ff7000;
    --cor-bg: #f7f7f7;
    --cor-texto: #222;
    --cor-footer: #1a1a1a;
    --cor-destaque: #e0eefc;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--cor-bg);
    color: var(--cor-texto);
    min-height: 100vh;
}

header {
    background: var(--cor-primaria);
    color: #fff;
    padding: 1rem 0;
}
header .nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
}

.logo {
    font-size: 2rem;
    font-weight: bold;
    letter-spacing: 2px;
    text-decoration: none;
    color: #fff;
}

nav ul {
    list-style: none;
    display: flex;
    gap: 2rem;
}
nav ul li a {
    text-decoration: none;
    color: #fff;
    font-size: 1rem;
    transition: color 0.2s;
}
nav ul li a:hover { color: var(--cor-cta); }

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-primario {
    background: var(--cor-primaria);
    color: #fff;
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-primario:hover {
    background: #18345a;
}

.btn-cta {
    background: var(--cor-cta);
    color: #fff;
    padding: 0.6rem 2rem;
    border: none;
    border-radius: 3px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px #ff700030;
    transition: background 0.2s;
}
.btn-cta:hover {
    background: #ff8800;
}

footer {
    background: var(--cor-footer);
    color: #fff;
    text-align: center;
    padding: 2rem 0 1rem;
    font-size: 1rem;
}

.vehicle-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
    padding: 1rem;
    margin: 1rem 0;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: box-shadow 0.2s;
}
.vehicle-card:hover {
    box-shadow: 0 4px 16px #00214722;
}
.vehicle-card img {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 6px;
    object-fit: cover;
    margin-bottom: 0.5rem;
}
.vehicle-card h3 {
    font-size: 1.1rem;
    color: var(--cor-primaria);
    margin-bottom: 0.4rem;
    font-weight: bold;
}
.vehicle-card .price {
    color: var(--cor-cta);
    font-size: 1.2rem;
    font-weight: bold;
}
.vehicle-card .meta {
    font-size: 0.96rem;
    color: #444;
    margin-bottom: 0.2rem;
}

.filter-sidebar {
    background: var(--cor-destaque);
    border-radius: 12px;
    padding: 1.5rem 1rem;
    margin-right: 2rem;
    min-width: 220px;
}

.filter-group label {
    font-size: 1rem;
    color: var(--cor-primaria);
    font-weight: 500;
}
.filter-group input,
.filter-group select {
    width: 100%;
    margin: 0.2rem 0 1rem 0;
    padding: 0.3rem;
    border-radius: 4px;
    border: 1px solid #ccc;
}

.form-step {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
    padding: 2rem 1.5rem;
    margin-bottom: 1.5rem;
}

.container-main {
    max-width: 1050px;
    margin: 2rem auto 3rem auto;
}
.favorites-title {
    margin-bottom: 2rem;
}
.favorites-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
}
.remove-fav-btn {
    margin-top: 1rem;
}

.card {
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px #00214710;
}
.card-lg {
    padding: 1.5rem;
}
.card-mb {
    margin-bottom: 0.8rem;
}
.card-mb-lg {
    margin-bottom: 1.2rem;
}
.status-badge {
    border-radius: 3px;
    padding: 2px 7px;
    font-size: 0.94em;
    font-weight: 500;
}
.status-active {
    background: #bee3b4;
    color: #256908;
}
.status-paused {
    background: #ffe9a0;
    color: #b88301;
}

.seller-fields {
    border-left: 3px solid #0d6efd;
    padding-left: 15px;
}

.badge-container {
    margin: 0.8rem 0;
}

@media (max-width: 900px) {
    header .nav { flex-direction: column; gap: 1.5rem; }
    .filter-sidebar { min-width: 170px; }
}

@media (max-width: 600px) {
    header .nav { flex-direction: column; gap: 1rem; }
    .btn-cta, .btn-primario { width: 100%; }
    .filter-sidebar { margin-right: 0; margin-bottom: 2rem; }
    .vehicle-card { max-width: 100%; }
    .form-step { padding: 1rem; }
    .filter-sidebar { padding: 1rem 0.5rem; }
}
</file>

<file path="appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": ""
  },
  "DefaultAdmin": {
    "Email": "",
    "Password": "" 
  },
  "EmailSettings": {
    "SmtpServer": "",
    "SmtpPort": 587,
    "SmtpUsername": "",
    "SmtpPassword": "",
    "FromEmail": "noreply@automarket.com",
    "FromName": "AutoMarket",
    "SecureSocketOptions": "StartTls"
  },
  "FileUploadSettings": {
    "MaxFileSizePerFileInBytes": 10485760,
    "MaxTotalSizePerCarInBytes": 52428800,
    "MaxFilesPerCar": 10,
    "AllowedExtensions": [ ".jpg", ".jpeg", ".png", ".webp" ],
    "UploadFolder": "images/cars"
  },
  "Encryption": {
    "Key": ""
  }
}
</file>

<file path="AutoMarket.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>823e9d94-4f52-46ad-bce5-166fb074c3cf</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="Areas\Vendedores\Views\Carros\**" />
    <Content Remove="Areas\Vendedores\Views\Carros\**" />
    <EmbeddedResource Remove="Areas\Vendedores\Views\Carros\**" />
    <None Remove="Areas\Vendedores\Views\Carros\**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.22" />
    
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.22" />
    
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.22">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    
    <PackageReference Include="MailKit" Version="4.9.0" />
    <PackageReference Include="MimeKit" Version="4.9.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Areas\Admin\Pages\" />
    <Folder Include="Areas\Admin\NewFolder\" />
    <Folder Include="Areas\Public\Pages\" />
    <Folder Include="Areas\Public\Views\Transacao\" />
    <Folder Include="Areas\Public\Views\Visitas\" />
    <Folder Include="Areas\Vendedores\Pages\" />
    <Folder Include="docs\" />
    <Folder Include="Infrastructure\Migrations\" />
    <Folder Include="Models\ViewModels\Carros\" />
  </ItemGroup>
</Project>
</file>

<file path="Models/ViewModels/RegisterViewModel.cs">
using System.ComponentModel.DataAnnotations;
using AutoMarket.Models.Attributes;

namespace AutoMarket.Models.ViewModels
{
    public class RegisterViewModel : IValidatableObject
    {
        // --- Identity Base ---
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = string.Empty;

        [Required]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = string.Empty;

        [DataType(DataType.Password)]
        [Display(Name = "Confirmar password")]
        [Compare("Password", ErrorMessage = "As passwords não coincidem.")]
        public string ConfirmPassword { get; set; } = string.Empty;

        [Required]
        [Display(Name = "Nome Completo")]
        public string Nome { get; set; } = string.Empty;

        [Required]
        [StringLength(200, ErrorMessage= "A morada não pode ter mais de 200 caracteres.")]
        [Display(Name = "Morada")]
        public string Morada { get; set; } = string.Empty;

        [Required]
        [StringLength(50, ErrorMessage = "O contacto não pode ter mais de 50 caracteres.")]
        [Display(Name = "Contacto")]
        public string Contacto { get; set; } = string.Empty;

        [Required(ErrorMessage = "Por favor, selecione o tipo de conta.")]
        [Display(Name = "Tipo de Conta")]
        public TipoConta TipoConta { get; set; } = TipoConta.Comprador;

        // --- Campos específicos para Vendedor --- (Nullable para não dar erro de validação ao comprador)
        [Display(Name ="NIF")]
        [NifPortugues]
        public string? NIF { get; set; }

        // -- Lógica de validação personalizada do NIF --
        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // Regra 1: Validação para empresas
            if (TipoConta == TipoConta.Empresa)
            {
                if (string.IsNullOrWhiteSpace(NIF))
                {
                    yield return new ValidationResult("O NIF é obrigatório para contas de Empresa.", new[] { nameof(NIF) });
                }
                else if (!NIF.Trim().StartsWith("5"))
                {
                    yield return new ValidationResult("NIF de empresa deve começar por 5.", new[] { nameof(NIF) });
                }
            }
        }
    }
}
</file>

<file path="Views/Shared/_Header.cshtml">
@using Microsoft.AspNetCore.Identity;
@using AutoMarket.Models;
@inject SignInManager<Utilizador> SignInManager

<header class="bg-primary py-3 sticky-top shadow-sm">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand fw-bold fs-5" asp-area="" asp-controller="Home" asp-action="Index">
                🚗 AutoMarket
            </a>

            <!-- Toggler para Mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Menu Principal -->
            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Links Centrais -->
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" asp-area="" asp-controller="Veiculos" asp-action="Index">Veículos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Sobre">Sobre</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Ajuda">Ajuda</a>
                    </li>
                </ul>

                <!-- Links Direita (Autenticação) -->
                <ul class="navbar-nav ms-auto gap-2">
                    @if (SignInManager.IsSignedIn(User))
                    {
                        <!-- Dropdown do Utilizador -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i> @(User.Identity?.Name?.Split('@')[0] ?? "Utilizador")
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" asp-area="" asp-controller="Conta" asp-action="Perfil">
                                        <i class="bi bi-person"></i> O Meu Perfil
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" asp-area="" asp-controller="Transacoes" asp-action="MinhasCompras">
                                        <i class="bi bi-bag-check"></i> Minhas Compras
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" asp-area="" asp-controller="Transacoes" asp-action="MinhasVendas">
                                        <i class="bi bi-cash-stack"></i> Minhas Vendas
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form asp-area="" asp-controller="Conta" asp-action="Logout" method="post" class="px-2">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="bi bi-box-arrow-right"></i> Logout
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    }
                    else
                    {
                        <li class="nav-item">
                            <a class="nav-link" asp-area="" asp-controller="Conta" asp-action="Login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-area="" asp-controller="Conta" asp-action="Register">Registar</a>
                        </li>
                    }

                    <!-- Botão CTA (Vender) -->
                    <li class="nav-item">
                        <a class="btn btn-warning fw-bold ms-2" asp-area="Vendedores" asp-controller="Carros" asp-action="Index">
                            ➕ Vender Carro
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<style>
    header .navbar-dark .nav-link:hover {
        color: var(--cor-cta) !important;
        transition: color 0.2s;
    }

    header .btn-warning:hover {
        background-color: #e6a800 !important;
    }

    /* Dropdown Menu Styling */
    .dropdown-menu {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        margin-top: 0.5rem;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        transition: background-color 0.2s;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .dropdown-item i {
        margin-right: 0.5rem;
    }
</style>
</file>

<file path="Program.cs">
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using AutoMarket.Services.Implementations;
using AutoMarket.Models.Constants;
using AutoMarket.Infrastructure.Data;
using AutoMarket.Infrastructure.Security;
using AutoMarket.Services;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllersWithViews();

// Add localization services
builder.Services.AddLocalization(options => options.ResourcesPath = "Resources");
builder.Services.Configure<RequestLocalizationOptions>(options =>
{
    var supportedCultures = new[] { "pt-PT", "en-US" };
    options.SetDefaultCulture("pt-PT")
           .AddSupportedCultures(supportedCultures)
           .AddSupportedUICultures(supportedCultures);
});

// Adiciona o serviço de encriptação (RGPD compliance)
builder.Services.AddSingleton<IEncryptionService, EncryptionService>();

// Adiciona o DbContext
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Adiciona o ASP.NET Core Identity com UserStore customizado (soft delete)
builder.Services.AddIdentity<Utilizador, IdentityRole>(options =>
{
    options.Password.RequireDigit = false; // Simplificado para testes
    options.Password.RequireLowercase = false;
    options.Password.RequireUppercase = false;
    options.Password.RequireNonAlphanumeric = false;
    options.Password.RequiredLength = 6; // Simplificado para testes
    options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(15);
    options.Lockout.MaxFailedAccessAttempts = 5;
    options.Lockout.AllowedForNewUsers = true;
    options.User.RequireUniqueEmail = true;
    options.SignIn.RequireConfirmedEmail = false; // ❌ Desativado - sem confirmação de email
})
.AddEntityFrameworkStores<ApplicationDbContext>() 
.AddUserStore<CustomUserStore>()                
.AddDefaultTokenProviders()
.AddClaimsPrincipalFactory<CustomClaimsPrincipalFactory>();

builder.Services.AddHttpContextAccessor();
builder.Services.AddScoped<IAuthorizationHandler, VendedorAprovadoHandler>();
builder.Services.AddSingleton<EmailFailureTracker>(sp =>
    new EmailFailureTracker(maxFailures: 5, failureWindow: TimeSpan.FromMinutes(5), circuitBreakerTimeout: TimeSpan.FromMinutes(1)));
builder.Services.AddScoped<IEmailSender, EmailSender>();
builder.Services.AddScoped<EmailTemplateService>();
builder.Services.AddScoped<IEmailAuthService, EmailAuthService>();

builder.Services.AddScoped<IFileService, FileService>();

builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<ICheckoutService, CheckoutService>();

builder.Services.AddScoped<ICarrinhoService, CarrinhoService>();

// Adicionar serviços de Reservas e Visitas
builder.Services.AddScoped<IReservaService, ReservaService>();
builder.Services.AddScoped<IVisitaService, VisitaService>();

// Adicionar serviços de Denúncias, Auditoria e Notificações
builder.Services.AddScoped<IDenunciaService, DenunciaService>();
builder.Services.AddScoped<IAuditoriaService, AuditoriaService>();
builder.Services.AddScoped<INotificacaoService, NotificacaoService>();
builder.Services.AddScoped<IEstatisticasService, EstatisticasService>();
builder.Services.AddScoped<IGestaoUtilizadoresService, GestaoUtilizadoresService>();
builder.Services.AddScoped<IFavoritoService, FavoritoService>();
builder.Services.AddScoped<IMensagensService, MensagensService>();

// Adicionar Background Service para limpeza de reservas expiradas
builder.Services.AddHostedService<LimparReservasHostedService>();

builder.Services.AddSession(options => {                 
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

builder.Services.ConfigureApplicationCookie(options =>
{
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = builder.Environment.IsDevelopment()
        ? CookieSecurePolicy.SameAsRequest
        : CookieSecurePolicy.Always;
    options.ExpireTimeSpan = TimeSpan.FromMinutes(30);
    options.LoginPath = "/Public/Conta/Login";
    options.AccessDeniedPath = "/Public/Home/Index"; // Redireciona para Home em vez de AguardandoAprovacao
    options.SlidingExpiration = true;
});

var app = builder.Build();

var encryptionService = app.Services.GetRequiredService<IEncryptionService>();
NifEncryptionHelper.Initialize(encryptionService);

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseSession();
var localizationOptions = app.Services.GetRequiredService<Microsoft.Extensions.Options.IOptions<RequestLocalizationOptions>>().Value;
app.UseRequestLocalization(localizationOptions);
app.UseAuthentication();
app.UseAuthorization();

app.UseStatusCodePages(context =>
{
    // Deixar o sistema padrão tratar erros 403
    // Não fazemos redirecionamentos aqui
    return Task.CompletedTask;
});
app.MapControllerRoute(
    name: "areas",
    pattern: "{area:exists}/{controller=Home}/{action=Index}/{id?}");

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}",
    defaults: new { area = "Public" }
);

app.MapAreaControllerRoute(
    name: "vendedores",
    areaName: "Vendedores",
    pattern: "Vendedores/{controller=Carros}/{action=Index}/{id?}");

// Inicializar base de dados (criar roles, utilizadores de teste)
using (var scope = app.Services.CreateScope())
{
    await DbInitializer.InitializeAsync(scope.ServiceProvider);
}

app.Run();
</file>

<file path="Controllers/ContaController.cs">
using AutoMarket.Models.Constants;
using AutoMarket.Infrastructure.Data;
using AutoMarket.Models.Entities;
using AutoMarket.Models.Enums;
using AutoMarket.Models.ViewModels;
using AutoMarket.Services.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Controllers
{
    public class ContaController : Controller
    {
        private readonly UserManager<Utilizador> _userManager;
        private readonly SignInManager<Utilizador> _signInManager;
        private readonly ApplicationDbContext _context;
        private readonly IEmailAuthService _emailAuthService;
        private readonly ILogger<ContaController> _logger;

        public ContaController(
            UserManager<Utilizador> userManager,
            SignInManager<Utilizador> signInManager,
            ApplicationDbContext context,
            IEmailAuthService emailAuthService,
            ILogger<ContaController> logger)
        {
            _userManager = userManager;
            _signInManager = signInManager;
            _context = context;
            _logger = logger;
            _emailAuthService = emailAuthService;
        }

        [HttpGet]
        public IActionResult Register()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Register(RegisterViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            // 1. Iniciar Transação
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var user = new Utilizador
                {
                    UserName = model.Email,
                    Email = model.Email,
                    Nome = model.Nome,
                    Morada = model.Morada,
                    PhoneNumber = model.Contacto,
                    NIF = model.NIF,
                    DataRegisto = DateTime.UtcNow
                };

                // 2. Criar o User (Identity)
                var result = await _userManager.CreateAsync(user, model.Password);

                if (result.Succeeded)
                {
                    // 3. Criar o Perfil Específico (Vendedor ou Comprador) baseado no enum
                    if (model.TipoConta == TipoConta.Vendedor || model.TipoConta == TipoConta.Empresa)
                    {
                        var vendedor = new Vendedor
                        {
                            UserId = user.Id,
                            TipoConta = model.TipoConta,
                            Status = StatusAprovacao.Pendente
                        };
                        _context.Vendedores.Add(vendedor);
                        await _userManager.AddToRoleAsync(user, Roles.Vendedor);
                    }
                    else
                    {
                        var comprador = new Comprador
                        {
                            UserId = user.Id,
                            ReceberNotificacoes = false
                        };
                        _context.Compradores.Add(comprador);
                        await _userManager.AddToRoleAsync(user, Roles.Comprador);
                    }
                    // 4. Gravar Perfil na BD
                    await _context.SaveChangesAsync();
                    // 5. Se chegámos aqui sem erros, confirmar a transação
                    await transaction.CommitAsync();

                    // Lógica de envio de email de confirmação
                    var token = await _userManager.GenerateEmailConfirmationTokenAsync(user);

                    var confirmationLink = Url.Action(nameof(ConfirmarEmail), "Conta",
                        new { userId = user.Id, token }, Request.Scheme);

                    if (string.IsNullOrEmpty(confirmationLink))
                    {
                        _logger.LogError("Falha ao gerar link de confirmação para {Email}", user.Email);
                        // allow registration to complete, but log the issue
                    }
                    else
                    {
                        await _emailAuthService.EnviarEmailConfirmacaoAsync(user, confirmationLink);
                    }
                    return RedirectToAction("Index", "Home");
                }
                // Se o Identity falhar (ex: password fraca), adicionar erros ao ModelState
                foreach (var error in result.Errors)
                {
                    ModelState.AddModelError(string.Empty, error.Description);
                }
            }
            catch (Exception ex)
            {
                // Se ocorrer um erro, reverter a transação
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Erro ao registar utilizador {Email}", model.Email);
                ModelState.AddModelError(string.Empty, "Ocorreu um erro interno. Tente novamente.");
            }
            return View(model);
        }

        [HttpGet]
        public IActionResult Login()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Login(LoginViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            // 1. Tentar Login
            var result = await _signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, lockoutOnFailure: false);

            if (result.Succeeded)
            {
                var user = await _userManager.FindByEmailAsync(model.Email);
                if (user == null)
                {
                    await _signInManager.SignOutAsync();
                    ModelState.AddModelError(string.Empty, "Erro inesperado ao obter dados do utilizador.");
                    return View(model);
                }

                // 2. Verificar Bloqueio Global
                if (user.IsBlocked || user.IsDeleted)
                {
                    await _signInManager.SignOutAsync();
                    ModelState.AddModelError(string.Empty, "Conta bloqueada ou eliminada.");
                    return View(model);
                }

                // 3. Verificar Vendedor
                if (await _userManager.IsInRoleAsync(user, Roles.Vendedor))
                {
                    var vendedor = await _context.Vendedores
                        .Select(v => new { v.UserId, v.Status })
                        .FirstOrDefaultAsync(v => v.UserId == user.Id);

                    if (vendedor != null && vendedor.Status != StatusAprovacao.Aprovado)
                    {
                        _logger.LogWarning("Vendedor {Email} tentou entrar mas está com status {Status}", user.Email, vendedor.Status);

                        return RedirectToAction(nameof(AguardandoAprovacao));
                    }
                }

                return RedirectToAction("Index", "Home");
            }

            ModelState.AddModelError(string.Empty, "Login inválido.");
            return View(model);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Logout()
        {
            await _signInManager.SignOutAsync();
            return RedirectToAction("Index", "Home");
        }

        // Action para confirmar email (link clicado pelo user)
        [HttpGet]
        public async Task<IActionResult> ConfirmarEmail(string userId, string token)
        {
            if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(token)) return View("Error", new ErrorViewModel { Message = "Link de confirmação inválido ou incompleto." }); 

            var user = await _userManager.FindByIdAsync(userId);
            if (user == null) return View("Error", new ErrorViewModel { Message = "Utilizador não encontrado no sistema." });

            var result = await _userManager.ConfirmEmailAsync(user, token);
            if (result.Succeeded)
                return View("EmailConfirmado");

            var erros = string.Join(", ", result.Errors.Select(e => e.Description));

            _logger.LogWarning("Falha na confirmação de email para {UserId}: {Errors}",userId, erros);
            return View("Error", new ErrorViewModel
            {
                Message = "Não foi possível confirmar o email. O link pode ter expirado ou já foi utilizado."
                // OPCIONAL: Request Id para debug técnico
                // RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier
            });
        }

        [HttpGet]
        [Authorize]
        public IActionResult PreencherDadosFiscais()
        {
            return View(); // Uma view simples com um input "NIF"
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> PreencherDadosFiscais(DadosFiscaisViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var user = await _userManager.GetUserAsync(User);
            if (user == null) { return Unauthorized(); }
            user.NIF = model.NIF; // Grava no perfil para sempre

            var result = await _userManager.UpdateAsync(user);

            if (!result.Succeeded)
            {
                foreach (var error in result.Errors)
                {
                    ModelState.AddModelError(string.Empty, error.Description);
                }
                return View(model);
            }

            // Se tínhamos uma transação pendente, voltamos para lá
            if (TempData["ReturnUrl"] is string returnUrl)
            {
                TempData.Keep("ReturnUrl");
                return Redirect(returnUrl); // Volta para o checkout
            }
            // Senão, volta para a home
            return RedirectToAction("Index", "Home");
        }

        [HttpGet]
        [Authorize(Roles = Roles.Vendedor)]
        public IActionResult AguardandoAprovacao()
        {
            // Vamos buscar o utilizador para garantir que é mesmo um Vendedor
            // (Otimização: Injetar IAuthMessageService aqui se quiseres reenviar email, etc.)
            return View();
        }

        // GET: Conta/AccessDenied
        [HttpGet]
        public IActionResult AccessDenied(string returnUrl = null)
        {
            ViewData["ReturnUrl"] = returnUrl;
            _logger.LogWarning("Acesso negado para utilizador {User} ao tentar aceder {Url}", 
                User.Identity?.Name ?? "Anónimo", returnUrl ?? "URL desconhecido");
            return View();
        }

        // GET: Conta/Perfil
        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Perfil()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return NotFound();

            // Buscar estatísticas do utilizador
            ViewBag.IsVendedor = await _userManager.IsInRoleAsync(user, Roles.Vendedor);
            ViewBag.IsComprador = await _userManager.IsInRoleAsync(user, Roles.Comprador);

            if (ViewBag.IsComprador)
            {
                var comprador = await _context.Compradores
                    .FirstOrDefaultAsync(c => c.UserId == user.Id);

                if (comprador != null)
                {
                    ViewBag.TotalCompras = await _context.Transacoes
                        .Where(t => t.CompradorId == comprador.Id)
                        .CountAsync();
                }
            }

            if (ViewBag.IsVendedor)
            {
                var vendedor = await _context.Vendedores
                    .FirstOrDefaultAsync(v => v.UserId == user.Id);

                if (vendedor != null)
                {
                    ViewBag.TotalVendas = await _context.Transacoes
                        .Where(t => t.VendedorId == vendedor.Id)
                        .CountAsync();

                    ViewBag.TotalVeiculos = await _context.Veiculos
                        .Where(v => v.VendedorId == vendedor.Id)
                        .CountAsync();

                    ViewBag.StatusVendedor = vendedor.Status.ToString();
                }
            }

            var model = new EditarPerfilViewModel
            {
                Nome = user.Nome,
                Email = user.Email ?? string.Empty,
                Morada = user.Morada,
                Contacto = user.PhoneNumber ?? string.Empty,
                NIF = user.NIF,
                DataRegisto = user.DataRegisto
            };

            return View(model);
        }

        // POST: Conta/Perfil
        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Perfil(EditarPerfilViewModel model)
        {
            if (!ModelState.IsValid)
            {
                // Recarregar ViewBag para estatísticas
                var userTemp = await _userManager.GetUserAsync(User);
                if (userTemp == null)
                {
                    ViewBag.IsVendedor = false;
                    ViewBag.IsComprador = false;
                }
                else
                {
                    ViewBag.IsVendedor = await _userManager.IsInRoleAsync(userTemp, Roles.Vendedor);
                    ViewBag.IsComprador = await _userManager.IsInRoleAsync(userTemp, Roles.Comprador);
                }
                return View(model);
            }

            var user = await _userManager.GetUserAsync(User);
            if (user == null) return NotFound();

            // Atualizar dados
            user.Nome = model.Nome;
            user.Morada = model.Morada;
            user.PhoneNumber = model.Contacto;
            user.NIF = model.NIF;

            var result = await _userManager.UpdateAsync(user);

            if (result.Succeeded)
            {
                TempData["MensagemSucesso"] = "Perfil atualizado com sucesso!";
                _logger.LogInformation("Utilizador {UserId} atualizou o perfil.", user.Id);
                return RedirectToAction(nameof(Perfil));
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error.Description);
            }

            ViewBag.IsVendedor = await _userManager.IsInRoleAsync(user, Roles.Vendedor);
            ViewBag.IsComprador = await _userManager.IsInRoleAsync(user, Roles.Comprador);
            return View(model);
        }

        // GET: Conta/AlterarPassword
        [HttpGet]
        [Authorize]
        public IActionResult AlterarPassword()
        {
            return View();
        }

        // POST: Conta/AlterarPassword
        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> AlterarPassword(AlterarPasswordViewModel model)
        {
            if (!ModelState.IsValid) return View(model);

            var user = await _userManager.GetUserAsync(User);
            if (user == null) return NotFound();

            var result = await _userManager.ChangePasswordAsync(user, model.PasswordAtual, model.NovaPassword);

            if (result.Succeeded)
            {
                await _signInManager.RefreshSignInAsync(user); // Mantém o user logado
                TempData["MensagemSucesso"] = "Password alterada com sucesso!";
                _logger.LogInformation("Utilizador {UserId} alterou a password.", user.Id);
                return RedirectToAction(nameof(Perfil));
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error.Description);
            }

            return View(model);
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ApagarConta()
        {
            var user = await _userManager.GetUserAsync(User);
            if (user == null) return NotFound();

            // LÓGICA DE SOFT DELETE
            // 1. Ofuscar dados pessoais (Opcional, mas recomendado por RGPD)
            // user.Email = $"deleted_{Guid.NewGuid()}@automarket.com";
            // user.UserName = user.Email;
            // user.Nome = "Utilizador Eliminado";
            // user.NIF = null; 

            // 2. Marcar como eliminado
            user.IsDeleted = true;

            // 3. Atualizar na BD
            var result = await _userManager.UpdateAsync(user);

            if (result.Succeeded)
            {
                // 4. Fazer Logout forçado
                await _signInManager.SignOutAsync();
                _logger.LogInformation("Utilizador {Id} apagou a conta (Soft Delete).", user.Id);

                return RedirectToAction("Index", "Home");
            }

            // Tratar erro...
            return View("Perfil");
        }
    }
}
</file>

</files>
