@model Veiculo
@using AutoMarket.Models.Entities
@{
    ViewData["Title"] = "Checkout - Comprar Veículo";
}

<div class="container py-5">
    <div class="row">
        <!-- Coluna Esquerda: Formulário -->
        <div class="col-lg-8">
            <h2 class="mb-4">?? Finalizar Compra</h2>

            <form method="post" asp-action="ProcessarPagamento" class="needs-validation">
                <!-- RESUMO DO VEÍCULO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">?? Resumo do Veículo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                @{
                                    var imagem = Model.Imagens?.FirstOrDefault(i => i.IsCapa) ?? Model.Imagens?.FirstOrDefault();
                                }
                                @if (imagem != null)
                                {
                                    <img src="/images/veiculos/@imagem.CaminhoFicheiro" class="img-fluid rounded" alt="@Model.Marca @Model.Modelo">
                                }
                                else
                                {
                                    <div style="height: 200px; background: #e0e0e0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">Sem imagem</span>
                                    </div>
                                }
                            </div>
                            <div class="col-md-8">
                                <h5>@Model.Marca @Model.Modelo (@Model.Ano)</h5>
                                <p class="text-muted mb-2">@Model.Titulo</p>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <small class="text-muted">Quilometragem</small>
                                        <p class="fw-bold">@Model.Km.ToString("N0") km</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Combustível</small>
                                        <p class="fw-bold">@Model.Combustivel</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Caixa</small>
                                        <p class="fw-bold">@Model.Caixa</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Localização</small>
                                        <p class="fw-bold">@Model.Localizacao</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DADOS DE FATURAÇÃO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">?? Dados de Faturação</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="morada" class="form-label fw-bold">Morada de Envio</label>
                                <input type="text" class="form-control" id="morada" name="morada" required>
                                <small class="text-muted">Onde deseja receber o veículo</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nif" class="form-label fw-bold">NIF (para fatura)</label>
                                <input type="text" class="form-control" id="nif" name="nif" placeholder="123456789" required>
                                <small class="text-muted">Número de contribuinte</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label fw-bold">Nome Completo</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label fw-bold">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefone" class="form-label fw-bold">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" name="telefone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cidade" class="form-label fw-bold">Cidade</label>
                                <input type="text" class="form-control" id="cidade" name="cidade" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MÉTODO DE PAGAMENTO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">?? Método de Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="metodo" class="form-label fw-bold">Selecione o Método</label>
                            <select class="form-select form-select-lg" id="metodo" name="metodo" required>
                                <option value="">-- Escolher --</option>
                                <option value="cartao">?? Cartão de Crédito</option>
                                <option value="transferencia">?? Transferência Bancária</option>
                                <option value="mbway">?? MB Way</option>
                                <option value="paypal">??? PayPal</option>
                            </select>
                        </div>

                        <!-- Dados Cartão (apenas para demonstração) -->
                        <div id="dadosCartao" style="display: none;" class="mt-3">
                            <div class="alert alert-info">
                                ?? <strong>Simulação:</strong> Use os dados abaixo para testar o pagamento
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold">Número do Cartão</label>
                                    <input type="text" class="form-control" value="4532123456789010" readonly>
                                    <small class="text-muted">Teste: 4532123456789010</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">CVV</label>
                                    <input type="text" class="form-control" value="123" readonly>
                                    <small class="text-muted">Teste: 123</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Validade</label>
                                    <input type="text" class="form-control" value="12/25" readonly>
                                    <small class="text-muted">Teste: 12/25</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Nome do Titular</label>
                                    <input type="text" class="form-control" value="JOHN DOE" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TERMOS E CONDIÇÕES -->
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="termos" name="aceitar_termos" required>
                    <label class="form-check-label" for="termos">
                        Aceito os <a href="/Public/Home/Termos" target="_blank">termos e condições</a> da compra
                    </label>
                </div>

                <!-- BOTÕES -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg fw-bold">
                        ? Confirmar Pagamento - €@Model.Preco.ToString("F2")
                    </button>
                    <a href="@Url.Action("Detalhe", "Veiculos", new { id = Model.Id })" class="btn btn-outline-secondary btn-lg">
                        ? Voltar ao Anúncio
                    </a>
                </div>
            </form>
        </div>

        <!-- Coluna Direita: Resumo -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">?? Resumo da Compra</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td>Preço do Veículo:</td>
                            <td class="text-end fw-bold">€@Model.Preco.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>Comissão de Serviço:</td>
                            <td class="text-end">€@(Model.Preco * 0.05m).ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>IVA (23%):</td>
                            <td class="text-end">€@(Model.Preco * 1.23m * 0.23m).ToString("F2")</td>
                        </tr>
                        <tr class="border-top pt-3">
                            <td class="fw-bold">Total a Pagar:</td>
                            <td class="text-end text-success fw-bold fs-5">€@(Model.Preco * 1.23m + (Model.Preco * 0.05m)).ToString("F2")</td>
                        </tr>
                    </table>

                    <hr>

                    <div class="mb-3">
                        <h6 class="mb-2">Vendedor</h6>
                        <p class="mb-0 fw-bold">@Model.Vendedor?.User?.Nome</p>
                        <small class="text-muted">
                            <i class="bi bi-telephone"></i> @Model.Vendedor?.User?.Contacto
                        </small>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <small>
                            ? Compra segura com garantia de entrega<br>
                            ? Suporte ao cliente 24/7<br>
                            ? Direito de devolução em 14 dias
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('metodo').addEventListener('change', function() {
            document.getElementById('dadosCartao').style.display = 
                this.value === 'cartao' ? 'block' : 'none';
        });
    </script>
}
