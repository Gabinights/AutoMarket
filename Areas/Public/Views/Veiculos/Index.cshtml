@using AutoMarket.Models.Entities
@model IEnumerable<Veiculo>
@{
    ViewData["Title"] = "Pesquisa de Veículos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- SIDEBAR FILTROS (Esquerda) -->
        <aside class="col-lg-3 col-md-4 col-12">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="/Veiculos/BuscarAjax" id="filtrosForm">
                        
                        <!-- Marca -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Marca</label>
                            <select name="marca" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todas as marcas --</option>
                                @foreach (var m in (ViewData["Marcas"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["MarcaSelecionada"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Modelo -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Modelo</label>
                            <select name="modelo" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os modelos --</option>
                                @foreach (var m in (ViewData["Modelos"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@m" selected="@(ViewData["ModeloSelecionado"]?.ToString() == m)">@m</option>
                                }
                            </select>
                        </div>

                        <!-- Combustível -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Combustível</label>
                            <select name="combustivel" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos --</option>
                                @foreach (var c in (ViewData["Combustiveis"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@c" selected="@(ViewData["CombustivelSelecionado"]?.ToString() == c)">@c</option>
                                }
                            </select>
                        </div>

                        <!-- Ano -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ano</label>
                            <select name="ano" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os anos --</option>
                                @foreach (var a in (ViewData["Anos"] as List<int>) ?? new List<int>())
                                {
                                    <option value="@a" selected="@(ViewData["AnoSelecionado"]?.ToString() == a.ToString())">@a</option>
                                }
                            </select>
                        </div>

                        <!-- Tipo/Segmento -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Tipo (Segmento)</label>
                            <select name="categoria" class="form-select form-select-sm filtro-select">
                                <option value="">-- Todos os tipos --</option>
                                @foreach (var cat in (ViewData["Categorias"] as List<string>) ?? new List<string>())
                                {
                                    <option value="@cat" selected="@(ViewData["CategoriaSelecionada"]?.ToString() == cat)">@cat</option>
                                }
                            </select>
                        </div>

                        <!-- Preço Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Preço (€)</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="precoMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["PrecoMin"]" />
                                <input type="number" name="precoMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["PrecoMax"]" />
                            </div>
                        </div>

                        <!-- KM Min-Max -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Quilómetros</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="number" name="kmMin" class="form-control filtro-input" placeholder="Mín" value="@ViewData["KmMin"]" />
                                <input type="number" name="kmMax" class="form-control filtro-input" placeholder="Máx" value="@ViewData["KmMax"]" />
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm" id="btnPesquisar">
                                <i class="bi bi-search"></i> Pesquisar
                            </button>
                            <a href="/Veiculos/Index" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <!-- ANÚNCIOS (Direita) -->
        <section class="col-lg-9 col-md-8 col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Veículos Disponíveis</h5>
                    <div>
                        <label class="form-label mb-0 me-2">Ordenar:</label>
                        <select id="ordenacao" class="form-select form-select-sm d-inline w-auto filtro-select">
                            <option value="recente" selected="@(ViewData["Ordenacao"]?.ToString() == "recente")">Mais recente</option>
                            <option value="preco_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_asc")">Preço ascendente</option>
                            <option value="preco_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "preco_desc")">Preço descendente</option>
                            <option value="km_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_asc")">KM ascendentes</option>
                            <option value="km_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "km_desc")">KM descendentes</option>
                            <option value="ano_asc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_asc")">Ano ascendente</option>
                            <option value="ano_desc" selected="@(ViewData["Ordenacao"]?.ToString() == "ano_desc")">Ano descendente</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- LOADING SPINNER -->
            <div id="loadingSpinner" class="text-center" style="display: none; padding: 3rem;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-3">Procurando veículos...</p>
            </div>

            <!-- CONTENTOR DE RESULTADOS (será preenchido via AJAX) -->
            <div id="resultado">
                @await Html.PartialAsync("_CarListPartial", Model)
            </div>
        </section>
    </div>
</div>

<style>
    .vehicle-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .vehicle-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<script>
    // ============================================================
    // AJAX LISTENER - Pesquisa dinâmica sem recarregar página
    // ============================================================

    function executarBusca() {
        // Mostrar loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('resultado').style.opacity = '0.5';

        // Obter dados do formulário
        const formData = new FormData(document.getElementById('filtrosForm'));
        const ordenacao = document.getElementById('ordenacao').value;
        formData.append('ordenacao', ordenacao);

        // Fazer requisição AJAX
        fetch('/Veiculos/BuscarAjax', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            // Substituir conteúdo do resultado
            document.getElementById('resultado').innerHTML = html;
            document.getElementById('resultado').style.opacity = '1';

            // Adicionar listeners aos links de paginação
            adicionarListenersPaginacao();

            // Scroll suave até os resultados
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Erro ao pesquisar:', error);
            document.getElementById('resultado').innerHTML = `
                <div class="alert alert-danger text-center">
                    <h6>Erro ao carregar resultados</h6>
                    <p>${error.message}</p>
                </div>
            `;
            document.getElementById('resultado').style.opacity = '1';
        })
        .finally(() => {
            // Esconder loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
        });
    }

    function adicionarListenersPaginacao() {
        // Listeners para links de paginação
        document.querySelectorAll('.pagination-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                const formData = new FormData(document.getElementById('filtrosForm'));
                formData.append('page', page);
                formData.append('ordenacao', document.getElementById('ordenacao').value);

                // Repetir busca com nova página
                executarBusca();
            });
        });
    }

    // ============================================================
    // INICIALIZAÇÃO
    // ============================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Listeners nos filtros (select e input)
        document.querySelectorAll('.filtro-select, .filtro-input').forEach(element => {
            element.addEventListener('change', executarBusca);
        });

        // Listener na dropdown de ordenação
        document.getElementById('ordenacao').addEventListener('change', executarBusca);

        // Listener no botão pesquisar (para Enter em inputs)
        document.getElementById('filtrosForm').addEventListener('submit', (e) => {
            e.preventDefault();
            executarBusca();
        });

        // Listeners iniciais na paginação
        adicionarListenersPaginacao();
    });
</script>
